<!doctype html><html lang=en class=no-js>
<head>
<meta name=ROBOTS content="NOINDEX, NOFOLLOW">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JPP6RFM2BP"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-JPP6RFM2BP')</script>
<link rel=alternate hreflang=zh href=https://kubernetes.io/zh/docs/setup/production-environment/>
<link rel=alternate hreflang=ko href=https://kubernetes.io/ko/docs/setup/production-environment/>
<link rel=alternate hreflang=ja href=https://kubernetes.io/ja/docs/setup/production-environment/>
<link rel=alternate hreflang=fr href=https://kubernetes.io/fr/docs/setup/production-environment/>
<link rel=alternate hreflang=id href=https://kubernetes.io/id/docs/setup/production-environment/>
<link rel=alternate hreflang=uk href=https://kubernetes.io/uk/docs/setup/production-environment/>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.87.0">
<link rel=canonical type=text/html href=https://kubernetes.io/docs/setup/production-environment/>
<link rel="shortcut icon" type=image/png href=/images/favicon.png>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=manifest href=/manifest.webmanifest>
<link rel=apple-touch-icon href=/images/kubernetes-192x192.png>
<title>Production environment | Kubernetes</title><meta property="og:title" content="Production environment">
<meta property="og:description" content="Create a production-quality Kubernetes cluster">
<meta property="og:type" content="website">
<meta property="og:url" content="https://kubernetes.io/docs/setup/production-environment/"><meta property="og:site_name" content="Kubernetes">
<meta itemprop=name content="Production environment">
<meta itemprop=description content="Create a production-quality Kubernetes cluster"><meta name=twitter:card content="summary">
<meta name=twitter:title content="Production environment">
<meta name=twitter:description content="Create a production-quality Kubernetes cluster">
<link href=/scss/main.css rel=stylesheet>
<script src=/js/jquery-3.3.1.min.js integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin=anonymous></script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"Organization","url":"https://kubernetes.io","logo":"https://kubernetes.io/images/favicon.png"}</script>
<meta name=theme-color content="#326ce5">
<link rel=stylesheet href=/css/feature-states.css>
<meta name=description content="Create a production-quality Kubernetes cluster">
<meta property="og:description" content="Create a production-quality Kubernetes cluster">
<meta name=twitter:description content="Create a production-quality Kubernetes cluster">
<meta property="og:url" content="https://kubernetes.io/docs/setup/production-environment/">
<meta property="og:title" content="Production environment">
<meta name=twitter:title content="Production environment">
<meta name=twitter:image content="https://kubernetes.io/images/favicon.png">
<meta name=twitter:image:alt content="Kubernetes">
<meta property="og:image" content="/images/kubernetes-horizontal-color.png">
<meta property="og:type" content="article">
<script src=/js/script.js></script>
</head>
<body class=td-section>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar" data-auto-burger=primary>
<a class=navbar-brand href=/></a>
<div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar>
<ul class="navbar-nav mt-2 mt-lg-0">
<li class="nav-item mr-2 mb-lg-0">
<a class="nav-link active" href=/docs/>Documentation</a>
</li>
<li class="nav-item mr-2 mb-lg-0">
<a class=nav-link href=/blog/>Kubernetes Blog</a>
</li>
<li class="nav-item mr-2 mb-lg-0">
<a class=nav-link href=/training/>Training</a>
</li>
<li class="nav-item mr-2 mb-lg-0">
<a class=nav-link href=/partners/>Partners</a>
</li>
<li class="nav-item mr-2 mb-lg-0">
<a class=nav-link href=/community/>Community</a>
</li>
<li class="nav-item mr-2 mb-lg-0">
<a class=nav-link href=/case-studies/>Case Studies</a>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
Versions
</a>
<div class="dropdown-menu dropdown-menu-right" aria-labelledby=navbarDropdownMenuLink>
<a class=dropdown-item href=/releases>Release Information</a>
<a class=dropdown-item href=https://kubernetes.io/docs/setup/production-environment/>v1.27</a>
<a class=dropdown-item href=https://v1-26.docs.kubernetes.io/docs/setup/production-environment/>v1.26</a>
<a class=dropdown-item href=https://v1-25.docs.kubernetes.io/docs/setup/production-environment/>v1.25</a>
<a class=dropdown-item href=https://v1-24.docs.kubernetes.io/docs/setup/production-environment/>v1.24</a>
<a class=dropdown-item href=https://v1-23.docs.kubernetes.io/docs/setup/production-environment/>v1.23</a>
</div>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdownMenuLink role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
English
</a>
<div class="dropdown-menu dropdown-menu-right" aria-labelledby=navbarDropdownMenuLink>
<a class=dropdown-item href=/zh/docs/setup/production-environment/>中文 Chinese</a>
<a class=dropdown-item href=/ko/docs/setup/production-environment/>한국어 Korean</a>
<a class=dropdown-item href=/ja/docs/setup/production-environment/>日本語 Japanese</a>
<a class=dropdown-item href=/fr/docs/setup/production-environment/>Français</a>
<a class=dropdown-item href=/id/docs/setup/production-environment/>Bahasa Indonesia</a>
<a class=dropdown-item href=/uk/docs/setup/production-environment/>Українська</a>
</div>
</li>
</ul>
</div>
<button id=hamburger onclick=kub.toggleMenu() data-auto-burger-exclude><div></div></button>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<div class=td-content>
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.
</p><p>
<a href=/docs/setup/production-environment/>Return to the regular view of this page</a>.
</p>
</div>
<h1 class=title>Production environment</h1>
<div class=lead>Create a production-quality Kubernetes cluster</div>
<ul>
<li>1: <a href=#pg-a77d3feb6e6d9978f32fa14622642e9a>Container Runtimes</a></li>
<li>2: <a href=#pg-00e1646f68aeb89f9722cf6f6cfcad94>Installing Kubernetes with deployment tools</a></li>
<ul>
<li>2.1: <a href=#pg-a16f59f325a17cdeed324d5c889f7f73>Bootstrapping clusters with kubeadm</a></li>
<ul>
<li>2.1.1: <a href=#pg-29e59491dd6118b23072dfe9ebb93323>Installing kubeadm</a></li>
<li>2.1.2: <a href=#pg-c3689df4b0c61a998e79d91a865aa244>Troubleshooting kubeadm</a></li>
<li>2.1.3: <a href=#pg-134ed1f6142a98e6ac681a1ba4920e53>Creating a cluster with kubeadm</a></li>
<li>2.1.4: <a href=#pg-4c656c5eda3e1c06ad1aedebdc04a211>Customizing components with the kubeadm API</a></li>
<li>2.1.5: <a href=#pg-015edbc7cc688d31b1d1edce7c186135>Options for Highly Available Topology</a></li>
<li>2.1.6: <a href=#pg-3941d5c3409342219bf7e03128b8ecb6>Creating Highly Available Clusters with kubeadm</a></li>
<li>2.1.7: <a href=#pg-8160424c22d24f7d2d63c521e107dbf8>Set up a High Availability etcd Cluster with kubeadm</a></li>
<li>2.1.8: <a href=#pg-07709e71de6b4ac2573041c31213dbeb>Configuring each kubelet in your cluster using kubeadm</a></li>
<li>2.1.9: <a href=#pg-df2f3f20d404ebe2b03fcda1fcee50e7>Dual-stack support with kubeadm</a></li>
</ul>
<li>2.2: <a href=#pg-478acca1934b6d89a0bc00fb25bfe5b6>Installing Kubernetes with kops</a></li>
<li>2.3: <a href=#pg-f8b4964187fe973644e06ee629eff1de>Installing Kubernetes with Kubespray</a></li>
</ul>
<li>3: <a href=#pg-d2f55eefe7222b7c637875af9c3ec199>Turnkey Cloud Solutions</a></li>
<li>4: <a href=#pg-acce7e24090fea04715a7a516ba3e69b>Windows in Kubernetes</a></li>
<ul>
<li>4.1: <a href=#pg-a307d413f1f7430fced233023087e2a1>Windows containers in Kubernetes</a></li>
<li>4.2: <a href=#pg-3a51e66c5de55f9093a8dc55742006d3>Guide for scheduling Windows containers in Kubernetes</a></li>
</ul>
</ul>
<div class=content>
<p>A production-quality Kubernetes cluster requires planning and preparation.
If your Kubernetes cluster is to run critical workloads, it must be configured to be resilient.
This page explains steps you can take to set up a production-ready cluster,
or to promote an existing cluster for production use.
If you're already familiar with production setup and want the links, skip to
<a href=#what-s-next>What's next</a>.</p>
<h2 id=production-considerations>Production considerations</h2>
<p>Typically, a production Kubernetes cluster environment has more requirements than a
personal learning, development, or test environment Kubernetes. A production environment may require
secure access by many users, consistent availability, and the resources to adapt
to changing demands.</p>
<p>As you decide where you want your production Kubernetes environment to live
(on premises or in a cloud) and the amount of management you want to take
on or hand to others, consider how your requirements for a Kubernetes cluster
are influenced by the following issues:</p>
<ul>
<li>
<p><em>Availability</em>: A single-machine Kubernetes <a href=/docs/setup/#learning-environment>learning environment</a>
has a single point of failure. Creating a highly available cluster means considering:</p>
<ul>
<li>Separating the control plane from the worker nodes.</li>
<li>Replicating the control plane components on multiple nodes.</li>
<li>Load balancing traffic to the cluster’s <a class=glossary-tooltip title="Control plane component that serves the Kubernetes API." data-toggle=tooltip data-placement=top href=/docs/concepts/overview/components/#kube-apiserver target=_blank aria-label="API server">API server</a>.</li>
<li>Having enough worker nodes available, or able to quickly become available, as changing workloads warrant it.</li>
</ul>
</li>
<li>
<p><em>Scale</em>: If you expect your production Kubernetes environment to receive a stable amount of
demand, you might be able to set up for the capacity you need and be done. However,
if you expect demand to grow over time or change dramatically based on things like
season or special events, you need to plan how to scale to relieve increased
pressure from more requests to the control plane and worker nodes or scale down to reduce unused
resources.</p>
</li>
<li>
<p><em>Security and access management</em>: You have full admin privileges on your own
Kubernetes learning cluster. But shared clusters with important workloads, and
more than one or two users, require a more refined approach to who and what can
access cluster resources. You can use role-based access control
(<a href=/docs/reference/access-authn-authz/rbac/>RBAC</a>) and other
security mechanisms to make sure that users and workloads can get access to the
resources they need, while keeping workloads, and the cluster itself, secure.
You can set limits on the resources that users and workloads can access
by managing <a href=/docs/concepts/policy/>policies</a> and
<a href=/docs/concepts/configuration/manage-resources-containers/>container resources</a>.</p>
</li>
</ul>
<p>Before building a Kubernetes production environment on your own, consider
handing off some or all of this job to
<a href=/docs/setup/production-environment/turnkey-solutions/>Turnkey Cloud Solutions</a>
providers or other <a href=https://kubernetes.io/partners/>Kubernetes Partners</a>.
Options include:</p>
<ul>
<li><em>Serverless</em>: Just run workloads on third-party equipment without managing
a cluster at all. You will be charged for things like CPU usage, memory, and
disk requests.</li>
<li><em>Managed control plane</em>: Let the provider manage the scale and availability
of the cluster's control plane, as well as handle patches and upgrades.</li>
<li><em>Managed worker nodes</em>: Configure pools of nodes to meet your needs,
then the provider makes sure those nodes are available and ready to implement
upgrades when needed.</li>
<li><em>Integration</em>: There are providers that integrate Kubernetes with other
services you may need, such as storage, container registries, authentication
methods, and development tools.</li>
</ul>
<p>Whether you build a production Kubernetes cluster yourself or work with
partners, review the following sections to evaluate your needs as they relate
to your cluster’s <em>control plane</em>, <em>worker nodes</em>, <em>user access</em>, and
<em>workload resources</em>.</p>
<h2 id=production-cluster-setup>Production cluster setup</h2>
<p>In a production-quality Kubernetes cluster, the control plane manages the
cluster from services that can be spread across multiple computers
in different ways. Each worker node, however, represents a single entity that
is configured to run Kubernetes pods.</p>
<h3 id=production-control-plane>Production control plane</h3>
<p>The simplest Kubernetes cluster has the entire control plane and worker node
services running on the same machine. You can grow that environment by adding
worker nodes, as reflected in the diagram illustrated in
<a href=/docs/concepts/overview/components/>Kubernetes Components</a>.
If the cluster is meant to be available for a short period of time, or can be
discarded if something goes seriously wrong, this might meet your needs.</p>
<p>If you need a more permanent, highly available cluster, however, you should
consider ways of extending the control plane. By design, one-machine control
plane services running on a single machine are not highly available.
If keeping the cluster up and running
and ensuring that it can be repaired if something goes wrong is important,
consider these steps:</p>
<ul>
<li><em>Choose deployment tools</em>: You can deploy a control plane using tools such
as kubeadm, kops, and kubespray. See
<a href=/docs/setup/production-environment/tools/>Installing Kubernetes with deployment tools</a>
to learn tips for production-quality deployments using each of those deployment
methods. Different <a href=/docs/setup/production-environment/container-runtimes/>Container Runtimes</a>
are available to use with your deployments.</li>
<li><em>Manage certificates</em>: Secure communications between control plane services
are implemented using certificates. Certificates are automatically generated
during deployment or you can generate them using your own certificate authority.
See <a href=/docs/setup/best-practices/certificates/>PKI certificates and requirements</a> for details.</li>
<li><em>Configure load balancer for apiserver</em>: Configure a load balancer
to distribute external API requests to the apiserver service instances running on different nodes. See
<a href=/docs/tasks/access-application-cluster/create-external-load-balancer/>Create an External Load Balancer</a>
for details.</li>
<li><em>Separate and backup etcd service</em>: The etcd services can either run on the
same machines as other control plane services or run on separate machines, for
extra security and availability. Because etcd stores cluster configuration data,
backing up the etcd database should be done regularly to ensure that you can
repair that database if needed.
See the <a href=https://etcd.io/docs/v3.4/faq/>etcd FAQ</a> for details on configuring and using etcd.
See <a href=/docs/tasks/administer-cluster/configure-upgrade-etcd/>Operating etcd clusters for Kubernetes</a>
and <a href=/docs/setup/production-environment/tools/kubeadm/setup-ha-etcd-with-kubeadm/>Set up a High Availability etcd cluster with kubeadm</a>
for details.</li>
<li><em>Create multiple control plane systems</em>: For high availability, the
control plane should not be limited to a single machine. If the control plane
services are run by an init service (such as systemd), each service should run on at
least three machines. However, running control plane services as pods in
Kubernetes ensures that the replicated number of services that you request
will always be available.
The scheduler should be fault tolerant,
but not highly available. Some deployment tools set up <a href=https://raft.github.io/>Raft</a>
consensus algorithm to do leader election of Kubernetes services. If the
primary goes away, another service elects itself and take over.</li>
<li><em>Span multiple zones</em>: If keeping your cluster available at all times is
critical, consider creating a cluster that runs across multiple data centers,
referred to as zones in cloud environments. Groups of zones are referred to as regions.
By spreading a cluster across
multiple zones in the same region, it can improve the chances that your
cluster will continue to function even if one zone becomes unavailable.
See <a href=/docs/setup/best-practices/multiple-zones/>Running in multiple zones</a> for details.</li>
<li><em>Manage on-going features</em>: If you plan to keep your cluster over time,
there are tasks you need to do to maintain its health and security. For example,
if you installed with kubeadm, there are instructions to help you with
<a href=/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/>Certificate Management</a>
and <a href=/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/>Upgrading kubeadm clusters</a>.
See <a href=/docs/tasks/administer-cluster/>Administer a Cluster</a>
for a longer list of Kubernetes administrative tasks.</li>
</ul>
<p>To learn about available options when you run control plane services, see
<a href=/docs/reference/command-line-tools-reference/kube-apiserver/>kube-apiserver</a>,
<a href=/docs/reference/command-line-tools-reference/kube-controller-manager/>kube-controller-manager</a>,
and <a href=/docs/reference/command-line-tools-reference/kube-scheduler/>kube-scheduler</a>
component pages. For highly available control plane examples, see
<a href=/docs/setup/production-environment/tools/kubeadm/ha-topology/>Options for Highly Available topology</a>,
<a href=/docs/setup/production-environment/tools/kubeadm/high-availability/>Creating Highly Available clusters with kubeadm</a>,
and <a href=/docs/tasks/administer-cluster/configure-upgrade-etcd/>Operating etcd clusters for Kubernetes</a>.
See <a href=/docs/tasks/administer-cluster/configure-upgrade-etcd/#backing-up-an-etcd-cluster>Backing up an etcd cluster</a>
for information on making an etcd backup plan.</p>
<h3 id=production-worker-nodes>Production worker nodes</h3>
<p>Production-quality workloads need to be resilient and anything they rely
on needs to be resilient (such as CoreDNS). Whether you manage your own
control plane or have a cloud provider do it for you, you still need to
consider how you want to manage your worker nodes (also referred to
simply as <em>nodes</em>).</p>
<ul>
<li><em>Configure nodes</em>: Nodes can be physical or virtual machines. If you want to
create and manage your own nodes, you can install a supported operating system,
then add and run the appropriate
<a href=/docs/concepts/overview/components/#node-components>Node services</a>. Consider:
<ul>
<li>The demands of your workloads when you set up nodes by having appropriate memory, CPU, and disk speed and storage capacity available.</li>
<li>Whether generic computer systems will do or you have workloads that need GPU processors, Windows nodes, or VM isolation.</li>
</ul>
</li>
<li><em>Validate nodes</em>: See <a href=/docs/setup/best-practices/node-conformance/>Valid node setup</a>
for information on how to ensure that a node meets the requirements to join
a Kubernetes cluster.</li>
<li><em>Add nodes to the cluster</em>: If you are managing your own cluster you can
add nodes by setting up your own machines and either adding them manually or
having them register themselves to the cluster’s apiserver. See the
<a href=/docs/concepts/architecture/nodes/>Nodes</a> section for information on how to set up Kubernetes to add nodes in these ways.</li>
<li><em>Add Windows nodes to the cluster</em>: Kubernetes offers support for Windows
worker nodes, allowing you to run workloads implemented in Windows containers. See
<a href=/docs/setup/production-environment/windows/>Windows in Kubernetes</a> for details.</li>
<li><em>Scale nodes</em>: Have a plan for expanding the capacity your cluster will
eventually need. See <a href=/docs/setup/best-practices/cluster-large/>Considerations for large clusters</a>
to help determine how many nodes you need, based on the number of pods and
containers you need to run. If you are managing nodes yourself, this can mean
purchasing and installing your own physical equipment.</li>
<li><em>Autoscale nodes</em>: Most cloud providers support
<a href=https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler#readme>Cluster Autoscaler</a>
to replace unhealthy nodes or grow and shrink the number of nodes as demand requires. See the
<a href=https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/FAQ.md>Frequently Asked Questions</a>
for how the autoscaler works and
<a href=https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler#deployment>Deployment</a>
for how it is implemented by different cloud providers. For on-premises, there
are some virtualization platforms that can be scripted to spin up new nodes
based on demand.</li>
<li><em>Set up node health checks</em>: For important workloads, you want to make sure
that the nodes and pods running on those nodes are healthy. Using the
<a href=/docs/tasks/debug/debug-cluster/monitor-node-health/>Node Problem Detector</a>
daemon, you can ensure your nodes are healthy.</li>
</ul>
<h2 id=production-user-management>Production user management</h2>
<p>In production, you may be moving from a model where you or a small group of
people are accessing the cluster to where there may potentially be dozens or
hundreds of people. In a learning environment or platform prototype, you might have a single
administrative account for everything you do. In production, you will want
more accounts with different levels of access to different namespaces.</p>
<p>Taking on a production-quality cluster means deciding how you
want to selectively allow access by other users. In particular, you need to
select strategies for validating the identities of those who try to access your
cluster (authentication) and deciding if they have permissions to do what they
are asking (authorization):</p>
<ul>
<li><em>Authentication</em>: The apiserver can authenticate users using client
certificates, bearer tokens, an authenticating proxy, or HTTP basic auth.
You can choose which authentication methods you want to use.
Using plugins, the apiserver can leverage your organization’s existing
authentication methods, such as LDAP or Kerberos. See
<a href=/docs/reference/access-authn-authz/authentication/>Authentication</a>
for a description of these different methods of authenticating Kubernetes users.</li>
<li><em>Authorization</em>: When you set out to authorize your regular users, you will probably choose between RBAC and ABAC authorization. See <a href=/docs/reference/access-authn-authz/authorization/>Authorization Overview</a> to review different modes for authorizing user accounts (as well as service account access to your cluster):
<ul>
<li><em>Role-based access control</em> (<a href=/docs/reference/access-authn-authz/rbac/>RBAC</a>): Lets you assign access to your cluster by allowing specific sets of permissions to authenticated users. Permissions can be assigned for a specific namespace (Role) or across the entire cluster (ClusterRole). Then using RoleBindings and ClusterRoleBindings, those permissions can be attached to particular users.</li>
<li><em>Attribute-based access control</em> (<a href=/docs/reference/access-authn-authz/abac/>ABAC</a>): Lets you create policies based on resource attributes in the cluster and will allow or deny access based on those attributes. Each line of a policy file identifies versioning properties (apiVersion and kind) and a map of spec properties to match the subject (user or group), resource property, non-resource property (/version or /apis), and readonly. See <a href=/docs/reference/access-authn-authz/abac/#examples>Examples</a> for details.</li>
</ul>
</li>
</ul>
<p>As someone setting up authentication and authorization on your production Kubernetes cluster, here are some things to consider:</p>
<ul>
<li><em>Set the authorization mode</em>: When the Kubernetes API server
(<a href=/docs/reference/command-line-tools-reference/kube-apiserver/>kube-apiserver</a>)
starts, the supported authentication modes must be set using the <em>--authorization-mode</em>
flag. For example, that flag in the <em>kube-adminserver.yaml</em> file (in <em>/etc/kubernetes/manifests</em>)
could be set to Node,RBAC. This would allow Node and RBAC authorization for authenticated requests.</li>
<li><em>Create user certificates and role bindings (RBAC)</em>: If you are using RBAC
authorization, users can create a CertificateSigningRequest (CSR) that can be
signed by the cluster CA. Then you can bind Roles and ClusterRoles to each user.
See <a href=/docs/reference/access-authn-authz/certificate-signing-requests/>Certificate Signing Requests</a>
for details.</li>
<li><em>Create policies that combine attributes (ABAC)</em>: If you are using ABAC
authorization, you can assign combinations of attributes to form policies to
authorize selected users or groups to access particular resources (such as a
pod), namespace, or apiGroup. For more information, see
<a href=/docs/reference/access-authn-authz/abac/#examples>Examples</a>.</li>
<li><em>Consider Admission Controllers</em>: Additional forms of authorization for
requests that can come in through the API server include
<a href=/docs/reference/access-authn-authz/authentication/#webhook-token-authentication>Webhook Token Authentication</a>.
Webhooks and other special authorization types need to be enabled by adding
<a href=/docs/reference/access-authn-authz/admission-controllers/>Admission Controllers</a>
to the API server.</li>
</ul>
<h2 id=set-limits-on-workload-resources>Set limits on workload resources</h2>
<p>Demands from production workloads can cause pressure both inside and outside
of the Kubernetes control plane. Consider these items when setting up for the
needs of your cluster's workloads:</p>
<ul>
<li><em>Set namespace limits</em>: Set per-namespace quotas on things like memory and CPU. See
<a href=/docs/tasks/administer-cluster/manage-resources/>Manage Memory, CPU, and API Resources</a>
for details. You can also set
<a href=/blog/2020/08/14/introducing-hierarchical-namespaces/>Hierarchical Namespaces</a>
for inheriting limits.</li>
<li><em>Prepare for DNS demand</em>: If you expect workloads to massively scale up,
your DNS service must be ready to scale up as well. See
<a href=/docs/tasks/administer-cluster/dns-horizontal-autoscaling/>Autoscale the DNS service in a Cluster</a>.</li>
<li><em>Create additional service accounts</em>: User accounts determine what users can
do on a cluster, while a service account defines pod access within a particular
namespace. By default, a pod takes on the default service account from its namespace.
See <a href=/docs/reference/access-authn-authz/service-accounts-admin/>Managing Service Accounts</a>
for information on creating a new service account. For example, you might want to:
<ul>
<li>Add secrets that a pod could use to pull images from a particular container registry. See <a href=/docs/tasks/configure-pod-container/configure-service-account/>Configure Service Accounts for Pods</a> for an example.</li>
<li>Assign RBAC permissions to a service account. See <a href=/docs/reference/access-authn-authz/rbac/#service-account-permissions>ServiceAccount permissions</a> for details.</li>
</ul>
</li>
</ul>
<h2 id=what-s-next>What's next</h2>
<ul>
<li>Decide if you want to build your own production Kubernetes or obtain one from
available <a href=/docs/setup/production-environment/turnkey-solutions/>Turnkey Cloud Solutions</a>
or <a href=https://kubernetes.io/partners/>Kubernetes Partners</a>.</li>
<li>If you choose to build your own cluster, plan how you want to
handle <a href=/docs/setup/best-practices/certificates/>certificates</a>
and set up high availability for features such as
<a href=/docs/setup/production-environment/tools/kubeadm/setup-ha-etcd-with-kubeadm/>etcd</a>
and the
<a href=/docs/setup/production-environment/tools/kubeadm/ha-topology/>API server</a>.</li>
<li>Choose from <a href=/docs/setup/production-environment/tools/kubeadm/>kubeadm</a>, <a href=/docs/setup/production-environment/tools/kops/>kops</a> or <a href=/docs/setup/production-environment/tools/kubespray/>Kubespray</a>
deployment methods.</li>
<li>Configure user management by determining your
<a href=/docs/reference/access-authn-authz/authentication/>Authentication</a> and
<a href=/docs/reference/access-authn-authz/authorization/>Authorization</a> methods.</li>
<li>Prepare for application workloads by setting up
<a href=/docs/tasks/administer-cluster/manage-resources/>resource limits</a>,
<a href=/docs/tasks/administer-cluster/dns-horizontal-autoscaling/>DNS autoscaling</a>
and <a href=/docs/reference/access-authn-authz/service-accounts-admin/>service accounts</a>.</li>
</ul>
</div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-a77d3feb6e6d9978f32fa14622642e9a>1 - Container Runtimes</h1>
<div class="alert alert-secondary callout note" role=alert>
<strong>Note:</strong> Dockershim has been removed from the Kubernetes project as of release 1.24. Read the <a href=/dockershim>Dockershim Removal FAQ</a> for further details.
</div>
<p>You need to install a
<a class=glossary-tooltip title="The container runtime is the software that is responsible for running containers." data-toggle=tooltip data-placement=top href=/docs/setup/production-environment/container-runtimes target=_blank aria-label="container runtime">container runtime</a>
into each node in the cluster so that Pods can run there. This page outlines
what is involved and describes related tasks for setting up nodes.</p>
<p>Kubernetes 1.23 requires that you use a runtime that
conforms with the
<a class=glossary-tooltip title="An API for container runtimes to integrate with kubelet" data-toggle=tooltip data-placement=top href=/docs/concepts/overview/components/#container-runtime target=_blank aria-label="Container Runtime Interface">Container Runtime Interface</a> (CRI).</p>
<p>See <a href=#cri-versions>CRI version support</a> for more information.</p>
<p>This page provides an outline of how to use several common container runtimes with
Kubernetes.</p>
<ul>
<li><a href=#containerd>containerd</a></li>
<li><a href=#cri-o>CRI-O</a></li>
<li><a href=#docker>Docker Engine</a></li>
<li><a href=#mcr>Mirantis Container Runtime</a></li>
</ul>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> <p>Kubernetes releases before v1.24 included a direct integration with Docker Engine,
using a component named <em>dockershim</em>. That special direct integration is no longer
part of Kubernetes (this removal was
<a href=/blog/2020/12/08/kubernetes-1-20-release-announcement/#dockershim-deprecation>announced</a>
as part of the v1.20 release).
You can read
<a href=/docs/tasks/administer-cluster/migrating-from-dockershim/check-if-dockershim-deprecation-affects-you/>Check whether Dockershim deprecation affects you</a> to understand how this removal might
affect you. To learn about migrating from using dockershim, see
<a href=/docs/tasks/administer-cluster/migrating-from-dockershim/>Migrating from dockershim</a>.</p>
<p>If you are running a version of Kubernetes other than v1.23,
check the documentation for that version.</p>
</div>
<h2 id=cgroup-drivers>Cgroup drivers</h2>
<p>On Linux, <a class=glossary-tooltip title="A group of Linux processes with optional resource isolation, accounting and limits." data-toggle=tooltip data-placement=top href="/docs/reference/glossary/?all=true#term-cgroup" target=_blank aria-label="control groups">control groups</a>
are used to constrain resources that are allocated to processes.</p>
<p>When <a href=https://www.freedesktop.org/wiki/Software/systemd/>systemd</a> is chosen as the init
system for a Linux distribution, the init process generates and consumes a root control group
(<code>cgroup</code>) and acts as a cgroup manager.
Systemd has a tight integration with cgroups and allocates a cgroup per systemd unit. It's possible
to configure your container runtime and the kubelet to use <code>cgroupfs</code>. Using <code>cgroupfs</code> alongside
systemd means that there will be two different cgroup managers.</p>
<p>A single cgroup manager simplifies the view of what resources are being allocated
and will by default have a more consistent view of the available and in-use resources.
When there are two cgroup managers on a system, you end up with two views of those resources.
In the field, people have reported cases where nodes that are configured to use <code>cgroupfs</code>
for the kubelet and Docker, but <code>systemd</code> for the rest of the processes, become unstable under
resource pressure.</p>
<p>Changing the settings such that your container runtime and kubelet use <code>systemd</code> as the cgroup driver
stabilized the system. To configure this for Docker, set <code>native.cgroupdriver=systemd</code>.</p>
<div class="alert alert-warning caution callout" role=alert>
<strong>Caution:</strong> <p>Changing the cgroup driver of a Node that has joined a cluster is a sensitive operation.
If the kubelet has created Pods using the semantics of one cgroup driver, changing the container
runtime to another cgroup driver can cause errors when trying to re-create the Pod sandbox
for such existing Pods. Restarting the kubelet may not solve such errors.</p>
<p>If you have automation that makes it feasible, replace the node with another using the updated
configuration, or reinstall it using automation.</p>
</div>
<h3 id=cgroup-v2>Cgroup version 2</h3>
<p>Cgroup v2 is the next version of the cgroup Linux API. Differently than cgroup v1, there is a single
hierarchy instead of a different one for each controller.</p>
<p>The new version offers several improvements over cgroup v1, some of these improvements are:</p>
<ul>
<li>cleaner and easier to use API</li>
<li>safe sub-tree delegation to containers</li>
<li>newer features like Pressure Stall Information</li>
</ul>
<p>Even if the kernel supports a hybrid configuration where some controllers are managed by cgroup v1
and some others by cgroup v2, Kubernetes supports only the same cgroup version to manage all the
controllers.</p>
<p>If systemd doesn't use cgroup v2 by default, you can configure the system to use it by adding
<code>systemd.unified_cgroup_hierarchy=1</code> to the kernel command line.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#080;font-style:italic># This example is for a Linux OS that uses the DNF package manager</span>
<span style=color:#080;font-style:italic># Your system might use a different method for setting the command line</span>
<span style=color:#080;font-style:italic># that the Linux kernel uses.</span>
sudo dnf install -y grubby <span style=color:#666>&amp;&amp;</span> <span style=color:#b62;font-weight:700>\
</span><span style=color:#b62;font-weight:700></span>  sudo grubby <span style=color:#b62;font-weight:700>\
</span><span style=color:#b62;font-weight:700></span>  --update-kernel<span style=color:#666>=</span>ALL <span style=color:#b62;font-weight:700>\
</span><span style=color:#b62;font-weight:700></span>  --args<span style=color:#666>=</span><span style=color:#b44>&#34;systemd.unified_cgroup_hierarchy=1&#34;</span>
</code></pre></div><p>If you change the command line for the kernel, you must reboot the node before your
change takes effect.</p>
<p>There should not be any noticeable difference in the user experience when switching to cgroup v2, unless
users are accessing the cgroup file system directly, either on the node or from within the containers.</p>
<p>In order to use it, cgroup v2 must be supported by the CRI runtime as well.</p>
<h3 id=migrating-to-the-systemd-driver-in-kubeadm-managed-clusters>Migrating to the <code>systemd</code> driver in kubeadm managed clusters</h3>
<p>If you wish to migrate to the <code>systemd</code> cgroup driver in existing kubeadm managed clusters,
follow <a href=/docs/tasks/administer-cluster/kubeadm/configure-cgroup-driver/>configuring a cgroup driver</a>.</p>
<h2 id=cri-versions>CRI version support</h2>
<p>Your container runtime must support at least v1alpha2 of the container runtime interface.</p>
<p>Kubernetes 1.23 defaults to using v1 of the CRI API.
If a container runtime does not support the v1 API, the kubelet falls back to
using the (deprecated) v1alpha2 API instead.</p>
<h2 id=container-runtimes>Container runtimes</h2>
<div class="alert alert-secondary callout third-party-content" role=alert><strong>Note:</strong>
This section links to third party projects that provide functionality required by Kubernetes. The Kubernetes project authors aren't responsible for these projects, which are listed alphabetically. To add a project to this list, read the <a href=/docs/contribute/style/content-guide/#third-party-content>content guide</a> before submitting a change. <a href=#third-party-content-disclaimer>More information.</a></div>
<h3 id=containerd>containerd</h3>
<p>This section outlines the necessary steps to use containerd as CRI runtime.</p>
<p>Use the following commands to install Containerd on your system:</p>
<ol>
<li>
<p>Install and configure prerequisites:</p>
<p>(these instructions apply to Linux nodes only)</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>cat <span style=color:#b44>&lt;&lt;EOF | sudo tee /etc/modules-load.d/containerd.conf
</span><span style=color:#b44>overlay
</span><span style=color:#b44>br_netfilter
</span><span style=color:#b44>EOF</span>

sudo modprobe overlay
sudo modprobe br_netfilter

<span style=color:#080;font-style:italic># Setup required sysctl params, these persist across reboots.</span>
cat <span style=color:#b44>&lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf
</span><span style=color:#b44>net.bridge.bridge-nf-call-iptables  = 1
</span><span style=color:#b44>net.ipv4.ip_forward                 = 1
</span><span style=color:#b44>net.bridge.bridge-nf-call-ip6tables = 1
</span><span style=color:#b44>EOF</span>

<span style=color:#080;font-style:italic># Apply sysctl params without reboot</span>
sudo sysctl --system
</code></pre></div></li>
<li>
<p>Install containerd:</p>
<p>Visit
<a href=https://github.com/containerd/containerd/blob/main/docs/getting-started.md>Getting started with containerd</a>
and follow the instructions there, up to the point where you have a valid
configuration file, config.toml.
On Linux, you can find this file under the path <code>/etc/containerd/config.toml</code>.
On Windows, you can find this file under the path <code>C:\Program Files\containerd\config.toml</code>.</p>
</li>
</ol>
<p>On Linux the default CRI socket for containerd is <code>/run/containerd/containerd.sock</code>.
On Windows the default CRI endpoint is <code>npipe://./pipe/containerd-containerd</code>.</p>
<h4 id=containerd-systemd>Configuring the <code>systemd</code> cgroup driver</h4>
<p>To use the <code>systemd</code> cgroup driver in <code>/etc/containerd/config.toml</code> with <code>runc</code>, set</p>
<pre><code>[plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc]
  ...
  [plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc.options]
    SystemdCgroup = true
</code></pre><p>If you apply this change, make sure to restart containerd:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sudo systemctl restart containerd
</code></pre></div><p>When using kubeadm, manually configure the
<a href=/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#configure-cgroup-driver-used-by-kubelet-on-control-plane-node>cgroup driver for kubelet</a>.</p>
<h3 id=cri-o>CRI-O</h3>
<p>This section contains the necessary steps to install CRI-O as a container runtime.</p>
<p>To install CRI-O, follow <a href=https://github.com/cri-o/cri-o/blob/main/install.md#readme>CRI-O Install Instructions</a>.</p>
<h4 id=cgroup-driver>cgroup driver</h4>
<p>CRI-O uses the systemd cgroup driver per default, which is likely to work fine
for you. To switch to the <code>cgroupfs</code> cgroup driver, either edit
<code>/etc/crio/crio.conf</code> or place a drop-in configuration in
<code>/etc/crio/crio.conf.d/02-cgroup-manager.conf</code>, for example:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml>[crio.runtime]
conmon_cgroup = <span style=color:#b44>&#34;pod&#34;</span>
cgroup_manager = <span style=color:#b44>&#34;cgroupfs&#34;</span>
</code></pre></div><p>You should also note the changed <code>conmon_cgroup</code>, which has to be set to the value
<code>pod</code> when using CRI-O with <code>cgroupfs</code>. It is generally necessary to keep the
cgroup driver configuration of the kubelet (usually done via kubeadm) and CRI-O
in sync.</p>
<p>For CRI-O, the CRI socket is <code>/var/run/crio/crio.sock</code> by default.</p>
<h3 id=docker>Docker Engine</h3>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> These instructions assume that you are using the
<a href=https://github.com/Mirantis/cri-dockerd><code>cri-dockerd</code></a> adapter to integrate
Docker Engine with Kubernetes.
</div>
<ol>
<li>
<p>On each of your nodes, install Docker for your Linux distribution as per
<a href=https://docs.docker.com/engine/install/#server>Install Docker Engine</a>.</p>
</li>
<li>
<p>Install <a href=https://github.com/Mirantis/cri-dockerd><code>cri-dockerd</code></a>, following
the instructions in that source code repository.</p>
</li>
</ol>
<p>For <code>cri-dockerd</code>, the CRI socket is <code>/run/cri-dockerd.sock</code> by default.</p>
<h3 id=mcr>Mirantis Container Runtime</h3>
<p><a href=https://docs.mirantis.com/mcr/20.10/overview.html>Mirantis Container Runtime</a> (MCR) is a commercially
available container runtime that was formerly known as Docker Enterprise Edition.</p>
<p>You can use Mirantis Container Runtime with Kubernetes using the open source
<a href=https://github.com/Mirantis/cri-dockerd><code>cri-dockerd</code></a> component, included with MCR.</p>
<p>To learn more about how to install Mirantis Container Runtime,
visit <a href=https://docs.mirantis.com/mcr/20.10/install.html>MCR Deployment Guide</a>.</p>
<p>Check the systemd unit named <code>cri-docker.socket</code> to find out the path to the CRI
socket.</p>
<h2 id=what-s-next>What's next</h2>
<p>As well as a container runtime, your cluster will need a working
<a href=/docs/concepts/cluster-administration/networking/#how-to-implement-the-kubernetes-networking-model>network plugin</a>.</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-00e1646f68aeb89f9722cf6f6cfcad94>2 - Installing Kubernetes with deployment tools</h1>
</div>
<div class=td-content>
<h1 id=pg-a16f59f325a17cdeed324d5c889f7f73>2.1 - Bootstrapping clusters with kubeadm</h1>
</div>
<div class=td-content>
<h1 id=pg-29e59491dd6118b23072dfe9ebb93323>2.1.1 - Installing kubeadm</h1>
<p><img src=/images/kubeadm-stacked-color.png align=right width=150px></img>
This page shows how to install the <code>kubeadm</code> toolbox.
For information on how to create a cluster with kubeadm once you have performed this installation process, see the <a href=/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/>Using kubeadm to Create a Cluster</a> page.</p>
<h2 id=before-you-begin>Before you begin</h2>
<ul>
<li>A compatible Linux host. The Kubernetes project provides generic instructions for Linux distributions based on Debian and Red Hat, and those distributions without a package manager.</li>
<li>2 GB or more of RAM per machine (any less will leave little room for your apps).</li>
<li>2 CPUs or more.</li>
<li>Full network connectivity between all machines in the cluster (public or private network is fine).</li>
<li>Unique hostname, MAC address, and product_uuid for every node. See <a href=#verify-mac-address>here</a> for more details.</li>
<li>Certain ports are open on your machines. See <a href=#check-required-ports>here</a> for more details.</li>
<li>Swap disabled. You <strong>MUST</strong> disable swap in order for the kubelet to work properly.</li>
</ul>
<h2 id=verify-mac-address>Verify the MAC address and product_uuid are unique for every node</h2>
<ul>
<li>You can get the MAC address of the network interfaces using the command <code>ip link</code> or <code>ifconfig -a</code></li>
<li>The product_uuid can be checked by using the command <code>sudo cat /sys/class/dmi/id/product_uuid</code></li>
</ul>
<p>It is very likely that hardware devices will have unique addresses, although some virtual machines may have
identical values. Kubernetes uses these values to uniquely identify the nodes in the cluster.
If these values are not unique to each node, the installation process
may <a href=https://github.com/kubernetes/kubeadm/issues/31>fail</a>.</p>
<h2 id=check-network-adapters>Check network adapters</h2>
<p>If you have more than one network adapter, and your Kubernetes components are not reachable on the default
route, we recommend you add IP route(s) so Kubernetes cluster addresses go via the appropriate adapter.</p>
<h2 id=letting-iptables-see-bridged-traffic>Letting iptables see bridged traffic</h2>
<p>Make sure that the <code>br_netfilter</code> module is loaded. This can be done by running <code>lsmod | grep br_netfilter</code>. To load it explicitly call <code>sudo modprobe br_netfilter</code>.</p>
<p>As a requirement for your Linux Node's iptables to correctly see bridged traffic, you should ensure <code>net.bridge.bridge-nf-call-iptables</code> is set to 1 in your <code>sysctl</code> config, e.g.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cat <span style=color:#b44>&lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf
</span><span style=color:#b44>br_netfilter
</span><span style=color:#b44>EOF</span>

cat <span style=color:#b44>&lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf
</span><span style=color:#b44>net.bridge.bridge-nf-call-ip6tables = 1
</span><span style=color:#b44>net.bridge.bridge-nf-call-iptables = 1
</span><span style=color:#b44>EOF</span>
sudo sysctl --system
</code></pre></div><p>For more details please see the <a href=/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/#network-plugin-requirements>Network Plugin Requirements</a> page.</p>
<h2 id=check-required-ports>Check required ports</h2>
<p>These
<a href=/docs/reference/ports-and-protocols/>required ports</a>
need to be open in order for Kubernetes components to communicate with each other. You can use tools like netcat to check if a port is open. For example:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>nc 127.0.0.1 <span style=color:#666>6443</span>
</code></pre></div><p>The pod network plugin you use (see below) may also require certain ports to be
open. Since this differs with each pod network plugin, please see the
documentation for the plugins about what port(s) those need.</p>
<h2 id=installing-runtime>Installing runtime</h2>
<p>To run containers in Pods, Kubernetes uses a
<a class=glossary-tooltip title="The container runtime is the software that is responsible for running containers." data-toggle=tooltip data-placement=top href=/docs/setup/production-environment/container-runtimes target=_blank aria-label="container runtime">container runtime</a>.</p>
<ul class="nav nav-tabs" id=container-runtime role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#container-runtime-0 role=tab aria-controls=container-runtime-0 aria-selected=true>Linux nodes</a></li>
<li class=nav-item><a data-toggle=tab class=nav-link href=#container-runtime-1 role=tab aria-controls=container-runtime-1>other operating systems</a></li></ul>
<div class=tab-content id=container-runtime><div id=container-runtime-0 class="tab-pane show active" role=tabpanel aria-labelledby=container-runtime-0>
<p><p>By default, Kubernetes uses the
<a class=glossary-tooltip title="An API for container runtimes to integrate with kubelet" data-toggle=tooltip data-placement=top href=/docs/concepts/overview/components/#container-runtime target=_blank aria-label="Container Runtime Interface">Container Runtime Interface</a> (CRI)
to interface with your chosen container runtime.</p>
<p>If you don't specify a runtime, kubeadm automatically tries to detect an installed
container runtime by scanning through a list of well known Unix domain sockets.
The following table lists container runtimes that kubeadm looks for, and their associated socket paths:</p>
<table><caption style=display:none>Container runtimes and their socket paths</caption>
<thead>
<tr>
<th>Runtime</th>
<th>Path to Unix domain socket</th>
</tr>
</thead>
<tbody>
<tr>
<td>Docker Engine</td>
<td><code>/var/run/dockershim.sock</code></td>
</tr>
<tr>
<td>containerd</td>
<td><code>/run/containerd/containerd.sock</code></td>
</tr>
<tr>
<td>CRI-O</td>
<td><code>/var/run/crio/crio.sock</code></td>
</tr>
</tbody>
</table>
<p><br>
If both Docker Engine and containerd are detected, kubeadm will give precedence to Docker Engine. This is
needed because Docker 18.09 ships with containerd and both are detectable even if you only
installed Docker.
<strong>If any other two or more runtimes are detected, kubeadm exits with an error.</strong></p>
<p>The kubelet can integrate with Docker Engine using the deprecated <code>dockershim</code> adapter (the dockershim is part of the kubelet itself).</p>
<p>See <a href=/docs/setup/production-environment/container-runtimes/>container runtimes</a>
for more information.</p>
</div>
<div id=container-runtime-1 class=tab-pane role=tabpanel aria-labelledby=container-runtime-1>
<p><p>By default, kubeadm uses <a class=glossary-tooltip title="Docker is a software technology providing operating-system-level virtualization also known as containers." data-toggle=tooltip data-placement=top href=https://docs.docker.com/engine/ target=_blank aria-label=Docker>Docker</a> as the container runtime.
The kubelet can integrate with Docker Engine using the deprecated <code>dockershim</code> adapter (the dockershim is part of the kubelet itself).</p>
<p>See <a href=/docs/setup/production-environment/container-runtimes/>container runtimes</a>
for more information.</p>
</div></div>
<h2 id=installing-kubeadm-kubelet-and-kubectl>Installing kubeadm, kubelet and kubectl</h2>
<p>You will install these packages on all of your machines:</p>
<ul>
<li>
<p><code>kubeadm</code>: the command to bootstrap the cluster.</p>
</li>
<li>
<p><code>kubelet</code>: the component that runs on all of the machines in your cluster
and does things like starting pods and containers.</p>
</li>
<li>
<p><code>kubectl</code>: the command line util to talk to your cluster.</p>
</li>
</ul>
<p>kubeadm <strong>will not</strong> install or manage <code>kubelet</code> or <code>kubectl</code> for you, so you will
need to ensure they match the version of the Kubernetes control plane you want
kubeadm to install for you. If you do not, there is a risk of a version skew occurring that
can lead to unexpected, buggy behaviour. However, <em>one</em> minor version skew between the
kubelet and the control plane is supported, but the kubelet version may never exceed the API
server version. For example, the kubelet running 1.7.0 should be fully compatible with a 1.8.0 API server,
but not vice versa.</p>
<p>For information about installing <code>kubectl</code>, see <a href=/docs/tasks/tools/>Install and set up kubectl</a>.</p>
<div class="alert alert-danger warning callout" role=alert>
<strong>Warning:</strong> These instructions exclude all Kubernetes packages from any system upgrades.
This is because kubeadm and Kubernetes require
<a href=/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/>special attention to upgrade</a>.
</div>
<p>For more information on version skews, see:</p>
<ul>
<li>Kubernetes <a href=/docs/setup/release/version-skew-policy/>version and version-skew policy</a></li>
<li>Kubeadm-specific <a href=/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#version-skew-policy>version skew policy</a></li>
</ul>
<ul class="nav nav-tabs" id=k8s-install role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#k8s-install-0 role=tab aria-controls=k8s-install-0 aria-selected=true>Debian-based distributions</a></li>
<li class=nav-item><a data-toggle=tab class=nav-link href=#k8s-install-1 role=tab aria-controls=k8s-install-1>Red Hat-based distributions</a></li>
<li class=nav-item><a data-toggle=tab class=nav-link href=#k8s-install-2 role=tab aria-controls=k8s-install-2>Without a package manager</a></li></ul>
<div class=tab-content id=k8s-install><div id=k8s-install-0 class="tab-pane show active" role=tabpanel aria-labelledby=k8s-install-0>
<p><ol>
<li>
<p>Update the <code>apt</code> package index and install packages needed to use the Kubernetes <code>apt</code> repository:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sudo apt-get update
sudo apt-get install -y apt-transport-https ca-certificates curl
</code></pre></div></li>
<li>
<p>Download the Google Cloud public signing key:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sudo curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg
</code></pre></div></li>
<li>
<p>Add the Kubernetes <code>apt</code> repository:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#a2f>echo</span> <span style=color:#b44>&#34;deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main&#34;</span> | sudo tee /etc/apt/sources.list.d/kubernetes.list
</code></pre></div></li>
<li>
<p>Update <code>apt</code> package index, install kubelet, kubeadm and kubectl, and pin their version:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sudo apt-get update
sudo apt-get install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl
</code></pre></div></li>
</ol>
</div>
<div id=k8s-install-1 class=tab-pane role=tabpanel aria-labelledby=k8s-install-1>
<p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cat <span style=color:#b44>&lt;&lt;EOF | sudo tee /etc/yum.repos.d/kubernetes.repo
</span><span style=color:#b44>[kubernetes]
</span><span style=color:#b44>name=Kubernetes
</span><span style=color:#b44>baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\$basearch
</span><span style=color:#b44>enabled=1
</span><span style=color:#b44>gpgcheck=1
</span><span style=color:#b44>repo_gpgcheck=1
</span><span style=color:#b44>gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
</span><span style=color:#b44>exclude=kubelet kubeadm kubectl
</span><span style=color:#b44>EOF</span>

<span style=color:#080;font-style:italic># Set SELinux in permissive mode (effectively disabling it)</span>
sudo setenforce <span style=color:#666>0</span>
sudo sed -i <span style=color:#b44>&#39;s/^SELINUX=enforcing$/SELINUX=permissive/&#39;</span> /etc/selinux/config

sudo yum install -y kubelet kubeadm kubectl --disableexcludes<span style=color:#666>=</span>kubernetes

sudo systemctl <span style=color:#a2f>enable</span> --now kubelet
</code></pre></div><p><strong>Notes:</strong></p>
<ul>
<li>
<p>Setting SELinux in permissive mode by running <code>setenforce 0</code> and <code>sed ...</code> effectively disables it.
This is required to allow containers to access the host filesystem, which is needed by pod networks for example.
You have to do this until SELinux support is improved in the kubelet.</p>
</li>
<li>
<p>You can leave SELinux enabled if you know how to configure it but it may require settings that are not supported by kubeadm.</p>
</li>
<li>
<p>If the <code>baseurl</code> fails because your Red Hat-based distribution cannot interpret <code>basearch</code>, replace <code>\$basearch</code> with your computer's architecture.
Type <code>uname -m</code> to see that value.
For example, the <code>baseurl</code> URL for <code>x86_64</code> could be: <code>https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64</code>.</p>
</li>
</ul>
</div>
<div id=k8s-install-2 class=tab-pane role=tabpanel aria-labelledby=k8s-install-2>
<p><p>Install CNI plugins (required for most pod network):</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#b8860b>CNI_VERSION</span><span style=color:#666>=</span><span style=color:#b44>&#34;v0.8.2&#34;</span>
<span style=color:#b8860b>ARCH</span><span style=color:#666>=</span><span style=color:#b44>&#34;amd64&#34;</span>
sudo mkdir -p /opt/cni/bin
curl -L <span style=color:#b44>&#34;https://github.com/containernetworking/plugins/releases/download/</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>CNI_VERSION</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>/cni-plugins-linux-</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>ARCH</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>-</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>CNI_VERSION</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>.tgz&#34;</span> | sudo tar -C /opt/cni/bin -xz
</code></pre></div><p>Define the directory to download command files</p>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> The <code>DOWNLOAD_DIR</code> variable must be set to a writable directory.
If you are running Flatcar Container Linux, set <code>DOWNLOAD_DIR=/opt/bin</code>.
</div>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#b8860b>DOWNLOAD_DIR</span><span style=color:#666>=</span>/usr/local/bin
sudo mkdir -p <span style=color:#b8860b>$DOWNLOAD_DIR</span>
</code></pre></div><p>Install crictl (required for kubeadm / Kubelet Container Runtime Interface (CRI))</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#b8860b>CRICTL_VERSION</span><span style=color:#666>=</span><span style=color:#b44>&#34;v1.22.0&#34;</span>
<span style=color:#b8860b>ARCH</span><span style=color:#666>=</span><span style=color:#b44>&#34;amd64&#34;</span>
curl -L <span style=color:#b44>&#34;https://github.com/kubernetes-sigs/cri-tools/releases/download/</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>CRICTL_VERSION</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>/crictl-</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>CRICTL_VERSION</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>-linux-</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>ARCH</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>.tar.gz&#34;</span> | sudo tar -C <span style=color:#b8860b>$DOWNLOAD_DIR</span> -xz
</code></pre></div><p>Install <code>kubeadm</code>, <code>kubelet</code>, <code>kubectl</code> and add a <code>kubelet</code> systemd service:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#b8860b>RELEASE</span><span style=color:#666>=</span><span style=color:#b44>&#34;</span><span style=color:#a2f;font-weight:700>$(</span>curl -sSL https://dl.k8s.io/release/stable.txt<span style=color:#a2f;font-weight:700>)</span><span style=color:#b44>&#34;</span>
<span style=color:#b8860b>ARCH</span><span style=color:#666>=</span><span style=color:#b44>&#34;amd64&#34;</span>
<span style=color:#a2f>cd</span> <span style=color:#b8860b>$DOWNLOAD_DIR</span>
sudo curl -L --remote-name-all https://storage.googleapis.com/kubernetes-release/release/<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>RELEASE</span><span style=color:#b68;font-weight:700>}</span>/bin/linux/<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>ARCH</span><span style=color:#b68;font-weight:700>}</span>/<span style=color:#666>{</span>kubeadm,kubelet,kubectl<span style=color:#666>}</span>
sudo chmod +x <span style=color:#666>{</span>kubeadm,kubelet,kubectl<span style=color:#666>}</span>

<span style=color:#b8860b>RELEASE_VERSION</span><span style=color:#666>=</span><span style=color:#b44>&#34;v0.4.0&#34;</span>
curl -sSL <span style=color:#b44>&#34;https://raw.githubusercontent.com/kubernetes/release/</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>RELEASE_VERSION</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>/cmd/kubepkg/templates/latest/deb/kubelet/lib/systemd/system/kubelet.service&#34;</span> | sed <span style=color:#b44>&#34;s:/usr/bin:</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>DOWNLOAD_DIR</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>:g&#34;</span> | sudo tee /etc/systemd/system/kubelet.service
sudo mkdir -p /etc/systemd/system/kubelet.service.d
curl -sSL <span style=color:#b44>&#34;https://raw.githubusercontent.com/kubernetes/release/</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>RELEASE_VERSION</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>/cmd/kubepkg/templates/latest/deb/kubeadm/10-kubeadm.conf&#34;</span> | sed <span style=color:#b44>&#34;s:/usr/bin:</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>DOWNLOAD_DIR</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>:g&#34;</span> | sudo tee /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
</code></pre></div><p>Enable and start <code>kubelet</code>:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>systemctl <span style=color:#a2f>enable</span> --now kubelet
</code></pre></div><div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> The Flatcar Container Linux distribution mounts the <code>/usr</code> directory as a read-only filesystem.
Before bootstrapping your cluster, you need to take additional steps to configure a writable directory.
See the <a href=/docs/setup/production-environment/tools/kubeadm/troubleshooting-kubeadm/#usr-mounted-read-only/>Kubeadm Troubleshooting guide</a> to learn how to set up a writable directory.
</div>
</div></div>
<p>The kubelet is now restarting every few seconds, as it waits in a crashloop for
kubeadm to tell it what to do.</p>
<h2 id=configuring-a-cgroup-driver>Configuring a cgroup driver</h2>
<p>Both the container runtime and the kubelet have a property called
<a href=/docs/setup/production-environment/container-runtimes/>"cgroup driver"</a>, which is important
for the management of cgroups on Linux machines.</p>
<div class="alert alert-danger warning callout" role=alert>
<strong>Warning:</strong> <p>Matching the container runtime and kubelet cgroup drivers is required or otherwise the kubelet process will fail.</p>
<p>See <a href=/docs/tasks/administer-cluster/kubeadm/configure-cgroup-driver/>Configuring a cgroup driver</a> for more details.</p>
</div>
<h2 id=troubleshooting>Troubleshooting</h2>
<p>If you are running into difficulties with kubeadm, please consult our <a href=/docs/setup/production-environment/tools/kubeadm/troubleshooting-kubeadm/>troubleshooting docs</a>.</p>
<h2 id=what-s-next>What's next</h2>
<ul>
<li><a href=/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/>Using kubeadm to Create a Cluster</a></li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-c3689df4b0c61a998e79d91a865aa244>2.1.2 - Troubleshooting kubeadm</h1>
<p>As with any program, you might run into an error installing or running kubeadm.
This page lists some common failure scenarios and have provided steps that can help you understand and fix the problem.</p>
<p>If your problem is not listed below, please follow the following steps:</p>
<ul>
<li>
<p>If you think your problem is a bug with kubeadm:</p>
<ul>
<li>Go to <a href=https://github.com/kubernetes/kubeadm/issues>github.com/kubernetes/kubeadm</a> and search for existing issues.</li>
<li>If no issue exists, please <a href=https://github.com/kubernetes/kubeadm/issues/new>open one</a> and follow the issue template.</li>
</ul>
</li>
<li>
<p>If you are unsure about how kubeadm works, you can ask on <a href=https://slack.k8s.io/>Slack</a> in <code>#kubeadm</code>,
or open a question on <a href=https://stackoverflow.com/questions/tagged/kubernetes>StackOverflow</a>. Please include
relevant tags like <code>#kubernetes</code> and <code>#kubeadm</code> so folks can help you.</p>
</li>
</ul>
<h2 id=not-possible-to-join-a-v1-18-node-to-a-v1-17-cluster-due-to-missing-rbac>Not possible to join a v1.18 Node to a v1.17 cluster due to missing RBAC</h2>
<p>In v1.18 kubeadm added prevention for joining a Node in the cluster if a Node with the same name already exists.
This required adding RBAC for the bootstrap-token user to be able to GET a Node object.</p>
<p>However this causes an issue where <code>kubeadm join</code> from v1.18 cannot join a cluster created by kubeadm v1.17.</p>
<p>To workaround the issue you have two options:</p>
<p>Execute <code>kubeadm init phase bootstrap-token</code> on a control-plane node using kubeadm v1.18.
Note that this enables the rest of the bootstrap-token permissions as well.</p>
<p>or</p>
<p>Apply the following RBAC manually using <code>kubectl apply -f ...</code>:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>rbac.authorization.k8s.io/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterRole<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>kubeadm:get-nodes<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>rules</span>:<span style=color:#bbb>
</span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>apiGroups</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:#b44>&#34;&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- nodes<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>verbs</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- get<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>rbac.authorization.k8s.io/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterRoleBinding<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>kubeadm:get-nodes<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>roleRef</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>apiGroup</span>:<span style=color:#bbb> </span>rbac.authorization.k8s.io<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterRole<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>kubeadm:get-nodes<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>subjects</span>:<span style=color:#bbb>
</span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>apiGroup</span>:<span style=color:#bbb> </span>rbac.authorization.k8s.io<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Group<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>system:bootstrappers:kubeadm:default-node-token<span style=color:#bbb>
</span></code></pre></div><h2 id=ebtables-or-some-similar-executable-not-found-during-installation><code>ebtables</code> or some similar executable not found during installation</h2>
<p>If you see the following warnings while running <code>kubeadm init</code></p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#666>[</span>preflight<span style=color:#666>]</span> WARNING: ebtables not found in system path
<span style=color:#666>[</span>preflight<span style=color:#666>]</span> WARNING: ethtool not found in system path
</code></pre></div><p>Then you may be missing <code>ebtables</code>, <code>ethtool</code> or a similar executable on your node. You can install them with the following commands:</p>
<ul>
<li>For Ubuntu/Debian users, run <code>apt install ebtables ethtool</code>.</li>
<li>For CentOS/Fedora users, run <code>yum install ebtables ethtool</code>.</li>
</ul>
<h2 id=kubeadm-blocks-waiting-for-control-plane-during-installation>kubeadm blocks waiting for control plane during installation</h2>
<p>If you notice that <code>kubeadm init</code> hangs after printing out the following line:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#666>[</span>apiclient<span style=color:#666>]</span> Created API client, waiting <span style=color:#a2f;font-weight:700>for</span> the control plane to become ready
</code></pre></div><p>This may be caused by a number of problems. The most common are:</p>
<ul>
<li>network connection problems. Check that your machine has full network connectivity before continuing.</li>
<li>the cgroup driver of the container runtime differs from that of the kubelet. To understand how to
configure it properly see <a href=/docs/tasks/administer-cluster/kubeadm/configure-cgroup-driver/>Configuring a cgroup driver</a>.</li>
<li>control plane containers are crashlooping or hanging. You can check this by running <code>docker ps</code>
and investigating each container by running <code>docker logs</code>. For other container runtime see
<a href=/docs/tasks/debug/debug-cluster/crictl/>Debugging Kubernetes nodes with crictl</a>.</li>
</ul>
<h2 id=kubeadm-blocks-when-removing-managed-containers>kubeadm blocks when removing managed containers</h2>
<p>The following could happen if Docker halts and does not remove any Kubernetes-managed containers:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sudo kubeadm reset
</code></pre></div><pre><code class=language-console data-lang=console>[preflight] Running pre-flight checks
[reset] Stopping the kubelet service
[reset] Unmounting mounted directories in &quot;/var/lib/kubelet&quot;
[reset] Removing kubernetes-managed containers
(block)
</code></pre><p>A possible solution is to restart the Docker service and then re-run <code>kubeadm reset</code>:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sudo systemctl restart docker.service
sudo kubeadm reset
</code></pre></div><p>Inspecting the logs for docker may also be useful:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>journalctl -u docker
</code></pre></div><h2 id=pods-in-runcontainererror-crashloopbackoff-or-error-state>Pods in <code>RunContainerError</code>, <code>CrashLoopBackOff</code> or <code>Error</code> state</h2>
<p>Right after <code>kubeadm init</code> there should not be any pods in these states.</p>
<ul>
<li>If there are pods in one of these states <em>right after</em> <code>kubeadm init</code>, please open an
issue in the kubeadm repo. <code>coredns</code> (or <code>kube-dns</code>) should be in the <code>Pending</code> state
until you have deployed the network add-on.</li>
<li>If you see Pods in the <code>RunContainerError</code>, <code>CrashLoopBackOff</code> or <code>Error</code> state
after deploying the network add-on and nothing happens to <code>coredns</code> (or <code>kube-dns</code>),
it's very likely that the Pod Network add-on that you installed is somehow broken.
You might have to grant it more RBAC privileges or use a newer version. Please file
an issue in the Pod Network providers' issue tracker and get the issue triaged there.</li>
<li>If you install a version of Docker older than 1.12.1, remove the <code>MountFlags=slave</code> option
when booting <code>dockerd</code> with <code>systemd</code> and restart <code>docker</code>. You can see the MountFlags in <code>/usr/lib/systemd/system/docker.service</code>.
MountFlags can interfere with volumes mounted by Kubernetes, and put the Pods in <code>CrashLoopBackOff</code> state.
The error happens when Kubernetes does not find <code>var/run/secrets/kubernetes.io/serviceaccount</code> files.</li>
</ul>
<h2 id=coredns-is-stuck-in-the-pending-state><code>coredns</code> is stuck in the <code>Pending</code> state</h2>
<p>This is <strong>expected</strong> and part of the design. kubeadm is network provider-agnostic, so the admin
should <a href=/docs/concepts/cluster-administration/addons/>install the pod network add-on</a>
of choice. You have to install a Pod Network
before CoreDNS may be deployed fully. Hence the <code>Pending</code> state before the network is set up.</p>
<h2 id=hostport-services-do-not-work><code>HostPort</code> services do not work</h2>
<p>The <code>HostPort</code> and <code>HostIP</code> functionality is available depending on your Pod Network
provider. Please contact the author of the Pod Network add-on to find out whether
<code>HostPort</code> and <code>HostIP</code> functionality are available.</p>
<p>Calico, Canal, and Flannel CNI providers are verified to support HostPort.</p>
<p>For more information, see the <a href=https://github.com/containernetworking/plugins/blob/master/plugins/meta/portmap/README.md>CNI portmap documentation</a>.</p>
<p>If your network provider does not support the portmap CNI plugin, you may need to use the <a href=/docs/concepts/services-networking/service/#type-nodeport>NodePort feature of
services</a> or use <code>HostNetwork=true</code>.</p>
<h2 id=pods-are-not-accessible-via-their-service-ip>Pods are not accessible via their Service IP</h2>
<ul>
<li>
<p>Many network add-ons do not yet enable <a href=/docs/tasks/debug/debug-application/debug-service/#a-pod-fails-to-reach-itself-via-the-service-ip>hairpin mode</a>
which allows pods to access themselves via their Service IP. This is an issue related to
<a href=https://github.com/containernetworking/cni/issues/476>CNI</a>. Please contact the network
add-on provider to get the latest status of their support for hairpin mode.</p>
</li>
<li>
<p>If you are using VirtualBox (directly or via Vagrant), you will need to
ensure that <code>hostname -i</code> returns a routable IP address. By default the first
interface is connected to a non-routable host-only network. A work around
is to modify <code>/etc/hosts</code>, see this <a href=https://github.com/errordeveloper/k8s-playground/blob/22dd39dfc06111235620e6c4404a96ae146f26fd/Vagrantfile#L11>Vagrantfile</a>
for an example.</p>
</li>
</ul>
<h2 id=tls-certificate-errors>TLS certificate errors</h2>
<p>The following error indicates a possible certificate mismatch.</p>
<pre><code class=language-none data-lang=none># kubectl get pods
Unable to connect to the server: x509: certificate signed by unknown authority (possibly because of &quot;crypto/rsa: verification error&quot; while trying to verify candidate authority certificate &quot;kubernetes&quot;)
</code></pre><ul>
<li>
<p>Verify that the <code>$HOME/.kube/config</code> file contains a valid certificate, and
regenerate a certificate if necessary. The certificates in a kubeconfig file
are base64 encoded. The <code>base64 --decode</code> command can be used to decode the certificate
and <code>openssl x509 -text -noout</code> can be used for viewing the certificate information.</p>
</li>
<li>
<p>Unset the <code>KUBECONFIG</code> environment variable using:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#a2f>unset</span> KUBECONFIG
</code></pre></div><p>Or set it to the default <code>KUBECONFIG</code> location:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#a2f>export</span> <span style=color:#b8860b>KUBECONFIG</span><span style=color:#666>=</span>/etc/kubernetes/admin.conf
</code></pre></div></li>
<li>
<p>Another workaround is to overwrite the existing <code>kubeconfig</code> for the "admin" user:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>mv  <span style=color:#b8860b>$HOME</span>/.kube <span style=color:#b8860b>$HOME</span>/.kube.bak
mkdir <span style=color:#b8860b>$HOME</span>/.kube
sudo cp -i /etc/kubernetes/admin.conf <span style=color:#b8860b>$HOME</span>/.kube/config
sudo chown <span style=color:#a2f;font-weight:700>$(</span>id -u<span style=color:#a2f;font-weight:700>)</span>:<span style=color:#a2f;font-weight:700>$(</span>id -g<span style=color:#a2f;font-weight:700>)</span> <span style=color:#b8860b>$HOME</span>/.kube/config
</code></pre></div></li>
</ul>
<h2 id=kubelet-client-cert>Kubelet client certificate rotation fails</h2>
<p>By default, kubeadm configures a kubelet with automatic rotation of client certificates by using the <code>/var/lib/kubelet/pki/kubelet-client-current.pem</code> symlink specified in <code>/etc/kubernetes/kubelet.conf</code>.
If this rotation process fails you might see errors such as <code>x509: certificate has expired or is not yet valid</code>
in kube-apiserver logs. To fix the issue you must follow these steps:</p>
<ol>
<li>
<p>Backup and delete <code>/etc/kubernetes/kubelet.conf</code> and <code>/var/lib/kubelet/pki/kubelet-client*</code> from the failed node.</p>
</li>
<li>
<p>From a working control plane node in the cluster that has <code>/etc/kubernetes/pki/ca.key</code> execute
<code>kubeadm kubeconfig user --org system:nodes --client-name system:node:$NODE > kubelet.conf</code>.
<code>$NODE</code> must be set to the name of the existing failed node in the cluster.
Modify the resulted <code>kubelet.conf</code> manually to adjust the cluster name and server endpoint,
or pass <code>kubeconfig user --config</code> (it accepts <code>InitConfiguration</code>). If your cluster does not have
the <code>ca.key</code> you must sign the embedded certificates in the <code>kubelet.conf</code> externally.</p>
</li>
<li>
<p>Copy this resulted <code>kubelet.conf</code> to <code>/etc/kubernetes/kubelet.conf</code> on the failed node.</p>
</li>
<li>
<p>Restart the kubelet (<code>systemctl restart kubelet</code>) on the failed node and wait for
<code>/var/lib/kubelet/pki/kubelet-client-current.pem</code> to be recreated.</p>
</li>
<li>
<p>Manually edit the <code>kubelet.conf</code> to point to the rotated kubelet client certificates, by replacing
<code>client-certificate-data</code> and <code>client-key-data</code> with:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>client-certificate</span>:<span style=color:#bbb> </span>/var/lib/kubelet/pki/kubelet-client-current.pem<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>client-key</span>:<span style=color:#bbb> </span>/var/lib/kubelet/pki/kubelet-client-current.pem<span style=color:#bbb>
</span></code></pre></div></li>
<li>
<p>Restart the kubelet.</p>
</li>
<li>
<p>Make sure the node becomes <code>Ready</code>.</p>
</li>
</ol>
<h2 id=default-nic-when-using-flannel-as-the-pod-network-in-vagrant>Default NIC When using flannel as the pod network in Vagrant</h2>
<p>The following error might indicate that something was wrong in the pod network:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>Error from server <span style=color:#666>(</span>NotFound<span style=color:#666>)</span>: the server could not find the requested resource
</code></pre></div><ul>
<li>
<p>If you're using flannel as the pod network inside Vagrant, then you will have to specify the default interface name for flannel.</p>
<p>Vagrant typically assigns two interfaces to all VMs. The first, for which all hosts are assigned the IP address <code>10.0.2.15</code>, is for external traffic that gets NATed.</p>
<p>This may lead to problems with flannel, which defaults to the first interface on a host. This leads to all hosts thinking they have the same public IP address. To prevent this, pass the <code>--iface eth1</code> flag to flannel so that the second interface is chosen.</p>
</li>
</ul>
<h2 id=non-public-ip-used-for-containers>Non-public IP used for containers</h2>
<p>In some situations <code>kubectl logs</code> and <code>kubectl run</code> commands may return with the following errors in an otherwise functional cluster:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>Error from server: Get https://10.19.0.41:10250/containerLogs/default/mysql-ddc65b868-glc5m/mysql: dial tcp 10.19.0.41:10250: getsockopt: no route to host
</code></pre></div><ul>
<li>
<p>This may be due to Kubernetes using an IP that can not communicate with other IPs on the seemingly same subnet, possibly by policy of the machine provider.</p>
</li>
<li>
<p>DigitalOcean assigns a public IP to <code>eth0</code> as well as a private one to be used internally as anchor for their floating IP feature, yet <code>kubelet</code> will pick the latter as the node's <code>InternalIP</code> instead of the public one.</p>
<p>Use <code>ip addr show</code> to check for this scenario instead of <code>ifconfig</code> because <code>ifconfig</code> will not display the offending alias IP address. Alternatively an API endpoint specific to DigitalOcean allows to query for the anchor IP from the droplet:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>curl http://169.254.169.254/metadata/v1/interfaces/public/0/anchor_ipv4/address
</code></pre></div><p>The workaround is to tell <code>kubelet</code> which IP to use using <code>--node-ip</code>.
When using DigitalOcean, it can be the public one (assigned to <code>eth0</code>) or
the private one (assigned to <code>eth1</code>) should you want to use the optional
private network. The <code>kubeletExtraArgs</code> section of the kubeadm
<a href=/docs/reference/config-api/kubeadm-config.v1beta3/#kubeadm-k8s-io-v1beta3-NodeRegistrationOptions><code>NodeRegistrationOptions</code> structure</a>
can be used for this.</p>
<p>Then restart <code>kubelet</code>:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>systemctl daemon-reload
systemctl restart kubelet
</code></pre></div></li>
</ul>
<h2 id=coredns-pods-have-crashloopbackoff-or-error-state><code>coredns</code> pods have <code>CrashLoopBackOff</code> or <code>Error</code> state</h2>
<p>If you have nodes that are running SELinux with an older version of Docker you might experience a scenario
where the <code>coredns</code> pods are not starting. To solve that you can try one of the following options:</p>
<ul>
<li>
<p>Upgrade to a <a href=/docs/setup/production-environment/container-runtimes/#docker>newer version of Docker</a>.</p>
</li>
<li>
<p><a href=https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/security-enhanced_linux/sect-security-enhanced_linux-enabling_and_disabling_selinux-disabling_selinux>Disable SELinux</a>.</p>
</li>
<li>
<p>Modify the <code>coredns</code> deployment to set <code>allowPrivilegeEscalation</code> to <code>true</code>:</p>
</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl -n kube-system get deployment coredns -o yaml | <span style=color:#b62;font-weight:700>\
</span><span style=color:#b62;font-weight:700></span>  sed <span style=color:#b44>&#39;s/allowPrivilegeEscalation: false/allowPrivilegeEscalation: true/g&#39;</span> | <span style=color:#b62;font-weight:700>\
</span><span style=color:#b62;font-weight:700></span>  kubectl apply -f -
</code></pre></div><p>Another cause for CoreDNS to have <code>CrashLoopBackOff</code> is when a CoreDNS Pod deployed in Kubernetes detects a loop. <a href=https://github.com/coredns/coredns/tree/master/plugin/loop#troubleshooting-loops-in-kubernetes-clusters>A number of workarounds</a>
are available to avoid Kubernetes trying to restart the CoreDNS Pod every time CoreDNS detects the loop and exits.</p>
<div class="alert alert-danger warning callout" role=alert>
<strong>Warning:</strong> Disabling SELinux or setting <code>allowPrivilegeEscalation</code> to <code>true</code> can compromise
the security of your cluster.
</div>
<h2 id=etcd-pods-restart-continually>etcd pods restart continually</h2>
<p>If you encounter the following error:</p>
<pre><code>rpc error: code = 2 desc = oci runtime error: exec failed: container_linux.go:247: starting container process caused &quot;process_linux.go:110: decoding init error from pipe caused \&quot;read parent: connection reset by peer\&quot;&quot;
</code></pre><p>this issue appears if you run CentOS 7 with Docker 1.13.1.84.
This version of Docker can prevent the kubelet from executing into the etcd container.</p>
<p>To work around the issue, choose one of these options:</p>
<ul>
<li>Roll back to an earlier version of Docker, such as 1.13.1-75</li>
</ul>
<pre><code>yum downgrade docker-1.13.1-75.git8633870.el7.centos.x86_64 docker-client-1.13.1-75.git8633870.el7.centos.x86_64 docker-common-1.13.1-75.git8633870.el7.centos.x86_64
</code></pre><ul>
<li>Install one of the more recent recommended versions, such as 18.06:</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
yum install docker-ce-18.06.1.ce-3.el7.x86_64
</code></pre></div><h2 id=not-possible-to-pass-a-comma-separated-list-of-values-to-arguments-inside-a-component-extra-args-flag>Not possible to pass a comma separated list of values to arguments inside a <code>--component-extra-args</code> flag</h2>
<p><code>kubeadm init</code> flags such as <code>--component-extra-args</code> allow you to pass custom arguments to a control-plane
component like the kube-apiserver. However, this mechanism is limited due to the underlying type used for parsing
the values (<code>mapStringString</code>).</p>
<p>If you decide to pass an argument that supports multiple, comma-separated values such as
<code>--apiserver-extra-args "enable-admission-plugins=LimitRanger,NamespaceExists"</code> this flag will fail with
<code>flag: malformed pair, expect string=string</code>. This happens because the list of arguments for
<code>--apiserver-extra-args</code> expects <code>key=value</code> pairs and in this case <code>NamespacesExists</code> is considered
as a key that is missing a value.</p>
<p>Alternatively, you can try separating the <code>key=value</code> pairs like so:
<code>--apiserver-extra-args "enable-admission-plugins=LimitRanger,enable-admission-plugins=NamespaceExists"</code>
but this will result in the key <code>enable-admission-plugins</code> only having the value of <code>NamespaceExists</code>.</p>
<p>A known workaround is to use the kubeadm <a href=/docs/reference/config-api/kubeadm-config.v1beta3/>configuration file</a>.</p>
<h2 id=kube-proxy-scheduled-before-node-is-initialized-by-cloud-controller-manager>kube-proxy scheduled before node is initialized by cloud-controller-manager</h2>
<p>In cloud provider scenarios, kube-proxy can end up being scheduled on new worker nodes before
the cloud-controller-manager has initialized the node addresses. This causes kube-proxy to fail
to pick up the node's IP address properly and has knock-on effects to the proxy function managing
load balancers.</p>
<p>The following error can be seen in kube-proxy Pods:</p>
<pre><code>server.go:610] Failed to retrieve node IP: host IP unknown; known addresses: []
proxier.go:340] invalid nodeIP, initializing kube-proxy with 127.0.0.1 as nodeIP
</code></pre><p>A known solution is to patch the kube-proxy DaemonSet to allow scheduling it on control-plane
nodes regardless of their conditions, keeping it off of other nodes until their initial guarding
conditions abate:</p>
<pre><code>kubectl -n kube-system patch ds kube-proxy -p='{ &quot;spec&quot;: { &quot;template&quot;: { &quot;spec&quot;: { &quot;tolerations&quot;: [ { &quot;key&quot;: &quot;CriticalAddonsOnly&quot;, &quot;operator&quot;: &quot;Exists&quot; }, { &quot;effect&quot;: &quot;NoSchedule&quot;, &quot;key&quot;: &quot;node-role.kubernetes.io/master&quot; } ] } } } }'
</code></pre><p>The tracking issue for this problem is <a href=https://github.com/kubernetes/kubeadm/issues/1027>here</a>.</p>
<h2 id=usr-mounted-read-only><code>/usr</code> is mounted read-only on nodes</h2>
<p>On Linux distributions such as Fedora CoreOS or Flatcar Container Linux, the directory <code>/usr</code> is mounted as a read-only filesystem.
For <a href=https://github.com/kubernetes/community/blob/ab55d85/contributors/devel/sig-storage/flexvolume.md>flex-volume support</a>,
Kubernetes components like the kubelet and kube-controller-manager use the default path of
<code>/usr/libexec/kubernetes/kubelet-plugins/volume/exec/</code>, yet the flex-volume directory <em>must be writeable</em>
for the feature to work.
(<strong>Note</strong>: FlexVolume was deprecated in the Kubernetes v1.23 release)</p>
<p>To workaround this issue you can configure the flex-volume directory using the kubeadm
<a href=/docs/reference/config-api/kubeadm-config.v1beta3/>configuration file</a>.</p>
<p>On the primary control-plane Node (created using <code>kubeadm init</code>) pass the following
file using <code>--config</code>:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kubeadm.k8s.io/v1beta3<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>InitConfiguration<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>nodeRegistration</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>kubeletExtraArgs</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>volume-plugin-dir</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;/opt/libexec/kubernetes/kubelet-plugins/volume/exec/&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kubeadm.k8s.io/v1beta3<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterConfiguration<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>controllerManager</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>extraArgs</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>flex-volume-plugin-dir</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;/opt/libexec/kubernetes/kubelet-plugins/volume/exec/&#34;</span><span style=color:#bbb>
</span></code></pre></div><p>On joining Nodes:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kubeadm.k8s.io/v1beta3<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>JoinConfiguration<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>nodeRegistration</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>kubeletExtraArgs</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>volume-plugin-dir</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;/opt/libexec/kubernetes/kubelet-plugins/volume/exec/&#34;</span><span style=color:#bbb>
</span></code></pre></div><p>Alternatively, you can modify <code>/etc/fstab</code> to make the <code>/usr</code> mount writeable, but please
be advised that this is modifying a design principle of the Linux distribution.</p>
<h2 id=kubeadm-upgrade-plan-prints-out-context-deadline-exceeded-error-message><code>kubeadm upgrade plan</code> prints out <code>context deadline exceeded</code> error message</h2>
<p>This error message is shown when upgrading a Kubernetes cluster with <code>kubeadm</code> in the case of running an external etcd. This is not a critical bug and happens because older versions of kubeadm perform a version check on the external etcd cluster. You can proceed with <code>kubeadm upgrade apply ...</code>.</p>
<p>This issue is fixed as of version 1.19.</p>
<h2 id=kubeadm-reset-unmounts-var-lib-kubelet><code>kubeadm reset</code> unmounts <code>/var/lib/kubelet</code></h2>
<p>If <code>/var/lib/kubelet</code> is being mounted, performing a <code>kubeadm reset</code> will effectively unmount it.</p>
<p>To workaround the issue, re-mount the <code>/var/lib/kubelet</code> directory after performing the <code>kubeadm reset</code> operation.</p>
<p>This is a regression introduced in kubeadm 1.15. The issue is fixed in 1.20.</p>
<h2 id=cannot-use-the-metrics-server-securely-in-a-kubeadm-cluster>Cannot use the metrics-server securely in a kubeadm cluster</h2>
<p>In a kubeadm cluster, the <a href=https://github.com/kubernetes-sigs/metrics-server>metrics-server</a>
can be used insecurely by passing the <code>--kubelet-insecure-tls</code> to it. This is not recommended for production clusters.</p>
<p>If you want to use TLS between the metrics-server and the kubelet there is a problem,
since kubeadm deploys a self-signed serving certificate for the kubelet. This can cause the following errors
on the side of the metrics-server:</p>
<pre><code>x509: certificate signed by unknown authority
x509: certificate is valid for IP-foo not IP-bar
</code></pre><p>See <a href=/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/#kubelet-serving-certs>Enabling signed kubelet serving certificates</a>
to understand how to configure the kubelets in a kubeadm cluster to have properly signed serving certificates.</p>
<p>Also see <a href=https://github.com/kubernetes-sigs/metrics-server/blob/master/FAQ.md#how-to-run-metrics-server-securely>How to run the metrics-server securely</a>.</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-134ed1f6142a98e6ac681a1ba4920e53>2.1.3 - Creating a cluster with kubeadm</h1>
<p><img src=/images/kubeadm-stacked-color.png align=right width=150px></img>
Using <code>kubeadm</code>, you can create a minimum viable Kubernetes cluster that conforms to best practices.
In fact, you can use <code>kubeadm</code> to set up a cluster that will pass the
<a href=https://kubernetes.io/blog/2017/10/software-conformance-certification>Kubernetes Conformance tests</a>.
<code>kubeadm</code> also supports other cluster lifecycle functions, such as
<a href=/docs/reference/access-authn-authz/bootstrap-tokens/>bootstrap tokens</a> and cluster upgrades.</p>
<p>The <code>kubeadm</code> tool is good if you need:</p>
<ul>
<li>A simple way for you to try out Kubernetes, possibly for the first time.</li>
<li>A way for existing users to automate setting up a cluster and test their application.</li>
<li>A building block in other ecosystem and/or installer tools with a larger
scope.</li>
</ul>
<p>You can install and use <code>kubeadm</code> on various machines: your laptop, a set
of cloud servers, a Raspberry Pi, and more. Whether you're deploying into the
cloud or on-premises, you can integrate <code>kubeadm</code> into provisioning systems such
as Ansible or Terraform.</p>
<h2 id=before-you-begin>Before you begin</h2>
<p>To follow this guide, you need:</p>
<ul>
<li>One or more machines running a deb/rpm-compatible Linux OS; for example: Ubuntu or CentOS.</li>
<li>2 GiB or more of RAM per machine--any less leaves little room for your
apps.</li>
<li>At least 2 CPUs on the machine that you use as a control-plane node.</li>
<li>Full network connectivity among all machines in the cluster. You can use either a
public or a private network.</li>
</ul>
<p>You also need to use a version of <code>kubeadm</code> that can deploy the version
of Kubernetes that you want to use in your new cluster.</p>
<p><a href=/docs/setup/release/version-skew-policy/#supported-versions>Kubernetes' version and version skew support policy</a>
applies to <code>kubeadm</code> as well as to Kubernetes overall.
Check that policy to learn about what versions of Kubernetes and <code>kubeadm</code>
are supported. This page is written for Kubernetes v1.23.</p>
<p>The <code>kubeadm</code> tool's overall feature state is General Availability (GA). Some sub-features are
still under active development. The implementation of creating the cluster may change
slightly as the tool evolves, but the overall implementation should be pretty stable.</p>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> Any commands under <code>kubeadm alpha</code> are, by definition, supported on an alpha level.
</div>
<h2 id=objectives>Objectives</h2>
<ul>
<li>Install a single control-plane Kubernetes cluster</li>
<li>Install a Pod network on the cluster so that your Pods can
talk to each other</li>
</ul>
<h2 id=instructions>Instructions</h2>
<h3 id=preparing-the-hosts>Preparing the hosts</h3>
<p>Install a <a class=glossary-tooltip title="The container runtime is the software that is responsible for running containers." data-toggle=tooltip data-placement=top href=/docs/setup/production-environment/container-runtimes target=_blank aria-label="container runtime">container runtime</a> and kubeadm on all the hosts.
For detailed instructions and other prerequisites, see <a href=/docs/setup/production-environment/tools/kubeadm/install-kubeadm/>Installing kubeadm</a>.</p>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> <p>If you have already installed kubeadm, run <code>apt-get update && apt-get upgrade</code> or <code>yum update</code> to get the latest version of kubeadm.</p>
<p>When you upgrade, the kubelet restarts every few seconds as it waits in a crashloop for
kubeadm to tell it what to do. This crashloop is expected and normal.
After you initialize your control-plane, the kubelet runs normally.</p>
</div>
<h3 id=preparing-the-required-container-images>Preparing the required container images</h3>
<p>This step is optional and only applies in case you wish <code>kubeadm init</code> and <code>kubeadm join</code>
to not download the default container images which are hosted at <code>k8s.gcr.io</code>.</p>
<p>Kubeadm has commands that can help you pre-pull the required images
when creating a cluster without an internet connection on its nodes.
See <a href=/docs/reference/setup-tools/kubeadm/kubeadm-init#without-internet-connection>Running kubeadm without an internet connection</a> for more details.</p>
<p>Kubeadm allows you to use a custom image repository for the required images.
See <a href=/docs/reference/setup-tools/kubeadm/kubeadm-init#custom-images>Using custom images</a>
for more details.</p>
<h3 id=initializing-your-control-plane-node>Initializing your control-plane node</h3>
<p>The control-plane node is the machine where the control plane components run, including
<a class=glossary-tooltip title="Consistent and highly-available key value store used as Kubernetes' backing store for all cluster data." data-toggle=tooltip data-placement=top href=/docs/tasks/administer-cluster/configure-upgrade-etcd/ target=_blank aria-label=etcd>etcd</a> (the cluster database) and the
<a class=glossary-tooltip title="Control plane component that serves the Kubernetes API." data-toggle=tooltip data-placement=top href=/docs/concepts/overview/components/#kube-apiserver target=_blank aria-label="API Server">API Server</a>
(which the <a class=glossary-tooltip title="A command line tool for communicating with a Kubernetes cluster." data-toggle=tooltip data-placement=top href=/docs/user-guide/kubectl-overview/ target=_blank aria-label=kubectl>kubectl</a> command line tool
communicates with).</p>
<ol>
<li>(Recommended) If you have plans to upgrade this single control-plane <code>kubeadm</code> cluster
to high availability you should specify the <code>--control-plane-endpoint</code> to set the shared endpoint
for all control-plane nodes. Such an endpoint can be either a DNS name or an IP address of a load-balancer.</li>
<li>Choose a Pod network add-on, and verify whether it requires any arguments to
be passed to <code>kubeadm init</code>. Depending on which
third-party provider you choose, you might need to set the <code>--pod-network-cidr</code> to
a provider-specific value. See <a href=#pod-network>Installing a Pod network add-on</a>.</li>
<li>(Optional) Since version 1.14, <code>kubeadm</code> tries to detect the container runtime on Linux
by using a list of well known domain socket paths. To use different container runtime or
if there are more than one installed on the provisioned node, specify the <code>--cri-socket</code>
argument to <code>kubeadm init</code>. See
<a href=/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#installing-runtime>Installing a runtime</a>.</li>
<li>(Optional) Unless otherwise specified, <code>kubeadm</code> uses the network interface associated
with the default gateway to set the advertise address for this particular control-plane node's API server.
To use a different network interface, specify the <code>--apiserver-advertise-address=&lt;ip-address></code> argument
to <code>kubeadm init</code>. To deploy an IPv6 Kubernetes cluster using IPv6 addressing, you
must specify an IPv6 address, for example <code>--apiserver-advertise-address=fd00::101</code></li>
</ol>
<p>To initialize the control-plane node run:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubeadm init &lt;args&gt;
</code></pre></div><h3 id=considerations-about-apiserver-advertise-address-and-controlplaneendpoint>Considerations about apiserver-advertise-address and ControlPlaneEndpoint</h3>
<p>While <code>--apiserver-advertise-address</code> can be used to set the advertise address for this particular
control-plane node's API server, <code>--control-plane-endpoint</code> can be used to set the shared endpoint
for all control-plane nodes.</p>
<p><code>--control-plane-endpoint</code> allows both IP addresses and DNS names that can map to IP addresses.
Please contact your network administrator to evaluate possible solutions with respect to such mapping.</p>
<p>Here is an example mapping:</p>
<pre><code>192.168.0.102 cluster-endpoint
</code></pre><p>Where <code>192.168.0.102</code> is the IP address of this node and <code>cluster-endpoint</code> is a custom DNS name that maps to this IP.
This will allow you to pass <code>--control-plane-endpoint=cluster-endpoint</code> to <code>kubeadm init</code> and pass the same DNS name to
<code>kubeadm join</code>. Later you can modify <code>cluster-endpoint</code> to point to the address of your load-balancer in an
high availability scenario.</p>
<p>Turning a single control plane cluster created without <code>--control-plane-endpoint</code> into a highly available cluster
is not supported by kubeadm.</p>
<h3 id=more-information>More information</h3>
<p>For more information about <code>kubeadm init</code> arguments, see the <a href=/docs/reference/setup-tools/kubeadm/>kubeadm reference guide</a>.</p>
<p>To configure <code>kubeadm init</code> with a configuration file see
<a href=/docs/reference/setup-tools/kubeadm/kubeadm-init/#config-file>Using kubeadm init with a configuration file</a>.</p>
<p>To customize control plane components, including optional IPv6 assignment to liveness probe
for control plane components and etcd server, provide extra arguments to each component as documented in
<a href=/docs/setup/production-environment/tools/kubeadm/control-plane-flags/>custom arguments</a>.</p>
<p>To reconfigure a cluster that has already been created see
<a href=/docs/tasks/administer-cluster/kubeadm/kubeadm-reconfigure>Reconfiguring a kubeadm cluster</a>.</p>
<p>To run <code>kubeadm init</code> again, you must first <a href=#tear-down>tear down the cluster</a>.</p>
<p>If you join a node with a different architecture to your cluster, make sure that your deployed DaemonSets
have container image support for this architecture.</p>
<p><code>kubeadm init</code> first runs a series of prechecks to ensure that the machine
is ready to run Kubernetes. These prechecks expose warnings and exit on errors. <code>kubeadm init</code>
then downloads and installs the cluster control plane components. This may take several minutes.
After it finishes you should see:</p>
<pre><code class=language-none data-lang=none>Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

You should now deploy a Pod network to the cluster.
Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:
  /docs/concepts/cluster-administration/addons/

You can now join any number of machines by running the following on each node
as root:

  kubeadm join &lt;control-plane-host&gt;:&lt;control-plane-port&gt; --token &lt;token&gt; --discovery-token-ca-cert-hash sha256:&lt;hash&gt;
</code></pre><p>To make kubectl work for your non-root user, run these commands, which are
also part of the <code>kubeadm init</code> output:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mkdir -p <span style=color:#b8860b>$HOME</span>/.kube
sudo cp -i /etc/kubernetes/admin.conf <span style=color:#b8860b>$HOME</span>/.kube/config
sudo chown <span style=color:#a2f;font-weight:700>$(</span>id -u<span style=color:#a2f;font-weight:700>)</span>:<span style=color:#a2f;font-weight:700>$(</span>id -g<span style=color:#a2f;font-weight:700>)</span> <span style=color:#b8860b>$HOME</span>/.kube/config
</code></pre></div><p>Alternatively, if you are the <code>root</code> user, you can run:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#a2f>export</span> <span style=color:#b8860b>KUBECONFIG</span><span style=color:#666>=</span>/etc/kubernetes/admin.conf
</code></pre></div><div class="alert alert-danger warning callout" role=alert>
<strong>Warning:</strong> Kubeadm signs the certificate in the <code>admin.conf</code> to have <code>Subject: O = system:masters, CN = kubernetes-admin</code>.
<code>system:masters</code> is a break-glass, super user group that bypasses the authorization layer (e.g. RBAC).
Do not share the <code>admin.conf</code> file with anyone and instead grant users custom permissions by generating
them a kubeconfig file using the <code>kubeadm kubeconfig user</code> command. For more details see
<a href=/docs/tasks/administer-cluster/kubeadm/kubeadm-certs#kubeconfig-additional-users>Generating kubeconfig files for additional users</a>.
</div>
<p>Make a record of the <code>kubeadm join</code> command that <code>kubeadm init</code> outputs. You
need this command to <a href=#join-nodes>join nodes to your cluster</a>.</p>
<p>The token is used for mutual authentication between the control-plane node and the joining
nodes. The token included here is secret. Keep it safe, because anyone with this
token can add authenticated nodes to your cluster. These tokens can be listed,
created, and deleted with the <code>kubeadm token</code> command. See the
<a href=/docs/reference/setup-tools/kubeadm/kubeadm-token/>kubeadm reference guide</a>.</p>
<h3 id=pod-network>Installing a Pod network add-on</h3>
<div class="alert alert-warning caution callout" role=alert>
<strong>Caution:</strong> <p>This section contains important information about networking setup and
deployment order.
Read all of this advice carefully before proceeding.</p>
<p><strong>You must deploy a
<a class=glossary-tooltip title="Container network interface (CNI) plugins are a type of Network plugin that adheres to the appc/CNI specification." data-toggle=tooltip data-placement=top href=/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/#cni target=_blank aria-label="Container Network Interface">Container Network Interface</a>
(CNI) based Pod network add-on so that your Pods can communicate with each other.
Cluster DNS (CoreDNS) will not start up before a network is installed.</strong></p>
<ul>
<li>
<p>Take care that your Pod network must not overlap with any of the host
networks: you are likely to see problems if there is any overlap.
(If you find a collision between your network plugin's preferred Pod
network and some of your host networks, you should think of a suitable
CIDR block to use instead, then use that during <code>kubeadm init</code> with
<code>--pod-network-cidr</code> and as a replacement in your network plugin's YAML).</p>
</li>
<li>
<p>By default, <code>kubeadm</code> sets up your cluster to use and enforce use of
<a href=/docs/reference/access-authn-authz/rbac/>RBAC</a> (role based access
control).
Make sure that your Pod network plugin supports RBAC, and so do any manifests
that you use to deploy it.</p>
</li>
<li>
<p>If you want to use IPv6--either dual-stack, or single-stack IPv6 only
networking--for your cluster, make sure that your Pod network plugin
supports IPv6.
IPv6 support was added to CNI in <a href=https://github.com/containernetworking/cni/releases/tag/v0.6.0>v0.6.0</a>.</p>
</li>
</ul>
</div>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> Kubeadm should be CNI agnostic and the validation of CNI providers is out of the scope of our current e2e testing.
If you find an issue related to a CNI plugin you should log a ticket in its respective issue
tracker instead of the kubeadm or kubernetes issue trackers.
</div>
<p>Several external projects provide Kubernetes Pod networks using CNI, some of which also
support <a href=/docs/concepts/services-networking/network-policies/>Network Policy</a>.</p>
<p>See a list of add-ons that implement the
<a href=/docs/concepts/cluster-administration/networking/#how-to-implement-the-kubernetes-networking-model>Kubernetes networking model</a>.</p>
<p>You can install a Pod network add-on with the following command on the
control-plane node or a node that has the kubeconfig credentials:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -f &lt;add-on.yaml&gt;
</code></pre></div><p>You can install only one Pod network per cluster.</p>
<p>Once a Pod network has been installed, you can confirm that it is working by
checking that the CoreDNS Pod is <code>Running</code> in the output of <code>kubectl get pods --all-namespaces</code>.
And once the CoreDNS Pod is up and running, you can continue by joining your nodes.</p>
<p>If your network is not working or CoreDNS is not in the <code>Running</code> state, check out the
<a href=/docs/setup/production-environment/tools/kubeadm/troubleshooting-kubeadm/>troubleshooting guide</a>
for <code>kubeadm</code>.</p>
<h3 id=managed-node-labels>Managed node labels</h3>
<p>By default, kubeadm enables the <a href=/docs/reference/access-authn-authz/admission-controllers/#noderestriction>NodeRestriction</a>
admission controller that restricts what labels can be self-applied by kubelets on node registration.
The admission controller documentation covers what labels are permitted to be used with the kubelet <code>--node-labels</code> option.
The <code>node-role.kubernetes.io/control-plane</code> label is such a restricted label and kubeadm manually applies it using
a privileged client after a node has been created. To do that manually you can do the same by using <code>kubectl label</code>
and ensure it is using a privileged kubeconfig such as the kubeadm managed <code>/etc/kubernetes/admin.conf</code>.</p>
<h3 id=control-plane-node-isolation>Control plane node isolation</h3>
<p>By default, your cluster will not schedule Pods on the control-plane node for security
reasons. If you want to be able to schedule Pods on the control-plane node, for example for a
single-machine Kubernetes cluster for development, run:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl taint nodes --all node-role.kubernetes.io/master-
</code></pre></div><p>With output looking something like:</p>
<pre><code>node &quot;test-01&quot; untainted
taint &quot;node-role.kubernetes.io/master:&quot; not found
taint &quot;node-role.kubernetes.io/master:&quot; not found
</code></pre><p>This will remove the <code>node-role.kubernetes.io/master</code> taint from any nodes that
have it, including the control-plane node, meaning that the scheduler will then be able
to schedule Pods everywhere.</p>
<h3 id=join-nodes>Joining your nodes</h3>
<p>The nodes are where your workloads (containers and Pods, etc) run. To add new nodes to your cluster do the following for each machine:</p>
<ul>
<li>
<p>SSH to the machine</p>
</li>
<li>
<p>Become root (e.g. <code>sudo su -</code>)</p>
</li>
<li>
<p><a href=/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#installing-runtime>Install a runtime</a>
if needed</p>
</li>
<li>
<p>Run the command that was output by <code>kubeadm init</code>. For example:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubeadm join --token &lt;token&gt; &lt;control-plane-host&gt;:&lt;control-plane-port&gt; --discovery-token-ca-cert-hash sha256:&lt;hash&gt;
</code></pre></div></li>
</ul>
<p>If you do not have the token, you can get it by running the following command on the control-plane node:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubeadm token list
</code></pre></div><p>The output is similar to this:</p>
<pre><code class=language-console data-lang=console>TOKEN                    TTL  EXPIRES              USAGES           DESCRIPTION            EXTRA GROUPS
8ewj1p.9r9hcjoqgajrj4gi  23h  2018-06-12T02:51:28Z authentication,  The default bootstrap  system:
                                                   signing          token generated by     bootstrappers:
                                                                    'kubeadm init'.        kubeadm:
                                                                                           default-node-token
</code></pre><p>By default, tokens expire after 24 hours. If you are joining a node to the cluster after the current token has expired,
you can create a new token by running the following command on the control-plane node:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubeadm token create
</code></pre></div><p>The output is similar to this:</p>
<pre><code class=language-console data-lang=console>5didvk.d09sbcov8ph2amjw
</code></pre><p>If you don't have the value of <code>--discovery-token-ca-cert-hash</code>, you can get it by running the following command chain on the control-plane node:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | <span style=color:#b62;font-weight:700>\
</span><span style=color:#b62;font-weight:700></span>   openssl dgst -sha256 -hex | sed <span style=color:#b44>&#39;s/^.* //&#39;</span>
</code></pre></div><p>The output is similar to:</p>
<pre><code class=language-console data-lang=console>8cb2de97839780a412b93877f8507ad6c94f73add17d5d7058e91741c9d5ec78
</code></pre><div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> To specify an IPv6 tuple for <code>&lt;control-plane-host>:&lt;control-plane-port></code>, IPv6 address must be enclosed in square brackets, for example: <code>[fd00::101]:2073</code>.
</div>
<p>The output should look something like:</p>
<pre><code>[preflight] Running pre-flight checks

... (log output of join workflow) ...

Node join complete:
* Certificate signing request sent to control-plane and response
  received.
* Kubelet informed of new secure connection details.

Run 'kubectl get nodes' on control-plane to see this machine join.
</code></pre><p>A few seconds later, you should notice this node in the output from <code>kubectl get nodes</code> when run on the control-plane node.</p>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> As the cluster nodes are usually initialized sequentially, the CoreDNS Pods are likely to all run
on the first control-plane node. To provide higher availability, please rebalance the CoreDNS Pods
with <code>kubectl -n kube-system rollout restart deployment coredns</code> after at least one new node is joined.
</div>
<h3 id=optional-controlling-your-cluster-from-machines-other-than-the-control-plane-node>(Optional) Controlling your cluster from machines other than the control-plane node</h3>
<p>In order to get a kubectl on some other computer (e.g. laptop) to talk to your
cluster, you need to copy the administrator kubeconfig file from your control-plane node
to your workstation like this:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>scp root@&lt;control-plane-host&gt;:/etc/kubernetes/admin.conf .
kubectl --kubeconfig ./admin.conf get nodes
</code></pre></div><div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> <p>The example above assumes SSH access is enabled for root. If that is not the
case, you can copy the <code>admin.conf</code> file to be accessible by some other user
and <code>scp</code> using that other user instead.</p>
<p>The <code>admin.conf</code> file gives the user <em>superuser</em> privileges over the cluster.
This file should be used sparingly. For normal users, it's recommended to
generate an unique credential to which you grant privileges. You can do
this with the <code>kubeadm alpha kubeconfig user --client-name &lt;CN></code>
command. That command will print out a KubeConfig file to STDOUT which you
should save to a file and distribute to your user. After that, grant
privileges by using <code>kubectl create (cluster)rolebinding</code>.</p>
</div>
<h3 id=optional-proxying-api-server-to-localhost>(Optional) Proxying API Server to localhost</h3>
<p>If you want to connect to the API Server from outside the cluster you can use
<code>kubectl proxy</code>:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>scp root@&lt;control-plane-host&gt;:/etc/kubernetes/admin.conf .
kubectl --kubeconfig ./admin.conf proxy
</code></pre></div><p>You can now access the API Server locally at <code>http://localhost:8001/api/v1</code></p>
<h2 id=tear-down>Clean up</h2>
<p>If you used disposable servers for your cluster, for testing, you can
switch those off and do no further clean up. You can use
<code>kubectl config delete-cluster</code> to delete your local references to the
cluster.</p>
<p>However, if you want to deprovision your cluster more cleanly, you should
first <a href=/docs/reference/generated/kubectl/kubectl-commands#drain>drain the node</a>
and make sure that the node is empty, then deconfigure the node.</p>
<h3 id=remove-the-node>Remove the node</h3>
<p>Talking to the control-plane node with the appropriate credentials, run:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl drain &lt;node name&gt; --delete-emptydir-data --force --ignore-daemonsets
</code></pre></div><p>Before removing the node, reset the state installed by <code>kubeadm</code>:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubeadm reset
</code></pre></div><p>The reset process does not reset or clean up iptables rules or IPVS tables. If you wish to reset iptables, you must do so manually:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>iptables -F <span style=color:#666>&amp;&amp;</span> iptables -t nat -F <span style=color:#666>&amp;&amp;</span> iptables -t mangle -F <span style=color:#666>&amp;&amp;</span> iptables -X
</code></pre></div><p>If you want to reset the IPVS tables, you must run the following command:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>ipvsadm -C
</code></pre></div><p>Now remove the node:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl delete node &lt;node name&gt;
</code></pre></div><p>If you wish to start over, run <code>kubeadm init</code> or <code>kubeadm join</code> with the
appropriate arguments.</p>
<h3 id=clean-up-the-control-plane>Clean up the control plane</h3>
<p>You can use <code>kubeadm reset</code> on the control plane host to trigger a best-effort
clean up.</p>
<p>See the <a href=/docs/reference/setup-tools/kubeadm/kubeadm-reset/><code>kubeadm reset</code></a>
reference documentation for more information about this subcommand and its
options.</p>
<h2 id=whats-next>What's next</h2>
<ul>
<li>Verify that your cluster is running properly with <a href=https://github.com/heptio/sonobuoy>Sonobuoy</a></li>
<li><a id=lifecycle>See <a href=/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/>Upgrading kubeadm clusters</a>
for details about upgrading your cluster using <code>kubeadm</code>.</li>
<li>Learn about advanced <code>kubeadm</code> usage in the <a href=/docs/reference/setup-tools/kubeadm/kubeadm>kubeadm reference documentation</a></li>
<li>Learn more about Kubernetes <a href=/docs/concepts/>concepts</a> and <a href=/docs/reference/kubectl/><code>kubectl</code></a>.</li>
<li>See the <a href=/docs/concepts/cluster-administration/networking/>Cluster Networking</a> page for a bigger list
of Pod network add-ons.</li>
<li><a id=other-addons>See the <a href=/docs/concepts/cluster-administration/addons/>list of add-ons</a> to
explore other add-ons, including tools for logging, monitoring, network policy, visualization &
control of your Kubernetes cluster.</li>
<li>Configure how your cluster handles logs for cluster events and from
applications running in Pods.
See <a href=/docs/concepts/cluster-administration/logging/>Logging Architecture</a> for
an overview of what is involved.</li>
</ul>
<h3 id=feedback>Feedback</h3>
<ul>
<li>For bugs, visit the <a href=https://github.com/kubernetes/kubeadm/issues>kubeadm GitHub issue tracker</a></li>
<li>For support, visit the
<a href=https://kubernetes.slack.com/messages/kubeadm/>#kubeadm</a> Slack channel</li>
<li>General SIG Cluster Lifecycle development Slack channel:
<a href=https://kubernetes.slack.com/messages/sig-cluster-lifecycle/>#sig-cluster-lifecycle</a></li>
<li>SIG Cluster Lifecycle <a href=https://github.com/kubernetes/community/tree/master/sig-cluster-lifecycle#readme>SIG information</a></li>
<li>SIG Cluster Lifecycle mailing list:
<a href=https://groups.google.com/forum/#!forum/kubernetes-sig-cluster-lifecycle>kubernetes-sig-cluster-lifecycle</a></li>
</ul>
<h2 id=version-skew-policy>Version skew policy</h2>
<p>While kubeadm allows version skew against some components that it manages, it is recommended that you
match the kubeadm version with the versions of the control plane components, kube-proxy and kubelet.</p>
<h3 id=kubeadm-s-skew-against-the-kubernetes-version>kubeadm's skew against the Kubernetes version</h3>
<p>kubeadm can be used with Kubernetes components that are the same version as kubeadm
or one version older. The Kubernetes version can be specified to kubeadm by using the
<code>--kubernetes-version</code> flag of <code>kubeadm init</code> or the
<a href=/docs/reference/config-api/kubeadm-config.v1beta3/><code>ClusterConfiguration.kubernetesVersion</code></a>
field when using <code>--config</code>. This option will control the versions
of kube-apiserver, kube-controller-manager, kube-scheduler and kube-proxy.</p>
<p>Example:</p>
<ul>
<li>kubeadm is at 1.23</li>
<li><code>kubernetesVersion</code> must be at 1.23 or 1.22</li>
</ul>
<h3 id=kubeadm-s-skew-against-the-kubelet>kubeadm's skew against the kubelet</h3>
<p>Similarly to the Kubernetes version, kubeadm can be used with a kubelet version that is the same
version as kubeadm or one version older.</p>
<p>Example:</p>
<ul>
<li>kubeadm is at 1.23</li>
<li>kubelet on the host must be at 1.23 or 1.22</li>
</ul>
<h3 id=kubeadm-s-skew-against-kubeadm>kubeadm's skew against kubeadm</h3>
<p>There are certain limitations on how kubeadm commands can operate on existing nodes or whole clusters
managed by kubeadm.</p>
<p>If new nodes are joined to the cluster, the kubeadm binary used for <code>kubeadm join</code> must match
the last version of kubeadm used to either create the cluster with <code>kubeadm init</code> or to upgrade
the same node with <code>kubeadm upgrade</code>. Similar rules apply to the rest of the kubeadm commands
with the exception of <code>kubeadm upgrade</code>.</p>
<p>Example for <code>kubeadm join</code>:</p>
<ul>
<li>kubeadm version 1.23 was used to create a cluster with <code>kubeadm init</code></li>
<li>Joining nodes must use a kubeadm binary that is at version 1.23</li>
</ul>
<p>Nodes that are being upgraded must use a version of kubeadm that is the same MINOR
version or one MINOR version newer than the version of kubeadm used for managing the
node.</p>
<p>Example for <code>kubeadm upgrade</code>:</p>
<ul>
<li>kubeadm version 1.22 was used to create or upgrade the node</li>
<li>The version of kubeadm used for upgrading the node must be at 1.22
or 1.23</li>
</ul>
<p>To learn more about the version skew between the different Kubernetes component see
the <a href=https://kubernetes.io/releases/version-skew-policy/>Version Skew Policy</a>.</p>
<h2 id=limitations>Limitations</h2>
<h3 id=resilience>Cluster resilience</h3>
<p>The cluster created here has a single control-plane node, with a single etcd database
running on it. This means that if the control-plane node fails, your cluster may lose
data and may need to be recreated from scratch.</p>
<p>Workarounds:</p>
<ul>
<li>
<p>Regularly <a href=https://coreos.com/etcd/docs/latest/admin_guide.html>back up etcd</a>. The
etcd data directory configured by kubeadm is at <code>/var/lib/etcd</code> on the control-plane node.</p>
</li>
<li>
<p>Use multiple control-plane nodes. You can read
<a href=/docs/setup/production-environment/tools/kubeadm/ha-topology/>Options for Highly Available topology</a> to pick a cluster
topology that provides <a href=/docs/setup/production-environment/tools/kubeadm/high-availability/>high-availability</a>.</p>
</li>
</ul>
<h3 id=multi-platform>Platform compatibility</h3>
<p>kubeadm deb/rpm packages and binaries are built for amd64, arm (32-bit), arm64, ppc64le, and s390x
following the <a href=https://github.com/kubernetes/community/blob/master/contributors/design-proposals/multi-platform.md>multi-platform
proposal</a>.</p>
<p>Multiplatform container images for the control plane and addons are also supported since v1.12.</p>
<p>Only some of the network providers offer solutions for all platforms. Please consult the list of
network providers above or the documentation from each provider to figure out whether the provider
supports your chosen platform.</p>
<h2 id=troubleshooting>Troubleshooting</h2>
<p>If you are running into difficulties with kubeadm, please consult our <a href=/docs/setup/production-environment/tools/kubeadm/troubleshooting-kubeadm/>troubleshooting docs</a>.</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-4c656c5eda3e1c06ad1aedebdc04a211>2.1.4 - Customizing components with the kubeadm API</h1>
<p>This page covers how to customize the components that kubeadm deploys. For control plane components
you can use flags in the <code>ClusterConfiguration</code> structure or patches per-node. For the kubelet
and kube-proxy you can use <code>KubeletConfiguration</code> and <code>KubeProxyConfiguration</code>, accordingly.</p>
<p>All of these options are possible via the kubeadm configuration API.
For more details on each field in the configuration you can navigate to our
<a href=/docs/reference/config-api/kubeadm-config.v1beta3/>API reference pages</a>.</p>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> Customizing the CoreDNS deployment of kubeadm is currently not supported. You must manually
patch the <code>kube-system/coredns</code> <a class=glossary-tooltip title="An API object used to store non-confidential data in key-value pairs. Can be consumed as environment variables, command-line arguments, or configuration files in a volume." data-toggle=tooltip data-placement=top href=/docs/concepts/configuration/configmap/ target=_blank aria-label=ConfigMap>ConfigMap</a>
and recreate the CoreDNS <a class=glossary-tooltip title="A Pod represents a set of running containers in your cluster." data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/pods/ target=_blank aria-label=Pods>Pods</a> after that. Alternatively,
you can skip the default CoreDNS deployment and deploy your own variant.
For more details on that see <a href=/docs/reference/setup-tools/kubeadm/kubeadm-init/#init-phases>Using init phases with kubeadm</a>.
</div>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> To reconfigure a cluster that has already been created see
<a href=/docs/tasks/administer-cluster/kubeadm/kubeadm-reconfigure>Reconfiguring a kubeadm cluster</a>.
</div>
<h2 id=customizing-the-control-plane-with-flags-in-clusterconfiguration>Customizing the control plane with flags in <code>ClusterConfiguration</code></h2>
<p>The kubeadm <code>ClusterConfiguration</code> object exposes a way for users to override the default
flags passed to control plane components such as the APIServer, ControllerManager, Scheduler and Etcd.
The components are defined using the following structures:</p>
<ul>
<li><code>apiServer</code></li>
<li><code>controllerManager</code></li>
<li><code>scheduler</code></li>
<li><code>etcd</code></li>
</ul>
<p>These structures contain a common <code>extraArgs</code> field, that consists of <code>key: value</code> pairs.
To override a flag for a control plane component:</p>
<ol>
<li>Add the appropriate <code>extraArgs</code> to your configuration.</li>
<li>Add flags to the <code>extraArgs</code> field.</li>
<li>Run <code>kubeadm init</code> with <code>--config &lt;YOUR CONFIG YAML></code>.</li>
</ol>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> You can generate a <code>ClusterConfiguration</code> object with default values by running <code>kubeadm config print init-defaults</code>
and saving the output to a file of your choice.
</div>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> The <code>ClusterConfiguration</code> object is currently global in kubeadm clusters. This means that any flags that you add,
will apply to all instances of the same component on different nodes. To apply individual configuration per component
on different nodes you can use <a href=#patches>patches</a>.
</div>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> Duplicate flags (keys), or passing the same flag <code>--foo</code> multiple times, is currently not supported.
To workaround that you must use <a href=#patches>patches</a>.
</div>
<h3 id=apiserver-flags>APIServer flags</h3>
<p>For details, see the <a href=/docs/reference/command-line-tools-reference/kube-apiserver/>reference documentation for kube-apiserver</a>.</p>
<p>Example usage:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kubeadm.k8s.io/v1beta3<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterConfiguration<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kubernetesVersion</span>:<span style=color:#bbb> </span>v1.16.0<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiServer</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>extraArgs</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>anonymous-auth</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;false&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>enable-admission-plugins</span>:<span style=color:#bbb> </span>AlwaysPullImages,DefaultStorageClass<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>audit-log-path</span>:<span style=color:#bbb> </span>/home/johndoe/audit.log<span style=color:#bbb>
</span></code></pre></div><h3 id=controllermanager-flags>ControllerManager flags</h3>
<p>For details, see the <a href=/docs/reference/command-line-tools-reference/kube-controller-manager/>reference documentation for kube-controller-manager</a>.</p>
<p>Example usage:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kubeadm.k8s.io/v1beta3<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterConfiguration<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kubernetesVersion</span>:<span style=color:#bbb> </span>v1.16.0<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>controllerManager</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>extraArgs</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cluster-signing-key-file</span>:<span style=color:#bbb> </span>/home/johndoe/keys/ca.key<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>deployment-controller-sync-period</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;50&#34;</span><span style=color:#bbb>
</span></code></pre></div><h3 id=scheduler-flags>Scheduler flags</h3>
<p>For details, see the <a href=/docs/reference/command-line-tools-reference/kube-scheduler/>reference documentation for kube-scheduler</a>.</p>
<p>Example usage:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kubeadm.k8s.io/v1beta3<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterConfiguration<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kubernetesVersion</span>:<span style=color:#bbb> </span>v1.16.0<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>scheduler</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>extraArgs</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>config</span>:<span style=color:#bbb> </span>/etc/kubernetes/scheduler-config.yaml<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>extraVolumes</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>schedulerconfig<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>hostPath</span>:<span style=color:#bbb> </span>/home/johndoe/schedconfig.yaml<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/etc/kubernetes/scheduler-config.yaml<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>readOnly</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>pathType</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;File&#34;</span><span style=color:#bbb>
</span></code></pre></div><h3 id=etcd-flags>Etcd flags</h3>
<p>For details, see the <a href=https://etcd.io/docs/>etcd server documentation</a>.</p>
<p>Example usage:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kubeadm.k8s.io/v1beta3<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterConfiguration<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>etcd</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>local</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>extraArgs</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>election-timeout</span>:<span style=color:#bbb> </span><span style=color:#666>1000</span><span style=color:#bbb>
</span></code></pre></div><h2 id=patches>Customizing the control plane with patches</h2>
<div style=margin-top:10px;margin-bottom:10px>
<b>FEATURE STATE:</b> <code>Kubernetes v1.22 [beta]</code>
</div>
<p>Kubeadm allows you to pass a directory with patch files to <code>InitConfiguration</code> and <code>JoinConfiguration</code>
on individual nodes. These patches can be used as the last customization step before the control
plane component manifests are written to disk.</p>
<p>You can pass this file to <code>kubeadm init</code> with <code>--config &lt;YOUR CONFIG YAML></code>:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kubeadm.k8s.io/v1beta3<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>InitConfiguration<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>patches</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>directory</span>:<span style=color:#bbb> </span>/home/user/somedir<span style=color:#bbb>
</span></code></pre></div><div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> For <code>kubeadm init</code> you can pass a file containing both a <code>ClusterConfiguration</code> and <code>InitConfiguration</code>
separated by <code>---</code>.
</div>
<p>You can pass this file to <code>kubeadm join</code> with <code>--config &lt;YOUR CONFIG YAML></code>:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kubeadm.k8s.io/v1beta3<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>JoinConfiguration<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>patches</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>directory</span>:<span style=color:#bbb> </span>/home/user/somedir<span style=color:#bbb>
</span></code></pre></div><p>The directory must contain files named <code>target[suffix][+patchtype].extension</code>.
For example, <code>kube-apiserver0+merge.yaml</code> or just <code>etcd.json</code>.</p>
<ul>
<li><code>target</code> can be one of <code>kube-apiserver</code>, <code>kube-controller-manager</code>, <code>kube-scheduler</code> and <code>etcd</code>.</li>
<li><code>patchtype</code> can be one of <code>strategic</code>, <code>merge</code> or <code>json</code> and these must match the patching formats
<a href=/docs/tasks/manage-kubernetes-objects/update-api-object-kubectl-patch>supported by kubectl</a>.
The default <code>patchtype</code> is <code>strategic</code>.</li>
<li><code>extension</code> must be either <code>json</code> or <code>yaml</code>.</li>
<li><code>suffix</code> is an optional string that can be used to determine which patches are applied first
alpha-numerically.</li>
</ul>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> If you are using <code>kubeadm upgrade</code> to upgrade your kubeadm nodes you must again provide the same
patches, so that the customization is preserved after upgrade. To do that you can use the <code>--patches</code>
flag, which must point to the same directory. <code>kubeadm upgrade</code> currently does not support a configuration
API structure that can be used for the same purpose.
</div>
<h2 id=customizing-the-kubelet>Customizing the kubelet</h2>
<p>To customize the kubelet you can add a <code>KubeletConfiguration</code> next to the <code>ClusterConfiguration</code> or
<code>InitConfiguration</code> separated by <code>---</code> within the same configuration file. This file can then be passed to <code>kubeadm init</code>.</p>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> kubeadm applies the same <code>KubeletConfiguration</code> to all nodes in the cluster. To apply node
specific settings you can use kubelet flags as overrides by passing them in the <code>nodeRegistration.kubeletExtraArgs</code>
field supported by both <code>InitConfiguration</code> and <code>JoinConfiguration</code>. Some kubelet flags are deprecated,
so check their status in the <a href=/docs/reference/command-line-tools-reference/kubelet>kubelet reference documentation</a>
before using them.
</div>
<p>For more details see <a href=/docs/setup/production-environment/tools/kubeadm/kubelet-integration>Configuring each kubelet in your cluster using kubeadm</a></p>
<h2 id=customizing-kube-proxy>Customizing kube-proxy</h2>
<p>To customize kube-proxy you can pass a <code>KubeProxyConfiguration</code> next your <code>ClusterConfiguration</code> or
<code>InitConfiguration</code> to <code>kubeadm init</code> separated by <code>---</code>.</p>
<p>For more details you can navigate to our <a href=/docs/reference/config-api/kubeadm-config.v1beta3/>API reference pages</a>.</p>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> kubeadm deploys kube-proxy as a <a class=glossary-tooltip title="Ensures a copy of a Pod is running across a set of nodes in a cluster." data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/controllers/daemonset target=_blank aria-label=DaemonSet>DaemonSet</a>, which means
that the <code>KubeProxyConfiguration</code> would apply to all instances of kube-proxy in the cluster.
</div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-015edbc7cc688d31b1d1edce7c186135>2.1.5 - Options for Highly Available Topology</h1>
<p>This page explains the two options for configuring the topology of your highly available (HA) Kubernetes clusters.</p>
<p>You can set up an HA cluster:</p>
<ul>
<li>With stacked control plane nodes, where etcd nodes are colocated with control plane nodes</li>
<li>With external etcd nodes, where etcd runs on separate nodes from the control plane</li>
</ul>
<p>You should carefully consider the advantages and disadvantages of each topology before setting up an HA cluster.</p>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> kubeadm bootstraps the etcd cluster statically. Read the etcd <a href=https://github.com/etcd-io/etcd/blob/release-3.4/Documentation/op-guide/clustering.md#static>Clustering Guide</a>
for more details.
</div>
<h2 id=stacked-etcd-topology>Stacked etcd topology</h2>
<p>A stacked HA cluster is a <a href=https://en.wikipedia.org/wiki/Network_topology>topology</a> where the distributed
data storage cluster provided by etcd is stacked on top of the cluster formed by the nodes managed by
kubeadm that run control plane components.</p>
<p>Each control plane node runs an instance of the <code>kube-apiserver</code>, <code>kube-scheduler</code>, and <code>kube-controller-manager</code>.
The <code>kube-apiserver</code> is exposed to worker nodes using a load balancer.</p>
<p>Each control plane node creates a local etcd member and this etcd member communicates only with
the <code>kube-apiserver</code> of this node. The same applies to the local <code>kube-controller-manager</code>
and <code>kube-scheduler</code> instances.</p>
<p>This topology couples the control planes and etcd members on the same nodes. It is simpler to set up than a cluster
with external etcd nodes, and simpler to manage for replication.</p>
<p>However, a stacked cluster runs the risk of failed coupling. If one node goes down, both an etcd member and a control
plane instance are lost, and redundancy is compromised. You can mitigate this risk by adding more control plane nodes.</p>
<p>You should therefore run a minimum of three stacked control plane nodes for an HA cluster.</p>
<p>This is the default topology in kubeadm. A local etcd member is created automatically
on control plane nodes when using <code>kubeadm init</code> and <code>kubeadm join --control-plane</code>.</p>
<p><img src=/images/kubeadm/kubeadm-ha-topology-stacked-etcd.svg alt="Stacked etcd topology"></p>
<h2 id=external-etcd-topology>External etcd topology</h2>
<p>An HA cluster with external etcd is a <a href=https://en.wikipedia.org/wiki/Network_topology>topology</a> where the distributed data storage cluster provided by etcd is external to the cluster formed by the nodes that run control plane components.</p>
<p>Like the stacked etcd topology, each control plane node in an external etcd topology runs an instance of the <code>kube-apiserver</code>, <code>kube-scheduler</code>, and <code>kube-controller-manager</code>. And the <code>kube-apiserver</code> is exposed to worker nodes using a load balancer. However, etcd members run on separate hosts, and each etcd host communicates with the <code>kube-apiserver</code> of each control plane node.</p>
<p>This topology decouples the control plane and etcd member. It therefore provides an HA setup where
losing a control plane instance or an etcd member has less impact and does not affect
the cluster redundancy as much as the stacked HA topology.</p>
<p>However, this topology requires twice the number of hosts as the stacked HA topology.
A minimum of three hosts for control plane nodes and three hosts for etcd nodes are required for an HA cluster with this topology.</p>
<p><img src=/images/kubeadm/kubeadm-ha-topology-external-etcd.svg alt="External etcd topology"></p>
<h2 id=what-s-next>What's next</h2>
<ul>
<li><a href=/docs/setup/production-environment/tools/kubeadm/high-availability/>Set up a highly available cluster with kubeadm</a></li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-3941d5c3409342219bf7e03128b8ecb6>2.1.6 - Creating Highly Available Clusters with kubeadm</h1>
<p>This page explains two different approaches to setting up a highly available Kubernetes
cluster using kubeadm:</p>
<ul>
<li>With stacked control plane nodes. This approach requires less infrastructure. The etcd members
and control plane nodes are co-located.</li>
<li>With an external etcd cluster. This approach requires more infrastructure. The
control plane nodes and etcd members are separated.</li>
</ul>
<p>Before proceeding, you should carefully consider which approach best meets the needs of your applications
and environment. <a href=/docs/setup/production-environment/tools/kubeadm/ha-topology/>Options for Highly Available topology</a> outlines the advantages and disadvantages of each.</p>
<p>If you encounter issues with setting up the HA cluster, please report these
in the kubeadm <a href=https://github.com/kubernetes/kubeadm/issues/new>issue tracker</a>.</p>
<p>See also the <a href=/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/>upgrade documentation</a>.</p>
<div class="alert alert-warning caution callout" role=alert>
<strong>Caution:</strong> This page does not address running your cluster on a cloud provider. In a cloud
environment, neither approach documented here works with Service objects of type
LoadBalancer, or with dynamic PersistentVolumes.
</div>
<h2 id=before-you-begin>Before you begin</h2>
<p>The prerequisites depend on which topology you have selected for your cluster's
control plane:</p>
<ul class="nav nav-tabs" id=prerequisite-tabs role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#prerequisite-tabs-0 role=tab aria-controls=prerequisite-tabs-0 aria-selected=true>Stacked etcd</a></li>
<li class=nav-item><a data-toggle=tab class=nav-link href=#prerequisite-tabs-1 role=tab aria-controls=prerequisite-tabs-1>External etcd</a></li></ul>
<div class=tab-content id=prerequisite-tabs><div id=prerequisite-tabs-0 class="tab-pane show active" role=tabpanel aria-labelledby=prerequisite-tabs-0>
<p>
<p>You need:</p>
<ul>
<li>Three or more machines that meet <a href=/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#before-you-begin>kubeadm's minimum requirements</a> for
the control-plane nodes. Having an odd number of control plane nodes can help
with leader selection in the case of machine or zone failure.
<ul>
<li>including a <a class=glossary-tooltip title="The container runtime is the software that is responsible for running containers." data-toggle=tooltip data-placement=top href=/docs/setup/production-environment/container-runtimes target=_blank aria-label="container runtime">container runtime</a>, already set up and working</li>
</ul>
</li>
<li>Three or more machines that meet <a href=/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#before-you-begin>kubeadm's minimum
requirements</a> for the workers
<ul>
<li>including a container runtime, already set up and working</li>
</ul>
</li>
<li>Full network connectivity between all machines in the cluster (public or
private network)</li>
<li>Superuser privileges on all machines using <code>sudo</code>
<ul>
<li>You can use a different tool; this guide uses <code>sudo</code> in the examples.</li>
</ul>
</li>
<li>SSH access from one device to all nodes in the system</li>
<li><code>kubeadm</code> and <code>kubelet</code> already installed on all machines.</li>
</ul>
<p><em>See <a href=/docs/setup/production-environment/tools/kubeadm/ha-topology/#stacked-etcd-topology>Stacked etcd topology</a> for context.</em></p>
</div>
<div id=prerequisite-tabs-1 class=tab-pane role=tabpanel aria-labelledby=prerequisite-tabs-1>
<p>
<p>You need:</p>
<ul>
<li>Three or more machines that meet <a href=/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#before-you-begin>kubeadm's minimum requirements</a> for
the control-plane nodes. Having an odd number of control plane nodes can help
with leader selection in the case of machine or zone failure.
<ul>
<li>including a <a class=glossary-tooltip title="The container runtime is the software that is responsible for running containers." data-toggle=tooltip data-placement=top href=/docs/setup/production-environment/container-runtimes target=_blank aria-label="container runtime">container runtime</a>, already set up and working</li>
</ul>
</li>
<li>Three or more machines that meet <a href=/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#before-you-begin>kubeadm's minimum
requirements</a> for the workers
<ul>
<li>including a container runtime, already set up and working</li>
</ul>
</li>
<li>Full network connectivity between all machines in the cluster (public or
private network)</li>
<li>Superuser privileges on all machines using <code>sudo</code>
<ul>
<li>You can use a different tool; this guide uses <code>sudo</code> in the examples.</li>
</ul>
</li>
<li>SSH access from one device to all nodes in the system</li>
<li><code>kubeadm</code> and <code>kubelet</code> already installed on all machines.</li>
</ul>
<p>And you also need:</p>
<ul>
<li>Three or more additional machines, that will become etcd cluster members.
Having an odd number of members in the etcd cluster is a requirement for achieving
optimal voting quorum.
<ul>
<li>These machines again need to have <code>kubeadm</code> and <code>kubelet</code> installed.</li>
<li>These machines also require a container runtime, that is already set up and working.</li>
</ul>
</li>
</ul>
<p><em>See <a href=/docs/setup/production-environment/tools/kubeadm/ha-topology/#external-etcd-topology>External etcd topology</a> for context.</em></p>
</div></div>
<h3 id=container-images>Container images</h3>
<p>Each host should have access read and fetch images from the Kubernetes container image registry, <code>k8s.gcr.io</code>.
If you want to deploy a highly-available cluster where the hosts do not have access to pull images, this is possible. You must ensure by some other means that the correct container images are already available on the relevant hosts.</p>
<h3 id=kubectl>Command line interface</h3>
<p>To manage Kubernetes once your cluster is set up, you should
<a href=/docs/tasks/tools/#kubectl>install kubectl</a> on your PC. It is also useful
to install the <code>kubectl</code> tool on each control plane node, as this can be
helpful for troubleshooting.</p>
<h2 id=first-steps-for-both-methods>First steps for both methods</h2>
<h3 id=create-load-balancer-for-kube-apiserver>Create load balancer for kube-apiserver</h3>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> There are many configurations for load balancers. The following example is only one
option. Your cluster requirements may need a different configuration.
</div>
<ol>
<li>
<p>Create a kube-apiserver load balancer with a name that resolves to DNS.</p>
<ul>
<li>
<p>In a cloud environment you should place your control plane nodes behind a TCP
forwarding load balancer. This load balancer distributes traffic to all
healthy control plane nodes in its target list. The health check for
an apiserver is a TCP check on the port the kube-apiserver listens on
(default value <code>:6443</code>).</p>
</li>
<li>
<p>It is not recommended to use an IP address directly in a cloud environment.</p>
</li>
<li>
<p>The load balancer must be able to communicate with all control plane nodes
on the apiserver port. It must also allow incoming traffic on its
listening port.</p>
</li>
<li>
<p>Make sure the address of the load balancer always matches
the address of kubeadm's <code>ControlPlaneEndpoint</code>.</p>
</li>
<li>
<p>Read the <a href=https://git.k8s.io/kubeadm/docs/ha-considerations.md#options-for-software-load-balancing>Options for Software Load Balancing</a>
guide for more details.</p>
</li>
</ul>
</li>
<li>
<p>Add the first control plane node to the load balancer, and test the
connection:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>nc -v &lt;LOAD_BALANCER_IP&gt; &lt;PORT&gt;
</code></pre></div><p>A connection refused error is expected because the API server is not yet
running. A timeout, however, means the load balancer cannot communicate
with the control plane node. If a timeout occurs, reconfigure the load
balancer to communicate with the control plane node.</p>
</li>
<li>
<p>Add the remaining control plane nodes to the load balancer target group.</p>
</li>
</ol>
<h2 id=stacked-control-plane-and-etcd-nodes>Stacked control plane and etcd nodes</h2>
<h3 id=steps-for-the-first-control-plane-node>Steps for the first control plane node</h3>
<ol>
<li>
<p>Initialize the control plane:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>sudo kubeadm init --control-plane-endpoint <span style=color:#b44>&#34;LOAD_BALANCER_DNS:LOAD_BALANCER_PORT&#34;</span> --upload-certs
</code></pre></div><ul>
<li>
<p>You can use the <code>--kubernetes-version</code> flag to set the Kubernetes version to use.
It is recommended that the versions of kubeadm, kubelet, kubectl and Kubernetes match.</p>
</li>
<li>
<p>The <code>--control-plane-endpoint</code> flag should be set to the address or DNS and port of the load balancer.</p>
</li>
<li>
<p>The <code>--upload-certs</code> flag is used to upload the certificates that should be shared
across all the control-plane instances to the cluster. If instead, you prefer to copy certs across
control-plane nodes manually or using automation tools, please remove this flag and refer to <a href=#manual-certs>Manual
certificate distribution</a> section below.</p>
</li>
</ul>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> The <code>kubeadm init</code> flags <code>--config</code> and <code>--certificate-key</code> cannot be mixed, therefore if you want
to use the <a href=/docs/reference/config-api/kubeadm-config.v1beta3/>kubeadm configuration</a>
you must add the <code>certificateKey</code> field in the appropriate config locations
(under <code>InitConfiguration</code> and <code>JoinConfiguration: controlPlane</code>).
</div>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> Some CNI network plugins require additional configuration, for example specifying the pod IP CIDR, while others do not.
See the <a href=/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#pod-network>CNI network documentation</a>.
To add a pod CIDR pass the flag <code>--pod-network-cidr</code>, or if you are using a kubeadm configuration file
set the <code>podSubnet</code> field under the <code>networking</code> object of <code>ClusterConfiguration</code>.
</div>
<p>The output looks similar to:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>...
You can now join any number of control-plane node by running the following <span style=color:#a2f>command</span> on each as a root:
    kubeadm join 192.168.0.200:6443 --token 9vr73a.a8uxyaju799qwdjv --discovery-token-ca-cert-hash sha256:7c2e69131a36ae2a042a339b33381c6d0d43887e2de83720eff5359e26aec866 --control-plane --certificate-key f8902e114ef118304e561c3ecd4d0b543adc226b7a07f675f56564185ffe0c07

Please note that the certificate-key gives access to cluster sensitive data, keep it secret!
As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use kubeadm init phase upload-certs to reload certs afterward.

Then you can join any number of worker nodes by running the following on each as root:
    kubeadm join 192.168.0.200:6443 --token 9vr73a.a8uxyaju799qwdjv --discovery-token-ca-cert-hash sha256:7c2e69131a36ae2a042a339b33381c6d0d43887e2de83720eff5359e26aec866
</code></pre></div><ul>
<li>
<p>Copy this output to a text file. You will need it later to join control plane and worker nodes to
the cluster.</p>
</li>
<li>
<p>When <code>--upload-certs</code> is used with <code>kubeadm init</code>, the certificates of the primary control plane
are encrypted and uploaded in the <code>kubeadm-certs</code> Secret.</p>
</li>
<li>
<p>To re-upload the certificates and generate a new decryption key, use the following command on a
control plane
node that is already joined to the cluster:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>sudo kubeadm init phase upload-certs --upload-certs
</code></pre></div></li>
<li>
<p>You can also specify a custom <code>--certificate-key</code> during <code>init</code> that can later be used by <code>join</code>.
To generate such a key you can use the following command:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>kubeadm certs certificate-key
</code></pre></div></li>
</ul>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> The <code>kubeadm-certs</code> Secret and decryption key expire after two hours.
</div>
<div class="alert alert-warning caution callout" role=alert>
<strong>Caution:</strong> As stated in the command output, the certificate key gives access to cluster sensitive data, keep it secret!
</div>
</li>
<li>
<p>Apply the CNI plugin of your choice:<br>
<a href=/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#pod-network>Follow these instructions</a>
to install the CNI provider. Make sure the configuration corresponds to the Pod CIDR specified in the
kubeadm configuration file (if applicable).</p>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> You must pick a network plugin that suits your use case and deploy it before you move on to next step.
If you don't do this, you will not be able to launch your cluster properly.
</div>
</li>
<li>
<p>Type the following and watch the pods of the control plane components get started:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>kubectl get pod -n kube-system -w
</code></pre></div></li>
</ol>
<h3 id=steps-for-the-rest-of-the-control-plane-nodes>Steps for the rest of the control plane nodes</h3>
<p>For each additional control plane node you should:</p>
<ol>
<li>
<p>Execute the join command that was previously given to you by the <code>kubeadm init</code> output on the first node.
It should look something like this:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>sudo kubeadm join 192.168.0.200:6443 --token 9vr73a.a8uxyaju799qwdjv --discovery-token-ca-cert-hash sha256:7c2e69131a36ae2a042a339b33381c6d0d43887e2de83720eff5359e26aec866 --control-plane --certificate-key f8902e114ef118304e561c3ecd4d0b543adc226b7a07f675f56564185ffe0c07
</code></pre></div><ul>
<li>The <code>--control-plane</code> flag tells <code>kubeadm join</code> to create a new control plane.</li>
<li>The <code>--certificate-key ...</code> will cause the control plane certificates to be downloaded
from the <code>kubeadm-certs</code> Secret in the cluster and be decrypted using the given key.</li>
</ul>
</li>
</ol>
<p>You can join multiple control-plane nodes in parallel.</p>
<h2 id=external-etcd-nodes>External etcd nodes</h2>
<p>Setting up a cluster with external etcd nodes is similar to the procedure used for stacked etcd
with the exception that you should setup etcd first, and you should pass the etcd information
in the kubeadm config file.</p>
<h3 id=set-up-the-etcd-cluster>Set up the etcd cluster</h3>
<ol>
<li>
<p>Follow these <a href=/docs/setup/production-environment/tools/kubeadm/setup-ha-etcd-with-kubeadm/>instructions</a> to set up the etcd cluster.</p>
</li>
<li>
<p>Setup SSH as described <a href=#manual-certs>here</a>.</p>
</li>
<li>
<p>Copy the following files from any etcd node in the cluster to the first control plane node:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#a2f>export</span> <span style=color:#b8860b>CONTROL_PLANE</span><span style=color:#666>=</span><span style=color:#b44>&#34;ubuntu@10.0.0.7&#34;</span>
scp /etc/kubernetes/pki/etcd/ca.crt <span style=color:#b44>&#34;</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>CONTROL_PLANE</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>&#34;</span>:
scp /etc/kubernetes/pki/apiserver-etcd-client.crt <span style=color:#b44>&#34;</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>CONTROL_PLANE</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>&#34;</span>:
scp /etc/kubernetes/pki/apiserver-etcd-client.key <span style=color:#b44>&#34;</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>CONTROL_PLANE</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>&#34;</span>:
</code></pre></div><ul>
<li>Replace the value of <code>CONTROL_PLANE</code> with the <code>user@host</code> of the first control-plane node.</li>
</ul>
</li>
</ol>
<h3 id=set-up-the-first-control-plane-node>Set up the first control plane node</h3>
<ol>
<li>
<p>Create a file called <code>kubeadm-config.yaml</code> with the following contents:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kubeadm.k8s.io/v1beta3<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterConfiguration<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kubernetesVersion</span>:<span style=color:#bbb> </span>stable<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>controlPlaneEndpoint</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;LOAD_BALANCER_DNS:LOAD_BALANCER_PORT&#34;</span><span style=color:#bbb> </span><span style=color:#080;font-style:italic># change this (see below)</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>etcd</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>external</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>endpoints</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span>- https://ETCD_0_IP:2379<span style=color:#bbb> </span><span style=color:#080;font-style:italic># change ETCD_0_IP appropriately</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span>- https://ETCD_1_IP:2379<span style=color:#bbb> </span><span style=color:#080;font-style:italic># change ETCD_1_IP appropriately</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span>- https://ETCD_2_IP:2379<span style=color:#bbb> </span><span style=color:#080;font-style:italic># change ETCD_2_IP appropriately</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>caFile</span>:<span style=color:#bbb> </span>/etc/kubernetes/pki/etcd/ca.crt<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>certFile</span>:<span style=color:#bbb> </span>/etc/kubernetes/pki/apiserver-etcd-client.crt<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>keyFile</span>:<span style=color:#bbb> </span>/etc/kubernetes/pki/apiserver-etcd-client.key<span style=color:#bbb>
</span></code></pre></div><div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> The difference between stacked etcd and external etcd here is that the external etcd setup requires
a configuration file with the etcd endpoints under the <code>external</code> object for <code>etcd</code>.
In the case of the stacked etcd topology, this is managed automatically.
</div>
<ul>
<li>
<p>Replace the following variables in the config template with the appropriate values for your cluster:</p>
<ul>
<li><code>LOAD_BALANCER_DNS</code></li>
<li><code>LOAD_BALANCER_PORT</code></li>
<li><code>ETCD_0_IP</code></li>
<li><code>ETCD_1_IP</code></li>
<li><code>ETCD_2_IP</code></li>
</ul>
</li>
</ul>
</li>
</ol>
<p>The following steps are similar to the stacked etcd setup:</p>
<ol>
<li>
<p>Run <code>sudo kubeadm init --config kubeadm-config.yaml --upload-certs</code> on this node.</p>
</li>
<li>
<p>Write the output join commands that are returned to a text file for later use.</p>
</li>
<li>
<p>Apply the CNI plugin of your choice.</p>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> You must pick a network plugin that suits your use case and deploy it before you move on to next step.
If you don't do this, you will not be able to launch your cluster properly.
</div>
</li>
</ol>
<h3 id=steps-for-the-rest-of-the-control-plane-nodes-1>Steps for the rest of the control plane nodes</h3>
<p>The steps are the same as for the stacked etcd setup:</p>
<ul>
<li>Make sure the first control plane node is fully initialized.</li>
<li>Join each control plane node with the join command you saved to a text file. It's recommended
to join the control plane nodes one at a time.</li>
<li>Don't forget that the decryption key from <code>--certificate-key</code> expires after two hours, by default.</li>
</ul>
<h2 id=common-tasks-after-bootstrapping-control-plane>Common tasks after bootstrapping control plane</h2>
<h3 id=install-workers>Install workers</h3>
<p>Worker nodes can be joined to the cluster with the command you stored previously
as the output from the <code>kubeadm init</code> command:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>sudo kubeadm join 192.168.0.200:6443 --token 9vr73a.a8uxyaju799qwdjv --discovery-token-ca-cert-hash sha256:7c2e69131a36ae2a042a339b33381c6d0d43887e2de83720eff5359e26aec866
</code></pre></div><h2 id=manual-certs>Manual certificate distribution</h2>
<p>If you choose to not use <code>kubeadm init</code> with the <code>--upload-certs</code> flag this means that
you are going to have to manually copy the certificates from the primary control plane node to the
joining control plane nodes.</p>
<p>There are many ways to do this. The following example uses <code>ssh</code> and <code>scp</code>:</p>
<p>SSH is required if you want to control all nodes from a single machine.</p>
<ol>
<li>
<p>Enable ssh-agent on your main device that has access to all other nodes in
the system:</p>
<pre><code>eval $(ssh-agent)
</code></pre></li>
<li>
<p>Add your SSH identity to the session:</p>
<pre><code>ssh-add ~/.ssh/path_to_private_key
</code></pre></li>
<li>
<p>SSH between nodes to check that the connection is working correctly.</p>
<ul>
<li>
<p>When you SSH to any node, add the <code>-A</code> flag. This flag allows the node that you
have logged into via SSH to access the SSH agent on your PC. Consider alternative
methods if you do not fully trust the security of your user session on the node.</p>
<pre><code>ssh -A 10.0.0.7
</code></pre></li>
<li>
<p>When using sudo on any node, make sure to preserve the environment so SSH
forwarding works:</p>
<pre><code>sudo -E -s
</code></pre></li>
</ul>
</li>
<li>
<p>After configuring SSH on all the nodes you should run the following script on the first
control plane node after running <code>kubeadm init</code>. This script will copy the certificates from
the first control plane node to the other control plane nodes:</p>
<p>In the following example, replace <code>CONTROL_PLANE_IPS</code> with the IP addresses of the
other control plane nodes.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#b8860b>USER</span><span style=color:#666>=</span>ubuntu <span style=color:#080;font-style:italic># customizable</span>
<span style=color:#b8860b>CONTROL_PLANE_IPS</span><span style=color:#666>=</span><span style=color:#b44>&#34;10.0.0.7 10.0.0.8&#34;</span>
<span style=color:#a2f;font-weight:700>for</span> host in <span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>CONTROL_PLANE_IPS</span><span style=color:#b68;font-weight:700>}</span>; <span style=color:#a2f;font-weight:700>do</span>
    scp /etc/kubernetes/pki/ca.crt <span style=color:#b44>&#34;</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>USER</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>&#34;</span>@<span style=color:#b8860b>$host</span>:
    scp /etc/kubernetes/pki/ca.key <span style=color:#b44>&#34;</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>USER</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>&#34;</span>@<span style=color:#b8860b>$host</span>:
    scp /etc/kubernetes/pki/sa.key <span style=color:#b44>&#34;</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>USER</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>&#34;</span>@<span style=color:#b8860b>$host</span>:
    scp /etc/kubernetes/pki/sa.pub <span style=color:#b44>&#34;</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>USER</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>&#34;</span>@<span style=color:#b8860b>$host</span>:
    scp /etc/kubernetes/pki/front-proxy-ca.crt <span style=color:#b44>&#34;</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>USER</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>&#34;</span>@<span style=color:#b8860b>$host</span>:
    scp /etc/kubernetes/pki/front-proxy-ca.key <span style=color:#b44>&#34;</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>USER</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>&#34;</span>@<span style=color:#b8860b>$host</span>:
    scp /etc/kubernetes/pki/etcd/ca.crt <span style=color:#b44>&#34;</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>USER</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>&#34;</span>@<span style=color:#b8860b>$host</span>:etcd-ca.crt
    <span style=color:#080;font-style:italic># Skip the next line if you are using external etcd</span>
    scp /etc/kubernetes/pki/etcd/ca.key <span style=color:#b44>&#34;</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>USER</span><span style=color:#b68;font-weight:700>}</span><span style=color:#b44>&#34;</span>@<span style=color:#b8860b>$host</span>:etcd-ca.key
<span style=color:#a2f;font-weight:700>done</span>
</code></pre></div><div class="alert alert-warning caution callout" role=alert>
<strong>Caution:</strong> Copy only the certificates in the above list. kubeadm will take care of generating the rest of the certificates
with the required SANs for the joining control-plane instances. If you copy all the certificates by mistake,
the creation of additional nodes could fail due to a lack of required SANs.
</div>
</li>
<li>
<p>Then on each joining control plane node you have to run the following script before running <code>kubeadm join</code>.
This script will move the previously copied certificates from the home directory to <code>/etc/kubernetes/pki</code>:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#b8860b>USER</span><span style=color:#666>=</span>ubuntu <span style=color:#080;font-style:italic># customizable</span>
mkdir -p /etc/kubernetes/pki/etcd
mv /home/<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>USER</span><span style=color:#b68;font-weight:700>}</span>/ca.crt /etc/kubernetes/pki/
mv /home/<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>USER</span><span style=color:#b68;font-weight:700>}</span>/ca.key /etc/kubernetes/pki/
mv /home/<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>USER</span><span style=color:#b68;font-weight:700>}</span>/sa.pub /etc/kubernetes/pki/
mv /home/<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>USER</span><span style=color:#b68;font-weight:700>}</span>/sa.key /etc/kubernetes/pki/
mv /home/<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>USER</span><span style=color:#b68;font-weight:700>}</span>/front-proxy-ca.crt /etc/kubernetes/pki/
mv /home/<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>USER</span><span style=color:#b68;font-weight:700>}</span>/front-proxy-ca.key /etc/kubernetes/pki/
mv /home/<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>USER</span><span style=color:#b68;font-weight:700>}</span>/etcd-ca.crt /etc/kubernetes/pki/etcd/ca.crt
<span style=color:#080;font-style:italic># Skip the next line if you are using external etcd</span>
mv /home/<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>USER</span><span style=color:#b68;font-weight:700>}</span>/etcd-ca.key /etc/kubernetes/pki/etcd/ca.key
</code></pre></div></li>
</ol>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-8160424c22d24f7d2d63c521e107dbf8>2.1.7 - Set up a High Availability etcd Cluster with kubeadm</h1>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> While kubeadm is being used as the management tool for external etcd nodes
in this guide, please note that kubeadm does not plan to support certificate rotation
or upgrades for such nodes. The long term plan is to empower the tool
<a href=https://github.com/kubernetes-sigs/etcdadm>etcdadm</a> to manage these
aspects.
</div>
<p>By default, kubeadm runs a local etcd instance on each control plane node.
It is also possible to treat the etcd cluster as external and provision
etcd instances on separate hosts. The differences between the two approaches are covered in the
<a href=/docs/setup/production-environment/tools/kubeadm/ha-topology>Options for Highly Available topology</a> page.</p>
<p>This task walks through the process of creating a high availability external
etcd cluster of three members that can be used by kubeadm during cluster creation.</p>
<h2 id=before-you-begin>Before you begin</h2>
<ul>
<li>Three hosts that can talk to each other over TCP ports 2379 and 2380. This
document assumes these default ports. However, they are configurable through
the kubeadm config file.</li>
<li>Each host must have systemd and a bash compatible shell installed.</li>
<li>Each host must <a href=/docs/setup/production-environment/tools/kubeadm/install-kubeadm/>have a container runtime, kubelet, and kubeadm installed</a>.</li>
<li>Each host should have access to the Kubernetes container image registry (<code>k8s.gcr.io</code>) or list/pull the required etcd image using
<code>kubeadm config images list/pull</code>. This guide will setup etcd instances as
<a href=/docs/tasks/configure-pod-container/static-pod/>static pods</a> managed by a kubelet.</li>
<li>Some infrastructure to copy files between hosts. For example <code>ssh</code> and <code>scp</code>
can satisfy this requirement.</li>
</ul>
<h2 id=setting-up-the-cluster>Setting up the cluster</h2>
<p>The general approach is to generate all certs on one node and only distribute
the <em>necessary</em> files to the other nodes.</p>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> kubeadm contains all the necessary crytographic machinery to generate
the certificates described below; no other cryptographic tooling is required for
this example.
</div>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> The examples below use IPv4 addresses but you can also configure kubeadm, the kubelet and etcd
to use IPv6 addresses. Dual-stack is supported by some Kubernetes options, but not by etcd. For more details
on Kubernetes dual-stack support see <a href=/docs/setup/production-environment/tools/kubeadm/dual-stack-support/>Dual-stack support with kubeadm</a>.
</div>
<ol>
<li>
<p>Configure the kubelet to be a service manager for etcd.</p>
<p><div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> You must do this on every host where etcd should be running.
</div>
Since etcd was created first, you must override the service priority by creating a new unit file
that has higher precedence than the kubeadm-provided kubelet unit file.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>cat <span style=color:#b44>&lt;&lt; EOF &gt; /etc/systemd/system/kubelet.service.d/20-etcd-service-manager.conf
</span><span style=color:#b44>[Service]
</span><span style=color:#b44>ExecStart=
</span><span style=color:#b44># Replace &#34;systemd&#34; with the cgroup driver of your container runtime. The default value in the kubelet is &#34;cgroupfs&#34;.
</span><span style=color:#b44># Replace the value of &#34;--container-runtime-endpoint&#34; for a different container runtime if needed.
</span><span style=color:#b44>ExecStart=/usr/bin/kubelet --address=127.0.0.1 --pod-manifest-path=/etc/kubernetes/manifests --cgroup-driver=systemd --container-runtime=remote --container-runtime-endpoint=unix:///var/run/containerd/containerd.sock
</span><span style=color:#b44>Restart=always
</span><span style=color:#b44>EOF</span>

systemctl daemon-reload
systemctl restart kubelet
</code></pre></div><p>Check the kubelet status to ensure it is running.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>systemctl status kubelet
</code></pre></div></li>
<li>
<p>Create configuration files for kubeadm.</p>
<p>Generate one kubeadm configuration file for each host that will have an etcd
member running on it using the following script.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#080;font-style:italic># Update HOST0, HOST1 and HOST2 with the IPs of your hosts</span>
<span style=color:#a2f>export</span> <span style=color:#b8860b>HOST0</span><span style=color:#666>=</span>10.0.0.6
<span style=color:#a2f>export</span> <span style=color:#b8860b>HOST1</span><span style=color:#666>=</span>10.0.0.7
<span style=color:#a2f>export</span> <span style=color:#b8860b>HOST2</span><span style=color:#666>=</span>10.0.0.8

<span style=color:#080;font-style:italic># Update NAME0, NAME1 and NAME2 with the hostnames of your hosts</span>
<span style=color:#a2f>export</span> <span style=color:#b8860b>NAME0</span><span style=color:#666>=</span><span style=color:#b44>&#34;infra0&#34;</span>
<span style=color:#a2f>export</span> <span style=color:#b8860b>NAME1</span><span style=color:#666>=</span><span style=color:#b44>&#34;infra1&#34;</span>
<span style=color:#a2f>export</span> <span style=color:#b8860b>NAME2</span><span style=color:#666>=</span><span style=color:#b44>&#34;infra2&#34;</span>

<span style=color:#080;font-style:italic># Create temp directories to store files that will end up on other hosts.</span>
mkdir -p /tmp/<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>HOST0</span><span style=color:#b68;font-weight:700>}</span>/ /tmp/<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>HOST1</span><span style=color:#b68;font-weight:700>}</span>/ /tmp/<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>HOST2</span><span style=color:#b68;font-weight:700>}</span>/

<span style=color:#b8860b>HOSTS</span><span style=color:#666>=(</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>HOST0</span><span style=color:#b68;font-weight:700>}</span> <span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>HOST1</span><span style=color:#b68;font-weight:700>}</span> <span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>HOST2</span><span style=color:#b68;font-weight:700>}</span><span style=color:#666>)</span>
<span style=color:#b8860b>NAMES</span><span style=color:#666>=(</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>NAME0</span><span style=color:#b68;font-weight:700>}</span> <span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>NAME1</span><span style=color:#b68;font-weight:700>}</span> <span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>NAME2</span><span style=color:#b68;font-weight:700>}</span><span style=color:#666>)</span>

<span style=color:#a2f;font-weight:700>for</span> i in <span style=color:#b44>&#34;</span><span style=color:#b68;font-weight:700>${</span>!HOSTS[@]<span style=color:#b68;font-weight:700>}</span><span style=color:#b44>&#34;</span>; <span style=color:#a2f;font-weight:700>do</span>
<span style=color:#b8860b>HOST</span><span style=color:#666>=</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>HOSTS</span>[<span style=color:#b8860b>$i</span>]<span style=color:#b68;font-weight:700>}</span>
<span style=color:#b8860b>NAME</span><span style=color:#666>=</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>NAMES</span>[<span style=color:#b8860b>$i</span>]<span style=color:#b68;font-weight:700>}</span>
cat <span style=color:#b44>&lt;&lt; EOF &gt; /tmp/${HOST}/kubeadmcfg.yaml
</span><span style=color:#b44>---
</span><span style=color:#b44>apiVersion: &#34;kubeadm.k8s.io/v1beta3&#34;
</span><span style=color:#b44>kind: InitConfiguration
</span><span style=color:#b44>nodeRegistration:
</span><span style=color:#b44>    name: ${NAME}
</span><span style=color:#b44>localAPIEndpoint:
</span><span style=color:#b44>    advertiseAddress: ${HOST}
</span><span style=color:#b44>---
</span><span style=color:#b44>apiVersion: &#34;kubeadm.k8s.io/v1beta3&#34;
</span><span style=color:#b44>kind: ClusterConfiguration
</span><span style=color:#b44>etcd:
</span><span style=color:#b44>    local:
</span><span style=color:#b44>        serverCertSANs:
</span><span style=color:#b44>        - &#34;${HOST}&#34;
</span><span style=color:#b44>        peerCertSANs:
</span><span style=color:#b44>        - &#34;${HOST}&#34;
</span><span style=color:#b44>        extraArgs:
</span><span style=color:#b44>            initial-cluster: ${NAMES[0]}=https://${HOSTS[0]}:2380,${NAMES[1]}=https://${HOSTS[1]}:2380,${NAMES[2]}=https://${HOSTS[2]}:2380
</span><span style=color:#b44>            initial-cluster-state: new
</span><span style=color:#b44>            name: ${NAME}
</span><span style=color:#b44>            listen-peer-urls: https://${HOST}:2380
</span><span style=color:#b44>            listen-client-urls: https://${HOST}:2379
</span><span style=color:#b44>            advertise-client-urls: https://${HOST}:2379
</span><span style=color:#b44>            initial-advertise-peer-urls: https://${HOST}:2380
</span><span style=color:#b44>EOF</span>
<span style=color:#a2f;font-weight:700>done</span>
</code></pre></div></li>
<li>
<p>Generate the certificate authority</p>
<p>If you already have a CA then the only action that is copying the CA's <code>crt</code> and
<code>key</code> file to <code>/etc/kubernetes/pki/etcd/ca.crt</code> and
<code>/etc/kubernetes/pki/etcd/ca.key</code>. After those files have been copied,
proceed to the next step, "Create certificates for each member".</p>
<p>If you do not already have a CA then run this command on <code>$HOST0</code> (where you
generated the configuration files for kubeadm).</p>
<pre><code>kubeadm init phase certs etcd-ca
</code></pre><p>This creates two files</p>
<ul>
<li><code>/etc/kubernetes/pki/etcd/ca.crt</code></li>
<li><code>/etc/kubernetes/pki/etcd/ca.key</code></li>
</ul>
</li>
<li>
<p>Create certificates for each member</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>kubeadm init phase certs etcd-server --config<span style=color:#666>=</span>/tmp/<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>HOST2</span><span style=color:#b68;font-weight:700>}</span>/kubeadmcfg.yaml
kubeadm init phase certs etcd-peer --config<span style=color:#666>=</span>/tmp/<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>HOST2</span><span style=color:#b68;font-weight:700>}</span>/kubeadmcfg.yaml
kubeadm init phase certs etcd-healthcheck-client --config<span style=color:#666>=</span>/tmp/<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>HOST2</span><span style=color:#b68;font-weight:700>}</span>/kubeadmcfg.yaml
kubeadm init phase certs apiserver-etcd-client --config<span style=color:#666>=</span>/tmp/<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>HOST2</span><span style=color:#b68;font-weight:700>}</span>/kubeadmcfg.yaml
cp -R /etc/kubernetes/pki /tmp/<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>HOST2</span><span style=color:#b68;font-weight:700>}</span>/
<span style=color:#080;font-style:italic># cleanup non-reusable certificates</span>
find /etc/kubernetes/pki -not -name ca.crt -not -name ca.key -type f -delete

kubeadm init phase certs etcd-server --config<span style=color:#666>=</span>/tmp/<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>HOST1</span><span style=color:#b68;font-weight:700>}</span>/kubeadmcfg.yaml
kubeadm init phase certs etcd-peer --config<span style=color:#666>=</span>/tmp/<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>HOST1</span><span style=color:#b68;font-weight:700>}</span>/kubeadmcfg.yaml
kubeadm init phase certs etcd-healthcheck-client --config<span style=color:#666>=</span>/tmp/<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>HOST1</span><span style=color:#b68;font-weight:700>}</span>/kubeadmcfg.yaml
kubeadm init phase certs apiserver-etcd-client --config<span style=color:#666>=</span>/tmp/<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>HOST1</span><span style=color:#b68;font-weight:700>}</span>/kubeadmcfg.yaml
cp -R /etc/kubernetes/pki /tmp/<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>HOST1</span><span style=color:#b68;font-weight:700>}</span>/
find /etc/kubernetes/pki -not -name ca.crt -not -name ca.key -type f -delete

kubeadm init phase certs etcd-server --config<span style=color:#666>=</span>/tmp/<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>HOST0</span><span style=color:#b68;font-weight:700>}</span>/kubeadmcfg.yaml
kubeadm init phase certs etcd-peer --config<span style=color:#666>=</span>/tmp/<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>HOST0</span><span style=color:#b68;font-weight:700>}</span>/kubeadmcfg.yaml
kubeadm init phase certs etcd-healthcheck-client --config<span style=color:#666>=</span>/tmp/<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>HOST0</span><span style=color:#b68;font-weight:700>}</span>/kubeadmcfg.yaml
kubeadm init phase certs apiserver-etcd-client --config<span style=color:#666>=</span>/tmp/<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>HOST0</span><span style=color:#b68;font-weight:700>}</span>/kubeadmcfg.yaml
<span style=color:#080;font-style:italic># No need to move the certs because they are for HOST0</span>

<span style=color:#080;font-style:italic># clean up certs that should not be copied off this host</span>
find /tmp/<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>HOST2</span><span style=color:#b68;font-weight:700>}</span> -name ca.key -type f -delete
find /tmp/<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>HOST1</span><span style=color:#b68;font-weight:700>}</span> -name ca.key -type f -delete
</code></pre></div></li>
<li>
<p>Copy certificates and kubeadm configs</p>
<p>The certificates have been generated and now they must be moved to their
respective hosts.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#b8860b>USER</span><span style=color:#666>=</span>ubuntu
<span style=color:#b8860b>HOST</span><span style=color:#666>=</span><span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>HOST1</span><span style=color:#b68;font-weight:700>}</span>
scp -r /tmp/<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>HOST</span><span style=color:#b68;font-weight:700>}</span>/* <span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>USER</span><span style=color:#b68;font-weight:700>}</span>@<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>HOST</span><span style=color:#b68;font-weight:700>}</span>:
ssh <span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>USER</span><span style=color:#b68;font-weight:700>}</span>@<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>HOST</span><span style=color:#b68;font-weight:700>}</span>
USER@HOST $ sudo -Es
root@HOST $ chown -R root:root pki
root@HOST $ mv pki /etc/kubernetes/
</code></pre></div></li>
<li>
<p>Ensure all expected files exist</p>
<p>The complete list of required files on <code>$HOST0</code> is:</p>
<pre><code>/tmp/${HOST0}
└── kubeadmcfg.yaml
---
/etc/kubernetes/pki
├── apiserver-etcd-client.crt
├── apiserver-etcd-client.key
└── etcd
    ├── ca.crt
    ├── ca.key
    ├── healthcheck-client.crt
    ├── healthcheck-client.key
    ├── peer.crt
    ├── peer.key
    ├── server.crt
    └── server.key
</code></pre><p>On <code>$HOST1</code>:</p>
<pre><code>$HOME
└── kubeadmcfg.yaml
---
/etc/kubernetes/pki
├── apiserver-etcd-client.crt
├── apiserver-etcd-client.key
└── etcd
    ├── ca.crt
    ├── healthcheck-client.crt
    ├── healthcheck-client.key
    ├── peer.crt
    ├── peer.key
    ├── server.crt
    └── server.key
</code></pre><p>On <code>$HOST2</code></p>
<pre><code>$HOME
└── kubeadmcfg.yaml
---
/etc/kubernetes/pki
├── apiserver-etcd-client.crt
├── apiserver-etcd-client.key
└── etcd
    ├── ca.crt
    ├── healthcheck-client.crt
    ├── healthcheck-client.key
    ├── peer.crt
    ├── peer.key
    ├── server.crt
    └── server.key
</code></pre></li>
<li>
<p>Create the static pod manifests</p>
<p>Now that the certificates and configs are in place it's time to create the
manifests. On each host run the <code>kubeadm</code> command to generate a static manifest
for etcd.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>root@HOST0 $ kubeadm init phase etcd <span style=color:#a2f>local</span> --config<span style=color:#666>=</span>/tmp/<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>HOST0</span><span style=color:#b68;font-weight:700>}</span>/kubeadmcfg.yaml
root@HOST1 $ kubeadm init phase etcd <span style=color:#a2f>local</span> --config<span style=color:#666>=</span><span style=color:#b8860b>$HOME</span>/kubeadmcfg.yaml
root@HOST2 $ kubeadm init phase etcd <span style=color:#a2f>local</span> --config<span style=color:#666>=</span><span style=color:#b8860b>$HOME</span>/kubeadmcfg.yaml
</code></pre></div></li>
<li>
<p>Optional: Check the cluster health</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh>docker run --rm -it <span style=color:#b62;font-weight:700>\
</span><span style=color:#b62;font-weight:700></span>--net host <span style=color:#b62;font-weight:700>\
</span><span style=color:#b62;font-weight:700></span>-v /etc/kubernetes:/etc/kubernetes k8s.gcr.io/etcd:<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>ETCD_TAG</span><span style=color:#b68;font-weight:700>}</span> etcdctl <span style=color:#b62;font-weight:700>\
</span><span style=color:#b62;font-weight:700></span>--cert /etc/kubernetes/pki/etcd/peer.crt <span style=color:#b62;font-weight:700>\
</span><span style=color:#b62;font-weight:700></span>--key /etc/kubernetes/pki/etcd/peer.key <span style=color:#b62;font-weight:700>\
</span><span style=color:#b62;font-weight:700></span>--cacert /etc/kubernetes/pki/etcd/ca.crt <span style=color:#b62;font-weight:700>\
</span><span style=color:#b62;font-weight:700></span>--endpoints https://<span style=color:#b68;font-weight:700>${</span><span style=color:#b8860b>HOST0</span><span style=color:#b68;font-weight:700>}</span>:2379 endpoint health --cluster
...
https://<span style=color:#666>[</span>HOST0 IP<span style=color:#666>]</span>:2379 is healthy: successfully committed proposal: <span style=color:#b8860b>took</span> <span style=color:#666>=</span> 16.283339ms
https://<span style=color:#666>[</span>HOST1 IP<span style=color:#666>]</span>:2379 is healthy: successfully committed proposal: <span style=color:#b8860b>took</span> <span style=color:#666>=</span> 19.44402ms
https://<span style=color:#666>[</span>HOST2 IP<span style=color:#666>]</span>:2379 is healthy: successfully committed proposal: <span style=color:#b8860b>took</span> <span style=color:#666>=</span> 35.926451ms
</code></pre></div><ul>
<li>Set <code>${ETCD_TAG}</code> to the version tag of your etcd image. For example <code>3.4.3-0</code>. To see the etcd image and tag that kubeadm uses execute <code>kubeadm config images list --kubernetes-version ${K8S_VERSION}</code>, where <code>${K8S_VERSION}</code> is for example <code>v1.17.0</code></li>
<li>Set <code>${HOST0}</code>to the IP address of the host you are testing.</li>
</ul>
</li>
</ol>
<h2 id=what-s-next>What's next</h2>
<p>Once you have a working 3 member etcd cluster, you can continue setting up a
highly available control plane using the <a href=/docs/setup/production-environment/tools/kubeadm/high-availability/>external etcd method with
kubeadm</a>.</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-07709e71de6b4ac2573041c31213dbeb>2.1.8 - Configuring each kubelet in your cluster using kubeadm</h1>
<div style=margin-top:10px;margin-bottom:10px>
<b>FEATURE STATE:</b> <code>Kubernetes v1.11 [stable]</code>
</div>
<p>The lifecycle of the kubeadm CLI tool is decoupled from the
<a href=/docs/reference/command-line-tools-reference/kubelet>kubelet</a>, which is a daemon that runs
on each node within the Kubernetes cluster. The kubeadm CLI tool is executed by the user when Kubernetes is
initialized or upgraded, whereas the kubelet is always running in the background.</p>
<p>Since the kubelet is a daemon, it needs to be maintained by some kind of an init
system or service manager. When the kubelet is installed using DEBs or RPMs,
systemd is configured to manage the kubelet. You can use a different service
manager instead, but you need to configure it manually.</p>
<p>Some kubelet configuration details need to be the same across all kubelets involved in the cluster, while
other configuration aspects need to be set on a per-kubelet basis to accommodate the different
characteristics of a given machine (such as OS, storage, and networking). You can manage the configuration
of your kubelets manually, but kubeadm now provides a <code>KubeletConfiguration</code> API type for
<a href=#configure-kubelets-using-kubeadm>managing your kubelet configurations centrally</a>.</p>
<h2 id=kubelet-configuration-patterns>Kubelet configuration patterns</h2>
<p>The following sections describe patterns to kubelet configuration that are simplified by
using kubeadm, rather than managing the kubelet configuration for each Node manually.</p>
<h3 id=propagating-cluster-level-configuration-to-each-kubelet>Propagating cluster-level configuration to each kubelet</h3>
<p>You can provide the kubelet with default values to be used by <code>kubeadm init</code> and <code>kubeadm join</code>
commands. Interesting examples include using a different CRI runtime or setting the default subnet
used by services.</p>
<p>If you want your services to use the subnet <code>10.96.0.0/12</code> as the default for services, you can pass
the <code>--service-cidr</code> parameter to kubeadm:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubeadm init --service-cidr 10.96.0.0/12
</code></pre></div><p>Virtual IPs for services are now allocated from this subnet. You also need to set the DNS address used
by the kubelet, using the <code>--cluster-dns</code> flag. This setting needs to be the same for every kubelet
on every manager and Node in the cluster. The kubelet provides a versioned, structured API object
that can configure most parameters in the kubelet and push out this configuration to each running
kubelet in the cluster. This object is called
<a href=/docs/reference/config-api/kubelet-config.v1beta1/><code>KubeletConfiguration</code></a>.
The <code>KubeletConfiguration</code> allows the user to specify flags such as the cluster DNS IP addresses expressed as
a list of values to a camelCased key, illustrated by the following example:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kubelet.config.k8s.io/v1beta1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>KubeletConfiguration<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>clusterDNS</span>:<span style=color:#bbb>
</span><span style=color:#bbb></span>- <span style=color:#666>10.96.0.10</span><span style=color:#bbb>
</span></code></pre></div><p>For more details on the <code>KubeletConfiguration</code> have a look at <a href=#configure-kubelets-using-kubeadm>this section</a>.</p>
<h3 id=providing-instance-specific-configuration-details>Providing instance-specific configuration details</h3>
<p>Some hosts require specific kubelet configurations due to differences in hardware, operating system,
networking, or other host-specific parameters. The following list provides a few examples.</p>
<ul>
<li>
<p>The path to the DNS resolution file, as specified by the <code>--resolv-conf</code> kubelet
configuration flag, may differ among operating systems, or depending on whether you are using
<code>systemd-resolved</code>. If this path is wrong, DNS resolution will fail on the Node whose kubelet
is configured incorrectly.</p>
</li>
<li>
<p>The Node API object <code>.metadata.name</code> is set to the machine's hostname by default,
unless you are using a cloud provider. You can use the <code>--hostname-override</code> flag to override the
default behavior if you need to specify a Node name different from the machine's hostname.</p>
</li>
<li>
<p>Currently, the kubelet cannot automatically detect the cgroup driver used by the CRI runtime,
but the value of <code>--cgroup-driver</code> must match the cgroup driver used by the CRI runtime to ensure
the health of the kubelet.</p>
</li>
<li>
<p>Depending on the CRI runtime your cluster uses, you may need to specify different flags to the kubelet.
For instance, when using Docker, you need to specify flags such as <code>--network-plugin=cni</code>, but if you
are using an external runtime, you need to specify <code>--container-runtime=remote</code> and specify the CRI
endpoint using the <code>--container-runtime-endpoint=&lt;path></code>.</p>
</li>
</ul>
<p>You can specify these flags by configuring an individual kubelet's configuration in your service manager,
such as systemd.</p>
<h2 id=configure-kubelets-using-kubeadm>Configure kubelets using kubeadm</h2>
<p>It is possible to configure the kubelet that kubeadm will start if a custom <code>KubeletConfiguration</code>
API object is passed with a configuration file like so <code>kubeadm ... --config some-config-file.yaml</code>.</p>
<p>By calling <code>kubeadm config print init-defaults --component-configs KubeletConfiguration</code> you can
see all the default values for this structure.</p>
<p>Also have a look at the
<a href=/docs/reference/config-api/kubelet-config.v1beta1/>reference for the KubeletConfiguration</a>
for more information on the individual fields.</p>
<h3 id=workflow-when-using-kubeadm-init>Workflow when using <code>kubeadm init</code></h3>
<p>When you call <code>kubeadm init</code>, the kubelet configuration is marshalled to disk
at <code>/var/lib/kubelet/config.yaml</code>, and also uploaded to a ConfigMap in the cluster. The ConfigMap
is named <code>kubelet-config-1.X</code>, where <code>X</code> is the minor version of the Kubernetes version you are
initializing. A kubelet configuration file is also written to <code>/etc/kubernetes/kubelet.conf</code> with the
baseline cluster-wide configuration for all kubelets in the cluster. This configuration file
points to the client certificates that allow the kubelet to communicate with the API server. This
addresses the need to
<a href=#propagating-cluster-level-configuration-to-each-kubelet>propagate cluster-level configuration to each kubelet</a>.</p>
<p>To address the second pattern of
<a href=#providing-instance-specific-configuration-details>providing instance-specific configuration details</a>,
kubeadm writes an environment file to <code>/var/lib/kubelet/kubeadm-flags.env</code>, which contains a list of
flags to pass to the kubelet when it starts. The flags are presented in the file like this:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#b8860b>KUBELET_KUBEADM_ARGS</span><span style=color:#666>=</span><span style=color:#b44>&#34;--flag1=value1 --flag2=value2 ...&#34;</span>
</code></pre></div><p>In addition to the flags used when starting the kubelet, the file also contains dynamic
parameters such as the cgroup driver and whether to use a different CRI runtime socket
(<code>--cri-socket</code>).</p>
<p>After marshalling these two files to disk, kubeadm attempts to run the following two
commands, if you are using systemd:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>systemctl daemon-reload <span style=color:#666>&amp;&amp;</span> systemctl restart kubelet
</code></pre></div><p>If the reload and restart are successful, the normal <code>kubeadm init</code> workflow continues.</p>
<h3 id=workflow-when-using-kubeadm-join>Workflow when using <code>kubeadm join</code></h3>
<p>When you run <code>kubeadm join</code>, kubeadm uses the Bootstrap Token credential to perform
a TLS bootstrap, which fetches the credential needed to download the
<code>kubelet-config-1.X</code> ConfigMap and writes it to <code>/var/lib/kubelet/config.yaml</code>. The dynamic
environment file is generated in exactly the same way as <code>kubeadm init</code>.</p>
<p>Next, <code>kubeadm</code> runs the following two commands to load the new configuration into the kubelet:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>systemctl daemon-reload <span style=color:#666>&amp;&amp;</span> systemctl restart kubelet
</code></pre></div><p>After the kubelet loads the new configuration, kubeadm writes the
<code>/etc/kubernetes/bootstrap-kubelet.conf</code> KubeConfig file, which contains a CA certificate and Bootstrap
Token. These are used by the kubelet to perform the TLS Bootstrap and obtain a unique
credential, which is stored in <code>/etc/kubernetes/kubelet.conf</code>.</p>
<p>When the <code>/etc/kubernetes/kubelet.conf</code> file is written, the kubelet has finished performing the TLS Bootstrap.
Kubeadm deletes the <code>/etc/kubernetes/bootstrap-kubelet.conf</code> file after completing the TLS Bootstrap.</p>
<h2 id=the-kubelet-drop-in-file-for-systemd>The kubelet drop-in file for systemd</h2>
<p><code>kubeadm</code> ships with configuration for how systemd should run the kubelet.
Note that the kubeadm CLI command never touches this drop-in file.</p>
<p>This configuration file installed by the <code>kubeadm</code>
<a href=https://github.com/kubernetes/release/blob/master/cmd/kubepkg/templates/latest/deb/kubeadm/10-kubeadm.conf>DEB</a> or
<a href=https://github.com/kubernetes/release/blob/master/cmd/kubepkg/templates/latest/rpm/kubeadm/10-kubeadm.conf>RPM package</a> is written to
<code>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</code> and is used by systemd.
It augments the basic
<a href=https://github.com/kubernetes/release/blob/master/cmd/kubepkg/templates/latest/rpm/kubelet/kubelet.service><code>kubelet.service</code> for RPM</a> or
<a href=https://github.com/kubernetes/release/blob/master/cmd/kubepkg/templates/latest/deb/kubelet/lib/systemd/system/kubelet.service><code>kubelet.service</code> for DEB</a>:</p>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> The contents below are just an example. If you don't want to use a package manager
follow the guide outlined in the <a href=/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#k8s-install-2>Without a package manager</a>)
section.
</div>
<pre><code class=language-none data-lang=none>[Service]
Environment=&quot;KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf&quot;
Environment=&quot;KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml&quot;
# This is a file that &quot;kubeadm init&quot; and &quot;kubeadm join&quot; generate at runtime, populating
the KUBELET_KUBEADM_ARGS variable dynamically
EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env
# This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably,
# the user should use the .NodeRegistration.KubeletExtraArgs object in the configuration files instead.
# KUBELET_EXTRA_ARGS should be sourced from this file.
EnvironmentFile=-/etc/default/kubelet
ExecStart=
ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS
</code></pre><p>This file specifies the default locations for all of the files managed by kubeadm for the kubelet.</p>
<ul>
<li>The KubeConfig file to use for the TLS Bootstrap is <code>/etc/kubernetes/bootstrap-kubelet.conf</code>,
but it is only used if <code>/etc/kubernetes/kubelet.conf</code> does not exist.</li>
<li>The KubeConfig file with the unique kubelet identity is <code>/etc/kubernetes/kubelet.conf</code>.</li>
<li>The file containing the kubelet's ComponentConfig is <code>/var/lib/kubelet/config.yaml</code>.</li>
<li>The dynamic environment file that contains <code>KUBELET_KUBEADM_ARGS</code> is sourced from <code>/var/lib/kubelet/kubeadm-flags.env</code>.</li>
<li>The file that can contain user-specified flag overrides with <code>KUBELET_EXTRA_ARGS</code> is sourced from
<code>/etc/default/kubelet</code> (for DEBs), or <code>/etc/sysconfig/kubelet</code> (for RPMs). <code>KUBELET_EXTRA_ARGS</code>
is last in the flag chain and has the highest priority in the event of conflicting settings.</li>
</ul>
<h2 id=kubernetes-binaries-and-package-contents>Kubernetes binaries and package contents</h2>
<p>The DEB and RPM packages shipped with the Kubernetes releases are:</p>
<table>
<thead>
<tr>
<th>Package name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>kubeadm</code></td>
<td>Installs the <code>/usr/bin/kubeadm</code> CLI tool and the <a href=#the-kubelet-drop-in-file-for-systemd>kubelet drop-in file</a> for the kubelet.</td>
</tr>
<tr>
<td><code>kubelet</code></td>
<td>Installs the <code>/usr/bin/kubelet</code> binary.</td>
</tr>
<tr>
<td><code>kubectl</code></td>
<td>Installs the <code>/usr/bin/kubectl</code> binary.</td>
</tr>
<tr>
<td><code>cri-tools</code></td>
<td>Installs the <code>/usr/bin/crictl</code> binary from the <a href=https://github.com/kubernetes-sigs/cri-tools>cri-tools git repository</a>.</td>
</tr>
<tr>
<td><code>kubernetes-cni</code></td>
<td>Installs the <code>/opt/cni/bin</code> binaries from the <a href=https://github.com/containernetworking/plugins>plugins git repository</a>.</td>
</tr>
</tbody>
</table>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-df2f3f20d404ebe2b03fcda1fcee50e7>2.1.9 - Dual-stack support with kubeadm</h1>
<div style=margin-top:10px;margin-bottom:10px>
<b>FEATURE STATE:</b> <code>Kubernetes v1.23 [stable]</code>
</div>
<p>Your Kubernetes cluster includes <a href=/docs/concepts/services-networking/dual-stack/>dual-stack</a> networking, which means that cluster networking lets you use either address family. In a cluster, the control plane can assign both an IPv4 address and an IPv6 address to a single <a class=glossary-tooltip title="A Pod represents a set of running containers in your cluster." data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/pods/ target=_blank aria-label=Pod>Pod</a> or a <a class=glossary-tooltip title="A way to expose an application running on a set of Pods as a network service." data-toggle=tooltip data-placement=top href=/docs/concepts/services-networking/service/ target=_blank aria-label=Service>Service</a>.</p>
<h2 id=before-you-begin>Before you begin</h2>
<p>You need to have installed the <a class=glossary-tooltip title="A tool for quickly installing Kubernetes and setting up a secure cluster." data-toggle=tooltip data-placement=top href=/docs/admin/kubeadm/ target=_blank aria-label=kubeadm>kubeadm</a> tool, following the steps from <a href=/docs/setup/production-environment/tools/kubeadm/install-kubeadm/>Installing kubeadm</a>.</p>
<p>For each server that you want to use as a <a class=glossary-tooltip title="A node is a worker machine in Kubernetes." data-toggle=tooltip data-placement=top href=/docs/concepts/architecture/nodes/ target=_blank aria-label=node>node</a>, make sure it allows IPv6 forwarding. On Linux, you can set this by running run <code>sysctl -w net.ipv6.conf.all.forwarding=1</code> as the root user on each server.</p>
<p>You need to have an IPv4 and and IPv6 address range to use. Cluster operators typically
use private address ranges for IPv4. For IPv6, a cluster operator typically chooses a global
unicast address block from within <code>2000::/3</code>, using a range that is assigned to the operator.
You don't have to route the cluster's IP address ranges to the public internet.</p>
<p>The size of the IP address allocations should be suitable for the number of Pods and
Services that you are planning to run.</p>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> If you are upgrading an existing cluster with the <code>kubeadm upgrade</code> command,
<code>kubeadm</code> does not support making modifications to the pod IP address range
(“cluster CIDR”) nor to the cluster's Service address range (“Service CIDR”).
</div>
<h3 id=create-a-dual-stack-cluster>Create a dual-stack cluster</h3>
<p>To create a dual-stack cluster with <code>kubeadm init</code> you can pass command line arguments
similar to the following example:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#080;font-style:italic># These address ranges are examples</span>
kubeadm init --pod-network-cidr<span style=color:#666>=</span>10.244.0.0/16,2001:db8:42:0::/56 --service-cidr<span style=color:#666>=</span>10.96.0.0/16,2001:db8:42:1::/112
</code></pre></div><p>To make things clearer, here is an example kubeadm
<a href=/docs/reference/config-api/kubeadm-config.v1beta3/>configuration file</a>
<code>kubeadm-config.yaml</code> for the primary dual-stack control plane node.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kubeadm.k8s.io/v1beta3<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterConfiguration<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>networking</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>podSubnet</span>:<span style=color:#bbb> </span><span style=color:#666>10.244.0.0</span>/16,2001:db8:42:0::/56<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>serviceSubnet</span>:<span style=color:#bbb> </span><span style=color:#666>10.96.0.0</span>/16,2001:db8:42:1::/112<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kubeadm.k8s.io/v1beta3<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>InitConfiguration<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>localAPIEndpoint</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>advertiseAddress</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;10.100.0.1&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>bindPort</span>:<span style=color:#bbb> </span><span style=color:#666>6443</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>nodeRegistration</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>kubeletExtraArgs</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>node-ip</span>:<span style=color:#bbb> </span><span style=color:#666>10.100.0.2</span>,fd00:1:2:3::2<span style=color:#bbb>
</span></code></pre></div><p><code>advertiseAddress</code> in InitConfiguration specifies the IP address that the API Server will advertise it is listening on. The value of <code>advertiseAddress</code> equals the <code>--apiserver-advertise-address</code> flag of <code>kubeadm init</code></p>
<p>Run kubeadm to initiate the dual-stack control plane node:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubeadm init --config<span style=color:#666>=</span>kubeadm-config.yaml
</code></pre></div><p>The kube-controller-manager flags <code>--node-cidr-mask-size-ipv4|--node-cidr-mask-size-ipv6</code> are set with default values. See <a href=/docs/concepts/services-networking/dual-stack#configure-ipv4-ipv6-dual-stack>configure IPv4/IPv6 dual stack</a>.</p>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> The <code>--apiserver-advertise-address</code> flag does not support dual-stack.
</div>
<h3 id=join-a-node-to-dual-stack-cluster>Join a node to dual-stack cluster</h3>
<p>Before joining a node, make sure that the node has IPv6 routable network interface and allows IPv6 forwarding.</p>
<p>Here is an example kubeadm <a href=/docs/reference/config-api/kubeadm-config.v1beta3/>configuration file</a>
<code>kubeadm-config.yaml</code> for joining a worker node to the cluster.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kubeadm.k8s.io/v1beta3<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>JoinConfiguration<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>discovery</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>bootstrapToken</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>apiServerEndpoint</span>:<span style=color:#bbb> </span><span style=color:#666>10.100.0.1</span>:<span style=color:#666>6443</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>token</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;clvldh.vjjwg16ucnhp94qr&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>caCertHashes</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:#b44>&#34;sha256:a4863cde706cfc580a439f842cc65d5ef112b7b2be31628513a9881cf0d9fe0e&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># change auth info above to match the actual token and CA certificate hash for your cluster</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>nodeRegistration</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>kubeletExtraArgs</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>node-ip</span>:<span style=color:#bbb> </span><span style=color:#666>10.100.0.3</span>,fd00:1:2:3::3<span style=color:#bbb>
</span></code></pre></div><p>Also, here is an example kubeadm <a href=/docs/reference/config-api/kubeadm-config.v1beta3/>configuration file</a>
<code>kubeadm-config.yaml</code> for joining another control plane node to the cluster.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kubeadm.k8s.io/v1beta3<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>JoinConfiguration<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>controlPlane</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>localAPIEndpoint</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>advertiseAddress</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;10.100.0.2&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>bindPort</span>:<span style=color:#bbb> </span><span style=color:#666>6443</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>discovery</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>bootstrapToken</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>apiServerEndpoint</span>:<span style=color:#bbb> </span><span style=color:#666>10.100.0.1</span>:<span style=color:#666>6443</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>token</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;clvldh.vjjwg16ucnhp94qr&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>caCertHashes</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:#b44>&#34;sha256:a4863cde706cfc580a439f842cc65d5ef112b7b2be31628513a9881cf0d9fe0e&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># change auth info above to match the actual token and CA certificate hash for your cluster</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>nodeRegistration</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>kubeletExtraArgs</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>node-ip</span>:<span style=color:#bbb> </span><span style=color:#666>10.100.0.4</span>,fd00:1:2:3::4<span style=color:#bbb>
</span><span style=color:#bbb>
</span></code></pre></div><p><code>advertiseAddress</code> in JoinConfiguration.controlPlane specifies the IP address that the API Server will advertise it is listening on. The value of <code>advertiseAddress</code> equals the <code>--apiserver-advertise-address</code> flag of <code>kubeadm join</code>.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubeadm join --config<span style=color:#666>=</span>kubeadm-config.yaml
</code></pre></div><h3 id=create-a-single-stack-cluster>Create a single-stack cluster</h3>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> Dual-stack support doesn't mean that you need to use dual-stack addressing.
You can deploy a single-stack cluster that has the dual-stack networking feature enabled.
</div>
<p>To make things more clear, here is an example kubeadm
<a href=/docs/reference/config-api/kubeadm-config.v1beta3/>configuration file</a>
<code>kubeadm-config.yaml</code> for the single-stack control plane node.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>kubeadm.k8s.io/v1beta3<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterConfiguration<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>networking</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>podSubnet</span>:<span style=color:#bbb> </span><span style=color:#666>10.244.0.0</span>/16<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>serviceSubnet</span>:<span style=color:#bbb> </span><span style=color:#666>10.96.0.0</span>/16<span style=color:#bbb>
</span></code></pre></div><h2 id=what-s-next>What's next</h2>
<ul>
<li><a href=/docs/tasks/network/validate-dual-stack>Validate IPv4/IPv6 dual-stack</a> networking</li>
<li>Read about <a href=/docs/concepts/services-networking/dual-stack/>Dual-stack</a> cluster networking</li>
<li>Learn more about the kubeadm <a href=/docs/reference/config-api/kubeadm-config.v1beta3/>configuration format</a></li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-478acca1934b6d89a0bc00fb25bfe5b6>2.2 - Installing Kubernetes with kops</h1>
<p>This quickstart shows you how to easily install a Kubernetes cluster on AWS.
It uses a tool called <a href=https://github.com/kubernetes/kops><code>kops</code></a>.</p>
<p>kops is an automated provisioning system:</p>
<ul>
<li>Fully automated installation</li>
<li>Uses DNS to identify clusters</li>
<li>Self-healing: everything runs in Auto-Scaling Groups</li>
<li>Multiple OS support (Debian, Ubuntu 16.04 supported, CentOS & RHEL, Amazon Linux and CoreOS) - see the <a href=https://github.com/kubernetes/kops/blob/master/docs/operations/images.md>images.md</a></li>
<li>High-Availability support - see the <a href=https://github.com/kubernetes/kops/blob/master/docs/operations/high_availability.md>high_availability.md</a></li>
<li>Can directly provision, or generate terraform manifests - see the <a href=https://github.com/kubernetes/kops/blob/master/docs/terraform.md>terraform.md</a></li>
</ul>
<h2 id=before-you-begin>Before you begin</h2>
<ul>
<li>
<p>You must have <a href=/docs/tasks/tools/>kubectl</a> installed.</p>
</li>
<li>
<p>You must <a href=https://github.com/kubernetes/kops#installing>install</a> <code>kops</code> on a 64-bit (AMD64 and Intel 64) device architecture.</p>
</li>
<li>
<p>You must have an <a href=https://docs.aws.amazon.com/polly/latest/dg/setting-up.html>AWS account</a>, generate <a href=https://docs.aws.amazon.com/general/latest/gr/aws-sec-cred-types.html#access-keys-and-secret-access-keys>IAM keys</a> and <a href=https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html#cli-quick-configuration>configure</a> them. The IAM user will need <a href=https://github.com/kubernetes/kops/blob/master/docs/getting_started/aws.md#setup-iam-user>adequate permissions</a>.</p>
</li>
</ul>
<h2 id=creating-a-cluster>Creating a cluster</h2>
<h3 id=1-5-install-kops>(1/5) Install kops</h3>
<h4 id=installation>Installation</h4>
<p>Download kops from the <a href=https://github.com/kubernetes/kops/releases>releases page</a> (it is also convenient to build from source):</p>
<ul class="nav nav-tabs" id=kops-installation role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#kops-installation-0 role=tab aria-controls=kops-installation-0 aria-selected=true>macOS</a></li>
<li class=nav-item><a data-toggle=tab class=nav-link href=#kops-installation-1 role=tab aria-controls=kops-installation-1>Linux</a></li></ul>
<div class=tab-content id=kops-installation><div id=kops-installation-0 class="tab-pane show active" role=tabpanel aria-labelledby=kops-installation-0>
<p><p>Download the latest release with the command:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl -LO https://github.com/kubernetes/kops/releases/download/<span style=color:#a2f;font-weight:700>$(</span>curl -s https://api.github.com/repos/kubernetes/kops/releases/latest | grep tag_name | cut -d <span style=color:#b44>&#39;&#34;&#39;</span> -f 4<span style=color:#a2f;font-weight:700>)</span>/kops-darwin-amd64
</code></pre></div><p>To download a specific version, replace the following portion of the command with the specific kops version.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#a2f;font-weight:700>$(</span>curl -s https://api.github.com/repos/kubernetes/kops/releases/latest | grep tag_name | cut -d <span style=color:#b44>&#39;&#34;&#39;</span> -f 4<span style=color:#a2f;font-weight:700>)</span>
</code></pre></div><p>For example, to download kops version v1.20.0 type:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl -LO https://github.com/kubernetes/kops/releases/download/v1.20.0/kops-darwin-amd64
</code></pre></div><p>Make the kops binary executable.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>chmod +x kops-darwin-amd64
</code></pre></div><p>Move the kops binary in to your PATH.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sudo mv kops-darwin-amd64 /usr/local/bin/kops
</code></pre></div><p>You can also install kops using <a href=https://brew.sh/>Homebrew</a>.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>brew update <span style=color:#666>&amp;&amp;</span> brew install kops
</code></pre></div></div>
<div id=kops-installation-1 class=tab-pane role=tabpanel aria-labelledby=kops-installation-1>
<p><p>Download the latest release with the command:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl -LO https://github.com/kubernetes/kops/releases/download/<span style=color:#a2f;font-weight:700>$(</span>curl -s https://api.github.com/repos/kubernetes/kops/releases/latest | grep tag_name | cut -d <span style=color:#b44>&#39;&#34;&#39;</span> -f 4<span style=color:#a2f;font-weight:700>)</span>/kops-linux-amd64
</code></pre></div><p>To download a specific version of kops, replace the following portion of the command with the specific kops version.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#a2f;font-weight:700>$(</span>curl -s https://api.github.com/repos/kubernetes/kops/releases/latest | grep tag_name | cut -d <span style=color:#b44>&#39;&#34;&#39;</span> -f 4<span style=color:#a2f;font-weight:700>)</span>
</code></pre></div><p>For example, to download kops version v1.20.0 type:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl -LO https://github.com/kubernetes/kops/releases/download/v1.20.0/kops-linux-amd64
</code></pre></div><p>Make the kops binary executable</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>chmod +x kops-linux-amd64
</code></pre></div><p>Move the kops binary in to your PATH.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>sudo mv kops-linux-amd64 /usr/local/bin/kops
</code></pre></div><p>You can also install kops using <a href=https://docs.brew.sh/Homebrew-on-Linux>Homebrew</a>.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>brew update <span style=color:#666>&amp;&amp;</span> brew install kops
</code></pre></div></div></div>
<h3 id=2-5-create-a-route53-domain-for-your-cluster>(2/5) Create a route53 domain for your cluster</h3>
<p>kops uses DNS for discovery, both inside the cluster and outside, so that you can reach the kubernetes API server
from clients.</p>
<p>kops has a strong opinion on the cluster name: it should be a valid DNS name. By doing so you will
no longer get your clusters confused, you can share clusters with your colleagues unambiguously,
and you can reach them without relying on remembering an IP address.</p>
<p>You can, and probably should, use subdomains to divide your clusters. As our example we will use
<code>useast1.dev.example.com</code>. The API server endpoint will then be <code>api.useast1.dev.example.com</code>.</p>
<p>A Route53 hosted zone can serve subdomains. Your hosted zone could be <code>useast1.dev.example.com</code>,
but also <code>dev.example.com</code> or even <code>example.com</code>. kops works with any of these, so typically
you choose for organization reasons (e.g. you are allowed to create records under <code>dev.example.com</code>,
but not under <code>example.com</code>).</p>
<p>Let's assume you're using <code>dev.example.com</code> as your hosted zone. You create that hosted zone using
the <a href=https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/CreatingNewSubdomain.html>normal process</a>, or
with a command such as <code>aws route53 create-hosted-zone --name dev.example.com --caller-reference 1</code>.</p>
<p>You must then set up your NS records in the parent domain, so that records in the domain will resolve. Here,
you would create NS records in <code>example.com</code> for <code>dev</code>. If it is a root domain name you would configure the NS
records at your domain registrar (e.g. <code>example.com</code> would need to be configured where you bought <code>example.com</code>).</p>
<p>Verify your route53 domain setup (it is the #1 cause of problems!). You can double-check that
your cluster is configured correctly if you have the dig tool by running:</p>
<p><code>dig NS dev.example.com</code></p>
<p>You should see the 4 NS records that Route53 assigned your hosted zone.</p>
<h3 id=3-5-create-an-s3-bucket-to-store-your-clusters-state>(3/5) Create an S3 bucket to store your clusters state</h3>
<p>kops lets you manage your clusters even after installation. To do this, it must keep track of the clusters
that you have created, along with their configuration, the keys they are using etc. This information is stored
in an S3 bucket. S3 permissions are used to control access to the bucket.</p>
<p>Multiple clusters can use the same S3 bucket, and you can share an S3 bucket between your colleagues that
administer the same clusters - this is much easier than passing around kubecfg files. But anyone with access
to the S3 bucket will have administrative access to all your clusters, so you don't want to share it beyond
the operations team.</p>
<p>So typically you have one S3 bucket for each ops team (and often the name will correspond
to the name of the hosted zone above!)</p>
<p>In our example, we chose <code>dev.example.com</code> as our hosted zone, so let's pick <code>clusters.dev.example.com</code> as
the S3 bucket name.</p>
<ul>
<li>
<p>Export <code>AWS_PROFILE</code> (if you need to select a profile for the AWS CLI to work)</p>
</li>
<li>
<p>Create the S3 bucket using <code>aws s3 mb s3://clusters.dev.example.com</code></p>
</li>
<li>
<p>You can <code>export KOPS_STATE_STORE=s3://clusters.dev.example.com</code> and then kops will use this location by default.
We suggest putting this in your bash profile or similar.</p>
</li>
</ul>
<h3 id=4-5-build-your-cluster-configuration>(4/5) Build your cluster configuration</h3>
<p>Run <code>kops create cluster</code> to create your cluster configuration:</p>
<p><code>kops create cluster --zones=us-east-1c useast1.dev.example.com</code></p>
<p>kops will create the configuration for your cluster. Note that it <em>only</em> creates the configuration, it does
not actually create the cloud resources - you'll do that in the next step with a <code>kops update cluster</code>. This
give you an opportunity to review the configuration or change it.</p>
<p>It prints commands you can use to explore further:</p>
<ul>
<li>List your clusters with: <code>kops get cluster</code></li>
<li>Edit this cluster with: <code>kops edit cluster useast1.dev.example.com</code></li>
<li>Edit your node instance group: <code>kops edit ig --name=useast1.dev.example.com nodes</code></li>
<li>Edit your master instance group: <code>kops edit ig --name=useast1.dev.example.com master-us-east-1c</code></li>
</ul>
<p>If this is your first time using kops, do spend a few minutes to try those out! An instance group is a
set of instances, which will be registered as kubernetes nodes. On AWS this is implemented via auto-scaling-groups.
You can have several instance groups, for example if you wanted nodes that are a mix of spot and on-demand instances, or
GPU and non-GPU instances.</p>
<h3 id=5-5-create-the-cluster-in-aws>(5/5) Create the cluster in AWS</h3>
<p>Run "kops update cluster" to create your cluster in AWS:</p>
<p><code>kops update cluster useast1.dev.example.com --yes</code></p>
<p>That takes a few seconds to run, but then your cluster will likely take a few minutes to actually be ready.
<code>kops update cluster</code> will be the tool you'll use whenever you change the configuration of your cluster; it
applies the changes you have made to the configuration to your cluster - reconfiguring AWS or kubernetes as needed.</p>
<p>For example, after you <code>kops edit ig nodes</code>, then <code>kops update cluster --yes</code> to apply your configuration, and
sometimes you will also have to <code>kops rolling-update cluster</code> to roll out the configuration immediately.</p>
<p>Without <code>--yes</code>, <code>kops update cluster</code> will show you a preview of what it is going to do. This is handy
for production clusters!</p>
<h3 id=explore-other-add-ons>Explore other add-ons</h3>
<p>See the <a href=/docs/concepts/cluster-administration/addons/>list of add-ons</a> to explore other add-ons, including tools for logging, monitoring, network policy, visualization, and control of your Kubernetes cluster.</p>
<h2 id=cleanup>Cleanup</h2>
<ul>
<li>To delete your cluster: <code>kops delete cluster useast1.dev.example.com --yes</code></li>
</ul>
<h2 id=what-s-next>What's next</h2>
<ul>
<li>Learn more about Kubernetes <a href=/docs/concepts/>concepts</a> and <a href=/docs/reference/kubectl/><code>kubectl</code></a>.</li>
<li>Learn more about <code>kops</code> <a href=https://kops.sigs.k8s.io/>advanced usage</a> for tutorials, best practices and advanced configuration options.</li>
<li>Follow <code>kops</code> community discussions on Slack: <a href=https://github.com/kubernetes/kops#other-ways-to-communicate-with-the-contributors>community discussions</a></li>
<li>Contribute to <code>kops</code> by addressing or raising an issue <a href=https://github.com/kubernetes/kops/issues>GitHub Issues</a></li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-f8b4964187fe973644e06ee629eff1de>2.3 - Installing Kubernetes with Kubespray</h1>
<p>This quickstart helps to install a Kubernetes cluster hosted on GCE, Azure, OpenStack, AWS, vSphere, Packet (bare metal), Oracle Cloud Infrastructure (Experimental) or Baremetal with <a href=https://github.com/kubernetes-sigs/kubespray>Kubespray</a>.</p>
<p>Kubespray is a composition of <a href=https://docs.ansible.com/>Ansible</a> playbooks, <a href=https://github.com/kubernetes-sigs/kubespray/blob/master/docs/ansible.md>inventory</a>, provisioning tools, and domain knowledge for generic OS/Kubernetes clusters configuration management tasks. Kubespray provides:</p>
<ul>
<li>a highly available cluster</li>
<li>composable attributes</li>
<li>support for most popular Linux distributions
<ul>
<li>Ubuntu 16.04, 18.04, 20.04</li>
<li>CentOS/RHEL/Oracle Linux 7, 8</li>
<li>Debian Buster, Jessie, Stretch, Wheezy</li>
<li>Fedora 31, 32</li>
<li>Fedora CoreOS</li>
<li>openSUSE Leap 15</li>
<li>Flatcar Container Linux by Kinvolk</li>
</ul>
</li>
<li>continuous integration tests</li>
</ul>
<p>To choose a tool which best fits your use case, read <a href=https://github.com/kubernetes-sigs/kubespray/blob/master/docs/comparisons.md>this comparison</a> to
<a href=/docs/reference/setup-tools/kubeadm/>kubeadm</a> and <a href=/docs/setup/production-environment/tools/kops/>kops</a>.</p>
<h2 id=creating-a-cluster>Creating a cluster</h2>
<h3 id=1-5-meet-the-underlay-requirements>(1/5) Meet the underlay requirements</h3>
<p>Provision servers with the following <a href=https://github.com/kubernetes-sigs/kubespray#requirements>requirements</a>:</p>
<ul>
<li><strong>Ansible v2.9 and python-netaddr are installed on the machine that will run Ansible commands</strong></li>
<li><strong>Jinja 2.11 (or newer) is required to run the Ansible Playbooks</strong></li>
<li>The target servers must have access to the Internet in order to pull docker images. Otherwise, additional configuration is required (<a href=https://github.com/kubernetes-sigs/kubespray/blob/master/docs/offline-environment.md>See Offline Environment</a>)</li>
<li>The target servers are configured to allow <strong>IPv4 forwarding</strong></li>
<li><strong>Your ssh key must be copied</strong> to all the servers in your inventory</li>
<li><strong>Firewalls are not managed by kubespray</strong>. You'll need to implement appropriate rules as needed. You should disable your firewall in order to avoid any issues during deployment</li>
<li>If kubespray is ran from a non-root user account, correct privilege escalation method should be configured in the target servers and the <code>ansible_become</code> flag or command parameters <code>--become</code> or <code>-b</code> should be specified</li>
</ul>
<p>Kubespray provides the following utilities to help provision your environment:</p>
<ul>
<li><a href=https://www.terraform.io/>Terraform</a> scripts for the following cloud providers:
<ul>
<li><a href=https://github.com/kubernetes-sigs/kubespray/tree/master/contrib/terraform/aws>AWS</a></li>
<li><a href=https://github.com/kubernetes-sigs/kubespray/tree/master/contrib/terraform/openstack>OpenStack</a></li>
<li><a href=https://github.com/kubernetes-sigs/kubespray/tree/master/contrib/terraform/packet>Packet</a></li>
</ul>
</li>
</ul>
<h3 id=2-5-compose-an-inventory-file>(2/5) Compose an inventory file</h3>
<p>After you provision your servers, create an <a href=https://docs.ansible.com/ansible/latest/network/getting_started/first_inventory.html>inventory file for Ansible</a>. You can do this manually or via a dynamic inventory script. For more information, see "<a href=https://github.com/kubernetes-sigs/kubespray/blob/master/docs/getting-started.md#building-your-own-inventory>Building your own inventory</a>".</p>
<h3 id=3-5-plan-your-cluster-deployment>(3/5) Plan your cluster deployment</h3>
<p>Kubespray provides the ability to customize many aspects of the deployment:</p>
<ul>
<li>Choice deployment mode: kubeadm or non-kubeadm</li>
<li>CNI (networking) plugins</li>
<li>DNS configuration</li>
<li>Choice of control plane: native/binary or containerized</li>
<li>Component versions</li>
<li>Calico route reflectors</li>
<li>Component runtime options
<ul>
<li><a class=glossary-tooltip title="Docker is a software technology providing operating-system-level virtualization also known as containers." data-toggle=tooltip data-placement=top href=https://docs.docker.com/engine/ target=_blank aria-label=Docker>Docker</a></li>
<li><a class=glossary-tooltip title="A container runtime with an emphasis on simplicity, robustness and portability" data-toggle=tooltip data-placement=top href=https://containerd.io/docs/ target=_blank aria-label=containerd>containerd</a></li>
<li><a class=glossary-tooltip title="A lightweight container runtime specifically for Kubernetes" data-toggle=tooltip data-placement=top href=https://cri-o.io/#what-is-cri-o target=_blank aria-label=CRI-O>CRI-O</a></li>
</ul>
</li>
<li>Certificate generation methods</li>
</ul>
<p>Kubespray customizations can be made to a <a href=https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html>variable file</a>. If you are getting started with Kubespray, consider using the Kubespray defaults to deploy your cluster and explore Kubernetes.</p>
<h3 id=4-5-deploy-a-cluster>(4/5) Deploy a Cluster</h3>
<p>Next, deploy your cluster:</p>
<p>Cluster deployment using <a href=https://github.com/kubernetes-sigs/kubespray/blob/master/docs/getting-started.md#starting-custom-deployment>ansible-playbook</a>.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>ansible-playbook -i your/inventory/inventory.ini cluster.yml -b -v <span style=color:#b62;font-weight:700>\
</span><span style=color:#b62;font-weight:700></span>  --private-key<span style=color:#666>=</span>~/.ssh/private_key
</code></pre></div><p>Large deployments (100+ nodes) may require <a href=https://github.com/kubernetes-sigs/kubespray/blob/master/docs/large-deployments.md>specific adjustments</a> for best results.</p>
<h3 id=5-5-verify-the-deployment>(5/5) Verify the deployment</h3>
<p>Kubespray provides a way to verify inter-pod connectivity and DNS resolve with <a href=https://github.com/kubernetes-sigs/kubespray/blob/master/docs/netcheck.md>Netchecker</a>. Netchecker ensures the netchecker-agents pods can resolve DNS requests and ping each over within the default namespace. Those pods mimic similar behavior as the rest of the workloads and serve as cluster health indicators.</p>
<h2 id=cluster-operations>Cluster operations</h2>
<p>Kubespray provides additional playbooks to manage your cluster: <em>scale</em> and <em>upgrade</em>.</p>
<h3 id=scale-your-cluster>Scale your cluster</h3>
<p>You can add worker nodes from your cluster by running the scale playbook. For more information, see "<a href=https://github.com/kubernetes-sigs/kubespray/blob/master/docs/getting-started.md#adding-nodes>Adding nodes</a>".
You can remove worker nodes from your cluster by running the remove-node playbook. For more information, see "<a href=https://github.com/kubernetes-sigs/kubespray/blob/master/docs/getting-started.md#remove-nodes>Remove nodes</a>".</p>
<h3 id=upgrade-your-cluster>Upgrade your cluster</h3>
<p>You can upgrade your cluster by running the upgrade-cluster playbook. For more information, see "<a href=https://github.com/kubernetes-sigs/kubespray/blob/master/docs/upgrades.md>Upgrades</a>".</p>
<h2 id=cleanup>Cleanup</h2>
<p>You can reset your nodes and wipe out all components installed with Kubespray via the <a href=https://github.com/kubernetes-sigs/kubespray/blob/master/reset.yml>reset playbook</a>.</p>
<div class="alert alert-warning caution callout" role=alert>
<strong>Caution:</strong> When running the reset playbook, be sure not to accidentally target your production cluster!
</div>
<h2 id=feedback>Feedback</h2>
<ul>
<li>Slack Channel: <a href=https://kubernetes.slack.com/messages/kubespray/>#kubespray</a> (You can get your invite <a href=https://slack.k8s.io/>here</a>)</li>
<li><a href=https://github.com/kubernetes-sigs/kubespray/issues>GitHub Issues</a></li>
</ul>
<h2 id=what-s-next>What's next</h2>
<p>Check out planned work on Kubespray's <a href=https://github.com/kubernetes-sigs/kubespray/blob/master/docs/roadmap.md>roadmap</a>.</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-d2f55eefe7222b7c637875af9c3ec199>3 - Turnkey Cloud Solutions</h1>
<p>This page provides a list of Kubernetes certified solution providers. From each
provider page, you can learn how to install and setup production
ready clusters.</p>
<script>function updateLandscapeSource(a,b){console.log({button:a,shouldUpdateFragment:b});try{if(b)window.location.hash="#"+a.id;else{var c=document.querySelectorAll("#landscape");let b=a.dataset.landscapeTypes,d="https://landscape.cncf.io/card-mode?category="+encodeURIComponent(b)+"&grouping=category&embed=yes";c[0].src=d}}catch(a){console.log({message:"error handling Landscape switch",error:a})}}document.addEventListener("DOMContentLoaded",function(){var c,a;let b=()=>{if(window.location.hash){let a=document.querySelectorAll(".landscape-trigger"+window.location.hash);a.length==1&&(landscapeSource=a[0],console.log("Updating Landscape source based on fragment:",window.location.hash.substring(1)),updateLandscapeSource(landscapeSource,!1))}};if(c=document.querySelectorAll(".landscape-trigger"),c.forEach(a=>{a.onclick=function(){updateLandscapeSource(a,!0)}}),a=document.querySelectorAll(".landscape-trigger.landscape-default"),a.length==1){let b=a[0];updateLandscapeSource(b,!1)}window.addEventListener("hashchange",b,!1),b()})</script><div id=frameHolder>
<iframe frameborder=0 id=landscape scrolling=no src="https://landscape.cncf.io/card-mode?category=certified-kubernetes-hosted&grouping=category&embed=yes" style=width:1px;min-width:100%></iframe>
<script src=https://landscape.cncf.io/iframeResizer.js></script>
</div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-acce7e24090fea04715a7a516ba3e69b>4 - Windows in Kubernetes</h1>
</div>
<div class=td-content>
<h1 id=pg-a307d413f1f7430fced233023087e2a1>4.1 - Windows containers in Kubernetes</h1>
<p>Windows applications constitute a large portion of the services and applications that
run in many organizations. <a href=https://aka.ms/windowscontainers>Windows containers</a>
provide a way to encapsulate processes and package dependencies, making it easier
to use DevOps practices and follow cloud native patterns for Windows applications.</p>
<p>Organizations with investments in Windows-based applications and Linux-based
applications don't have to look for separate orchestrators to manage their workloads,
leading to increased operational efficiencies across their deployments, regardless
of operating system.</p>
<h2 id=windows-nodes-in-kubernetes>Windows nodes in Kubernetes</h2>
<p>To enable the orchestration of Windows containers in Kubernetes, include Windows nodes
in your existing Linux cluster. Scheduling Windows containers in
<a class=glossary-tooltip title="A Pod represents a set of running containers in your cluster." data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/pods/ target=_blank aria-label=Pods>Pods</a> on Kubernetes is similar to
scheduling Linux-based containers.</p>
<p>In order to run Windows containers, your Kubernetes cluster must include
multiple operating systems.
While you can only run the <a class=glossary-tooltip title="The container orchestration layer that exposes the API and interfaces to define, deploy, and manage the lifecycle of containers." data-toggle=tooltip data-placement=top href="/docs/reference/glossary/?all=true#term-control-plane" target=_blank aria-label="control plane">control plane</a> on Linux, you can deploy worker nodes running either Windows or Linux depending on your workload needs.</p>
<p>Windows <a class=glossary-tooltip title="A node is a worker machine in Kubernetes." data-toggle=tooltip data-placement=top href=/docs/concepts/architecture/nodes/ target=_blank aria-label=nodes>nodes</a> are
<a href=#windows-os-version-support>supported</a> provided that the operating system is
Windows Server 2019.</p>
<p>This document uses the term <em>Windows containers</em> to mean Windows containers with
process isolation. Kubernetes does not support running Windows containers with
<a href=https://docs.microsoft.com/en-us/virtualization/windowscontainers/manage-containers/hyperv-container>Hyper-V isolation</a>.</p>
<h2 id=resource-management>Resource management</h2>
<p>On Linux nodes, <a class=glossary-tooltip title="A group of Linux processes with optional resource isolation, accounting and limits." data-toggle=tooltip data-placement=top href="/docs/reference/glossary/?all=true#term-cgroup" target=_blank aria-label=cgroups>cgroups</a> are used
as a pod boundary for resource control. Containers are created within that boundary
for network, process and file system isolation. The Linux cgroup APIs can be used
to gather CPU, I/O, and memory use statistics.</p>
<p>In contrast, Windows uses a <em>job object</em> per container with a system namespace filter
to contain all processes in a container and provide logical isolation from the
host.
(Job objects are a Windows process isolation mechanism and are different from
what Kubernetes refers to as a <a class=glossary-tooltip title="A finite or batch task that runs to completion." data-toggle=tooltip data-placement=top href=/docs/concepts/workloads/controllers/job/ target=_blank aria-label=Job>Job</a>).</p>
<p>There is no way to run a Windows container without the namespace filtering in
place. This means that system privileges cannot be asserted in the context of the
host, and thus privileged containers are not available on Windows.
Containers cannot assume an identity from the host because the Security Account Manager
(SAM) is separate.</p>
<h4 id=resource-management-memory>Memory reservations</h4>
<p>Windows does not have an out-of-memory process killer as Linux does. Windows always
treats all user-mode memory allocations as virtual, and pagefiles are mandatory
(on Linux, the kubelet will by default not start with swap space enabled).</p>
<p>Windows nodes do not overcommit memory for processes running in containers. The
net effect is that Windows won't reach out of memory conditions the same way Linux
does, and processes page to disk instead of being subject to out of memory (OOM)
termination. If memory is over-provisioned and all physical memory is exhausted,
then paging can slow down performance.</p>
<p>You can place bounds on memory use for workloads using the kubelet
parameters <code>--kubelet-reserve</code> and/or <code>--system-reserve</code>; these account
for memory usage on the node (outside of containers), and reduce
<a href=/docs/tasks/administer-cluster/reserve-compute-resources/#node-allocatable>NodeAllocatable</a>.
As you deploy workloads, set resource limits on containers. This also subtracts from
<code>NodeAllocatable</code> and prevents the scheduler from adding more pods once a node is full.</p>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> When you set memory resource limits for Windows containers, you should either set a
limit and leave the memory request unspecified, or set the request equal to the limit.
</div>
<p>On Windows, good practice to avoid over-provisioning is to configure the kubelet
with a system reserved memory of at least 2GiB to account for Windows, Kubernetes
and container runtime overheads.</p>
<h4 id=resource-management-cpu>CPU reservations</h4>
<p>To account for CPU use by the operating system, the container runtime, and by
Kubernetes host processes such as the kubelet, you can (and should) reserve a
percentage of total CPU. You should determine this CPU reservation taking account of
to the number of CPU cores available on the node. To decide on the CPU percentage to
reserve, identify the maximum pod density for each node and monitor the CPU usage of
the system services running there, then choose a value that meets your workload needs.</p>
<p>You can place bounds on CPU usage for workloads using the
kubelet parameters <code>--kubelet-reserve</code> and/or <code>--system-reserve</code> to
account for CPU usage on the node (outside of containers).
This reduces <code>NodeAllocatable</code>.
The cluster-wide scheduler then takes this reservation into account when determining
pod placement.</p>
<p>On Windows, the kubelet supports a command-line flag to set the priority of the
kubelet process: <code>--windows-priorityclass</code>. This flag allows the kubelet process to get
more CPU time slices when compared to other processes running on the Windows host.
More information on the allowable values and their meaning is available at
<a href=https://docs.microsoft.com/en-us/windows/win32/procthread/scheduling-priorities#priority-class>Windows Priority Classes</a>.
To ensure that running Pods do not starve the kubelet of CPU cycles, set this flag to <code>ABOVE_NORMAL_PRIORITY_CLASS</code> or above.</p>
<h2 id=limitations>Compatibility and limitations</h2>
<p>Some node features are only available if you use a specific
<a href=#container-runtime>container runtime</a>; others are not available on Windows nodes,
including:</p>
<ul>
<li>HugePages: not supported for Windows containers</li>
<li>Privileged containers: not supported for Windows containers</li>
<li>TerminationGracePeriod: requires containerD</li>
</ul>
<p>Not all features of shared namespaces are supported. See <a href=#api>API compatibility</a>
for more details.</p>
<p>See <a href=#windows-os-version-support>Windows OS version compatibility</a> for details on
the Windows versions that Kubernetes is tested against.</p>
<p>From an API and kubectl perspective, Windows containers behave in much the same
way as Linux-based containers. However, there are some notable differences in key
functionality which are outlined in this section.</p>
<h3 id=compatibility-linux-similarities>Comparison with Linux</h3>
<p>Key Kubernetes elements work the same way in Windows as they do in Linux. This
section refers to several key workload enablers and how they map to Windows.</p>
<ul>
<li>
<p><a href=/docs/concepts/workloads/pods/>Pods</a></p>
<p>A Pod is the basic building block of Kubernetes–the smallest and simplest unit in
the Kubernetes object model that you create or deploy. You may not deploy Windows and
Linux containers in the same Pod. All containers in a Pod are scheduled onto a single
Node where each Node represents a specific platform and architecture. The following
Pod capabilities, properties and events are supported with Windows containers:</p>
<ul>
<li>Single or multiple containers per Pod with process isolation and volume sharing</li>
<li>Pod <code>status</code> fields</li>
<li>Readiness and Liveness probes</li>
<li>postStart & preStop container lifecycle events</li>
<li>ConfigMap, Secrets: as environment variables or volumes</li>
<li><code>emptyDir</code> volumes</li>
<li>Named pipe host mounts</li>
<li>Resource limits</li>
<li>OS field:
<div style=margin-top:10px;margin-bottom:10px>
<b>FEATURE STATE:</b> <code>Kubernetes v1.23 [alpha]</code>
</div>
<code>.spec.os.name</code> should be set to <code>windows</code> to indicate that the current Pod uses Windows containers.
<code>IdentifyPodOS</code> feature gate needs to be enabled for this field to be recognized and used by control plane
components and kubelet.
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> <p>If the <code>IdentifyPodOS</code> feature gate is enabled and you set the <code>.spec.os.name</code> field to <code>windows</code>, you must not set the following fields in the <code>.spec</code> of that Pod:
* <code>spec.hostPID</code>
* <code>spec.hostIPC</code>
* <code>spec.securityContext.seLinuxOptions</code>
* <code>spec.securityContext.seccompProfile</code>
* <code>spec.securityContext.fsGroup</code>
* <code>spec.securityContext.fsGroupChangePolicy</code>
* <code>spec.securityContext.sysctls</code>
* <code>spec.shareProcessNamespace</code>
* <code>spec.securityContext.runAsUser</code>
* <code>spec.securityContext.runAsGroup</code>
* <code>spec.securityContext.supplementalGroups</code>
* <code>spec.containers[*].securityContext.seLinuxOptions</code>
* <code>spec.containers[*].securityContext.seccompProfile</code>
* <code>spec.containers[*].securityContext.capabilities</code>
* <code>spec.containers[*].securityContext.readOnlyRootFilesystem</code>
* <code>spec.containers[*].securityContext.privileged</code>
* <code>spec.containers[*].securityContext.allowPrivilegeEscalation</code>
* <code>spec.containers[*].securityContext.procMount</code>
* <code>spec.containers[*].securityContext.runAsUser</code>
* <code>spec.containers[*].securityContext.runAsGroup</code></p>
<pre><code>        Note: In this table, wildcards (*) indicate all elements in a list. For example, spec.containers[*].securityContext refers to the Security Context object for all defined containers. If not, Pod API validation would fail causing admission failures.</code></pre>
</div></li>
</ul>
</li>
<li>
<p><a href=/docs/concepts/workloads/controllers/>Workload resources</a> including:</p>
<ul>
<li>ReplicaSet</li>
<li>Deployments</li>
<li>StatefulSets</li>
<li>DaemonSet</li>
<li>Job</li>
<li>CronJob</li>
<li>ReplicationController</li>
</ul>
</li>
<li>
<p><a class=glossary-tooltip title="A way to expose an application running on a set of Pods as a network service." data-toggle=tooltip data-placement=top href=/docs/concepts/services-networking/service/ target=_blank aria-label=Services>Services</a>
See <a href=#load-balancing-and-services>Load balancing and Services</a> for more details.</p>
</li>
</ul>
<p>Pods, workload resources, and Services are critical elements to managing Windows
workloads on Kubernetes. However, on their own they are not enough to enable
the proper lifecycle management of Windows workloads in a dynamic cloud native
environment. Kubernetes also supports:</p>
<ul>
<li><code>kubectl exec</code></li>
<li>Pod and container metrics</li>
<li><a class=glossary-tooltip title="An API resource that automatically scales the number of pod replicas based on targeted CPU utilization or custom metric targets." data-toggle=tooltip data-placement=top href=/docs/tasks/run-application/horizontal-pod-autoscale/ target=_blank aria-label="Horizontal pod autoscaling">Horizontal pod autoscaling</a></li>
<li><a class=glossary-tooltip title="Provides constraints that limit aggregate resource consumption per namespace." data-toggle=tooltip data-placement=top href=/docs/concepts/policy/resource-quotas/ target=_blank aria-label="Resource quotas">Resource quotas</a></li>
<li>Scheduler preemption</li>
</ul>
<h3 id=compatibility-networking>Networking on Windows nodes</h3>
<p>Networking for Windows containers is exposed through
<a href=/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/>CNI plugins</a>.
Windows containers function similarly to virtual machines in regards to
networking. Each container has a virtual network adapter (vNIC) which is connected
to a Hyper-V virtual switch (vSwitch). The Host Networking Service (HNS) and the
Host Compute Service (HCS) work together to create containers and attach container
vNICs to networks. HCS is responsible for the management of containers whereas HNS
is responsible for the management of networking resources such as:</p>
<ul>
<li>Virtual networks (including creation of vSwitches)</li>
<li>Endpoints / vNICs</li>
<li>Namespaces</li>
<li>Policies including packet encapsulations, load-balancing rules, ACLs, and NAT rules.</li>
</ul>
<h4 id=networking>Container networking</h4>
<p>The Windows HNS and vSwitch implement namespacing and can
create virtual NICs as needed for a pod or container. However, many configurations such
as DNS, routes, and metrics are stored in the Windows registry database rather than as
files inside <code>/etc</code>, which is how Linux stores those configurations. The Windows registry for the container
is separate from that of the host, so concepts like mapping <code>/etc/resolv.conf</code> from
the host into a container don't have the same effect they would on Linux. These must
be configured using Windows APIs run in the context of that container. Therefore
CNI implementations need to call the HNS instead of relying on file mappings to pass
network details into the pod or container.</p>
<p>The following networking functionality is <em>not</em> supported on Windows nodes:</p>
<ul>
<li>Host networking mode</li>
<li>Local NodePort access from the node itself (works for other nodes or external clients)</li>
<li>More than 64 backend pods (or unique destination addresses) for a single Service</li>
<li>IPv6 communication between Windows pods connected to overlay networks</li>
<li>Local Traffic Policy in non-DSR mode</li>
<li>Outbound communication using the ICMP protocol via the <code>win-overlay</code>, <code>win-bridge</code>, or using the Azure-CNI plugin.<br>
Specifically, the Windows data plane (<a href=https://www.microsoft.com/en-us/research/project/azure-virtual-filtering-platform/>VFP</a>) doesn't support ICMP packet transpositions, and this means:
<ul>
<li>ICMP packets directed to destinations within the same network (such as pod to pod communication via ping) work as expected and without any limitations;</li>
<li>TCP/UDP packets work as expected and without any limitations;</li>
<li>ICMP packets directed to pass through a remote network (e.g. pod to external internet communication via ping) cannot be transposed and thus will not be routed back to their source;</li>
<li>Since TCP/UDP packets can still be transposed, you can substitute <code>ping &lt;destination></code> with <code>curl &lt;destination></code> to get some debugging insight into connectivity with the outside world.</li>
</ul>
</li>
</ul>
<p>Overlay networking support in kube-proxy is a beta feature. In addition, it requires
<a href=https://support.microsoft.com/en-us/help/4482887/windows-10-update-kb4482887>KB4482887</a>
to be installed on Windows Server 2019.</p>
<h4 id=network-modes>Network modes</h4>
<p>Windows supports five different networking drivers/modes: L2bridge, L2tunnel,
Overlay (beta), Transparent, and NAT. In a heterogeneous cluster with Windows and Linux
worker nodes, you need to select a networking solution that is compatible on both
Windows and Linux. The following out-of-tree plugins are supported on Windows,
with recommendations on when to use each CNI:</p>
<table>
<thead>
<tr>
<th>Network Driver</th>
<th>Description</th>
<th>Container Packet Modifications</th>
<th>Network Plugins</th>
<th>Network Plugin Characteristics</th>
</tr>
</thead>
<tbody>
<tr>
<td>L2bridge</td>
<td>Containers are attached to an external vSwitch. Containers are attached to the underlay network, although the physical network doesn't need to learn the container MACs because they are rewritten on ingress/egress.</td>
<td>MAC is rewritten to host MAC, IP may be rewritten to host IP using HNS OutboundNAT policy.</td>
<td><a href=https://github.com/containernetworking/plugins/tree/master/plugins/main/windows/win-bridge>win-bridge</a>, <a href=https://github.com/Azure/azure-container-networking/blob/master/docs/cni.md>Azure-CNI</a>, Flannel host-gateway uses win-bridge</td>
<td>win-bridge uses L2bridge network mode, connects containers to the underlay of hosts, offering best performance. Requires user-defined routes (UDR) for inter-node connectivity.</td>
</tr>
<tr>
<td>L2Tunnel</td>
<td>This is a special case of l2bridge, but only used on Azure. All packets are sent to the virtualization host where SDN policy is applied.</td>
<td>MAC rewritten, IP visible on the underlay network</td>
<td><a href=https://github.com/Azure/azure-container-networking/blob/master/docs/cni.md>Azure-CNI</a></td>
<td>Azure-CNI allows integration of containers with Azure vNET, and allows them to leverage the set of capabilities that <a href=https://azure.microsoft.com/en-us/services/virtual-network/>Azure Virtual Network provides</a>. For example, securely connect to Azure services or use Azure NSGs. See <a href=https://docs.microsoft.com/en-us/azure/aks/concepts-network#azure-cni-advanced-networking>azure-cni for some examples</a></td>
</tr>
<tr>
<td>Overlay (Overlay networking for Windows in Kubernetes is in <em>alpha</em> stage)</td>
<td>Containers are given a vNIC connected to an external vSwitch. Each overlay network gets its own IP subnet, defined by a custom IP prefix.The overlay network driver uses VXLAN encapsulation.</td>
<td>Encapsulated with an outer header.</td>
<td><a href=https://github.com/containernetworking/plugins/tree/master/plugins/main/windows/win-overlay>win-overlay</a>, Flannel VXLAN (uses win-overlay)</td>
<td>win-overlay should be used when virtual container networks are desired to be isolated from underlay of hosts (e.g. for security reasons). Allows for IPs to be re-used for different overlay networks (which have different VNID tags) if you are restricted on IPs in your datacenter. This option requires <a href=https://support.microsoft.com/help/4489899>KB4489899</a> on Windows Server 2019.</td>
</tr>
<tr>
<td>Transparent (special use case for <a href=https://github.com/openvswitch/ovn-kubernetes>ovn-kubernetes</a>)</td>
<td>Requires an external vSwitch. Containers are attached to an external vSwitch which enables intra-pod communication via logical networks (logical switches and routers).</td>
<td>Packet is encapsulated either via <a href=https://datatracker.ietf.org/doc/draft-gross-geneve/>GENEVE</a> or <a href=https://datatracker.ietf.org/doc/draft-davie-stt/>STT</a> tunneling to reach pods which are not on the same host. <br> Packets are forwarded or dropped via the tunnel metadata information supplied by the ovn network controller. <br> NAT is done for north-south communication.</td>
<td><a href=https://github.com/openvswitch/ovn-kubernetes>ovn-kubernetes</a></td>
<td><a href=https://github.com/openvswitch/ovn-kubernetes/tree/master/contrib>Deploy via ansible</a>. Distributed ACLs can be applied via Kubernetes policies. IPAM support. Load-balancing can be achieved without kube-proxy. NATing is done without using iptables/netsh.</td>
</tr>
<tr>
<td>NAT (<em>not used in Kubernetes</em>)</td>
<td>Containers are given a vNIC connected to an internal vSwitch. DNS/DHCP is provided using an internal component called <a href=https://techcommunity.microsoft.com/t5/virtualization/windows-nat-winnat-capabilities-and-limitations/ba-p/382303>WinNAT</a></td>
<td>MAC and IP is rewritten to host MAC/IP.</td>
<td><a href=https://github.com/Microsoft/windows-container-networking/tree/master/plugins/nat>nat</a></td>
<td>Included here for completeness</td>
</tr>
</tbody>
</table>
<p>As outlined above, the <a href=https://github.com/coreos/flannel>Flannel</a>
CNI <a href=https://github.com/containernetworking/plugins/tree/master/plugins/meta/flannel>meta plugin</a>
is also <a href=https://github.com/containernetworking/plugins/tree/master/plugins/meta/flannel#windows-support-experimental>supported</a> on Windows via the
<a href=https://github.com/coreos/flannel/blob/master/Documentation/backends.md#vxlan>VXLAN network backend</a> (<strong>alpha support</strong> ; delegates to win-overlay)
and <a href=https://github.com/coreos/flannel/blob/master/Documentation/backends.md#host-gw>host-gateway network backend</a> (stable support; delegates to win-bridge).</p>
<p>This plugin supports delegating to one of the reference CNI plugins (win-overlay,
win-bridge), to work in conjunction with Flannel daemon on Windows (Flanneld) for
automatic node subnet lease assignment and HNS network creation. This plugin reads
in its own configuration file (cni.conf), and aggregates it with the environment
variables from the FlannelD generated subnet.env file. It then delegates to one of
the reference CNI plugins for network plumbing, and sends the correct configuration
containing the node-assigned subnet to the IPAM plugin (for example: <code>host-local</code>).</p>
<p>For Node, Pod, and Service objects, the following network flows are supported for
TCP/UDP traffic:</p>
<ul>
<li>Pod → Pod (IP)</li>
<li>Pod → Pod (Name)</li>
<li>Pod → Service (Cluster IP)</li>
<li>Pod → Service (PQDN, but only if there are no ".")</li>
<li>Pod → Service (FQDN)</li>
<li>Pod → external (IP)</li>
<li>Pod → external (DNS)</li>
<li>Node → Pod</li>
<li>Pod → Node</li>
</ul>
<h4 id=cni-plugin-limitations>CNI plugin limitations</h4>
<ul>
<li>Windows reference network plugins win-bridge and win-overlay do not implement
<a href=https://github.com/containernetworking/cni/blob/master/SPEC.md>CNI spec</a> v0.4.0,
due to a missing <code>CHECK</code> implementation.</li>
<li>The Flannel VXLAN CNI plugin has the following limitations on Windows:</li>
</ul>
<ol>
<li>Node-pod connectivity isn't possible by design. It's only possible for local pods with Flannel v0.12.0 (or higher).</li>
<li>Flannel is restricted to using VNI 4096 and UDP port 4789. See the official
<a href=https://github.com/coreos/flannel/blob/master/Documentation/backends.md#vxlan>Flannel VXLAN</a>
backend docs for more details on these parameters.</li>
</ol>
<h4 id=ipam>IP address management (IPAM)</h4>
<p>The following IPAM options are supported on Windows:</p>
<ul>
<li><a href=https://github.com/containernetworking/plugins/tree/master/plugins/ipam/host-local>host-local</a></li>
<li>HNS IPAM (Inbox platform IPAM, this is a fallback when no IPAM is set)</li>
<li><a href=https://github.com/Azure/azure-container-networking/blob/master/docs/ipam.md>azure-vnet-ipam</a> (for azure-cni only)</li>
</ul>
<h4 id=load-balancing-and-services>Load balancing and Services</h4>
<p>A Kubernetes <a class=glossary-tooltip title="A way to expose an application running on a set of Pods as a network service." data-toggle=tooltip data-placement=top href=/docs/concepts/services-networking/service/ target=_blank aria-label=Service>Service</a> is an abstraction
that defines a logical set of Pods and a means to access them over a network.
In a cluster that includes Windows nodes, you can use the following types of Service:</p>
<ul>
<li><code>NodePort</code></li>
<li><code>ClusterIP</code></li>
<li><code>LoadBalancer</code></li>
<li><code>ExternalName</code></li>
</ul>
<div class="alert alert-danger warning callout" role=alert>
<strong>Warning:</strong> <p>There are known issue with NodePort services on overlay networking, if the target destination node is running Windows Server 2022.
To avoid the issue entirely, you can configure the service with <code>externalTrafficPolicy: Local</code>.</p>
<p>There are known issues with pod to pod connectivity on l2bridge network on Windows Server 2022 with KB5005619 or higher installed.
To workaround the issue and restore pod-pod connectivity, you can disable the WinDSR feature in kube-proxy.</p>
<p>These issues require OS fixes.
Please follow <a href=https://github.com/microsoft/Windows-Containers/issues/204>https://github.com/microsoft/Windows-Containers/issues/204</a> for updates.</p>
</div>
<p>Windows container networking differs in some important ways from Linux networking.
The <a href=https://docs.microsoft.com/en-us/virtualization/windowscontainers/container-networking/architecture>Microsoft documentation for Windows Container Networking</a> provides
additional details and background.</p>
<p>On Windows, you can use the following settings to configure Services and load
balancing behavior:</p>
<table><caption style=display:none>Windows Service Settings</caption>
<thead>
<tr>
<th>Feature</th>
<th>Description</th>
<th>Supported Kubernetes version</th>
<th>Supported Windows OS build</th>
<th>How to enable</th>
</tr>
</thead>
<tbody>
<tr>
<td>Session affinity</td>
<td>Ensures that connections from a particular client are passed to the same Pod each time.</td>
<td>v1.20+</td>
<td><a href=https://blogs.windows.com/windowsexperience/2020/01/28/announcing-windows-server-vnext-insider-preview-build-19551/>Windows Server vNext Insider Preview Build 19551</a> (or higher)</td>
<td>Set <code>service.spec.sessionAffinity</code> to "ClientIP"</td>
</tr>
<tr>
<td>Direct Server Return (DSR)</td>
<td>Load balancing mode where the IP address fixups and the LBNAT occurs at the container vSwitch port directly; service traffic arrives with the source IP set as the originating pod IP.</td>
<td>v1.20+</td>
<td>Windows Server 2019</td>
<td>Set the following flags in kube-proxy: <code>--feature-gates="WinDSR=true" --enable-dsr=true</code></td>
</tr>
<tr>
<td>Preserve-Destination</td>
<td>Skips DNAT of service traffic, thereby preserving the virtual IP of the target service in packets reaching the backend Pod. Also disables node-node forwarding.</td>
<td>v1.20+</td>
<td>Windows Server, version 1903 (or higher)</td>
<td>Set <code>"preserve-destination": "true"</code> in service annotations and enable DSR in kube-proxy.</td>
</tr>
<tr>
<td>IPv4/IPv6 dual-stack networking</td>
<td>Native IPv4-to-IPv4 in parallel with IPv6-to-IPv6 communications to, from, and within a cluster</td>
<td>v1.19+</td>
<td>Windows Server, version 2019</td>
<td>See <a href=#ipv4ipv6-dual-stack>IPv4/IPv6 dual-stack</a></td>
</tr>
<tr>
<td>Client IP preservation</td>
<td>Ensures that source IP of incoming ingress traffic gets preserved. Also disables node-node forwarding.</td>
<td>v1.20+</td>
<td>Windows Server, version 2019</td>
<td>Set <code>service.spec.externalTrafficPolicy</code> to "Local" and enable DSR in kube-proxy</td>
</tr>
</tbody>
</table>
<h5 id=session-affinity>Session affinity</h5>
<p>Setting the maximum session sticky time for Windows services using
<code>service.spec.sessionAffinityConfig.clientIP.timeoutSeconds</code> is not supported.</p>
<h4 id=dns-limitations>DNS</h4>
<ul>
<li>ClusterFirstWithHostNet is not supported for DNS. Windows treats all names with a
<code>.</code> as a FQDN and skips FQDN resolution</li>
<li>On Linux, you have a DNS suffix list, which is used when trying to resolve PQDNs. On
Windows, you can only have 1 DNS suffix, which is the DNS suffix associated with that
pod's namespace (mydns.svc.cluster.local for example). Windows can resolve FQDNs
and services or names resolvable with just that suffix. For example, a pod spawned
in the default namespace, will have the DNS suffix <strong>default.svc.cluster.local</strong>.
Inside a Windows pod, you can resolve both <strong>kubernetes.default.svc.cluster.local</strong>
and <strong>kubernetes</strong>, but not the in-betweens, like <strong>kubernetes.default</strong> or
<strong>kubernetes.default.svc</strong>.</li>
<li>On Windows, there are multiple DNS resolvers that can be used. As these come with
slightly different behaviors, using the <code>Resolve-DNSName</code> utility for name query
resolutions is recommended.</li>
</ul>
<h4 id=ipv6-networking>IPv6 networking</h4>
<p>Kubernetes on Windows does not support single-stack "IPv6-only" networking. However,
dual-stack IPv4/IPv6 networking for pods and nodes with single-family services
is supported.</p>
<p>You can use IPv4/IPv6 dual-stack networking with <code>l2bridge</code> networks. See <a href=/docs/concepts/services-networking/dual-stack#configure-ipv4-ipv6-dual-stack>configure IPv4/IPv6 dual stack</a> for more details.</p>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> Overlay (VXLAN) networks on Windows do not support dual-stack networking.
</div>
<h3 id=compatibility-storage>Persistent storage</h3>
<p>Windows has a layered filesystem driver to mount container layers and create a copy
filesystem based on NTFS. All file paths in the container are resolved only within
the context of that container.</p>
<ul>
<li>With Docker, volume mounts can only target a directory in the container, and not
an individual file. This limitation does not exist with CRI-containerD runtime.</li>
<li>Volume mounts cannot project files or directories back to the host filesystem.</li>
<li>Read-only filesystems are not supported because write access is always required
for the Windows registry and SAM database. However, read-only volumes are supported.</li>
<li>Volume user-masks and permissions are not available. Because the SAM is not shared
between the host & container, there's no mapping between them. All permissions are
resolved within the context of the container.</li>
</ul>
<p>As a result, the following storage functionality is not supported on Windows nodes:</p>
<ul>
<li>Volume subpath mounts: only the entire volume can be mounted in a Windows container</li>
<li>Subpath volume mounting for Secrets</li>
<li>Host mount projection</li>
<li>Read-only root filesystem (mapped volumes still support <code>readOnly</code>)</li>
<li>Block device mapping</li>
<li>Memory as the storage medium (for example, <code>emptyDir.medium</code> set to <code>Memory</code>)</li>
<li>File system features like uid/gid; per-user Linux filesystem permissions</li>
<li>DefaultMode (due to UID/GID dependency)</li>
<li>NFS based storage/volume support</li>
<li>Expanding the mounted volume (resizefs)</li>
</ul>
<p>Kubernetes <a class=glossary-tooltip title="A directory containing data, accessible to the containers in a pod." data-toggle=tooltip data-placement=top href=/docs/concepts/storage/volumes/ target=_blank aria-label=volumes>volumes</a> enable complex
applications, with data persistence and Pod volume sharing requirements, to be deployed
on Kubernetes. Management of persistent volumes associated with a specific storage
back-end or protocol includes actions such as provisioning/de-provisioning/resizing
of volumes, attaching/detaching a volume to/from a Kubernetes node and
mounting/dismounting a volume to/from individual containers in a pod that needs to
persist data.</p>
<p>The code implementing these volume management actions for a specific storage back-end
or protocol is shipped in the form of a Kubernetes volume
<a href=/docs/concepts/storage/volumes/#types-of-volumes>plugin</a>.
The following broad classes of Kubernetes volume plugins are supported on Windows:</p>
<h5 id=in-tree-volume-plugins>In-tree volume plugins</h5>
<p>Code associated with in-tree volume plugins ship as part of the core Kubernetes code
base. Deployment of in-tree volume plugins do not require installation of additional
scripts or deployment of separate containerized plugin components. These plugins can
handle provisioning/de-provisioning and resizing of volumes in the storage backend,
attaching/detaching of volumes to/from a Kubernetes node and mounting/dismounting a
volume to/from individual containers in a pod. The following in-tree plugins support
persistent storage on Windows nodes:</p>
<ul>
<li><a href=/docs/concepts/storage/volumes/#awselasticblockstore><code>awsElasticBlockStore</code></a></li>
<li><a href=/docs/concepts/storage/volumes/#azuredisk><code>azureDisk</code></a></li>
<li><a href=/docs/concepts/storage/volumes/#azurefile><code>azureFile</code></a></li>
<li><a href=/docs/concepts/storage/volumes/#gcepersistentdisk><code>gcePersistentDisk</code></a></li>
<li><a href=/docs/concepts/storage/volumes/#vspherevolume><code>vsphereVolume</code></a></li>
</ul>
<h4 id=flexvolume-plugins>FlexVolume plugins</h4>
<p>Code associated with <a href=/docs/concepts/storage/volumes/#flexVolume>FlexVolume</a>
plugins ship as out-of-tree scripts or binaries that need to be deployed directly
on the host. FlexVolume plugins handle attaching/detaching of volumes to/from a
Kubernetes node and mounting/dismounting a volume to/from individual containers
in a pod. Provisioning/De-provisioning of persistent volumes associated
with FlexVolume plugins may be handled through an external provisioner that
is typically separate from the FlexVolume plugins. The following FlexVolume
<a href=https://github.com/Microsoft/K8s-Storage-Plugins/tree/master/flexvolume/windows>plugins</a>,
deployed as PowerShell scripts on the host, support Windows nodes:</p>
<ul>
<li><a href=https://github.com/microsoft/K8s-Storage-Plugins/tree/master/flexvolume/windows/plugins/microsoft.com~smb.cmd>SMB</a></li>
<li><a href=https://github.com/microsoft/K8s-Storage-Plugins/tree/master/flexvolume/windows/plugins/microsoft.com~iscsi.cmd>iSCSI</a></li>
</ul>
<h4 id=csi-plugins>CSI plugins</h4>
<div style=margin-top:10px;margin-bottom:10px>
<b>FEATURE STATE:</b> <code>Kubernetes v1.19 [beta]</code>
</div>
<p>Code associated with <a class=glossary-tooltip title="The Container Storage Interface (CSI) defines a standard interface to expose storage systems to containers." data-toggle=tooltip data-placement=top href=/docs/concepts/storage/volumes/#csi target=_blank aria-label=CSI>CSI</a> plugins ship
as out-of-tree scripts and binaries that are typically distributed as container
images and deployed using standard Kubernetes constructs like DaemonSets and
StatefulSets.
CSI plugins handle a wide range of volume management actions in Kubernetes:
provisioning/de-provisioning/resizing of volumes, attaching/detaching of volumes
to/from a Kubernetes node and mounting/dismounting a volume to/from individual
containers in a pod, backup/restore of persistent data using snapshots and cloning.
CSI plugins typically consist of node plugins (that run on each node as a DaemonSet)
and controller plugins.</p>
<p>CSI node plugins (especially those associated with persistent volumes exposed as
either block devices or over a shared file-system) need to perform various privileged
operations like scanning of disk devices, mounting of file systems, etc. These
operations differ for each host operating system. For Linux worker nodes, containerized
CSI node plugins are typically deployed as privileged containers. For Windows worker
nodes, privileged operations for containerized CSI node plugins is supported using
<a href=https://github.com/kubernetes-csi/csi-proxy>csi-proxy</a>, a community-managed,
stand-alone binary that needs to be pre-installed on each Windows node.</p>
<p>For more details, refer to the deployment guide of the CSI plugin you wish to deploy.</p>
<h3 id=kubelet-compatibility>Command line options for the kubelet</h3>
<p>The behavior of some kubelet command line options behave differently on Windows, as described below:</p>
<ul>
<li>The <code>--windows-priorityclass</code> lets you set the scheduling priority of the kubelet process (see <a href=#resource-management-cpu>CPU resource management</a>)</li>
<li>The <code>--kubelet-reserve</code>, <code>--system-reserve</code> , and <code>--eviction-hard</code> flags update <a href=/docs/tasks/administer-cluster/reserve-compute-resources/#node-allocatable>NodeAllocatable</a></li>
<li>Eviction by using <code>--enforce-node-allocable</code> is not implemented</li>
<li>Eviction by using <code>--eviction-hard</code> and <code>--eviction-soft</code> are not implemented</li>
<li>A kubelet running on a Windows node does not have memory
restrictions. <code>--kubelet-reserve</code> and <code>--system-reserve</code> do not set limits on
kubelet or processes running on the host. This means kubelet or a process on the host
could cause memory resource starvation outside the node-allocatable and scheduler.</li>
<li>The <code>MemoryPressure</code> Condition is not implemented</li>
<li>The kubelet does not take OOM eviction actions</li>
</ul>
<h3 id=api>API compatibility</h3>
<p>There are no differences in how most of the Kubernetes APIs work for Windows. The
subtleties around what's different come down to differences in the OS and container
runtime. In certain situations, some properties on workload resources were designed
under the assumption that they would be implemented on Linux, and fail to run on Windows.</p>
<p>At a high level, these OS concepts are different:</p>
<ul>
<li>Identity - Linux uses userID (UID) and groupID (GID) which
are represented as integer types. User and group names
are not canonical - they are just an alias in <code>/etc/groups</code>
or <code>/etc/passwd</code> back to UID+GID. Windows uses a larger binary
<a href=https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/security-identifiers>security identifier</a> (SID)
which is stored in the Windows Security Access Manager (SAM) database. This
database is not shared between the host and containers, or between containers.</li>
<li>File permissions - Windows uses an access control list based on (SIDs), whereas
POSIX systems such as Linux use a bitmask based on object permissions and UID+GID,
plus <em>optional</em> access control lists.</li>
<li>File paths - the convention on Windows is to use <code>\</code> instead of <code>/</code>. The Go IO
libraries typically accept both and just make it work, but when you're setting a
path or command line that's interpreted inside a container, <code>\</code> may be needed.</li>
<li>Signals - Windows interactive apps handle termination differently, and can
implement one or more of these:
<ul>
<li>A UI thread handles well-defined messages including <code>WM_CLOSE</code>.</li>
<li>Console apps handle Ctrl-C or Ctrl-break using a Control Handler.</li>
<li>Services register a Service Control Handler function that can accept
<code>SERVICE_CONTROL_STOP</code> control codes.</li>
</ul>
</li>
</ul>
<p>Container exit codes follow the same convention where 0 is success, and nonzero is failure.
The specific error codes may differ across Windows and Linux. However, exit codes
passed from the Kubernetes components (kubelet, kube-proxy) are unchanged.</p>
<h5 id=compatibility-v1-pod-spec-containers>Field compatibility for container specifications</h5>
<p>The following list documents differences between how Pod container specifications
work between Windows and Linux:</p>
<ul>
<li>Huge pages are not implemented in the Windows container
runtime, and are not available. They require <a href=https://docs.microsoft.com/en-us/windows/desktop/Memory/large-page-support>asserting a user
privilege</a>
that's not configurable for containers.</li>
<li><code>requests.cpu</code> and <code>requests.memory</code> - requests are subtracted
from node available resources, so they can be used to avoid overprovisioning a
node. However, they cannot be used to guarantee resources in an overprovisioned
node. They should be applied to all containers as a best practice if the operator
wants to avoid overprovisioning entirely.</li>
<li><code>securityContext.allowPrivilegeEscalation</code> -
not possible on Windows; none of the capabilities are hooked up</li>
<li><code>securityContext.capabilities</code> -
POSIX capabilities are not implemented on Windows</li>
<li><code>securityContext.privileged</code> -
Windows doesn't support privileged containers</li>
<li><code>securityContext.procMount</code> -
Windows doesn't have a <code>/proc</code> filesystem</li>
<li><code>securityContext.readOnlyRootFilesystem</code> -
not possible on Windows; write access is required for registry & system
processes to run inside the container</li>
<li><code>securityContext.runAsGroup</code> -
not possible on Windows as there is no GID support</li>
<li><code>securityContext.runAsNonRoot</code> -
this setting will prevent containers from running as <code>ContainerAdministrator</code>
which is the closest equivalent to a root user on Windows.</li>
<li><code>securityContext.runAsUser</code> -
use <a href=/docs/tasks/configure-pod-container/configure-runasusername><code>runAsUserName</code></a>
instead</li>
<li><code>securityContext.seLinuxOptions</code> -
not possible on Windows as SELinux is Linux-specific</li>
<li><code>terminationMessagePath</code> -
this has some limitations in that Windows doesn't support mapping single files. The
default value is <code>/dev/termination-log</code>, which does work because it does not
exist on Windows by default.</li>
</ul>
<h5 id=compatibility-v1-pod>Field compatibility for Pod specifications</h5>
<p>The following list documents differences between how Pod specifications work between Windows and Linux:</p>
<ul>
<li><code>hostIPC</code> and <code>hostpid</code> - host namespace sharing is not possible on Windows</li>
<li><code>hostNetwork</code> - There is no Windows OS support to share the host network</li>
<li><code>dnsPolicy</code> - setting the Pod <code>dnsPolicy</code> to <code>ClusterFirstWithHostNet</code> is
not supported on Windows because host networking is not provided. Pods always
run with a container network.</li>
<li><code>podSecurityContext</code> (see below)</li>
<li><code>shareProcessNamespace</code> - this is a beta feature, and depends on Linux namespaces
which are not implemented on Windows. Windows cannot share process namespaces or
the container's root filesystem. Only the network can be shared.</li>
<li><code>terminationGracePeriodSeconds</code> - this is not fully implemented in Docker on Windows,
see the <a href=https://github.com/moby/moby/issues/25982>GitHub issue</a>.
The behavior today is that the ENTRYPOINT process is sent CTRL_SHUTDOWN_EVENT,
then Windows waits 5 seconds by default, and finally shuts down
all processes using the normal Windows shutdown behavior. The 5
second default is actually in the Windows registry
<a href=https://github.com/moby/moby/issues/25982#issuecomment-426441183>inside the container</a>,
so it can be overridden when the container is built.</li>
<li><code>volumeDevices</code> - this is a beta feature, and is not implemented on Windows.
Windows cannot attach raw block devices to pods.</li>
<li><code>volumes</code>
<ul>
<li>If you define an <code>emptyDir</code> volume, you cannot set its volume source to <code>memory</code>.</li>
</ul>
</li>
<li>You cannot enable <code>mountPropagation</code> for volume mounts as this is not
supported on Windows.</li>
</ul>
<h5 id=compatibility-v1-pod-spec-containers-securitycontext>Field compatibility for Pod security context</h5>
<p>None of the Pod <a href=/docs/reference/kubernetes-api/workload-resources/pod-v1/#security-context><code>securityContext</code></a> fields work on Windows.</p>
<h3 id=node-problem-detector>Node problem detector</h3>
<p>The node problem detector (see
<a href=/docs/tasks/debug/debug-cluster/monitor-node-health/>Monitor Node Health</a>)
is not compatible with Windows.</p>
<h3 id=pause-container>Pause container</h3>
<p>In a Kubernetes Pod, an infrastructure or “pause” container is first created
to host the container. In Linux, the cgroups and namespaces that make up a pod
need a process to maintain their continued existence; the pause process provides
this. Containers that belong to the same pod, including infrastructure and worker
containers, share a common network endpoint (same IPv4 and / or IPv6 address, same
network port spaces). Kubernetes uses pause containers to allow for worker containers
crashing or restarting without losing any of the networking configuration.</p>
<p>Kubernetes maintains a multi-architecture image that includes support for Windows.
For Kubernetes v1.23 the recommended pause image is <code>k8s.gcr.io/pause:3.6</code>.
The <a href=https://github.com/kubernetes/kubernetes/tree/master/build/pause>source code</a>
is available on GitHub.</p>
<p>Microsoft maintains a different multi-architecture image, with Linux and Windows
amd64 support, that you can find as <code>mcr.microsoft.com/oss/kubernetes/pause:3.6</code>.
This image is built from the same source as the Kubernetes maintained image but
all of the Windows binaries are <a href=https://docs.microsoft.com/en-us/windows-hardware/drivers/install/authenticode>authenticode signed</a> by Microsoft.
The Kubernetes project recommends using the Microsoft maintained image if you are
deploying to a production or production-like environment that requires signed
binaries.</p>
<h3 id=container-runtime>Container runtimes</h3>
<p>You need to install a
<a class=glossary-tooltip title="The container runtime is the software that is responsible for running containers." data-toggle=tooltip data-placement=top href=/docs/setup/production-environment/container-runtimes target=_blank aria-label="container runtime">container runtime</a>
into each node in the cluster so that Pods can run there.</p>
<p>The following container runtimes work with Windows:</p>
<div class="alert alert-secondary callout third-party-content" role=alert><strong>Note:</strong>
This section links to third party projects that provide functionality required by Kubernetes. The Kubernetes project authors aren't responsible for these projects, which are listed alphabetically. To add a project to this list, read the <a href=/docs/contribute/style/content-guide/#third-party-content>content guide</a> before submitting a change. <a href=#third-party-content-disclaimer>More information.</a></div>
<h4 id=cri-containerd>cri-containerd</h4>
<div style=margin-top:10px;margin-bottom:10px>
<b>FEATURE STATE:</b> <code>Kubernetes v1.20 [stable]</code>
</div>
<p>You can use <a class=glossary-tooltip title="A container runtime with an emphasis on simplicity, robustness and portability" data-toggle=tooltip data-placement=top href=https://containerd.io/docs/ target=_blank aria-label=ContainerD>ContainerD</a> 1.4.0+
as the container runtime for Kubernetes nodes that run Windows.</p>
<p>Learn how to <a href=/docs/setup/production-environment/container-runtimes/#install-containerd>install ContainerD on a Windows node</a>.</p>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> There is a <a href=/docs/tasks/configure-pod-container/configure-gmsa/#gmsa-limitations>known limitation</a>
when using GMSA with containerd to access Windows network shares, which requires a
kernel patch.
</div>
<h4 id=mcr>Mirantis Container Runtime</h4>
<p><a href=https://docs.mirantis.com/mcr/20.10/overview.html>Mirantis Container Runtime</a> (MCR) is available as a container runtime for all Windows Server 2019 and later versions.</p>
<p>See <a href=https://docs.mirantis.com/mcr/20.10/install/mcr-windows.html>Install MCR on Windows Servers</a> for more information.</p>
<h2 id=windows-os-version-support>Windows OS version compatibility</h2>
<p>On Windows nodes, strict compatibility rules apply where the host OS version must
match the container base image OS version. Only Windows containers with a container
operating system of Windows Server 2019 are fully supported.</p>
<p>For Kubernetes v1.23, operating system compatibility for Windows nodes (and Pods)
is as follows:</p>
<dl>
<dt>Windows Server LTSC release</dt>
<dd>Windows Server 2019</dd>
<dd>Windows Server 2022</dd>
<dt>Windows Server SAC release</dt>
<dd>Windows Server version 20H2</dd>
</dl>
<p>The Kubernetes <a href=/docs/setup/release/version-skew-policy/>version-skew policy</a> also applies.</p>
<h2 id=security>Security for Windows nodes</h2>
<p>On Windows, data from Secrets are written out in clear text onto the node's local
storage (as compared to using tmpfs / in-memory filesystems on Linux). As a cluster
operator, you should take both of the following additional measures:</p>
<ol>
<li>Use file ACLs to secure the Secrets' file location.</li>
<li>Apply volume-level encryption using <a href=https://docs.microsoft.com/en-us/windows/security/information-protection/bitlocker/bitlocker-how-to-deploy-on-windows-server>BitLocker</a>.</li>
</ol>
<p><a href=/docs/tasks/configure-pod-container/configure-runasusername>RunAsUsername</a>
can be specified for Windows Pods or containers to execute the container
processes as a node-default user. This is roughly equivalent to
<a href=/docs/concepts/security/pod-security-policy/#users-and-groups>RunAsUser</a>.</p>
<p>Linux-specific pod security context privileges such as SELinux, AppArmor, Seccomp, or capabilities (POSIX capabilities), and others are not supported.</p>
<p>Privileged containers are <a href=#compatibility-v1-pod-spec-containers-securitycontext>not supported</a> on Windows.</p>
<h2 id=troubleshooting>Getting help and troubleshooting</h2>
<p>Your main source of help for troubleshooting your Kubernetes cluster should start
with the <a href=/docs/tasks/debug/debug-cluster/>Troubleshooting</a>
page.</p>
<p>Some additional, Windows-specific troubleshooting help is included
in this section. Logs are an important element of troubleshooting
issues in Kubernetes. Make sure to include them any time you seek
troubleshooting assistance from other contributors. Follow the
instructions in the
SIG Windows <a href=https://github.com/kubernetes/community/blob/master/sig-windows/CONTRIBUTING.md#gathering-logs>contributing guide on gathering logs</a>.</p>
<h3 id=troubleshooting-node>Node-level troubleshooting</h3>
<ol>
<li>
<p>How do I know <code>start.ps1</code> completed successfully?</p>
<p>You should see kubelet, kube-proxy, and (if you chose Flannel as your networking
solution) flanneld host-agent processes running on your node, with running logs
being displayed in separate PowerShell windows. In addition to this, your Windows
node should be listed as "Ready" in your Kubernetes cluster.</p>
</li>
<li>
<p>Can I configure the Kubernetes node processes to run in the background as services?</p>
<p>The kubelet and kube-proxy are already configured to run as native Windows Services,
offering resiliency by re-starting the services automatically in the event of
failure (for example a process crash). You have two options for configuring these
node components as services.</p>
<ol>
<li>
<p>As native Windows Services</p>
<p>You can run the kubelet and kube-proxy as native Windows Services using <code>sc.exe</code>.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#080;font-style:italic># Create the services for kubelet and kube-proxy in two separate commands</span>
sc.exe create &lt;component_name&gt; binPath= <span style=color:#b44>&#34;&lt;path_to_binary&gt; --service &lt;other_args&gt;&#34;</span>

<span style=color:#080;font-style:italic># Please note that if the arguments contain spaces, they must be escaped.</span>
sc.exe create kubelet binPath= <span style=color:#b44>&#34;C:\kubelet.exe --service --hostname-override &#39;minion&#39; &lt;other_args&gt;&#34;</span>

<span style=color:#080;font-style:italic># Start the services</span>
<span style=color:#a2f>Start-Service</span> kubelet
<span style=color:#a2f>Start-Service</span> <span style=color:#a2f>kube-proxy</span>

<span style=color:#080;font-style:italic># Stop the service</span>
<span style=color:#a2f>Stop-Service</span> kubelet (-Force)
<span style=color:#a2f>Stop-Service</span> <span style=color:#a2f>kube-proxy</span> (-Force)

<span style=color:#080;font-style:italic># Query the service status</span>
<span style=color:#a2f>Get-Service</span> kubelet
<span style=color:#a2f>Get-Service</span> <span style=color:#a2f>kube-proxy</span>
</code></pre></div></li>
<li>
<p>Using <code>nssm.exe</code></p>
<p>You can also always use alternative service managers like
<a href=https://nssm.cc/>nssm.exe</a> to run these processes (flanneld,
kubelet & kube-proxy) in the background for you. You can use this
<a href=https://github.com/Microsoft/SDN/tree/master/Kubernetes/flannel/register-svc.ps1>sample script</a>,
leveraging nssm.exe to register kubelet, kube-proxy, and flanneld.exe to run
as Windows services in the background.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#a2f>register-svc</span>.ps1 -NetworkMode &lt;Network mode&gt; -ManagementIP &lt;Windows Node IP&gt; -ClusterCIDR &lt;Cluster subnet&gt; -KubeDnsServiceIP &lt;<span style=color:#a2f>Kube-dns</span> Service IP&gt; -LogDir &lt;Directory to place logs&gt;

<span style=color:#080;font-style:italic># NetworkMode      = The network mode l2bridge (flannel host-gw, also the default value) or overlay (flannel vxlan) chosen as a network solution</span>
<span style=color:#080;font-style:italic># ManagementIP     = The IP address assigned to the Windows node. You can use ipconfig to find this</span>
<span style=color:#080;font-style:italic># ClusterCIDR      = The cluster subnet range. (Default value 10.244.0.0/16)</span>
<span style=color:#080;font-style:italic># KubeDnsServiceIP = The Kubernetes DNS service IP (Default value 10.96.0.10)</span>
<span style=color:#080;font-style:italic># LogDir           = The directory where kubelet and kube-proxy logs are redirected into their respective output files (Default value C:\k)</span>
</code></pre></div><p>If the above referenced script is not suitable, you can manually configure
<code>nssm.exe</code> using the following examples.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#080;font-style:italic># Register flanneld.exe</span>
nssm install flanneld C:\flannel\flanneld.exe
nssm <span style=color:#a2f>set </span>flanneld AppParameters --kubeconfig<span style=color:#666>-file</span>=c:\k\config --iface=&lt;ManagementIP&gt; --ip-masq=1 --kube-subnet-mgr=1
nssm <span style=color:#a2f>set </span>flanneld AppEnvironmentExtra NODE_NAME=&lt;hostname&gt;
nssm <span style=color:#a2f>set </span>flanneld AppDirectory C:\flannel
nssm <span style=color:#a2f>start </span>flanneld

<span style=color:#080;font-style:italic># Register kubelet.exe</span>
<span style=color:#080;font-style:italic># Microsoft releases the pause infrastructure container at mcr.microsoft.com/oss/kubernetes/pause:3.6</span>
nssm install kubelet C:\k\kubelet.exe
nssm <span style=color:#a2f>set </span>kubelet AppParameters --hostname-override=&lt;hostname&gt; --v=6 --pod-infra-container-image=mcr.microsoft.com/oss/kubernetes/pause<span>:</span>3.6 --resolv-conf=<span style=color:#b44>&#34;&#34;</span> --allow-privileged=true --enable-debugging-handlers --cluster-dns=&lt;<span style=color:#a2f>DNS-service</span>-IP&gt; --cluster-domain=cluster.local --kubeconfig=c:\k\config --hairpin-mode=<span style=color:#a2f>promiscuous-bridge</span> --image-pull-progress-deadline=20m --cgroups-per-qos=false  --log-dir=&lt;log directory&gt; --logtostderr=false --enforce-node-allocatable=<span style=color:#b44>&#34;&#34;</span> --network-plugin=cni --cni-bin-dir=c:\k\cni --cni-conf-dir=c:\k\cni\config
nssm <span style=color:#a2f>set </span>kubelet AppDirectory C:\k
nssm <span style=color:#a2f>start </span>kubelet

<span style=color:#080;font-style:italic># Register kube-proxy.exe (l2bridge / host-gw)</span>
nssm install <span style=color:#a2f>kube-proxy</span> C:\k\<span style=color:#a2f>kube-proxy</span>.exe
nssm <span style=color:#a2f>set kube-proxy</span> AppDirectory c:\k
nssm <span style=color:#a2f>set kube-proxy</span> AppParameters --v=4 --proxy-mode=kernelspace --hostname-override=&lt;hostname&gt;--kubeconfig=c:\k\config --enable-dsr=false --log-dir=&lt;log directory&gt; --logtostderr=false
nssm.exe <span style=color:#a2f>set kube-proxy</span> AppEnvironmentExtra KUBE_NETWORK=cbr0
nssm <span style=color:#a2f>set kube-proxy</span> DependOnService kubelet
nssm <span style=color:#a2f>start kube-proxy</span>

<span style=color:#080;font-style:italic># Register kube-proxy.exe (overlay / vxlan)</span>
nssm install <span style=color:#a2f>kube-proxy</span> C:\k\<span style=color:#a2f>kube-proxy</span>.exe
nssm <span style=color:#a2f>set kube-proxy</span> AppDirectory c:\k
nssm <span style=color:#a2f>set kube-proxy</span> AppParameters --v=4 --proxy-mode=kernelspace --feature-gates=<span style=color:#b44>&#34;WinOverlay=true&#34;</span> --hostname-override=&lt;hostname&gt; --kubeconfig=c:\k\config --network-name=vxlan0 --source-vip=&lt;<span style=color:#a2f>source-vip</span>&gt; --enable-dsr=false --log-dir=&lt;log directory&gt; --logtostderr=false
nssm <span style=color:#a2f>set kube-proxy</span> DependOnService kubelet
nssm <span style=color:#a2f>start kube-proxy</span>
</code></pre></div><p>For initial troubleshooting, you can use the following flags in <a href=https://nssm.cc/>nssm.exe</a> to redirect stdout and stderr to a output file:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>nssm <span style=color:#a2f>set </span>&lt;Service Name&gt; AppStdout C:\k\mysvc.log
nssm <span style=color:#a2f>set </span>&lt;Service Name&gt; AppStderr C:\k\mysvc.log
</code></pre></div><p>For additional details, see <a href=https://nssm.cc/usage>NSSM - the Non-Sucking Service Manager</a>.</p>
</li>
</ol>
</li>
<li>
<p>My Pods are stuck at "Container Creating" or restarting over and over</p>
<p>Check that your pause image is compatible with your OS version. The
<a href=https://docs.microsoft.com/en-us/virtualization/windowscontainers/kubernetes/deploying-resources>instructions</a>
assume that both the OS and the containers are version 1803. If you have a later
version of Windows, such as an Insider build, you need to adjust the images
accordingly. See <a href=#pause-container>Pause container</a> for more details.</p>
</li>
</ol>
<h3 id=troubleshooting-network>Network troubleshooting</h3>
<ol>
<li>
<p>My Windows Pods do not have network connectivity</p>
<p>If you are using virtual machines, ensure that MAC spoofing is <strong>enabled</strong> on all
the VM network adapter(s).</p>
</li>
<li>
<p>My Windows Pods cannot ping external resources</p>
<p>Windows Pods do not have outbound rules programmed for the ICMP protocol. However,
TCP/UDP is supported. When trying to demonstrate connectivity to resources
outside of the cluster, substitute <code>ping &lt;IP></code> with corresponding
<code>curl &lt;IP></code> commands.</p>
<p>If you are still facing problems, most likely your network configuration in
<a href=https://github.com/Microsoft/SDN/blob/master/Kubernetes/flannel/l2bridge/cni/config/cni.conf>cni.conf</a>
deserves some extra attention. You can always edit this static file. The
configuration update will apply to any new Kubernetes resources.</p>
<p>One of the Kubernetes networking requirements
(see <a href=/docs/concepts/cluster-administration/networking/>Kubernetes model</a>) is
for cluster communication to occur without
NAT internally. To honor this requirement, there is an
<a href=https://github.com/Microsoft/SDN/blob/master/Kubernetes/flannel/l2bridge/cni/config/cni.conf#L20>ExceptionList</a>
for all the communication where you do not want outbound NAT to occur. However,
this also means that you need to exclude the external IP you are trying to query
from the <code>ExceptionList</code>. Only then will the traffic originating from your Windows
pods be SNAT'ed correctly to receive a response from the outside world. In this
regard, your <code>ExceptionList</code> in <code>cni.conf</code> should look as follows:</p>
<pre><code class=language-conf data-lang=conf>&quot;ExceptionList&quot;: [
                &quot;10.244.0.0/16&quot;,  # Cluster subnet
                &quot;10.96.0.0/12&quot;,   # Service subnet
                &quot;10.127.130.0/24&quot; # Management (host) subnet
            ]
</code></pre></li>
<li>
<p>My Windows node cannot access <code>NodePort</code> type Services</p>
<p>Local NodePort access from the node itself fails. This is a known
limitation. NodePort access works from other nodes or external clients.</p>
</li>
<li>
<p>vNICs and HNS endpoints of containers are being deleted</p>
<p>This issue can be caused when the <code>hostname-override</code> parameter is not passed to
<a href=/docs/reference/command-line-tools-reference/kube-proxy/>kube-proxy</a>. To resolve
it, users need to pass the hostname to kube-proxy as follows:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell>C:\k\<span style=color:#a2f>kube-proxy</span>.exe --hostname-override=$(hostname)
</code></pre></div></li>
<li>
<p>With flannel, my nodes are having issues after rejoining a cluster</p>
<p>Whenever a previously deleted node is being re-joined to the cluster, flannelD
tries to assign a new pod subnet to the node. Users should remove the old pod
subnet configuration files in the following paths:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#a2f>Remove-Item</span> C:\k\SourceVip.json
<span style=color:#a2f>Remove-Item</span> C:\k\SourceVipRequest.json
</code></pre></div></li>
<li>
<p>After launching <code>start.ps1</code>, flanneld is stuck in "Waiting for the Network to be created"</p>
<p>There are numerous reports of this <a href=https://github.com/coreos/flannel/issues/1066>issue</a>; most likely it is a timing issue for when the management IP of the flannel network is set. A workaround is to relaunch <code>start.ps1</code> or relaunch it manually as follows:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#800>[Environment]</span>::SetEnvironmentVariable(<span style=color:#b44>&#34;NODE_NAME&#34;</span>, <span style=color:#b44>&#34;&lt;Windows_Worker_Hostname&gt;&#34;</span>)
C:\flannel\flanneld.exe --kubeconfig<span style=color:#666>-file</span>=c:\k\config --iface=&lt;Windows_Worker_Node_IP&gt; --ip-masq=1 --kube-subnet-mgr=1
</code></pre></div></li>
<li>
<p>My Windows Pods cannot launch because of missing <code>/run/flannel/subnet.env</code></p>
<p>This indicates that Flannel didn't launch correctly. You can either try
to restart <code>flanneld.exe</code> or you can copy the files over manually from
<code>/run/flannel/subnet.env</code> on the Kubernetes master to <code>C:\run\flannel\subnet.env</code>
on the Windows worker node and modify the <code>FLANNEL_SUBNET</code> row to a different
number. For example, if node subnet 10.244.4.1/24 is desired:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-env data-lang=env><span style=color:#b8860b>FLANNEL_NETWORK</span><span style=color:#666>=</span>10.244.0.0/16
<span style=color:#b8860b>FLANNEL_SUBNET</span><span style=color:#666>=</span>10.244.4.1/24
<span style=color:#b8860b>FLANNEL_MTU</span><span style=color:#666>=</span><span style=color:#666>1500</span>
<span style=color:#b8860b>FLANNEL_IPMASQ</span><span style=color:#666>=</span><span style=color:#a2f>true</span>
</code></pre></div></li>
<li>
<p>My Windows node cannot access my services using the service IP</p>
<p>This is a known limitation of the networking stack on Windows. However, Windows Pods can access the Service IP.</p>
</li>
<li>
<p>No network adapter is found when starting the kubelet</p>
<p>The Windows networking stack needs a virtual adapter for Kubernetes networking to work. If the following commands return no results (in an admin shell), virtual network creation — a necessary prerequisite for the kubelet to work — has failed:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=color:#a2f>Get-HnsNetwork</span> | ? Name <span style=color:#666>-ieq</span> <span style=color:#b44>&#34;cbr0&#34;</span>
<span style=color:#a2f>Get-NetAdapter</span> | ? Name <span style=color:#666>-Like</span> <span style=color:#b44>&#34;vEthernet (Ethernet*&#34;</span>
</code></pre></div><p>Often it is worthwhile to modify the <a href=https://github.com/microsoft/SDN/blob/master/Kubernetes/flannel/start.ps1#L7>InterfaceName</a> parameter of the start.ps1 script, in cases where the host's network adapter isn't "Ethernet". Otherwise, consult the output of the <code>start-kubelet.ps1</code> script to see if there are errors during virtual network creation.</p>
</li>
<li>
<p>DNS resolution is not properly working</p>
<p>Check the DNS limitations for Windows in this <a href=#dns-limitations>section</a>.</p>
</li>
<li>
<p><code>kubectl port-forward</code> fails with "unable to do port forwarding: wincat not found"</p>
<p>This was implemented in Kubernetes 1.15 by including <code>wincat.exe</code> in the pause infrastructure container <code>mcr.microsoft.com/oss/kubernetes/pause:3.6</code>. Be sure to use a supported version of Kubernetes.
If you would like to build your own pause infrastructure container be sure to include <a href=https://github.com/kubernetes/kubernetes/tree/master/build/pause/windows/wincat>wincat</a>.</p>
</li>
<li>
<p>My Kubernetes installation is failing because my Windows Server node is behind a proxy</p>
<p>If you are behind a proxy, the following PowerShell environment variables must be defined:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-PowerShell data-lang=PowerShell><span style=color:#800>[Environment]</span>::SetEnvironmentVariable(<span style=color:#b44>&#34;HTTP_PROXY&#34;</span>, <span style=color:#b44>&#34;http://proxy.example.com:80/&#34;</span>, <span style=color:#800>[EnvironmentVariableTarget]</span>::Machine)
<span style=color:#800>[Environment]</span>::SetEnvironmentVariable(<span style=color:#b44>&#34;HTTPS_PROXY&#34;</span>, <span style=color:#b44>&#34;http://proxy.example.com:443/&#34;</span>, <span style=color:#800>[EnvironmentVariableTarget]</span>::Machine)
</code></pre></div></li>
</ol>
<h3 id=further-investigation>Further investigation</h3>
<p>If these steps don't resolve your problem, you can get help running Windows containers on Windows nodes in Kubernetes through:</p>
<ul>
<li>StackOverflow <a href=https://stackoverflow.com/questions/tagged/windows-server-container>Windows Server Container</a> topic</li>
<li>Kubernetes Official Forum <a href=https://discuss.kubernetes.io/>discuss.kubernetes.io</a></li>
<li>Kubernetes Slack <a href=https://kubernetes.slack.com/messages/sig-windows>#SIG-Windows Channel</a></li>
</ul>
<h3 id=reporting-issues-and-feature-requests>Reporting issues and feature requests</h3>
<p>If you have what looks like a bug, or you would like to
make a feature request, please use the
<a href=https://github.com/kubernetes/kubernetes/issues>GitHub issue tracking system</a>.
You can open issues on
<a href=https://github.com/kubernetes/kubernetes/issues/new/choose>GitHub</a> and assign
them to SIG-Windows. You should first search the list of issues in case it was
reported previously and comment with your experience on the issue and add additional
logs. SIG-Windows Slack is also a great avenue to get some initial support and
troubleshooting ideas prior to creating a ticket.</p>
<p>If filing a bug, please include detailed information about how to reproduce the problem, such as:</p>
<ul>
<li>Kubernetes version: output from <code>kubectl version</code></li>
<li>Environment details: Cloud provider, OS distro, networking choice and configuration, and Docker version</li>
<li>Detailed steps to reproduce the problem</li>
<li><a href=https://github.com/kubernetes/community/blob/master/sig-windows/CONTRIBUTING.md#gathering-logs>Relevant logs</a></li>
</ul>
<p>It helps if you tag the issue as <strong>sig/windows</strong>, by commenting on the issue with <code>/sig windows</code>. This helps to bring
the issue to a SIG Windows member's attention</p>
<h2 id=what-s-next>What's next</h2>
<h3 id=deployment-tools>Deployment tools</h3>
<p>The kubeadm tool helps you to deploy a Kubernetes cluster, providing the control
plane to manage the cluster it, and nodes to run your workloads.
<a href=/docs/tasks/administer-cluster/kubeadm/adding-windows-nodes/>Adding Windows nodes</a>
explains how to deploy Windows nodes to your cluster using kubeadm.</p>
<p>The Kubernetes <a href=https://cluster-api.sigs.k8s.io/>cluster API</a> project also provides means to automate deployment of Windows nodes.</p>
<h3 id=windows-distribution-channels>Windows distribution channels</h3>
<p>For a detailed explanation of Windows distribution channels see the <a href=https://docs.microsoft.com/en-us/windows-server/get-started-19/servicing-channels-19>Microsoft documentation</a>.</p>
<p>Information on the different Windows Server servicing channels
including their support models can be found at
<a href=https://docs.microsoft.com/en-us/windows-server/get-started/servicing-channels-comparison>Windows Server servicing channels</a>.</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-3a51e66c5de55f9093a8dc55742006d3>4.2 - Guide for scheduling Windows containers in Kubernetes</h1>
<p>Windows applications constitute a large portion of the services and applications that run in many organizations.
This guide walks you through the steps to configure and deploy a Windows container in Kubernetes.</p>
<h2 id=objectives>Objectives</h2>
<ul>
<li>Configure an example deployment to run Windows containers on the Windows node</li>
<li>(Optional) Configure an Active Directory Identity for your Pod using Group Managed Service Accounts (GMSA)</li>
</ul>
<h2 id=before-you-begin>Before you begin</h2>
<ul>
<li>Create a Kubernetes cluster that includes a
control plane and a <a href=/docs/tasks/administer-cluster/kubeadm/adding-windows-nodes/>worker node running Windows Server</a></li>
<li>It is important to note that creating and deploying services and workloads on Kubernetes
behaves in much the same way for Linux and Windows containers.
<a href=/docs/reference/kubectl/>Kubectl commands</a> to interface with the cluster are identical.
The example in the section below is provided to jumpstart your experience with Windows containers.</li>
</ul>
<h2 id=getting-started-deploying-a-windows-container>Getting Started: Deploying a Windows container</h2>
<p>To deploy a Windows container on Kubernetes, you must first create an example application.
The example YAML file below creates a simple webserver application.
Create a service spec named <code>win-webserver.yaml</code> with the contents below:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Service<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>win-webserver<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>win-webserver<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># the port that this service should serve on</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>targetPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>win-webserver<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>NodePort<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>win-webserver<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>win-webserver<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>2</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>win-webserver<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>win-webserver<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>win-webserver<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>     </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>windowswebserver<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>mcr.microsoft.com/windows/servercore:ltsc2019<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span>- powershell.exe<span style=color:#bbb>
</span><span style=color:#bbb>        </span>- -command<span style=color:#bbb>
</span><span style=color:#bbb>        </span>- <span style=color:#b44>&#34;&lt;#code used from https://gist.github.com/19WAS85/5424431#&gt; ; $$listener = New-Object System.Net.HttpListener ; $$listener.Prefixes.Add(&#39;http://*:80/&#39;) ; $$listener.Start() ; $$callerCounts = @{} ; Write-Host(&#39;Listening at http://*:80/&#39;) ; while ($$listener.IsListening) { ;$$context = $$listener.GetContext() ;$$requestUrl = $$context.Request.Url ;$$clientIP = $$context.Request.RemoteEndPoint.Address ;$$response = $$context.Response ;Write-Host &#39;&#39; ;Write-Host(&#39;&gt; {0}&#39; -f $$requestUrl) ;  ;$$count = 1 ;$$k=$$callerCounts.Get_Item($$clientIP) ;if ($$k -ne $$null) { $$count += $$k } ;$$callerCounts.Set_Item($$clientIP, $$count) ;$$ip=(Get-NetAdapter | Get-NetIpAddress); $$header=&#39;&lt;html&gt;&lt;body&gt;&lt;H1&gt;Windows Container Web Server&lt;/H1&gt;&#39; ;$$callerCountsString=&#39;&#39; ;$$callerCounts.Keys | % { $$callerCountsString+=&#39;&lt;p&gt;IP {0} callerCount {1} &#39; -f $$ip[1].IPAddress,$$callerCounts.Item($$_) } ;$$footer=&#39;&lt;/body&gt;&lt;/html&gt;&#39; ;$$content=&#39;{0}{1}{2}&#39; -f $$header,$$callerCountsString,$$footer ;Write-Output $$content ;$$buffer = [System.Text.Encoding]::UTF8.GetBytes($$content) ;$$response.ContentLength64 = $$buffer.Length ;$$response.OutputStream.Write($$buffer, 0, $$buffer.Length) ;$$response.Close() ;$$responseStatus = $$response.StatusCode ;Write-Host(&#39;&lt; {0}&#39; -f $$responseStatus)  } ; &#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>     </span><span style=color:green;font-weight:700>nodeSelector</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>kubernetes.io/os</span>:<span style=color:#bbb> </span>windows<span style=color:#bbb>
</span></code></pre></div><div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> Port mapping is also supported, but for simplicity in this example
the container port 80 is exposed directly to the service.
</div>
<ol>
<li>
<p>Check that all nodes are healthy:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl get nodes
</code></pre></div></li>
<li>
<p>Deploy the service and watch for pod updates:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl apply -f win-webserver.yaml
kubectl get pods -o wide -w
</code></pre></div><p>When the service is deployed correctly both Pods are marked as Ready. To exit the watch command, press Ctrl+C.</p>
</li>
<li>
<p>Check that the deployment succeeded. To verify:</p>
<ul>
<li>Two containers per pod on the Windows node, use <code>docker ps</code></li>
<li>Two pods listed from the Linux control plane node, use <code>kubectl get pods</code></li>
<li>Node-to-pod communication across the network, <code>curl</code> port 80 of your pod IPs from the Linux control plane node
to check for a web server response</li>
<li>Pod-to-pod communication, ping between pods (and across hosts, if you have more than one Windows node)
using docker exec or kubectl exec</li>
<li>Service-to-pod communication, <code>curl</code> the virtual service IP (seen under <code>kubectl get services</code>)
from the Linux control plane node and from individual pods</li>
<li>Service discovery, <code>curl</code> the service name with the Kubernetes <a href=/docs/concepts/services-networking/dns-pod-service/#services>default DNS suffix</a></li>
<li>Inbound connectivity, <code>curl</code> the NodePort from the Linux control plane node or machines outside of the cluster</li>
<li>Outbound connectivity, <code>curl</code> external IPs from inside the pod using kubectl exec</li>
</ul>
</li>
</ol>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> Windows container hosts are not able to access the IP of services scheduled on them due to current platform limitations of the Windows networking stack.
Only Windows pods are able to access service IPs.
</div>
<h2 id=observability>Observability</h2>
<h3 id=capturing-logs-from-workloads>Capturing logs from workloads</h3>
<p>Logs are an important element of observability; they enable users to gain insights
into the operational aspect of workloads and are a key ingredient to troubleshooting issues.
Because Windows containers and workloads inside Windows containers behave differently from Linux containers,
users had a hard time collecting logs, limiting operational visibility.
Windows workloads for example are usually configured to log to ETW (Event Tracing for Windows)
or push entries to the application event log.
<a href=https://github.com/microsoft/windows-container-tools/tree/master/LogMonitor>LogMonitor</a>, an open source tool by Microsoft,
is the recommended way to monitor configured log sources inside a Windows container.
LogMonitor supports monitoring event logs, ETW providers, and custom application logs,
piping them to STDOUT for consumption by <code>kubectl logs &lt;pod></code>.</p>
<p>Follow the instructions in the LogMonitor GitHub page to copy its binaries and configuration files
to all your containers and add the necessary entrypoints for LogMonitor to push your logs to STDOUT.</p>
<h2 id=using-configurable-container-usernames>Using configurable Container usernames</h2>
<p>Starting with Kubernetes v1.16, Windows containers can be configured to run their entrypoints and processes
with different usernames than the image defaults.
The way this is achieved is a bit different from the way it is done for Linux containers.
Learn more about it <a href=/docs/tasks/configure-pod-container/configure-runasusername/>here</a>.</p>
<h2 id=managing-workload-identity-with-group-managed-service-accounts>Managing Workload Identity with Group Managed Service Accounts</h2>
<p>Starting with Kubernetes v1.14, Windows container workloads can be configured to use Group Managed Service Accounts (GMSA).
Group Managed Service Accounts are a specific type of Active Directory account that provides automatic password management,
simplified service principal name (SPN) management, and the ability to delegate the management to other administrators across multiple servers.
Containers configured with a GMSA can access external Active Directory Domain resources while carrying the identity configured with the GMSA.
Learn more about configuring and using GMSA for Windows containers <a href=/docs/tasks/configure-pod-container/configure-gmsa/>here</a>.</p>
<h2 id=taints-and-tolerations>Taints and Tolerations</h2>
<p>Users today need to use some combination of taints and node selectors in order to
keep Linux and Windows workloads on their respective OS-specific nodes.
This likely imposes a burden only on Windows users. The recommended approach is outlined below,
with one of its main goals being that this approach should not break compatibility for existing Linux workloads.
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> <p>If the <code>IdentifyPodOS</code> <a href=/docs/reference/command-line-tools-reference/feature-gates/>feature gate</a> is
enabled, you can (and should) set <code>.spec.os.name</code> for a Pod to indicate the operating system
that the containers in that Pod are designed for. For Pods that run Linux containers, set
<code>.spec.os.name</code> to <code>linux</code>. For Pods that run Windows containers, set <code>.spec.os.name</code>
to Windows.</p>
<p>The scheduler does not use the value of <code>.spec.os.name</code> when assigning Pods to nodes. You should
use normal Kubernetes mechanisms for
<a href=/docs/concepts/scheduling-eviction/assign-pod-node/>assigning pods to nodes</a>
to ensure that the control plane for your cluster places pods onto nodes that are running the
appropriate operating system.
no effect on the scheduling of the Windows pods, so taints and tolerations and node selectors are still required
to ensure that the Windows pods land onto appropriate Windows nodes.</p>
</div></p>
<h3 id=ensuring-os-specific-workloads-land-on-the-appropriate-container-host>Ensuring OS-specific workloads land on the appropriate container host</h3>
<p>Users can ensure Windows containers can be scheduled on the appropriate host using Taints and Tolerations.
All Kubernetes nodes today have the following default labels:</p>
<ul>
<li>kubernetes.io/os = [windows|linux]</li>
<li>kubernetes.io/arch = [amd64|arm64|...]</li>
</ul>
<p>If a Pod specification does not specify a nodeSelector like <code>"kubernetes.io/os": windows</code>,
it is possible the Pod can be scheduled on any host, Windows or Linux.
This can be problematic since a Windows container can only run on Windows and a Linux container can only run on Linux.
The best practice is to use a nodeSelector.</p>
<p>However, we understand that in many cases users have a pre-existing large number of deployments for Linux containers,
as well as an ecosystem of off-the-shelf configurations, such as community Helm charts, and programmatic Pod generation cases, such as with Operators.
In those situations, you may be hesitant to make the configuration change to add nodeSelectors.
The alternative is to use Taints. Because the kubelet can set Taints during registration,
it could easily be modified to automatically add a taint when running on Windows only.</p>
<p>For example: <code>--register-with-taints='os=windows:NoSchedule'</code></p>
<p>By adding a taint to all Windows nodes, nothing will be scheduled on them (that includes existing Linux Pods).
In order for a Windows Pod to be scheduled on a Windows node,
it would need both the nodeSelector and the appropriate matching toleration to choose Windows.</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>nodeSelector</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubernetes.io/os</span>:<span style=color:#bbb> </span>windows<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>node.kubernetes.io/windows-build</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;10.0.17763&#39;</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>tolerations</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>key</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;os&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>operator</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;Equal&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;windows&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>effect</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;NoSchedule&#34;</span><span style=color:#bbb>
</span></code></pre></div><h3 id=handling-multiple-windows-versions-in-the-same-cluster>Handling multiple Windows versions in the same cluster</h3>
<p>The Windows Server version used by each pod must match that of the node. If you want to use multiple Windows
Server versions in the same cluster, then you should set additional node labels and nodeSelectors.</p>
<p>Kubernetes 1.17 automatically adds a new label <code>node.kubernetes.io/windows-build</code> to simplify this.
If you're running an older version, then it's recommended to add this label manually to Windows nodes.</p>
<p>This label reflects the Windows major, minor, and build number that need to match for compatibility.
Here are values used today for each Windows Server version.</p>
<table>
<thead>
<tr>
<th>Product Name</th>
<th>Build Number(s)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Windows Server 2019</td>
<td>10.0.17763</td>
</tr>
<tr>
<td>Windows Server version 1809</td>
<td>10.0.17763</td>
</tr>
<tr>
<td>Windows Server version 1903</td>
<td>10.0.18362</td>
</tr>
</tbody>
</table>
<h3 id=simplifying-with-runtimeclass>Simplifying with RuntimeClass</h3>
<p><a href=https://kubernetes.io/docs/concepts/containers/runtime-class/>RuntimeClass</a> can be used to simplify the process of using taints and tolerations.
A cluster administrator can create a <code>RuntimeClass</code> object which is used to encapsulate these taints and tolerations.</p>
<ol>
<li>Save this file to <code>runtimeClasses.yml</code>. It includes the appropriate <code>nodeSelector</code>
for the Windows OS, architecture, and version.</li>
</ol>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>node.k8s.io/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>RuntimeClass<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>windows-2019<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>handler</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;docker&#39;</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>scheduling</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>nodeSelector</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubernetes.io/os</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;windows&#39;</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubernetes.io/arch</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;amd64&#39;</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>node.kubernetes.io/windows-build</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;10.0.17763&#39;</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>tolerations</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>effect</span>:<span style=color:#bbb> </span>NoSchedule<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>key</span>:<span style=color:#bbb> </span>os<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>operator</span>:<span style=color:#bbb> </span>Equal<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>value</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;windows&#34;</span><span style=color:#bbb>
</span></code></pre></div><ol>
<li>Run <code>kubectl create -f runtimeClasses.yml</code> using as a cluster administrator</li>
<li>Add <code>runtimeClassName: windows-2019</code> as appropriate to Pod specs</li>
</ol>
<p>For example:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>iis-2019<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>iis-2019<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>iis-2019<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>iis-2019<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>runtimeClassName</span>:<span style=color:#bbb> </span>windows-2019<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>iis<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>mcr.microsoft.com/windows/servercore/iis:windowsservercore-ltsc2019<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>limits</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span>800Mi<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span>.1<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>memory</span>:<span style=color:#bbb> </span>300Mi<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span>- <span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span><span style=color:#bbb> </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>iis-2019<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Service<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>iis<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>LoadBalancer<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>protocol</span>:<span style=color:#bbb> </span>TCP<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>80</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>app</span>:<span style=color:#bbb> </span>iis-2019<span style=color:#bbb>
</span></code></pre></div>
</div>
</main>
</div>
</div>
<footer class=d-print-none>
<div class=footer__links>
<nav>
<a class=text-white href=/docs/home/>Home</a>
<a class=text-white href=/blog/>Blog</a>
<a class=text-white href=/training/>Training</a>
<a class=text-white href=/partners/>Partners</a>
<a class=text-white href=/community/>Community</a>
<a class=text-white href=/case-studies/>Case Studies</a>
</nav>
</div>
<div class=container-fluid>
<div class=row>
<div class="col-6 col-sm-2 text-xs-center order-sm-2">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list">
<a class=text-white target=_blank href=https://discuss.kubernetes.io>
<i class="fa fa-envelope"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter>
<a class=text-white target=_blank href=https://twitter.com/kubernetesio>
<i class="fab fa-twitter"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Calendar aria-label=Calendar>
<a class=text-white target=_blank href="https://calendar.google.com/calendar/embed?src=calendar%40kubernetes.io">
<i class="fas fa-calendar-alt"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Youtube aria-label=Youtube>
<a class=text-white target=_blank href=https://youtube.com/kubernetescommunity>
<i class="fab fa-youtube"></i>
</a>
</li>
</ul>
</div>
<div class="col-6 col-sm-2 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank href=https://github.com/kubernetes/kubernetes>
<i class="fab fa-github"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack>
<a class=text-white target=_blank href=https://slack.k8s.io>
<i class="fab fa-slack"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Contribute aria-label=Contribute>
<a class=text-white target=_blank href=https://git.k8s.io/community/contributors/guide>
<i class="fas fa-edit"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow">
<a class=text-white target=_blank href=https://stackoverflow.com/questions/tagged/kubernetes>
<i class="fab fa-stack-overflow"></i>
</a>
</li>
</ul>
</div>
<div class="col-12 col-sm-8 text-center order-sm-2">
<small class=text-white>&copy; 2023 The Kubernetes Authors | Documentation Distributed under <a href=https://git.k8s.io/website/LICENSE class=light-text>CC BY 4.0</a></small>
<br>
<small class=text-white>Copyright &copy; 2023 The Linux Foundation &reg;. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href=https://www.linuxfoundation.org/trademark-usage class=light-text>Trademark Usage page</a></small>
<br>
<small class=text-white>ICP license: 京ICP备17074266号-3</small>
</div>
</div>
</div>
</footer>
</div>
<script src=/js/popper-1.14.3.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=/js/bootstrap-4.3.1.min.js integrity=sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM crossorigin=anonymous></script>
<script src=/js/main.min.40616251a9b6e4b689e7769be0340661efa4d7ebb73f957404e963e135b4ed52.js integrity="sha256-QGFiUam25LaJ53ab4DQGYe+k1+u3P5V0BOlj4TW07VI=" crossorigin=anonymous></script>
</body>
</html>