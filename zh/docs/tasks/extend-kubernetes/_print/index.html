<!doctype html><html lang=zh class=no-js>
<head>
<meta name=ROBOTS content="NOINDEX, NOFOLLOW">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-JPP6RFM2BP"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-JPP6RFM2BP')</script>
<link rel=alternate hreflang=en href=https://kubernetes.io/docs/tasks/extend-kubernetes/>
<link rel=alternate hreflang=ko href=https://kubernetes.io/ko/docs/tasks/extend-kubernetes/>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.87.0">
<link rel=canonical type=text/html href=https://kubernetes.io/zh/docs/tasks/extend-kubernetes/>
<link rel="shortcut icon" type=image/png href=/images/favicon.png>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180>
<link rel=manifest href=/manifest.webmanifest>
<link rel=apple-touch-icon href=/images/kubernetes-192x192.png>
<title>扩展 Kubernetes | Kubernetes</title><meta property="og:title" content="扩展 Kubernetes">
<meta property="og:description" content="了解针对工作环境需要来调整 Kubernetes 集群的进阶方法。">
<meta property="og:type" content="website">
<meta property="og:url" content="https://kubernetes.io/zh/docs/tasks/extend-kubernetes/"><meta property="og:site_name" content="Kubernetes">
<meta itemprop=name content="扩展 Kubernetes">
<meta itemprop=description content="了解针对工作环境需要来调整 Kubernetes 集群的进阶方法。"><meta name=twitter:card content="summary">
<meta name=twitter:title content="扩展 Kubernetes">
<meta name=twitter:description content="了解针对工作环境需要来调整 Kubernetes 集群的进阶方法。">
<link href=/scss/main.css rel=stylesheet>
<script src=/js/jquery-3.3.1.min.js integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin=anonymous></script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"Organization","url":"https://kubernetes.io","logo":"https://kubernetes.io/images/favicon.png"}</script>
<meta name=theme-color content="#326ce5">
<link rel=stylesheet href=/css/feature-states.css>
<meta name=description content="了解针对工作环境需要来调整 Kubernetes 集群的进阶方法。">
<meta property="og:description" content="了解针对工作环境需要来调整 Kubernetes 集群的进阶方法。">
<meta name=twitter:description content="了解针对工作环境需要来调整 Kubernetes 集群的进阶方法。">
<meta property="og:url" content="https://kubernetes.io/zh/docs/tasks/extend-kubernetes/">
<meta property="og:title" content="扩展 Kubernetes">
<meta name=twitter:title content="扩展 Kubernetes">
<meta name=twitter:image content="https://kubernetes.io/images/favicon.png">
<meta name=twitter:image:alt content="Kubernetes">
<meta property="og:image" content="/images/kubernetes-horizontal-color.png">
<meta property="og:type" content="article">
<script src=/js/script.js></script>
</head>
<body class=td-section>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar" data-auto-burger=primary>
<a class=navbar-brand href=/zh/></a>
<div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar>
<ul class="navbar-nav mt-2 mt-lg-0">
<li class="nav-item mr-2 mb-lg-0">
<a class="nav-link active" href=/zh/docs/>文档</a>
</li>
<li class="nav-item mr-2 mb-lg-0">
<a class=nav-link href=/zh/blog/>Kubernetes 博客</a>
</li>
<li class="nav-item mr-2 mb-lg-0">
<a class=nav-link href=/zh/training/>培训</a>
</li>
<li class="nav-item mr-2 mb-lg-0">
<a class=nav-link href=/zh/partners/>合作伙伴</a>
</li>
<li class="nav-item mr-2 mb-lg-0">
<a class=nav-link href=/zh/community/>社区</a>
</li>
<li class="nav-item mr-2 mb-lg-0">
<a class=nav-link href=/zh/case-studies/>案例分析</a>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
Versions
</a>
<div class="dropdown-menu dropdown-menu-right" aria-labelledby=navbarDropdownMenuLink>
<a class=dropdown-item href=/releases>Release Information</a>
<a class=dropdown-item href=https://kubernetes.io/zh/docs/tasks/extend-kubernetes/>v1.27</a>
<a class=dropdown-item href=https://v1-26.docs.kubernetes.io/zh/docs/tasks/extend-kubernetes/>v1.26</a>
<a class=dropdown-item href=https://v1-25.docs.kubernetes.io/zh/docs/tasks/extend-kubernetes/>v1.25</a>
<a class=dropdown-item href=https://v1-24.docs.kubernetes.io/zh/docs/tasks/extend-kubernetes/>v1.24</a>
<a class=dropdown-item href=https://v1-23.docs.kubernetes.io/zh/docs/tasks/extend-kubernetes/>v1.23</a>
</div>
</li>
<li class="nav-item dropdown">
<a class="nav-link dropdown-toggle" href=# id=navbarDropdownMenuLink role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
中文 Chinese
</a>
<div class="dropdown-menu dropdown-menu-right" aria-labelledby=navbarDropdownMenuLink>
<a class=dropdown-item href=/docs/tasks/extend-kubernetes/>English</a>
<a class=dropdown-item href=/ko/docs/tasks/extend-kubernetes/>한국어 Korean</a>
</div>
</li>
</ul>
</div>
<button id=hamburger onclick=kub.toggleMenu() data-auto-burger-exclude><div></div></button>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main>
<div class=td-content>
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.
</p><p>
<a href=/zh/docs/tasks/extend-kubernetes/>返回本页常规视图</a>.
</p>
</div>
<h1 class=title>扩展 Kubernetes</h1>
<div class=lead>了解针对工作环境需要来调整 Kubernetes 集群的进阶方法。</div>
<ul>
<li>1: <a href=#pg-8f1f7f0d3a1cc21537506bd4f9103a29>使用自定义资源</a></li>
<ul>
<li>1.1: <a href=#pg-dc64883f1fd119402b112d3ff6733452>使用 CustomResourceDefinition 扩展 Kubernetes API</a></li>
<li>1.2: <a href=#pg-7d2e2400f208b1637530752794e5a3bd>CustomResourceDefinition 的版本</a></li>
</ul>
<li>2: <a href=#pg-2bd28753e62a14a597073fa8ea18a5d8>配置聚合层</a></li>
<li>3: <a href=#pg-c4798e42eaccc051e396542befb3c57b>安装一个扩展的 API server</a></li>
<li>4: <a href=#pg-c00a2767fac9dbfafce583cf489cc423>配置多个调度器</a></li>
<li>5: <a href=#pg-1707517970dd390995f760308c2e2de6>使用 HTTP 代理访问 Kubernetes API</a></li>
<li>6: <a href=#pg-61cf1f2f0fbe98e7635fce65f04a775f>设置 Konnectivity 服务</a></li>
</ul>
<div class=content>
</div>
</div>
<div class=td-content>
<h1 id=pg-8f1f7f0d3a1cc21537506bd4f9103a29>1 - 使用自定义资源</h1>
</div>
<div class=td-content>
<h1 id=pg-dc64883f1fd119402b112d3ff6733452>1.1 - 使用 CustomResourceDefinition 扩展 Kubernetes API</h1>
<p>本页展示如何使用
<a href=/docs/reference/generated/kubernetes-api/v1.23/#customresourcedefinition-v1-apiextensions-k8s-io>CustomResourceDefinition</a>
将
<a href=/zh/docs/concepts/extend-kubernetes/api-extension/custom-resources/>定制资源（Custom Resource）</a>
安装到 Kubernetes API 上。</p>
<h2 id=before-you-begin>Before you begin</h2>
<p><p>你必须拥有一个 Kubernetes 的集群，同时你的 Kubernetes 集群必须带有 kubectl 命令行工具。
建议在至少有两个节点的集群上运行本教程，且这些节点不作为控制平面主机。
如果你还没有集群，你可以通过 <a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>Minikube</a>
构建一个你自己的集群，或者你可以使用下面任意一个 Kubernetes 工具构建：</p>
<ul>
<li><a href=https://www.katacoda.com/courses/kubernetes/playground>Katacoda</a></li>
<li><a href=http://labs.play-with-k8s.com/>玩转 Kubernetes</a></li>
</ul>
Your Kubernetes server must be at or later than version 1.16.
To check the version, enter <code>kubectl version</code>.
</p>
<p>如果你在使用较老的、仍处于被支持范围的 Kubernetes 版本，请切换到该版本的
文档查看对于的集群而言有用的建议。</p>
<h2 id=create-a-customresourcedefinition>创建 CustomResourceDefinition </h2>
<p>当你创建新的 CustomResourceDefinition（CRD）时，Kubernetes API 服务器会为你所
指定的每一个版本生成一个 RESTful 的 资源路径。CRD 可以是名字空间作用域的，也可以
是集群作用域的，取决于 CRD 的 <code>scope</code> 字段设置。和其他现有的内置对象一样，删除
一个名字空间时，该名字空间下的所有定制对象也会被删除。CustomResourceDefinition
本身是不受名字空间限制的，对所有名字空间可用。</p>
<p>例如，如果你将下面的 CustomResourceDefinition 保存到 <code>resourcedefinition.yaml</code>
文件：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 名字必需与下面的 spec 字段匹配，并且格式为 &#39;&lt;名称的复数形式&gt;.&lt;组名&gt;&#39;</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.stable.example.com<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 组名称，用于 REST API: /apis/&lt;组&gt;/&lt;版本&gt;</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>stable.example.com<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 列举此 CustomResourceDefinition 所支持的版本</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># 每个版本都可以通过 served 标志来独立启用或禁止</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># 其中一个且只有一个版本必需被标记为存储版本</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>integer<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 可以是 Namespaced 或 Cluster</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 名称的复数形式，用于 URL：/apis/&lt;组&gt;/&lt;版本&gt;/&lt;名称的复数形式&gt;</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 名称的单数形式，作为命令行使用时和显示时的别名</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># kind 通常是单数形式的帕斯卡编码（PascalCased）形式。你的资源清单会使用这一形式。</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># shortNames 允许你在命令行使用较短的字符串来匹配资源</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>shortNames</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- ct<span style=color:#bbb>
</span></code></pre></div>
<p>之后创建它：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl apply -f resourcedefinition.yaml
</code></pre></div>
<p>这样一个新的受名字空间约束的 RESTful API 端点会被创建在：</p>
<pre><code>/apis/stable.example.com/v1/namespaces/*/crontabs/...
</code></pre>
<p>此端点 URL 自此可以用来创建和管理定制对象。对象的 <code>kind</code> 将是来自你上面创建时
所用的 spec 中指定的 <code>CronTab</code>。</p>
<p>创建端点的操作可能需要几秒钟。你可以监测你的 CustomResourceDefinition 的
<code>Established</code> 状况变为 true，或者监测 API 服务器的发现信息等待你的资源出现在
那里。</p>
<h2 id=create-custom-objects>创建定制对象 </h2>
<p>在创建了 CustomResourceDefinition 对象之后，你可以创建定制对象（Custom
Objects）。定制对象可以包含定制字段。这些字段可以包含任意的 JSON 数据。
在下面的例子中，在类别为 <code>CrontTab</code> 的定制对象中，设置了<code>cronSpec</code> 和 <code>image</code>
定制字段。类别 <code>CronTab</code> 来自你在上面所创建的 CRD 的规约。</p>
<p>如果你将下面的 YAML 保存到 <code>my-crontab.yaml</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;stable.example.com/v1&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-new-cron-object<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;* * * * */5&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>my-awesome-cron-image<span style=color:#bbb>
</span></code></pre></div>
<p>并执行创建命令：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl apply -f my-crontab.yaml
</code></pre></div>
<p>你就可以使用 kubectl 来管理你的 CronTab 对象了。例如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl get crontab
</code></pre></div>
<p>应该会输出如下列表：</p>
<pre><code class=language-none data-lang=none>NAME                 AGE
my-new-cron-object   6s
</code></pre>
<p>使用 kubectl 时，资源名称是大小写不敏感的，而且你既可以使用 CRD 中所定义的单数
形式或复数形式，也可以使用其短名称：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl get ct -o yaml
</code></pre></div>
<p>你可以看到输出中包含了你创建定制对象时在 YAML 文件中指定的定制字段 <code>cronSpec</code>
和 <code>image</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>items</span>:<span style=color:#bbb>
</span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>stable.example.com/v1<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>annotations</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>kubectl.kubernetes.io/last-applied-configuration</span>:<span style=color:#bbb> </span>|<span style=color:#b44;font-style:italic>
</span><span style=color:#b44;font-style:italic>        </span><span style=color:#bbb>        </span>{<span style=color:#b44>&#34;apiVersion&#34;</span>:<span style=color:#b44>&#34;stable.example.com/v1&#34;</span>,<span style=color:#b44>&#34;kind&#34;</span>:<span style=color:#b44>&#34;CronTab&#34;</span>,<span style=color:#b44>&#34;metadata&#34;</span>:{<span style=color:#b44>&#34;annotations&#34;</span>:{},<span style=color:#b44>&#34;name&#34;</span>:<span style=color:#b44>&#34;my-new-cron-object&#34;</span>,<span style=color:#b44>&#34;namespace&#34;</span>:<span style=color:#b44>&#34;default&#34;</span>},<span style=color:#b44>&#34;spec&#34;</span>:{<span style=color:#b44>&#34;cronSpec&#34;</span>:<span style=color:#b44>&#34;* * * * */5&#34;</span>,<span style=color:#b44>&#34;image&#34;</span>:<span style=color:#b44>&#34;my-awesome-cron-image&#34;</span>}}<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>creationTimestamp</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2021-06-20T07:35:27Z&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>generation</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-new-cron-object<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resourceVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1326&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>uid</span>:<span style=color:#bbb> </span>9aab1d66-628e-41bb-a422-57b8b3b1f5a9<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;* * * * */5&#39;</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>my-awesome-cron-image<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>List<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>resourceVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selfLink</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;&#34;</span><span style=color:#bbb>
</span></code></pre></div>
<h2 id=delete-a-customresourcedefinition>删除 CustomResourceDefinition </h2>
<p>当你删除某 CustomResourceDefinition 时，服务器会卸载其 RESTful API
端点，并删除服务器上存储的所有定制对象。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl delete -f resourcedefinition.yaml
kubectl get crontabs
</code></pre></div><pre><code class=language-none data-lang=none>Error from server (NotFound): Unable to list {&quot;stable.example.com&quot; &quot;v1&quot; &quot;crontabs&quot;}: the server could not find the requested resource (get crontabs.stable.example.com)
</code></pre>
<p>如果你在以后创建相同的 CustomResourceDefinition 时，该 CRD 会是一个空的结构。</p>
<h2 id=specifying-a-structural-schema>设置结构化的模式 </h2>
<p>CustomResource 对象在定制字段中保存结构化的数据，这些字段和内置的字段
<code>apiVersion</code>、<code>kind</code> 和 <code>metadata</code> 等一起存储，不过内置的字段都会被 API
服务器隐式完成合法性检查。有了 <a href=#validation>OpenAPI v3.0 检查</a>
能力之后，你可以设置一个模式（Schema），在创建和更新定制对象时，这一模式会被用来
对对象内容进行合法性检查。参阅下文了解这类模式的细节和局限性。</p>
<p>在 <code>apiextensions.k8s.io/v1</code> 版本中，CustomResourceDefinition 的这一结构化模式
定义是必需的。
在 CustomResourceDefinition 的 beta 版本中，结构化模式定义是可选的。</p>
<p>结构化模式本身是一个 <a href=#validation>OpenAPI v3.0 验证模式</a>，其中：</p>
<ol>
<li>为对象根（root）设置一个非空的 type 值（藉由 OpenAPI 中的 <code>type</code>），对每个
object 节点的每个字段（藉由 OpenAPI 中的 <code>properties</code> 或 <code>additionalProperties</code>）以及
array 节点的每个条目（藉由 OpenAPI 中的 <code>items</code>）也要设置非空的 type 值，
除非：
<ul>
<li>节点包含属性 <code>x-kubernetes-int-or-string: true</code></li>
<li>节点包含属性 <code>x-kubernetes-preserve-unknown-fields: true</code></li>
</ul>
</li>
<li>对于 object 的每个字段或 array 中的每个条目，如果其定义中包含 <code>allOf</code>、<code>anyOf</code>、<code>oneOf</code>
或 <code>not</code>，则模式也要指定这些逻辑组合之外的字段或条目（试比较例 1 和例 2)。</li>
<li>在 <code>allOf</code>、<code>anyOf</code>、<code>oneOf</code> 或 <code>not</code> 上下文内不设置 <code>description</code>、<code>type</code>、<code>default</code>、
<code>additionalProperties</code> 或者 <code>nullable</code>。此规则的例外是
<code>x-kubernetes-int-or-string</code> 的两种模式（见下文）。</li>
<li>如果 <code>metadata</code> 被设置，则只允许对 <code>metadata.name</code> 和 <code>metadata.generateName</code> 设置约束。</li>
</ol>
<p>非结构化的例 1:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>allOf</span>:<span style=color:#bbb>
</span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span>...<span style=color:#bbb>
</span></code></pre></div>
<p>违反了第 2 条规则。下面的是正确的：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>allOf</span>:<span style=color:#bbb>
</span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span>...<span style=color:#bbb>
</span></code></pre></div>
<p>非结构化的例 2：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>allOf</span>:<span style=color:#bbb>
</span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>items</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span>...<span style=color:#bbb>
</span></code></pre></div>
<p>违反了第 2 条规则。下面的是正确的：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>items</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span>...<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>allOf</span>:<span style=color:#bbb>
</span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>items</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span>...<span style=color:#bbb>
</span></code></pre></div>
<p>非结构化的例 3：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>pattern</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;abc&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>pattern</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;^a&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>finalizers</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>array<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>items</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>pattern</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;my-finalizer&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>anyOf</span>:<span style=color:#bbb>
</span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>bar</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>integer<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>minimum</span>:<span style=color:#bbb> </span><span style=color:#666>42</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>required</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;bar&#34;</span>]<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>description</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;foo bar object&#34;</span><span style=color:#bbb>
</span></code></pre></div>
<p>不是一个结构化的模式，因为其中存在以下违例：</p>
<ul>
<li>根节点缺失 type 设置（规则 1）</li>
<li><code>foo</code> 的 type 缺失（规则 1）</li>
<li><code>anyOf</code> 中的 <code>bar</code> 未在外部指定（规则 2）</li>
<li><code>bar</code> 的 <code>type</code> 位于 <code>anyOf</code> 中（规则 3）</li>
<li><code>anyOf</code> 中设置了 <code>description</code> （规则 3）</li>
<li><code>metadata.finalizers</code> 不可以被限制 (规则 4）</li>
</ul>
<p>作为对比，下面的 YAML 所对应的模式则是结构化的：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>description</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;foo bar object&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>pattern</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;abc&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>bar</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>integer<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>pattern</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;^a&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>anyOf</span>:<span style=color:#bbb>
</span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>bar</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>minimum</span>:<span style=color:#bbb> </span><span style=color:#666>42</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>required</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;bar&#34;</span>]<span style=color:#bbb>
</span></code></pre></div>
<p>如果违反了结构化模式规则，CustomResourceDefinition 的 <code>NonStructural</code> 状况中
会包含报告信息。</p>
<h3 id=field-pruning>字段剪裁 </h3>
<p>CustomResourceDefinition 在集群的持久性存储
<a class=glossary-tooltip title="etcd 是兼具一致性和高可用性的键值数据库，用作保存 Kubernetes 所有集群数据的后台数据库。" data-toggle=tooltip data-placement=top href=/zh/docs/tasks/administer-cluster/configure-upgrade-etcd/ target=_blank aria-label=etcd>etcd</a>
中保存经过合法性检查的资源数据。
就像原生的 Kubernetes 资源，例如 <a class=glossary-tooltip title="ConfigMap 是一种 API 对象，用来将非机密性的数据保存到键值对中。使用时可以用作环境变量、命令行参数或者存储卷中的配置文件。" data-toggle=tooltip data-placement=top href=/zh/docs/tasks/configure-pod-container/configure-pod-configmap/ target=_blank aria-label=ConfigMap>ConfigMap</a>，
如果你指定了 API 服务器所无法识别的字段，则该未知字段会在保存资源之前
被 <em>剪裁（Pruned）</em> 掉（删除）。</p>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> <p>从 <code>apiextensions.k8s.io/v1beta1</code> 转换到 <code>apiextensions.k8s.io/v1</code> 的 CRD
可能没有结构化的模式定义，因此其 <code>spec.preserveUnknownFields</code> 可能为 <code>true</code>。</p>
<p>对于使用 <code>apiextensions.k8s.io/v1beta1</code> 且将 <code>spec.preserveUnknownFields</code> 设置为 <code>true</code>
创建的旧 CustomResourceDefinition 对象，有以下表现：</p>
<ul>
<li>裁剪未启用。</li>
<li>可以存储任意数据。</li>
</ul>
<p>为了与 <code>apiextensions.k8s.io/v1</code> 兼容，将你的自定义资源定义更新为：</p>
<ol>
<li>使用结构化的 OpenAPI 模式。</li>
<li><code>spec.preserveUnknownFields</code> 设置为 <code>false</code>。</li>
</ol>
</div>
<p>如果你将下面的 YAML 保存到 <code>my-crontab.yaml</code> 文件：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;stable.example.com/v1&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-new-cron-object<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;* * * * */5&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>my-awesome-cron-image<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>someRandomField</span>:<span style=color:#bbb> </span><span style=color:#666>42</span><span style=color:#bbb>
</span></code></pre></div>
<p>并创建之：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl create --validate<span style=color:#666>=</span><span style=color:#a2f>false</span> -f my-crontab.yaml -o yaml
</code></pre></div>
<p>输出类似于：</p>
<pre><code class=language-console data-lang=console>apiVersion: stable.example.com/v1
kind: CronTab
metadata:
  creationTimestamp: 2017-05-31T12:56:35Z
  generation: 1
  name: my-new-cron-object
  namespace: default
  resourceVersion: &quot;285&quot;
  uid: 9423255b-4600-11e7-af6a-28d2447dc82b
spec:
  cronSpec: '* * * * */5'
  image: my-awesome-cron-image
</code></pre>
<p>注意其中的字段 <code>someRandomField</code> 已经被剪裁掉。</p>
<p>本例中通过 <code>--validate=false</code> 命令行选项 关闭了客户端的合法性检查以展示 API 服务器的行为，
因为 <a href=#publish-validation-schema-in-openapi-v2>OpenAPI 合法性检查模式也会发布到</a>
客户端，<code>kubectl</code> 也会检查未知的字段并在对象被发送到 API
服务器之前就拒绝它们。</p>
<h4 id=controlling-pruning>控制剪裁 </h4>
<p>默认情况下，定制资源的所有版本中的所有未规定的字段都会被剪裁掉。
通过在结构化的 OpenAPI v3 <a href=#specifying-a-structural-schema>检查模式定义</a>
中为特定字段的子树添加 <code>x-kubernetes-preserve-unknown-fields: true</code> 属性，可以
选择不对其执行剪裁操作。
例如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>json</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>x-kubernetes-preserve-unknown-fields</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></code></pre></div>
<p>字段 <code>json</code> 可以保存任何 JSON 值，其中内容不会被剪裁掉。</p>
<p>你也可以部分地指定允许的 JSON 数据格式；例如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>json</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>x-kubernetes-preserve-unknown-fields</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>description</span>:<span style=color:#bbb> </span>this is arbitrary JSON<span style=color:#bbb>
</span></code></pre></div>
<p>通过这样设置，JSON 中只能设置 <code>object</code> 类型的值。</p>
<p>对于所指定的每个属性（或 <code>additionalProperties</code>），剪裁会再次被启用。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>json</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>x-kubernetes-preserve-unknown-fields</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>bar</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></code></pre></div>
<p>对于上述定义，如果提供的数值如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>json</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb> </span>abc<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>bar</span>:<span style=color:#bbb> </span>def<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>something</span>:<span style=color:#bbb> </span>x<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>something</span>:<span style=color:#bbb> </span>x<span style=color:#bbb>
</span></code></pre></div>
<p>则该值会被剪裁为：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>json</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb> </span>abc<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>bar</span>:<span style=color:#bbb> </span>def<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>something</span>:<span style=color:#bbb> </span>x<span style=color:#bbb>
</span></code></pre></div>
<p>这意味着所指定的 <code>spec</code> 对象中的 <code>something</code> 字段被剪裁掉，而其外部的内容都被保留。</p>
<h3 id=intorstring>IntOrString</h3>
<p>模式定义中标记了 <code>x-kubernetes-int-or-string: true</code> 的节点不受前述规则 1
约束，因此下面的定义是结构化的模式：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>x-kubernetes-int-or-string</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></code></pre></div>
<p>此外，所有这类节点也不再受规则 3 约束，也就是说，下面两种模式是被允许的
（注意，仅限于这两种模式，不支持添加新字段的任何其他变种）：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>x-kubernetes-int-or-string</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>anyOf</span>:<span style=color:#bbb>
</span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>integer<span style=color:#bbb>
</span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></code></pre></div><p>和</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>x-kubernetes-int-or-string</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>allOf</span>:<span style=color:#bbb>
</span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>anyOf</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>integer<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb></span>- ...<span style=color:#bbb> </span><span style=color:#080;font-style:italic># zero or more</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></code></pre></div>
<p>在以上两种规约中，整数值和字符串值都会被认为是合法的。</p>
<p>在<a href=#publish-validation-schema-in-openapi-v2>合法性检查模式定义的发布时</a>，
<code>x-kubernetes-int-or-string: true</code> 会被展开为上述两种模式之一。</p>
<h3 id=rawextension>RawExtension</h3>
<p>RawExtensions（就像在
<a href=https://github.com/kubernetes/apimachinery/blob/03ac7a9ade429d715a1a46ceaa3724c18ebae54f/pkg/runtime/types.go#L94>k8s.io/apimachinery</a>
项目中 <code>runtime.RawExtension</code> 所定义的那样）
可以保存完整的 Kubernetes 对象，也就是，其中会包含 <code>apiVersion</code> 和 <code>kind</code>
字段。</p>
<p>通过 <code>x-kubernetes-embedded-resource: true</code> 来设定这些嵌套对象的规约（无论是
完全无限制还是部分指定都可以）是可能的。例如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>x-kubernetes-embedded-resource</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>x-kubernetes-preserve-unknown-fields</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></code></pre></div>
<p>这里，字段 <code>foo</code> 包含一个完整的对象，例如：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span></code></pre></div>
<p>由于字段上设置了 <code>x-kubernetes-preserve-unknown-fields: true</code>，其中的内容不会
被剪裁。不过，在这个语境中，<code>x-kubernetes-preserve-unknown-fields: true</code> 的
使用是可选的。</p>
<p>设置了 <code>x-kubernetes-embedded-resource: true</code> 之后，<code>apiVersion</code>、<code>kind</code> 和
<code>metadata</code> 都是隐式设定并隐式完成合法性验证。</p>
<h2 id=serving-multiple-versions-of-a-crd>提供 CRD 的多个版本 </h2>
<p>关于如何为你的 CustomResourceDefinition 提供多个版本的支持，以及如何将你的对象
从一个版本迁移到另一个版本， 详细信息可参阅
<a href=/zh/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definition-versioning/>定制资源定义的版本</a>。</p>
<h2 id=advanced-topics>高级主题 </h2>
<h3 id=finalizers>Finalizers</h3>
<p><em>Finalizer</em> 能够让控制器实现异步的删除前（Pre-delete）回调。
与内置对象类似，定制对象也支持 Finalizer。</p>
<p>你可以像下面一样为定制对象添加 Finalizer：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;stable.example.com/v1&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>finalizers</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- stable.example.com/finalizer<span style=color:#bbb>
</span></code></pre></div>
<p>自定义 Finalizer 的标识符包含一个域名、一个正向斜线和 finalizer 的名称。
任何控制器都可以在任何对象的 finalizer 列表中添加新的 finalizer。</p>
<p>对带有 Finalizer 的对象的第一个删除请求会为其 <code>metadata.deletionTimestamp</code>
设置一个值，但不会真的删除对象。一旦此值被设置，<code>finalizers</code> 列表中的表项
只能被移除。在列表中仍然包含 finalizer 时，无法强制删除对应的对象。</p>
<p>当 <code>metadata.deletionTimestamp</code> 字段被设置时，监视该对象的各个控制器会
执行它们所能处理的 finalizer，并在完成处理之后将其从列表中移除。
每个控制器负责将其 finalizer 从列表中删除。</p>
<p><code>metadata.deletionGracePeriodSeconds</code> 的取值控制对更新的轮询周期。</p>
<p>一旦 finalizers 列表为空时，就意味着所有 finalizer 都被执行过，
Kubernetes 会最终删除该资源，</p>
<h3 id=validation>合法性检查 </h3>
<p>定制资源是通过
<a href=https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.0.md#schemaObject>OpenAPI v3 模式定义</a>
来执行合法性检查的，
你可以通过使用<a href=/zh/docs/reference/access-authn-authz/admission-controllers/#validatingadmissionwebhook>准入控制 Webhook</a>
来添加额外的合法性检查逻辑。</p>
<p>此外，对模式定义存在以下限制：</p>
<ul>
<li>以下字段不可设置：
<ul>
<li><code>definitions</code></li>
<li><code>dependencies</code></li>
<li><code>deprecated</code></li>
<li><code>discriminator</code></li>
<li><code>id</code></li>
<li><code>patternProperties</code></li>
<li><code>readOnly</code></li>
<li><code>writeOnly</code></li>
<li><code>xml</code></li>
<li><code>$ref</code></li>
</ul>
</li>
<li>字段 <code>uniqueItems</code> 不可设置为 <code>true</code></li>
<li>字段 <code>additionalProperties</code> 不可设置为 <code>false</code></li>
<li>字段 <code>additionalProperties</code> 与 <code>properties</code> 互斥，不可同时使用</li>
</ul>
<p>当<a href=#defaulting>设置默认值特性</a>被启用时，可以设置字段 <code>default</code>。
就 <code>apiextensions.k8s.io/v1</code> 组的 CustomResourceDefinitions，这一条件是满足的。
设置默认值的功能特性从 1.17 开始正式发布。该特性在 1.16 版本中处于
Beta 状态，要求 <code>CustomResourceDefaulting</code>
<a href=/zh/docs/reference/command-line-tools-reference/feature-gates/>特性门控</a>
被启用。对于大多数集群而言，Beta 状态的特性门控默认都是自动启用的。</p>
<p>关于对某些 CustomResourceDefinition 特性所必需的限制，可参见
<a href=#specifying-a-structural-schema>结构化的模式定义</a>小节。</p>
<p>模式定义是在 CustomResourceDefinition 中设置的。在下面的例子中，
CustomResourceDefinition 对定制对象执行以下合法性检查：</p>
<ul>
<li><code>spec.cronSpec</code> 必须是一个字符串，必须是正则表达式所描述的形式；</li>
<li><code>spec.replicas</code> 必须是一个整数，且其最小值为 1、最大值为 10。</li>
</ul>
<p>将此 CustomResourceDefinition 保存到 <code>resourcedefinition.yaml</code> 文件中：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.stable.example.com<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>stable.example.com<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:#080;font-style:italic># openAPIV3Schema is the schema for validating custom objects.</span><span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>pattern</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;^(\d+|\*)(/\d+)?(\s+(\d+|\*)(/\d+)?){4}$&#39;</span><span style=color:#bbb>
</span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>integer<span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>minimum</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>maximum</span>:<span style=color:#bbb> </span><span style=color:#666>10</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>shortNames</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- ct<span style=color:#bbb>
</span></code></pre></div>
<p>并创建 CustomResourceDefinition：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl apply -f resourcedefinition.yaml
</code></pre></div>
<p>对于一个创建 CronTab 类别对象的定制对象的请求而言，如果其字段中包含非法值，则
该请求会被拒绝。
在下面的例子中，定制对象中包含带非法值的字段：</p>
<ul>
<li><code>spec.cronSpec</code> 与正则表达式不匹配</li>
<li><code>spec.replicas</code> 数值大于 10。</li>
</ul>
<p>如果你将下面的 YAML 保存到 <code>my-crontab.yaml</code>：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;stable.example.com/v1&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-new-cron-object<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;* * * *&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>my-awesome-cron-image<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>15</span><span style=color:#bbb>
</span></code></pre></div>
<p>并尝试创建定制对象：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl apply -f my-crontab.yaml
</code></pre></div>
<p>你会看到下面的错误信息：</p>
<pre><code class=language-console data-lang=console>The CronTab &quot;my-new-cron-object&quot; is invalid: []: Invalid value: map[string]interface {}{&quot;apiVersion&quot;:&quot;stable.example.com/v1&quot;, &quot;kind&quot;:&quot;CronTab&quot;, &quot;metadata&quot;:map[string]interface {}{&quot;name&quot;:&quot;my-new-cron-object&quot;, &quot;namespace&quot;:&quot;default&quot;, &quot;deletionTimestamp&quot;:interface {}(nil), &quot;deletionGracePeriodSeconds&quot;:(*int64)(nil), &quot;creationTimestamp&quot;:&quot;2017-09-05T05:20:07Z&quot;, &quot;uid&quot;:&quot;e14d79e7-91f9-11e7-a598-f0761cb232d1&quot;, &quot;clusterName&quot;:&quot;&quot;}, &quot;spec&quot;:map[string]interface {}{&quot;cronSpec&quot;:&quot;* * * *&quot;, &quot;image&quot;:&quot;my-awesome-cron-image&quot;, &quot;replicas&quot;:15}}:
validation failure list:
spec.cronSpec in body should match '^(\d+|\*)(/\d+)?(\s+(\d+|\*)(/\d+)?){4}$'
spec.replicas in body should be less than or equal to 10
</code></pre>
<p>如果所有字段都包含合法值，则对象创建的请求会被接受。</p>
<p>将下面的 YAML 保存到 <code>my-crontab.yaml</code> 文件：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;stable.example.com/v1&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-new-cron-object<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;* * * * */5&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>my-awesome-cron-image<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>5</span><span style=color:#bbb>
</span></code></pre></div>
<p>并创建定制对象：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl apply -f my-crontab.yaml
crontab <span style=color:#b44>&#34;my-new-cron-object&#34;</span> created
</code></pre></div>
<h3 id=efaulting>设置默认值 </h3>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> 要使用设置默认值功能，你的 CustomResourceDefinition 必须使用 API 版本 <code>apiextensions.k8s.io/v1</code>。
</div>
<p>设置默认值的功能允许在 <a href=#validation>OpenAPI v3 合法性检查模式定义</a>中设置默认值：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.stable.example.com<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>stable.example.com<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:#080;font-style:italic># openAPIV3Schema 是用来检查定制对象的模式定义</span><span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>pattern</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;^(\d+|\*)(/\d+)?(\s+(\d+|\*)(/\d+)?){4}$&#39;</span><span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>default</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;5 0 * * *&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>integer<span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>minimum</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>maximum</span>:<span style=color:#bbb> </span><span style=color:#666>10</span><span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>default</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>shortNames</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- ct<span style=color:#bbb>
</span></code></pre></div>
<p>使用此 CRD 定义时，<code>cronSpec</code> 和 <code>replicas</code> 都会被设置默认值：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;stable.example.com/v1&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-new-cron-object<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>my-awesome-cron-image<span style=color:#bbb>
</span></code></pre></div>
<p>会生成：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;stable.example.com/v1&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-new-cron-object<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;5 0 * * *&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>my-awesome-cron-image<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span></code></pre></div>
<p>默认值设定的行为发生在定制对象上：</p>
<ul>
<li>在向 API 服务器发送的请求中，基于请求版本的设定设置默认值；</li>
<li>在从 etcd 读取对象时，使用存储版本来设置默认值；</li>
<li>在 Mutating 准入控制插件执行非空的补丁操作时，基于准入 Webhook 对象
版本设置默认值。</li>
</ul>
<p>从 etcd 中读取数据时所应用的默认值设置不会被写回到 etcd 中。
需要通过 API 执行更新请求才能将这种方式设置的默认值写回到 etcd。</p>
<p>默认值一定会被剪裁（除了 <code>metadata</code> 字段的默认值设置），且必须通过所提供
的模式定义的检查。</p>
<p>针对 <code>x-kubernetes-embedded-resource: true</code> 节点（或者包含 <code>metadata</code> 字段的结构的默认值）
的 <code>metadata</code> 字段的默认值设置不会在 CustomResourceDefinition 创建时被剪裁，
而是在处理请求的字段剪裁阶段被删除。</p>
<h4 id=defaulting-and-nullable>设置默认值和字段是否可为空（Nullable） </h4>
<p><strong>1.20 版本新增:</strong> 对于未设置其 nullable 标志的字段或者将该标志设置为
<code>false</code> 的字段，其空值（Null）会在设置默认值之前被剪裁掉。如果对应字段
存在默认值，则默认值会被赋予该字段。当 <code>nullable</code> 被设置为 <code>true</code> 时，
字段的空值会被保留，且不会在设置默认值时被覆盖。</p>
<p>例如，给定下面的 OpenAPI 模式定义：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>nullable</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>default</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;default&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>bar</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>nullable</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>baz</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span></code></pre></div>
<p>像下面这样创建一个为 <code>foo</code>、<code>bar</code> 和 <code>baz</code> 设置空值的对象时：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>null</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>bar</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>null</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>baz</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>null</span><span style=color:#bbb>
</span></code></pre></div>
<p>其结果会是这样：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>foo</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;default&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>bar</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>null</span><span style=color:#bbb>
</span></code></pre></div>
<p>其中的 <code>foo</code> 字段被剪裁掉并重新设置默认值，因为该字段是不可为空的。
<code>bar</code> 字段的 <code>nullable: true</code> 使得其能够保有其空值。
<code>baz</code> 字段则被完全剪裁掉，因为该字段是不可为空的，并且没有默认值设置。</p>
<h3 id=publish-validation-schema-in-openapi-v2>以 OpenAPI v2 形式发布合法性检查模式 </h3>
<p>CustomResourceDefinition 的<a href=#specifying-a-structural-schema>结构化的</a>、
<a href=#preserving-unknown-fields>启用了剪裁的</a> <a href=#validation>OpenAPI v3 合法性检查模式</a>
会在 Kubernetes API 服务器上作为
<a href=/zh/docs/concepts/overview/kubernetes-api/#openapi-and-swagger-definitions>OpenAPI v2 规约</a>
的一部分发布出来。</p>
<p><a href=/zh/docs/reference/kubectl/overview>kubectl</a> 命令行工具会基于所发布的模式定义来执行
客户端的合法性检查（<code>kubectl create</code> 和 <code>kubectl apply</code>），为定制资源的模式定义
提供解释（<code>kubectl explain</code>）。
所发布的模式还可被用于其他目的，例如生成客户端或者生成文档。</p>
<p>OpenAPI v3 合法性检查模式定义会被转换为 OpenAPI v2 模式定义，并出现在
<a href=/zh/docs/concepts/overview/kubernetes-api/#openapi-and-swagger-definitions>OpenAPI v2 规范</a>
的 <code>definitions</code> 和 <code>paths</code> 字段中。</p>
<p>在转换过程中会发生以下修改，目的是保持与 1.13 版本以前的 kubectl 工具兼容。
这些修改可以避免 kubectl 过于严格，以至于拒绝它无法理解的 OpenAPI 模式定义。
转换过程不会更改 CRD 中定义的合法性检查模式定义，因此不会影响到 API 服务器中
的<a href=#validation>合法性检查</a>。</p>
<ol>
<li>以下字段会被移除，因为它们在 OpenAPI v2 中不支持（在将来版本中将使用 OpenAPI v3，
因而不会有这些限制）
<ul>
<li>字段 <code>allOf</code>、<code>anyOf</code>、<code>oneOf</code> 和 <code>not</code> 会被删除</li>
</ul>
</li>
<li>如果设置了 <code>nullable: true</code>，我们会丢弃 <code>type</code>、<code>nullable</code>、<code>items</code> 和 <code>properties</code>
OpenAPI v2 无法表达 Nullable。为了避免 kubectl 拒绝正常的对象，这一转换是必要的。</li>
</ol>
<h3 id=additional-printer-columns>额外的打印列 </h3>
<p><code>kubectl</code> 工具依赖服务器端的输出格式化。你的集群的 API 服务器决定 <code>kubectl get</code> 命令要显示的列有哪些。
你可以为 CustomResourceDefinition 定制这些要打印的列。
下面的例子添加了 <code>Spec</code>、<code>Replicas</code> 和 <code>Age</code> 列：</p>
<p>将此 CustomResourceDefinition 保存到 <code>resourcedefinition.yaml</code> 文件：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.stable.example.com<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>stable.example.com<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>shortNames</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- ct<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb>
</span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb>
</span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>integer<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>additionalPrinterColumns</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>Spec<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>description</span>:<span style=color:#bbb> </span>The cron spec defining the interval a CronJob is run<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>jsonPath</span>:<span style=color:#bbb> </span>.spec.cronSpec<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>Replicas<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>integer<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>description</span>:<span style=color:#bbb> </span>The number of jobs launched by the CronJob<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>jsonPath</span>:<span style=color:#bbb> </span>.spec.replicas<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>Age<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>date<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>jsonPath</span>:<span style=color:#bbb> </span>.metadata.creationTimestamp<span style=color:#bbb>
</span></code></pre></div>
<p>创建 CustomResourceDefinition：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl apply -f resourcedefinition.yaml
</code></pre></div>
<p>使用前文中的 <code>my-crontab.yaml</code> 创建一个实例。</p>
<p>启用服务器端打印输出：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl get crontab my-new-cron-object
</code></pre></div>
<p>注意输出中的 <code>NAME</code>、<code>SPEC</code>、<code>REPLICAS</code> 和 <code>AGE</code> 列：</p>
<pre><code>NAME                 SPEC        REPLICAS   AGE
my-new-cron-object   * * * * *   1          7s
</code></pre>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> <code>NAME</code> 列是隐含的，不需要在 CustomResourceDefinition 中定义。
</div>
<h4 id=priority>优先级 </h4>
<p>每个列都包含一个 <code>priority</code>（优先级）字段。当前，优先级用来区分标准视图（Standard
View）和宽视图（Wide View）（使用 <code>-o wide</code> 标志）中显示的列：</p>
<ul>
<li>优先级为 <code>0</code> 的列会在标准视图中显示。</li>
<li>优先级大于 <code>0</code> 的列只会在宽视图中显示。</li>
</ul>
<h4 id=type>类型 </h4>
<p>列的 <code>type</code> 字段可以是以下值之一
（比较 <a href=https://github.com/OAI/OpenAPI-Specification/blob/master/versions/3.0.0.md#dataTypes>OpenAPI v3 数据类型</a>）：</p>
<ul>
<li><code>integer</code> – 非浮点数字</li>
<li><code>number</code> – 浮点数字</li>
<li><code>string</code> – 字符串</li>
<li><code>boolean</code> – <code>true</code> 或 <code>false</code></li>
<li><code>date</code> – 显示为以自此时间戳以来经过的时长</li>
</ul>
<p>如果定制资源中的值与列中指定的类型不匹配，该值会被忽略。
你可以通过定制资源的合法性检查来确保取值类型是正确的。</p>
<h4 id=format>格式 </h4>
<p>列的 <code>format</code> 字段可以是以下值之一：</p>
<ul>
<li><code>int32</code></li>
<li><code>int64</code></li>
<li><code>float</code></li>
<li><code>double</code></li>
<li><code>byte</code></li>
<li><code>date</code></li>
<li><code>date-time</code></li>
<li><code>password</code></li>
</ul>
<p>列的 <code>format</code> 字段控制 <code>kubectl</code> 打印对应取值时采用的风格。</p>
<h3 id=subresources>子资源 </h3>
<p>定制资源支持 <code>/status</code> 和 <code>/scale</code> 子资源。</p>
<p>通过在 CustomResourceDefinition 中定义 <code>status</code> 和 <code>scale</code>，
可以有选择地启用这些子资源。</p>
<h4 id=status-subresource>Status 子资源 </h4>
<p>当启用了 status 子资源时，对应定制资源的 <code>/status</code> 子资源会被暴露出来。</p>
<ul>
<li>status 和 spec 内容分别用定制资源内的 <code>.status</code> 和 <code>.spec</code> JSON 路径来表达；</li>
<li>对 <code>/status</code> 子资源的 <code>PUT</code> 请求要求使用定制资源对象作为其输入，但会忽略
status 之外的所有内容。</li>
<li>对 <code>/status</code> 子资源的 <code>PUT</code> 请求仅对定制资源的 status 内容进行合法性检查。</li>
<li>对定制资源的 <code>PUT</code>、<code>POST</code>、<code>PATCH</code> 请求会忽略 status 内容的改变。</li>
<li>对所有变更请求，除非改变是针对 <code>.metadata</code> 或 <code>.status</code>，<code>.metadata.generation</code>
的取值都会增加。</li>
</ul>
<ul>
<li>
<p>在 CRD OpenAPI 合法性检查模式定义的根节点，只允许存在以下结构：</p>
<ul>
<li><code>description</code></li>
<li><code>example</code></li>
<li><code>exclusiveMaximum</code></li>
<li><code>exclusiveMinimum</code></li>
<li><code>externalDocs</code></li>
<li><code>format</code></li>
<li><code>items</code></li>
<li><code>maximum</code></li>
<li><code>maxItems</code></li>
<li><code>maxLength</code></li>
<li><code>minimum</code></li>
<li><code>minItems</code></li>
<li><code>minLength</code></li>
<li><code>multipleOf</code></li>
<li><code>pattern</code></li>
<li><code>properties</code></li>
<li><code>required</code></li>
<li><code>title</code></li>
<li><code>type</code></li>
<li><code>uniqueItems</code></li>
</ul>
</li>
</ul>
<h4 id=scale-subresource>Scale 子资源 </h4>
<p>当启用了 scale 子资源时，定制资源的 <code>/scale</code> 子资源就被暴露出来。
针对 <code>/scale</code> 所发送的对象是 <code>autoscaling/v1.Scale</code>。</p>
<p>为了启用 scale 子资源，CustomResourceDefinition 定义了以下字段：</p>
<ul>
<li>
<p><code>specReplicasPath</code> 指定定制资源内与 <code>scale.spec.replicas</code> 对应的 JSON 路径。</p>
<ul>
<li>此字段为必需值。</li>
<li>只可以使用 <code>.spec</code> 下的 JSON 路径，只可使用带句点的路径。</li>
<li>如果定制资源的 <code>specReplicasPath</code> 下没有取值，则针对 <code>/scale</code> 子资源执行 GET
操作时会返回错误。</li>
</ul>
</li>
</ul>
<ul>
<li>
<p><code>statusReplicasPath</code> 指定定制资源内与 <code>scale.status.replicas</code> 对应的 JSON 路径。</p>
<ul>
<li>此字段为必需值。</li>
<li>只可以使用 <code>.status</code> 下的 JSON 路径，只可使用带句点的路径。</li>
<li>如果定制资源的 <code>statusReplicasPath</code> 下没有取值，则针对 <code>/scale</code> 子资源的
副本个数状态值默认为 0。</li>
</ul>
</li>
</ul>
<ul>
<li>
<p><code>labelSelectorPath</code> 指定定制资源内与 <code>scale.status.selector</code> 对应的 JSON 路径。</p>
<ul>
<li>此字段为可选值。</li>
<li>此字段必须设置才能使用 HPA。</li>
<li>只可以使用 <code>.status</code> 或 <code>.spec</code> 下的 JSON 路径，只可使用带句点的路径。</li>
<li>如果定制资源的 <code>labelSelectorPath</code> 下没有取值，则针对 <code>/scale</code> 子资源的
选择算符状态值默认为空字符串。</li>
<li>此 JSON 路径所指向的字段必须是一个字符串字段（而不是复合的选择算符结构），
其中包含标签选择算符串行化的字符串形式。</li>
</ul>
</li>
</ul>
<p>在下面的例子中，<code>status</code> 和 <code>scale</code> 子资源都被启用。</p>
<p>将此 CustomResourceDefinition 保存到 <code>resourcedefinition.yaml</code> 文件：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.stable.example.com<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>stable.example.com<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>integer<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb>
</span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>integer<span style=color:#bbb>
</span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>labelSelector</span>:<span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># subresources 描述定制资源的子资源</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>subresources</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:#080;font-style:italic># status 启用 status 子资源</span><span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb> </span>{}<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:#080;font-style:italic># scale 启用 scale 子资源</span><span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>scale</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:#080;font-style:italic># specReplicasPath 定义定制资源中对应 scale.spec.replicas 的 JSON 路径</span><span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>specReplicasPath</span>:<span style=color:#bbb> </span>.spec.replicas<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:#080;font-style:italic># statusReplicasPath 定义定制资源中对应 scale.status.replicas 的 JSON 路径 </span><span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>statusReplicasPath</span>:<span style=color:#bbb> </span>.status.replicas<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:#080;font-style:italic># labelSelectorPath  定义定制资源中对应 scale.status.selector 的 JSON 路径 </span><span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>labelSelectorPath</span>:<span style=color:#bbb> </span>.status.labelSelector<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>shortNames</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- ct<span style=color:#bbb>
</span></code></pre></div>
<p>之后创建此 CustomResourceDefinition：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl apply -f resourcedefinition.yaml
</code></pre></div>
<p>CustomResourceDefinition 对象创建完毕之后，你可以创建定制对象，。</p>
<p>如果你将下面的 YAML 保存到 <code>my-crontab.yaml</code> 文件：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;stable.example.com/v1&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-new-cron-object<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;* * * * */5&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>my-awesome-cron-image<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>3</span><span style=color:#bbb>
</span></code></pre></div>
<p>并创建定制对象：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl apply -f my-crontab.yaml
</code></pre></div>
<p>那么会创建新的、命名空间作用域的 RESTful API 端点：</p>
<pre><code>/apis/stable.example.com/v1/namespaces/*/crontabs/status
</code></pre>
<p>和</p>
<pre><code>/apis/stable.example.com/v1/namespaces/*/crontabs/scale
</code></pre>
<p>定制资源可以使用 <code>kubectl scale</code> 命令来扩缩其规模。
例如下面的命令将前面创建的定制资源的 <code>.spec.replicas</code> 设置为 5：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl scale --replicas<span style=color:#666>=</span><span style=color:#666>5</span> crontabs/my-new-cron-object
</code></pre></div><pre><code>crontabs &quot;my-new-cron-object&quot; scaled
</code></pre><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl get crontabs my-new-cron-object -o <span style=color:#b8860b>jsonpath</span><span style=color:#666>=</span><span style=color:#b44>&#39;{.spec.replicas}&#39;</span>
</code></pre></div><pre><code>5
</code></pre>
<p>你可以使用 <a href=/zh/docs/tasks/run-application/configure-pdb/>PodDisruptionBudget</a>
来保护启用了 scale 子资源的定制资源。</p>
<h3 id=categories>分类 </h3>
<p>分类（Categories）是定制资源所归属的分组资源列表（例如，<code>all</code>）。
你可以使用 <code>kubectl get &lt;分类名称></code> 来列举属于某分类的所有资源。</p>
<p>下面的示例在 CustomResourceDefinition 中将 <code>all</code> 添加到分类列表中，
并展示了如何使用 <code>kubectl get all</code> 来输出定制资源：</p>
<p>将下面的 CustomResourceDefinition 保存到 <code>resourcedefinition.yaml</code> 文件中：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.stable.example.com<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>stable.example.com<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb>                </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>integer<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>shortNames</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- ct<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># categories 是定制资源所归属的分类资源列表</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>categories</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- all<span style=color:#bbb>
</span></code></pre></div>
<p>之后创建此 CRD：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl apply -f resourcedefinition.yaml
</code></pre></div>
<p>创建了 CustomResourceDefinition 对象之后，你可以创建定制对象。</p>
<p>将下面的 YAML 保存到 <code>my-crontab.yaml</code> 中：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;stable.example.com/v1&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-new-cron-object<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>cronSpec</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;* * * * */5&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>my-awesome-cron-image<span style=color:#bbb>
</span></code></pre></div>
<p>并创建定制对象：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl apply -f my-crontab.yaml
</code></pre></div>
<p>你可以在使用 <code>kubectl get</code> 时指定分类：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl get all
</code></pre></div>
<p>输出中会包含类别为 <code>CronTab</code> 的定制资源：</p>
<pre><code class=language-console data-lang=console>NAME                          AGE
crontabs/my-new-cron-object   3s
</code></pre><h2 id=what-s-next>What's next</h2>
<ul>
<li>阅读了解<a href=/zh/docs/concepts/extend-kubernetes/api-extension/custom-resources/>定制资源</a></li>
<li>参阅 <a href=/docs/reference/generated/kubernetes-api/v1.23/#customresourcedefinition-v1-apiextensions-k8s-io>CustomResourceDefinition</a></li>
<li>参阅支持 CustomResourceDefinition 的<a href=/zh/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definition-versioning/>多个版本</a></li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-7d2e2400f208b1637530752794e5a3bd>1.2 - CustomResourceDefinition 的版本</h1>
<p>本页介绍如何添加版本信息到
<a href=/docs/reference/generated/kubernetes-api/v1.23/#customresourcedefinition-v1beta1-apiextensions>CustomResourceDefinitions</a>。
目的是标明 CustomResourceDefinitions 的稳定级别或者服务于 API 升级。
API 升级时需要在不同 API 表示形式之间进行转换。
本页还描述如何将对象从一个版本升级到另一个版本。</p>
<h2 id=before-you-begin>Before you begin</h2>
<p>你必须拥有一个 Kubernetes 的集群，同时你的 Kubernetes 集群必须带有 kubectl 命令行工具。
建议在至少有两个节点的集群上运行本教程，且这些节点不作为控制平面主机。
如果你还没有集群，你可以通过 <a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>Minikube</a>
构建一个你自己的集群，或者你可以使用下面任意一个 Kubernetes 工具构建：</p>
<ul>
<li><a href=https://www.katacoda.com/courses/kubernetes/playground>Katacoda</a></li>
<li><a href=http://labs.play-with-k8s.com/>玩转 Kubernetes</a></li>
</ul>
<p>你应该对<a href=/zh/docs/concepts/extend-kubernetes/api-extension/custom-resources/>定制资源</a>
有一些初步了解。</p>
Your Kubernetes server must be at or later than version v1.16.
To check the version, enter <code>kubectl version</code>.
<h2 id=概览>概览</h2>
<p>CustomResourceDefinition API 提供了用于引入和升级的工作流程到 CustomResourceDefinition
的新版本。</p>
<p>创建 CustomResourceDefinition 时，会在 CustomResourceDefinition <code>spec.versions</code>
列表设置适当的稳定级别和版本号。例如，<code>v1beta1</code> 表示第一个版本尚未稳定。
所有定制资源对象将首先用这个版本保存。</p>
<p>创建 CustomResourceDefinition 后，客户端可以开始使用 <code>v1beta1</code> API。</p>
<p>稍后可能需要添加新版本，例如 <code>v1</code>。</p>
<p>添加新版本：</p>
<ol>
<li>选择一种转化策略。由于定制资源对象需要能够两种版本都可用，
这意味着它们有时会以与存储版本不同的版本来提供服务。为了能够做到这一点，
有时必须在它们存储的版本和提供的版本之间进行转换。如果转换涉及模式变更，
并且需要自定义逻辑，则应该使用 Webhook 来完成。如果没有模式变更，
则可使用默认的 <code>None</code> 转换策略，为不同版本提供服务时只有 <code>apiVersion</code> 字段
会被改变。</li>
<li>如果使用转换 Webhook，请创建并部署转换 Webhook。更多详细信息请参见
<a href=#webhook-conversion>Webhook conversion</a>。</li>
<li>更新 CustomResourceDefinition，将新版本设置为 <code>served：true</code>，加入到
<code>spec.versions</code> 列表。另外，还要设置 <code>spec.conversion</code> 字段
为所选的转换策略。如果使用转换 Webhook，请配置
<code>spec.conversion.webhookClientConfig</code> 来调用 Webhook。</li>
</ol>
<p>添加新版本后，客户端可以逐步迁移到新版本。让某些客户使用旧版本的同时
支持其他人使用新版本是相当安全的。</p>
<p>将存储的对象迁移到新版本：</p>
<ol>
<li>请参阅<a href=#upgrade-existing-objects-to-a-new-stored-version>将现有对象升级到新的存储版本</a>节。</li>
</ol>
<p>对于客户来说，在将对象升级到新的存储版本之前、期间和之后使用旧版本和新版本都是安全的。</p>
<p>删除旧版本：</p>
<ol>
<li>确保所有客户端都已完全迁移到新版本。
可以查看 kube-apiserver 的日志以识别仍通过旧版本进行访问的所有客户端。</li>
<li>在 <code>spec.versions</code> 列表中将旧版本的 <code>served</code> 设置为 <code>false</code>。
如果仍有客户端意外地使用旧版本，他们可能开始会报告采用旧版本尝试访
定制资源的错误消息。
如果发生这种情况，请将旧版本的<code>served：true</code> 恢复，然后迁移余下的客户端
使用新版本，然后重复此步骤。</li>
<li>确保已完成<a href=#upgrade-existing-objects-to-a-new-stored-version>将现有对象升级到新存储版本</a>
的步骤。
<ol>
<li>在 CustomResourceDefinition 的 <code>spec.versions</code> 列表中，确认新版本的
<code>storage</code> 已被设置为 <code>true</code>。</li>
<li>确认旧版本不在 CustomResourceDefinition <code>status.storedVersions</code> 中。</li>
</ol>
</li>
<li>从 CustomResourceDefinition <code>spec.versions</code> 列表中删除旧版本。</li>
<li>在转换 Webhooks 中放弃对旧版本的转换支持。</li>
</ol>
<h2 id=specify-multiple-versions>指定多个版本 </h2>
<p>CustomResourceDefinition API 的 <code>versions</code> 字段可用于支持你所开发的
定制资源的多个版本。版本可以具有不同的模式，并且转换 Webhooks
可以在多个版本之间转换定制资源。
在适当的情况下，Webhook 转换应遵循
<a href=https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md>Kubernetes API 约定</a>。
尤其是，请查阅
<a href=https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api_changes.md>API 变更文档</a>
以了解一些有用的常见错误和建议。</p>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> 在 <code>apiextensions.k8s.io/v1beta1</code> 版本中曾经有一个 <code>version</code> 字段，
名字不叫做 <code>versions</code>。该 <code>version</code> 字段已经被废弃，成为可选项。
不过如果该字段不是空，则必须与 <code>versions</code> 字段中的第一个条目匹配。
</div>
<p>下面的示例显示了两个版本的 CustomResourceDefinition。
第一个例子中假设所有的版本使用相同的模式而它们之间没有转换。
YAML 中的注释提供了更多背景信息。</p>
<ul class="nav nav-tabs" id=customresourcedefinition-versioning-example-1 role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#customresourcedefinition-versioning-example-1-0 role=tab aria-controls=customresourcedefinition-versioning-example-1-0 aria-selected=true>apiextensions.k8s.io/v1</a></li>
<li class=nav-item><a data-toggle=tab class=nav-link href=#customresourcedefinition-versioning-example-1-1 role=tab aria-controls=customresourcedefinition-versioning-example-1-1>apiextensions.k8s.io/v1beta1</a></li></ul>
<div class=tab-content id=customresourcedefinition-versioning-example-1><div id=customresourcedefinition-versioning-example-1-0 class="tab-pane show active" role=tabpanel aria-labelledby=customresourcedefinition-versioning-example-1-0>
<p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># name 必须匹配后面 spec 中的字段，且使用格式 &lt;plural&gt;.&lt;group&gt;</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.example.com<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 组名，用于 REST API: /apis/&lt;group&gt;/&lt;version&gt;</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>example.com<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 此 CustomResourceDefinition 所支持的版本列表</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1beta1<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 每个 version 可以通过 served 标志启用或禁止</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 有且只能有一个 version 必须被标记为存储版本</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># schema 是必需字段</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>host</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>host</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># conversion 节是 Kubernetes 1.13+ 版本引入的，其默认值为无转换，即</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># strategy 子字段设置为 None。</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>conversion</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># None 转换假定所有版本采用相同的模式定义，仅仅将定制资源的 apiVersion</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 设置为合适的值.</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb> </span>None<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 可以是 Namespaced 或 Cluster</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 名称的复数形式，用于 URL: /apis/&lt;group&gt;/&lt;version&gt;/&lt;plural&gt;</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 名称的单数形式，用于在命令行接口和显示时作为其别名</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># kind 通常是驼峰编码（CamelCased）的单数形式，用于资源清单中</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># shortNames 允许你在命令行接口中使用更短的字符串来匹配你的资源</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>shortNames</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- ct<span style=color:#bbb>
</span></code></pre></div></div>
<div id=customresourcedefinition-versioning-example-1-1 class=tab-pane role=tabpanel aria-labelledby=customresourcedefinition-versioning-example-1-1>
<p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#080;font-style:italic># 在 v1.16 中被弃用以推荐使用 apiextensions.k8s.io/v1</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1beta1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># name 必须匹配后面 spec 中的字段，且使用格式 &lt;plural&gt;.&lt;group&gt;</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.example.com<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 组名，用于 REST API: /apis/&lt;group&gt;/&lt;version&gt;</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>example.com<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 此 CustomResourceDefinition 所支持的版本列表</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1beta1<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 每个 version 可以通过 served 标志启用或禁止</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 有且只能有一个 version 必须被标记为存储版本</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>validation</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>host</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># conversion 节是 Kubernetes 1.13+ 版本引入的，其默认值为无转换，即</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># strategy 子字段设置为 None。</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>conversion</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># None 转换假定所有版本采用相同的模式定义，仅仅将定制资源的 apiVersion</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 设置为合适的值.</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb> </span>None<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 可以是 Namespaced 或 Cluster</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 名称的复数形式，用于 URL: /apis/&lt;group&gt;/&lt;version&gt;/&lt;plural&gt;</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 名称的单数形式，用于在命令行接口和显示时作为其别名</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># kind 通常是大驼峰编码（PascalCased）的单数形式，用于资源清单中</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># shortNames 允许你在命令行接口中使用更短的字符串来匹配你的资源</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>shortNames</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- ct<span style=color:#bbb>
</span></code></pre></div></div></div>
<p>你可以将 CustomResourceDefinition 存储在 YAML 文件中，然后使用
<code>kubectl apply</code> 来创建它。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl apply -f my-versioned-crontab.yaml
</code></pre></div>
<p>在创建之后，API 服务器开始在 HTTP REST 端点上为每个已启用的版本提供服务。
在上面的示例中，API 版本可以在 <code>/apis/example.com/v1beta1</code> 和
<code>/apis/example.com/v1</code> 处获得。</p>
<h3 id=版本优先级>版本优先级</h3>
<p>不考虑 CustomResourceDefinition 中版本被定义的顺序，kubectl 使用
具有最高优先级的版本作为访问对象的默认版本。
通过解析 <em>name</em> 字段确定优先级来决定版本号，稳定性（GA、Beta 或 Alpha）
级别及该稳定性级别内的序列。</p>
<p>用于对版本进行排序的算法在设计上与 Kubernetes 项目对 Kubernetes 版本进行排序的方式相同。
版本以 <code>v</code> 开头跟一个数字，一个可选的 <code>beta</code> 或者 <code>alpha</code> 和一个可选的附加数字
作为版本信息。
从广义上讲，版本字符串可能看起来像 <code>v2</code> 或者 <code>v2beta1</code>。
使用以下算法对版本进行排序：</p>
<ul>
<li>遵循 Kubernetes 版本模式的条目在不符合条件的条目之前进行排序。</li>
<li>对于遵循 Kubernetes 版本模式的条目，版本字符串的数字部分从最大到最小排序。</li>
<li>如果第一个数字后面有字符串 <code>beta</code> 或 <code>alpha</code>，它们首先按去掉 <code>beta</code> 或
<code>alpha</code> 之后的版本号排序（相当于 GA 版本），之后按 <code>beta</code> 先、<code>alpha</code> 后的顺序排序，</li>
<li>如果 <code>beta</code> 或 <code>alpha</code> 之后还有另一个数字，那么也会针对这些数字
从大到小排序。</li>
<li>不符合上述格式的字符串按字母顺序排序，数字部分不经过特殊处理。
请注意，在下面的示例中，<code>foo1</code> 排在 <code>foo10</code> 之前。
这与遵循 Kubernetes 版本模式的条目的数字部分排序不同。</li>
</ul>
<p>如果查看以下版本排序列表，这些规则就容易懂了：</p>
<pre><code class=language-none data-lang=none>- v10
- v2
- v1
- v11beta2
- v10beta3
- v3beta1
- v12alpha1
- v11alpha2
- foo1
- foo10
</code></pre>
<p>对于<a href=#specify-multiple-versions>指定多个版本</a>中的示例，版本排序顺序为
<code>v1</code>，后跟着 <code>v1beta1</code>。
这导致了 kubectl 命令使用 <code>v1</code> 作为默认版本，除非所提供的对象指定了版本。</p>
<h3 id=版本废弃>版本废弃</h3>
<div style=margin-top:10px;margin-bottom:10px>
<b>FEATURE STATE:</b> <code>Kubernetes v1.19 [stable]</code>
</div>
<p>从 v1.19 开始，CustomResourceDefinition 可用来标明所定义的资源的特定版本
被废弃。当发起对已废弃的版本的 API 请求时，会在 API 响应中以 HTTP 头部
的形式返回警告消息。
如果需要，可以对资源的每个废弃版本定制该警告消息。</p>
<p>定制的警告消息应该标明废弃的 API 组、版本和类别（kind），并且应该标明
应该使用（如果有的话）哪个 API 组、版本和类别作为替代。</p>
<ul class="nav nav-tabs" id=customresourcedefinition-versioning-deprecated role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#customresourcedefinition-versioning-deprecated-0 role=tab aria-controls=customresourcedefinition-versioning-deprecated-0 aria-selected=true>apiextensions.k8s.io/v1</a></li>
<li class=nav-item><a data-toggle=tab class=nav-link href=#customresourcedefinition-versioning-deprecated-1 role=tab aria-controls=customresourcedefinition-versioning-deprecated-1>apiextensions.k8s.io/v1beta1</a></li></ul>
<div class=tab-content id=customresourcedefinition-versioning-deprecated><div id=customresourcedefinition-versioning-deprecated-0 class="tab-pane show active" role=tabpanel aria-labelledby=customresourcedefinition-versioning-deprecated-0>
<p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.example.com<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>example.com<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1alpha1<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 此属性标明此定制资源的 v1alpha1 版本已被弃用。</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 发给此版本的 API 请求会在服务器响应中收到警告消息头。</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>deprecated</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 此属性设置用来覆盖返回给发送 v1alpha1 API 请求的客户端的默认警告信息。</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>deprecationWarning</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;example.com/v1alpha1 CronTab is deprecated; see http://example.com/v1alpha1-v1 for instructions to migrate to example.com/v1 CronTab&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb> </span>...<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1beta1<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 此属性标明该定制资源的 v1beta1 版本已被弃用。</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 发给此版本的 API 请求会在服务器响应中收到警告消息头。</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 针对此版本的请求所返回的是默认的警告消息。</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>deprecated</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb> </span>...<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb> </span>...<span style=color:#bbb>
</span></code></pre></div></div>
<div id=customresourcedefinition-versioning-deprecated-1 class=tab-pane role=tabpanel aria-labelledby=customresourcedefinition-versioning-deprecated-1>
<p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#080;font-style:italic># 在 v1.16 中弃用以推荐使用  apiextensions.k8s.io/v1</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1beta1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.example.com<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>example.com<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>validation</span>:<span style=color:#bbb> </span>...<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1alpha1<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 此属性标明此定制资源的 v1alpha1 版本已被弃用。</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 发给此版本的 API 请求会在服务器响应中收到警告消息头。</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>deprecated</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 此属性设置用来覆盖返回给发送 v1alpha1 API 请求的客户端的默认警告信息。</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>deprecationWarning</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;example.com/v1alpha1 CronTab is deprecated; see http://example.com/v1alpha1-v1 for instructions to migrate to example.com/v1 CronTab&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1beta1<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 此属性标明该定制资源的 v1beta1 版本已被弃用。</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 发给此版本的 API 请求会在服务器响应中收到警告消息头。</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 针对此版本的请求所返回的是默认的警告消息。</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>deprecated</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span></code></pre></div></div></div>
<h2 id=webhook-conversion>Webhook 转换 </h2>
<div style=margin-top:10px;margin-bottom:10px>
<b>FEATURE STATE:</b> <code>Kubernetes v1.16 [stable]</code>
</div>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> Webhook 转换在 Kubernetes 1.13 版本引入，在 Kubernetes 1.15 中成为 Beta 功能。
要使用此功能，应启用 <code>CustomResourceWebhookConversion</code> 特性。
在大多数集群上，这类 Beta 特性应该是自动启用的。
请参阅<a href=/zh/docs/reference/command-line-tools-reference/feature-gates/>特性门控</a>
文档以获得更多信息。
</div>
<p>上面的例子在版本之间有一个 None 转换，它只在转换时设置 <code>apiVersion</code> 字段
而不改变对象的其余部分。API 服务器还支持在需要转换时调用外部服务的 webhook 转换。
例如：</p>
<ul>
<li>定制资源的请求版本与其存储版本不同。</li>
<li>使用某版本创建了 Watch 请求，但所更改对象以另一版本存储。</li>
<li>定制资源的 PUT 请求所针对版本与存储版本不同。</li>
</ul>
<p>为了涵盖所有这些情况并优化 API 服务器所作的转换，转换请求可以包含多个对象，
以便减少外部调用。Webhook 应该独立执行各个转换。</p>
<h3 id=编写一个转换-webhook-服务器>编写一个转换 Webhook 服务器</h3>
<p>请参考<a href=https://github.com/kubernetes/kubernetes/tree/v1.15.0/test/images/crd-conversion-webhook/main.go>定制资源转换 Webhook 服务器</a>
的实现；该实现在 Kubernetes e2e 测试中得到验证。
Webhook 处理由 API 服务器发送的 <code>ConversionReview</code> 请求，并在
<code>ConversionResponse</code> 中封装发回转换结果。
请注意，请求包含需要独立转换的定制资源列表，这些对象在被转换之后不能改变其
在列表中的顺序。该示例服务器的组织方式使其可以复用于其他转换。
大多数常见代码都位于
<a href=https://github.com/kubernetes/kubernetes/tree/v1.15.0/test/images/crd-conversion-webhook/converter/framework.go>framework 文件</a>
中，只留下
<a href=https://github.com/kubernetes/kubernetes/blob/v1.13.0/test/images/crd-conversion-webhook/converter/example_converter.go#L29-L80>一个函数</a>
用于实现不同的转换。</p>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> 转换 Webhook 服务器示例中将 <code>ClientAuth</code> 字段设置为
<a href=https://github.com/kubernetes/kubernetes/tree/v1.13.0/test/images/crd-conversion-webhook/config.go#L47-L48>空</a>，
默认为 <code>NoClientCert</code>。
这意味着 webhook 服务器没有验证客户端（也就是 API 服务器）的身份。
如果你需要双向 TLS 或者其他方式来验证客户端，请参阅如何
<a href=/zh/docs/reference/access-authn-authz/extensible-admission-controllers/#authenticate-apiservers>验证 API 服务</a>。
</div>
<h4 id=被允许的变更>被允许的变更</h4>
<p>转换 Webhook 不可以更改被转换对象的 <code>metadata</code> 中除 <code>labels</code> 和 <code>annotations</code>
之外的任何属性。
尝试更改 <code>name</code>、<code>UID</code> 和 <code>namespace</code> 时都会导致引起转换的请求失败。
所有其他变更都被忽略。</p>
<h3 id=部署转换-webhook-服务>部署转换 Webhook 服务</h3>
<p>用于部署转换 webhook 的文档与
<a href=/zh/docs/reference/access-authn-authz/extensible-admission-controllers/#deploy_the_admission_webhook_service>准入 Webhook 服务示例</a>相同。
这里的假设是转换 Webhook 服务器被部署为 <code>default</code> 名字空间中名为
<code>example-conversion-webhook-server</code> 的服务，并在路径 <code>/crdconvert</code>
上处理请求。</p>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> 当 Webhook 服务器作为一个服务被部署到 Kubernetes 集群中时，它必须
通过端口 443 公开其服务（服务器本身可以使用任意端口，但是服务对象
应该将它映射到端口 443）。
如果为服务器使用不同的端口，则 API 服务器和 Webhook 服务器之间的通信
可能会失败。
</div>
<h3 id=配置-customresourcedefinition-以使用转换-webhook>配置 CustomResourceDefinition 以使用转换 Webhook</h3>
<p>通过修改 <code>spec</code> 中的 <code>conversion</code> 部分，可以扩展 <code>None</code> 转换示例来
使用转换 Webhook。</p>
<ul class="nav nav-tabs" id=customresourcedefinition-versioning-example-2 role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#customresourcedefinition-versioning-example-2-0 role=tab aria-controls=customresourcedefinition-versioning-example-2-0 aria-selected=true>apiextensions.k8s.io/v1</a></li>
<li class=nav-item><a data-toggle=tab class=nav-link href=#customresourcedefinition-versioning-example-2-1 role=tab aria-controls=customresourcedefinition-versioning-example-2-1>apiextensions.k8s.io/v1beta1</a></li></ul>
<div class=tab-content id=customresourcedefinition-versioning-example-2><div id=customresourcedefinition-versioning-example-2-0 class="tab-pane show active" role=tabpanel aria-labelledby=customresourcedefinition-versioning-example-2-0>
<p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># name 必须匹配后面 spec 中的字段，且使用格式 &lt;plural&gt;.&lt;group&gt;</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.example.com<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 组名，用于 REST API: /apis/&lt;group&gt;/&lt;version&gt;</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>example.com<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 此 CustomResourceDefinition 所支持的版本列表</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1beta1<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 每个 version 可以通过 served 标志启用或禁止</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 有且只能有一个 version 必须被标记为存储版本</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 当不存在顶级模式定义时，每个版本（version）可以定义其自身的模式</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>hostPort</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>host</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>conversion</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># Webhook strategy 告诉 API 服务器调用外部 Webhook 来完成定制资源</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 之间的转换</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb> </span>Webhook<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 当 strategy 为 &#34;Webhook&#34; 时，webhook 属性是必需的</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 该属性配置将被 API 服务器调用的 Webhook 端点</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>webhook</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># conversionReviewVersions 标明 Webhook 所能理解或偏好使用的</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># ConversionReview 对象版本。</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># API 服务器所能理解的列表中的第一个版本会被发送到 Webhook</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># Webhook 必须按所接收到的版本响应一个 ConversionReview 对象</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>conversionReviewVersions</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;v1&#34;</span>,<span style=color:#b44>&#34;v1beta1&#34;</span>]<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>clientConfig</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>service</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>example-conversion-webhook-server<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/crdconvert<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>caBundle</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;Ci0tLS0tQk...&lt;base64-encoded PEM bundle&gt;...tLS0K&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 可以是 Namespaced 或 Cluster</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 名称的复数形式，用于 URL: /apis/&lt;group&gt;/&lt;version&gt;/&lt;plural&gt;</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 名称的单数形式，用于在命令行接口和显示时作为其别名</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># kind 通常是驼峰编码（CamelCased）的单数形式，用于资源清单中</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># shortNames 允许你在命令行接口中使用更短的字符串来匹配你的资源</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>shortNames</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- ct<span style=color:#bbb>
</span></code></pre></div></div>
<div id=customresourcedefinition-versioning-example-2-1 class=tab-pane role=tabpanel aria-labelledby=customresourcedefinition-versioning-example-2-1>
<p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#080;font-style:italic># 在 v1.16 中被弃用以推荐使用 apiextensions.k8s.io/v1</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1beta1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># name 必须匹配后面 spec 中的字段，且使用格式 &lt;plural&gt;.&lt;group&gt;</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>crontabs.example.com<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 组名，用于 REST API: /apis/&lt;group&gt;/&lt;version&gt;</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>example.com<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 裁剪掉下面的 OpenAPI 模式中未曾定义的对象字段</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>preserveUnknownFields</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 此 CustomResourceDefinition 所支持的版本列表</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versions</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1beta1<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 每个 version 可以通过 served 标志启用或禁止</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 有且只能有一个 version 必须被标记为存储版本</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 当不存在顶级模式定义时，每个版本（version）可以定义其自身的模式</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>hostPort</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>served</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>storage</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>schema</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>openAPIV3Schema</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>object<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>properties</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>host</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>string<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>conversion</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># Webhook strategy 告诉 API 服务器调用外部 Webhook 来完成定制资源</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb> </span>Webhook<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 当 strategy 为 &#34;Webhook&#34; 时，webhookClientConfig 属性是必需的</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 该属性配置将被 API 服务器调用的 Webhook 端点</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>webhookClientConfig</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>service</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>example-conversion-webhook-server<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/crdconvert<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>caBundle</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;Ci0tLS0tQk...&lt;base64-encoded PEM bundle&gt;...tLS0K&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 可以是 Namespaced 或 Cluster</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>scope</span>:<span style=color:#bbb> </span>Namespaced<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>names</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 名称的复数形式，用于 URL: /apis/&lt;group&gt;/&lt;version&gt;/&lt;plural&gt;</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>plural</span>:<span style=color:#bbb> </span>crontabs<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># 名称的单数形式，用于在命令行接口和显示时作为其别名</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>singular</span>:<span style=color:#bbb> </span>crontab<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># kind 通常是驼峰编码（CamelCased）的单数形式，用于资源清单中</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># shortNames 允许你在命令行接口中使用更短的字符串来匹配你的资源</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>shortNames</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- ct<span style=color:#bbb>
</span></code></pre></div></div></div>
<p>你可以将 CustomResourceDefinition 保存在 YAML 文件中，然后使用
<code>kubectl apply</code> 来应用它。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl apply -f my-versioned-crontab-with-conversion.yaml
</code></pre></div>
<p>在应用新更改之前，请确保转换服务器已启动并正在运行。</p>
<h3 id=调用-webhook>调用 Webhook</h3>
<p>API 服务器一旦确定请求应发送到转换 Webhook，它需要知道如何调用 Webhook。
这是在 <code>webhookClientConfig</code> 中指定的 Webhook 配置。</p>
<p>转换 Webhook 可以通过 URL 或服务引用来调用，并且可以选择包含自定义 CA 包，
以用于验证 TLS 连接。</p>
<h3 id=url>URL</h3>
<p>url 以标准 URL 形式给出 Webhook 的位置（<code>scheme://host:port/path</code>）。
<code>host</code> 不应引用集群中运行的服务，而应通过指定 <code>service</code> 字段来提供
服务引用。
在某些 API 服务器中，<code>host</code> 可以通过外部 DNS 进行解析（即
<code>kube-apiserver</code> 无法解析集群内 DNS，那样会违反分层规则）。
<code>host</code> 也可以是 IP 地址。</p>
<p>请注意，除非你非常小心地在所有运行着可能调用 Webhook 的 API 服务器的
主机上运行此 Webhook，否则将 <code>localhost</code> 或 <code>127.0.0.1</code> 用作 <code>host</code>
是风险很大的。这样的安装可能是不可移植的，或者不容易在一个新的集群中运行。</p>
<p>HTTP 协议必须为 <code>https</code>；URL 必须以 <code>https://</code> 开头。</p>
<p>尝试使用用户或基本身份验证（例如，使用<code>user:password@</code>）是不允许的。
URL 片段（<code>#...</code>）和查询参数（<code>?...</code>）也是不允许的。</p>
<p>下面是为调用 URL 来执行转换 Webhook 的示例，其中期望使用系统信任根
来验证 TLS 证书，因此未指定 caBundle：</p>
<ul class="nav nav-tabs" id=customresourcedefinition-versioning-example-3 role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#customresourcedefinition-versioning-example-3-0 role=tab aria-controls=customresourcedefinition-versioning-example-3-0 aria-selected=true>apiextensions.k8s.io/v1</a></li>
<li class=nav-item><a data-toggle=tab class=nav-link href=#customresourcedefinition-versioning-example-3-1 role=tab aria-controls=customresourcedefinition-versioning-example-3-1>apiextensions.k8s.io/v1beta1</a></li></ul>
<div class=tab-content id=customresourcedefinition-versioning-example-3><div id=customresourcedefinition-versioning-example-3-0 class="tab-pane show active" role=tabpanel aria-labelledby=customresourcedefinition-versioning-example-3-0>
<p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>conversion</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb> </span>Webhook<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>webhook</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>clientConfig</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>url</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;https://my-webhook.example.com:9443/my-webhook-path&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></code></pre></div></div>
<div id=customresourcedefinition-versioning-example-3-1 class=tab-pane role=tabpanel aria-labelledby=customresourcedefinition-versioning-example-3-1>
<p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#080;font-style:italic># 在 v1.16 中已弃用以推荐使用 apiextensions.k8s.io/v1</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1beta1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>conversion</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb> </span>Webhook<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>webhookClientConfig</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>url</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;https://my-webhook.example.com:9443/my-webhook-path&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></code></pre></div></div></div>
<h3 id=服务引用>服务引用</h3>
<p><code>webhookClientConfig</code> 内部的 <code>service</code> 段是对转换 Webhook 服务的引用。
如果 Webhook 在集群中运行，则应使用 <code>service</code> 而不是 <code>url</code>。
服务的名字空间和名称是必需的。端口是可选的，默认为 443。
路径是可选的，默认为<code>/</code>。</p>
<p>下面配置中，服务配置为在端口 <code>1234</code>、子路径 <code>/my-path</code> 上被调用。
例子中针对 ServerName <code>my-service-name.my-service-namespace.svc</code>，
使用自定义 CA 包验证 TLS 连接。</p>
<ul class="nav nav-tabs" id=customresourcedefinition-versioning-example-4 role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#customresourcedefinition-versioning-example-4-0 role=tab aria-controls=customresourcedefinition-versioning-example-4-0 aria-selected=true>apiextensions.k8s.io/v1</a></li>
<li class=nav-item><a data-toggle=tab class=nav-link href=#customresourcedefinition-versioning-example-4-1 role=tab aria-controls=customresourcedefinition-versioning-example-4-1>apiextensions.k8s.io/v1beta1</a></li></ul>
<div class=tab-content id=customresourcedefinition-versioning-example-4><div id=customresourcedefinition-versioning-example-4-0 class="tab-pane show active" role=tabpanel aria-labelledby=customresourcedefinition-versioning-example-4-0>
<p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>conversion</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb> </span>Webhook<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>webhook</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>clientConfig</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>service</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>my-service-namespace<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-service-name<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/my-path<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>1234</span><span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>caBundle</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;Ci0tLS0tQk...&lt;base64-encoded PEM bundle&gt;...tLS0K&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></code></pre></div></div>
<div id=customresourcedefinition-versioning-example-4-1 class=tab-pane role=tabpanel aria-labelledby=customresourcedefinition-versioning-example-4-1>
<p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#080;font-style:italic>#  v1.16 中被弃用以推荐使用 apiextensions.k8s.io/v1</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1beta1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>conversion</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb> </span>Webhook<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>webhookClientConfig</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>service</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>my-service-namespace<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-service-name<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/my-path<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>1234</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>caBundle</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;Ci0tLS0tQk...&lt;base64-encoded PEM bundle&gt;...tLS0K&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></code></pre></div></div></div>
<h2 id=webhook-请求和响应>Webhook 请求和响应</h2>
<h3 id=请求>请求</h3>
<p>向 Webhooks 发起请求的动词是 POST，请求的 <code>Content-Type</code> 为 <code>application/json</code>。
请求的主题为 JSON 序列化形式的
apiextensions.k8s.io API 组的 ConversionReview API 对象。</p>
<p>Webhooks 可以在其 CustomResourceDefinition 中使用<code>conversionReviewVersions</code> 字段
设置它们接受的 <code>ConversionReview</code> 对象的版本：</p>
<ul class="nav nav-tabs" id=conversionreviewversions role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#conversionreviewversions-0 role=tab aria-controls=conversionreviewversions-0 aria-selected=true>apiextensions.k8s.io/v1</a></li>
<li class=nav-item><a data-toggle=tab class=nav-link href=#conversionreviewversions-1 role=tab aria-controls=conversionreviewversions-1>apiextensions.k8s.io/v1beta1</a></li></ul>
<div class=tab-content id=conversionreviewversions><div id=conversionreviewversions-0 class="tab-pane show active" role=tabpanel aria-labelledby=conversionreviewversions-0>
<p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>conversion</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb> </span>Webhook<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>webhook</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>conversionReviewVersions</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;v1&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;v1beta1&#34;</span>]<span style=color:#bbb>
</span><span style=color:#bbb>      </span>...<span style=color:#bbb>
</span></code></pre></div>
<p>创建 <code>apiextensions.k8s.io/v1</code> 版本的自定义资源定义时，
<code>conversionReviewVersions</code>是必填字段。
Webhooks 要求支持至少一个 <code>ConversionReview</code> 当前和以前的 API 服务器
可以理解的版本。</p>
</div>
<div id=conversionreviewversions-1 class=tab-pane role=tabpanel aria-labelledby=conversionreviewversions-1>
<p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#080;font-style:italic># v1.16 已弃用以推荐使用 apiextensions.k8s.io/v1</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1beta1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CustomResourceDefinition<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>conversion</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>strategy</span>:<span style=color:#bbb> </span>Webhook<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>conversionReviewVersions</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;v1&#34;</span>,<span style=color:#bbb> </span><span style=color:#b44>&#34;v1beta1&#34;</span>]<span style=color:#bbb>
</span><span style=color:#bbb>    </span>...<span style=color:#bbb>
</span></code></pre></div>
<p>创建 apiextensions.k8s.io/v1beta1 定制资源定义时若未指定
<code>conversionReviewVersions</code>，则默认值为 v1beta1。</p>
</div></div>
<p>API 服务器将 <code>conversionReviewVersions</code> 列表中他们所支持的第一个
<code>ConversionReview</code> 资源版本发送给 Webhook。
如果列表中的版本都不被 API 服务器支持，则无法创建自定义资源定义。
如果某 API 服务器遇到之前创建的转换 Webhook 配置，并且该配置不支持
API 服务器知道如何发送的任何 <code>ConversionReview</code> 版本，调用 Webhook
的尝试会失败。</p>
<p>下面的示例显示了包含在 <code>ConversionReview</code> 对象中的数据，
该请求意在将 <code>CronTab</code> 对象转换为 <code>example.com/v1</code>：</p>
<ul class="nav nav-tabs" id=conversionreview-request role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#conversionreview-request-0 role=tab aria-controls=conversionreview-request-0 aria-selected=true>apiextensions.k8s.io/v1</a></li>
<li class=nav-item><a data-toggle=tab class=nav-link href=#conversionreview-request-1 role=tab aria-controls=conversionreview-request-1>apiextensions.k8s.io/v1beta1</a></li></ul>
<div class=tab-content id=conversionreview-request><div id=conversionreview-request-0 class="tab-pane show active" role=tabpanel aria-labelledby=conversionreview-request-0>
<p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ConversionReview<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>request</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 用来唯一标识此转换调用的随机 UID</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>uid</span>:<span style=color:#bbb> </span>705ab4f5-6393-11e8-b7cc-42010a800002<span style=color:#bbb>
</span><span style=color:#bbb>  
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 对象要转换到的目标 API 组和版本</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>desiredAPIVersion</span>:<span style=color:#bbb> </span>example.com/v1<span style=color:#bbb>
</span><span style=color:#bbb>  
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 要转换的对象列表</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 其中可能包含一个或多个对象，版本可能相同也可能不同</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>objects</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>example.com/v1beta1<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>creationTimestamp</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2019-09-04T14:03:02Z&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>local-crontab<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>resourceVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;143&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>uid</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;3415a7fc-162b-4300-b5da-fd6083580d66&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>hostPort</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;localhost:1234&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>example.com/v1beta1<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>creationTimestamp</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2019-09-03T13:02:01Z&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>remote-crontab<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>resourceVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;12893&#34;</span>,<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>uid</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;359a83ec-b575-460d-b553-d859cedde8a0&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>hostPort</span>:<span style=color:#bbb> </span>example.com:2345<span style=color:#bbb>
</span></code></pre></div></div>
<div id=conversionreview-request-1 class=tab-pane role=tabpanel aria-labelledby=conversionreview-request-1>
<p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#080;font-style:italic># v1.16 中已废弃以推荐使用 apiextensions.k8s.io/v1</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1beta1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ConversionReview<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>request</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 用来唯一标识此转换调用的随机 UID</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>uid</span>:<span style=color:#bbb> </span>705ab4f5-6393-11e8-b7cc-42010a800002<span style=color:#bbb>
</span><span style=color:#bbb>  
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 对象要转换到的目标 API 组和版本</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>desiredAPIVersion</span>:<span style=color:#bbb> </span>example.com/v1<span style=color:#bbb>
</span><span style=color:#bbb>  
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 要转换的对象列表</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 其中可能包含一个或多个对象，版本可能相同也可能不同</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>objects</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>example.com/v1beta1<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>creationTimestamp</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2019-09-04T14:03:02Z&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>local-crontab<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>resourceVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;143&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>uid</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;3415a7fc-162b-4300-b5da-fd6083580d66&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>hostPort</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;localhost:1234&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>example.com/v1beta1<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>creationTimestamp</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2019-09-03T13:02:01Z&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>remote-crontab<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>resourceVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;12893&#34;</span>,<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>uid</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;359a83ec-b575-460d-b553-d859cedde8a0&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>hostPort</span>:<span style=color:#bbb> </span>example.com:2345<span style=color:#bbb>
</span></code></pre></div></div></div>
<h3 id=响应>响应</h3>
<p>Webhooks 响应包含 200 HTTP 状态代码、<code>Content-Type: application/json</code>，
在主体中包含 JSON 序列化形式的数据，在 <code>response</code> 节中给出
ConversionReview 对象（与发送的版本相同）。</p>
<p>如果转换成功，则 Webhook 应该返回包含以下字段的 <code>response</code> 节：</p>
<ul>
<li><code>uid</code>，从发送到 webhook 的 <code>request.uid</code> 复制而来</li>
<li><code>result</code>，设置为 <code>{"status":"Success"}}</code></li>
<li><code>convertedObjects</code>，包含来自 <code>request.objects</code> 的所有对象，均已转换为
<code>request.desiredVersion</code></li>
</ul>
<p>Webhook 的最简单成功响应示例：</p>
<ul class="nav nav-tabs" id=conversionreview-response-success role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#conversionreview-response-success-0 role=tab aria-controls=conversionreview-response-success-0 aria-selected=true>apiextensions.k8s.io/v1</a></li>
<li class=nav-item><a data-toggle=tab class=nav-link href=#conversionreview-response-success-1 role=tab aria-controls=conversionreview-response-success-1>apiextensions.k8s.io/v1beta1</a></li></ul>
<div class=tab-content id=conversionreview-response-success><div id=conversionreview-response-success-0 class="tab-pane show active" role=tabpanel aria-labelledby=conversionreview-response-success-0>
<p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ConversionReview<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>response</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 必须与 &lt;request.uid&gt; 匹配</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>uid</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;705ab4f5-6393-11e8-b7cc-42010a800002&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>result</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb> </span>Success<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 这里的对象必须与 request.objects 中的对象顺序相同并且其 apiVersion</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 被设置为 &lt;request.desiredAPIVersion&gt;。</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># kind、metadata.uid、metadata.name 和 metadata.namespace 等字段都不可</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 被 Webhook 修改。</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># Webhook 可以更改 metadata.labels 和 metadata.annotations 字段值</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># Webhook 对 metadata 中其他字段的更改都会被忽略</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>convertedObjects</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>example.com/v1<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>creationTimestamp</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2019-09-04T14:03:02Z&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>local-crontab<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>resourceVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;143&#34;</span>,<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>uid</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;3415a7fc-162b-4300-b5da-fd6083580d66&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>host</span>:<span style=color:#bbb> </span>localhost<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1234&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>example.com/v1<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>creationTimestamp</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2019-09-03T13:02:01Z&#34;</span>,<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>remote-crontab<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>resourceVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;12893&#34;</span>,<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>uid</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;359a83ec-b575-460d-b553-d859cedde8a0&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>host</span>:<span style=color:#bbb> </span>example.com<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2345&#34;</span><span style=color:#bbb>
</span></code></pre></div></div>
<div id=conversionreview-response-success-1 class=tab-pane role=tabpanel aria-labelledby=conversionreview-response-success-1>
<p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#080;font-style:italic># v1.16 中已弃用以推荐使用  apiextensions.k8s.io/v1</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1beta1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ConversionReview<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>response</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 必须与 &lt;request.uid&gt; 匹配</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>uid</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;705ab4f5-6393-11e8-b7cc-42010a800002&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>result</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb> </span>Failed<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 这里的对象必须与 request.objects 中的对象顺序相同并且其 apiVersion</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 被设置为 &lt;request.desiredAPIVersion&gt;。</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># kind、metadata.uid、metadata.name 和 metadata.namespace 等字段都不可</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># 被 Webhook 修改。</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># Webhook 可以更改 metadata.labels 和 metadata.annotations 字段值</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># Webhook 对 metadata 中其他字段的更改都会被忽略</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>convertedObjects</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>example.com/v1<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>creationTimestamp</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2019-09-04T14:03:02Z&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>local-crontab<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>default<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>resourceVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;143&#34;</span>,<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>uid</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;3415a7fc-162b-4300-b5da-fd6083580d66&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>host</span>:<span style=color:#bbb> </span>localhost<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;1234&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>CronTab<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>example.com/v1<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>creationTimestamp</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2019-09-03T13:02:01Z&#34;</span>,<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>remote-crontab<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>resourceVersion</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;12893&#34;</span>,<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>uid</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;359a83ec-b575-460d-b553-d859cedde8a0&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>host</span>:<span style=color:#bbb> </span>example.com<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;2345&#34;</span><span style=color:#bbb>
</span></code></pre></div></div></div>
<p>如果转换失败，则 Webhook 应该返回包含以下字段的 <code>response</code> 节：</p>
<ul>
<li><code>uid</code>，从发送到 Webhook 的 <code>request.uid</code> 复制而来</li>
<li><code>result</code>，设置为 <code>{"status": "Failed"}</code></li>
</ul>
<div class="alert alert-danger warning callout" role=alert>
<strong>Warning:</strong>
<p>转换失败会破坏对定制资源的读写访问，包括更新或删除资源的能力。
转换失败应尽可能避免，并且不可用于实施合法性检查约束
（应改用验证模式或 Webhook 准入插件）。
</div>
<p>来自 Webhook 的响应示例，指示转换请求失败，并带有可选消息：</p>
<ul class="nav nav-tabs" id=conversionreview-response-failure role=tablist><li class=nav-item><a data-toggle=tab class="nav-link active" href=#conversionreview-response-failure-0 role=tab aria-controls=conversionreview-response-failure-0 aria-selected=true>apiextensions.k8s.io/v1</a></li>
<li class=nav-item><a data-toggle=tab class=nav-link href=#conversionreview-response-failure-1 role=tab aria-controls=conversionreview-response-failure-1>apiextensions.k8s.io/v1beta1</a></li></ul>
<div class=tab-content id=conversionreview-response-failure><div id=conversionreview-response-failure-0 class="tab-pane show active" role=tabpanel aria-labelledby=conversionreview-response-failure-0>
<p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#bbb>  </span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ConversionReview<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>response</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>uid</span>:<span style=color:#bbb> </span>&lt;value from request.uid&gt;<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>result</span>:<span style=color:#bbb> </span>{<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb> </span>Failed<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>message</span>:<span style=color:#bbb> </span>hostPort could not be parsed into a separate host and port<span style=color:#bbb>
</span></code></pre></div></div>
<div id=conversionreview-response-failure-1 class=tab-pane role=tabpanel aria-labelledby=conversionreview-response-failure-1>
<p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#bbb>  </span><span style=color:#080;font-style:italic># v1.16 中弃用以推荐使用 apiextensions.k8s.io/v1</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiextensions.k8s.io/v1beta1<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ConversionReview<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>response</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>uid</span>:<span style=color:#bbb> </span>&lt;value from request.uid&gt;<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>result</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>status</span>:<span style=color:#bbb> </span>Failed<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>message</span>:<span style=color:#bbb> </span>hostPort could not be parsed into a separate host and port<span style=color:#bbb>
</span></code></pre></div></div></div>
<h2 id=编写-读取和更新版本化的-customresourcedefinition-对象>编写、读取和更新版本化的 CustomResourceDefinition 对象</h2>
<p>写入对象时，将使用写入时指定的存储版本来存储。如果存储版本发生变化，
现有对象永远不会被自动转换。然而，新创建或被更新的对象将以新的存储版本写入。
对象写入的版本不再被支持是有可能的。</p>
<p>当读取对象时，作为路径的一部分，你需要指定版本。
如果所指定的版本与对象的持久版本不同，Kubernetes 会按所请求的版本将对象返回，
但是在满足服务请求时，被持久化的对象既不会在磁盘上更改，也不会以任何方式进行
转换（除了 <code>apiVersion</code> 字符串被更改之外）。你可以以当前提供的任何版本
来请求对象。</p>
<p>如果你更新一个现有对象，它将以当前的存储版本被重写。
这是可以将对象从一个版本改到另一个版本的唯一办法。</p>
<p>为了说明这一点，请考虑以下假设的一系列事件：</p>
<ol>
<li>存储版本是 <code>v1beta1</code>。你创建一个对象。该对象以版本 <code>v1beta1</code> 存储。</li>
<li>你将为 CustomResourceDefinition 添加版本 <code>v1</code>，并将其指定为存储版本。</li>
<li>你使用版本 <code>v1beta1</code> 来读取你的对象，然后你再次用版本 <code>v1</code> 读取对象。
除了 apiVersion 字段之外，返回的两个对象是完全相同的。</li>
<li>你创建一个新对象。对象以版本 <code>v1</code> 保存在存储中。
你现在有两个对象，其中一个是 <code>v1beta1</code>，另一个是 <code>v1</code>。</li>
<li>你更新第一个对象。该对象现在以版本 <code>v1</code> 保存，因为 <code>v1</code> 是当前的存储版本。</li>
</ol>
<h3 id=以前的存储版本>以前的存储版本</h3>
<p>API 服务器在状态字段 <code>storedVersions</code> 中记录曾被标记为存储版本的每个版本。
对象可能以任何曾被指定为存储版本的版本保存。
存储中不会出现从未成为存储版本的版本的对象。</p>
<h2 id=upgrade-existing-objects-to-a-new-stored-version>将现有对象升级到新的存储版本 </h2>
<p>弃用版本并删除其支持时，请设计存储升级过程。</p>
<p><em>选项 1：</em> 使用存储版本迁移程序（Storage Version Migrator）</p>
<ol>
<li>运行<a href=https://github.com/kubernetes-sigs/kube-storage-version-migrator>存储版本迁移程序</a></li>
<li>从 CustomResourceDefinition 的 <code>status.storedVersions</code> 字段中去掉
老的版本。</li>
</ol>
<p><em>选项 2：</em> 手动将现有对象升级到新的存储版本</p>
<p>以下是从 <code>v1beta1</code> 升级到 <code>v1</code> 的示例过程。</p>
<ol>
<li>在 CustomResourceDefinition 文件中将 <code>v1</code> 设置为存储版本，并使用 kubectl 应用它。
<code>storedVersions</code>现在是<code>v1beta1, v1</code>。</li>
<li>编写升级过程以列出所有现有对象并使用相同内容将其写回存储。
这会强制后端使用当前存储版本（即 <code>v1</code>）写入对象。</li>
<li>从 CustomResourceDefinition 的 <code>status.storedVersions</code> 字段中删除 <code>v1beta1</code>。</li>
</ol>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> <p><code>kubectl</code> 工具目前不能用于编辑或修补 CRD 上的 <code>status</code> 子资源：请参阅
<a href=https://github.com/kubernetes/enhancements/tree/master/keps/sig-cli/2590-kubectl-subresource>kubectl Subresource Support KEP</a>
了解更多细节。</p>
<p>从 CLI 给 <code>status</code> 子资源打补丁的更简单的方法是使用 <code>curl</code> 工具直接与 API 服务器交互，示例:</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl proxy &amp;
curl --header <span style=color:#b44>&#34;Content-Type: application/json-patch+json&#34;</span> <span style=color:#b62;font-weight:700>\
</span><span style=color:#b62;font-weight:700></span>  --request PATCH http://localhost:8001/apis/apiextensions.k8s.io/v1/customresourcedefinitions/&lt;your CRD name here&gt;/status <span style=color:#b62;font-weight:700>\
</span><span style=color:#b62;font-weight:700></span>  --data <span style=color:#b44>&#39;[{&#34;op&#34;: &#34;replace&#34;, &#34;path&#34;: &#34;/status/storedVersions&#34;, &#34;value&#34;:[&#34;v1&#34;]}]&#39;</span>
</code></pre></div>
</div>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-2bd28753e62a14a597073fa8ea18a5d8>2 - 配置聚合层</h1>
<p>配置<a href=/zh/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/>聚合层</a>
可以允许 Kubernetes apiserver 使用其它 API 扩展，这些 API 不是核心
Kubernetes API 的一部分。</p>
<h2 id=before-you-begin>Before you begin</h2>
<p><p>你必须拥有一个 Kubernetes 的集群，同时你的 Kubernetes 集群必须带有 kubectl 命令行工具。
建议在至少有两个节点的集群上运行本教程，且这些节点不作为控制平面主机。
如果你还没有集群，你可以通过 <a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>Minikube</a>
构建一个你自己的集群，或者你可以使用下面任意一个 Kubernetes 工具构建：</p>
<ul>
<li><a href=https://www.katacoda.com/courses/kubernetes/playground>Katacoda</a></li>
<li><a href=http://labs.play-with-k8s.com/>玩转 Kubernetes</a></li>
</ul>
To check the version, enter <code>kubectl version</code>.
</p>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> 要使聚合层在你的环境中正常工作以支持代理服务器和扩展 apiserver 之间的相互 TLS 身份验证，
需要满足一些设置要求。Kubernetes 和 kube-apiserver 具有多个 CA，
因此请确保代理是由聚合层 CA 签名的，而不是由 Kubernetes 通用 CA 签名的。
</div>
<div class="alert alert-warning caution callout" role=alert>
<strong>Caution:</strong> 对不同的客户端类型重复使用相同的 CA 会对群集的功能产生负面影响。
有关更多信息，请参见 <a href=#ca-reusage-and-conflicts>CA 重用和冲突</a>。
</div>
<h2 id=身份认证流程>身份认证流程</h2>
<p>与自定义资源定义（CRD）不同，除标准的 Kubernetes apiserver 外，Aggregation API
还涉及另一个服务器：扩展 apiserver。
Kubernetes apiserver 将需要与你的扩展 apiserver 通信，并且你的扩展 apiserver
也需要与 Kubernetes apiserver 通信。
为了确保此通信的安全，Kubernetes apiserver 使用 x509 证书向扩展 apiserver 认证。</p>
<p>本节介绍身份认证和鉴权流程的工作方式以及如何配置它们。</p>
<p>大致流程如下：</p>
<ol>
<li>Kubernetes apiserver：对发出请求的用户身份认证，并对请求的 API 路径执行鉴权。</li>
<li>Kubernetes apiserver：将请求转发到扩展 apiserver</li>
<li>扩展 apiserver：认证来自 Kubernetes apiserver 的请求</li>
<li>扩展 apiserver：对来自原始用户的请求鉴权</li>
<li>扩展 apiserver：执行</li>
</ol>
<p>本节的其余部分详细描述了这些步骤。</p>
<p>该流程可以在下图中看到。</p>
<p><img src=/images/docs/aggregation-api-auth-flow.png alt=聚合层认证流程>.</p>
<p>以上泳道的来源可以在本文档的源码中找到。</p>
<h3 id=kubernetes-apiserver-认证和授权>Kubernetes Apiserver 认证和授权</h3>
<p>由扩展 apiserver 服务的对 API 路径的请求以与所有 API 请求相同的方式开始：
与 Kubernetes apiserver 的通信。该路径已通过扩展 apiserver 在
Kubernetes apiserver 中注册。</p>
<p>用户与 Kubernetes apiserver 通信，请求访问路径。
Kubernetes apiserver 使用它的标准认证和授权配置来对用户认证，以及对特定路径的鉴权。</p>
<p>有关对 Kubernetes 集群认证的概述，请参见
<a href=/zh/docs/reference/access-authn-authz/authentication/>对集群认证</a>。
有关对Kubernetes群集资源的访问鉴权的概述，请参见
<a href=/zh/docs/reference/access-authn-authz/authorization/>鉴权概述</a>。</p>
<p>到目前为止，所有内容都是标准的 Kubernetes API 请求，认证与鉴权。</p>
<p>Kubernetes apiserver 现在准备将请求发送到扩展 apiserver。</p>
<h3 id=kubernetes-apiserver-代理请求>Kubernetes Apiserver 代理请求</h3>
<p>Kubernetes apiserver 现在将请求发送或代理到注册以处理该请求的扩展 apiserver。
为此，它需要了解几件事：</p>
<ol>
<li>
<p>Kubernetes apiserver 应该如何向扩展 apiserver 认证，以通知扩展
apiserver 通过网络发出的请求来自有效的 Kubernetes apiserver？</p>
</li>
<li>
<p>Kubernetes apiserver 应该如何通知扩展 apiserver 原始请求
已通过认证的用户名和组？</p>
</li>
</ol>
<p>为提供这两条信息，你必须使用若干标志来配置 Kubernetes apiserver。</p>
<h4 id=kubernetes-apiserver-客户端认证>Kubernetes Apiserver 客户端认证</h4>
<p>Kubernetes apiserver 通过 TLS 连接到扩展 apiserver，并使用客户端证书认证。
你必须在启动时使用提供的标志向 Kubernetes apiserver 提供以下内容：</p>
<ul>
<li>通过 <code>--proxy-client-key-file</code> 指定私钥文件</li>
<li>通过 <code>--proxy-client-cert-file</code> 签名的客户端证书文件</li>
<li>通过 <code>--requestheader-client-ca-file</code> 签署客户端证书文件的 CA 证书</li>
<li>通过 <code>--requestheader-allowed-names</code> 在签署的客户证书中有效的公用名（CN）</li>
</ul>
<p>Kubernetes apiserver 将使用由 <code>--proxy-client-*-file</code> 指示的文件来验证扩展 apiserver。
为了使合规的扩展 apiserver 能够将该请求视为有效，必须满足以下条件：</p>
<ol>
<li>连接必须使用由 CA 签署的客户端证书，该证书的证书位于 <code>--requestheader-client-ca-file</code> 中。</li>
<li>连接必须使用客户端证书，该客户端证书的 CN 是 <code>--requestheader-allowed-names</code> 中列出的证书之一。</li>
</ol>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> 你可以将此选项设置为空白，即为<code>--requestheader-allowed-names</code>。
这将向扩展 apiserver 指示任何 CN 是可接受的。
</div>
<p>使用这些选项启动时，Kubernetes apiserver 将：</p>
<ol>
<li>使用它们向扩展 apiserver 认证。</li>
<li>在 <code>kube-system</code> 命名空间中
创建一个名为 <code>extension-apiserver-authentication</code> 的 ConfigMap，
它将在其中放置 CA 证书和允许的 CN。
反过来，扩展 apiserver 可以检索这些内容以验证请求。</li>
</ol>
<p>请注意，Kubernetes apiserver 使用相同的客户端证书对所有扩展 apiserver 认证。
它不会为每个扩展 apiserver 创建一个客户端证书，而是创建一个证书作为
Kubernetes apiserver 认证。所有扩展 apiserver 请求都重复使用相同的请求。</p>
<h4 id=原始请求用户名和组>原始请求用户名和组</h4>
<p>当 Kubernetes apiserver 将请求代理到扩展 apiserver 时，
它将向扩展 apiserver 通知原始请求已成功通过其验证的用户名和组。
它在其代理请求的 HTTP 头部中提供这些。你必须将要使用的标头名称告知
Kubernetes apiserver。</p>
<ul>
<li>通过<code>--requestheader-username-headers</code> 标明用来保存用户名的头部</li>
<li>通过<code>--requestheader-group-headers</code> 标明用来保存 group 的头部</li>
<li>通过<code>--requestheader-extra-headers-prefix</code> 标明用来保存拓展信息前缀的头部</li>
</ul>
<p>这些头部名称也放置在 <code>extension-apiserver-authentication</code> ConfigMap 中，
因此扩展 apiserver 可以检索和使用它们。</p>
<h3 id=扩展-apiserver-认证>扩展 Apiserver 认证</h3>
<p>扩展 apiserver 在收到来自 Kubernetes apiserver 的代理请求后，
必须验证该请求确实确实来自有效的身份验证代理，
该认证代理由 Kubernetes apiserver 履行。扩展 apiserver 通过以下方式对其认证：</p>
<ol>
<li>
<p>如上所述，从<code>kube-system</code>中的 configmap 中检索以下内容：</p>
<ul>
<li>客户端 CA 证书</li>
<li>允许名称（CN）列表</li>
<li>用户名，组和其他信息的头部</li>
</ul>
</li>
<li>
<p>使用以下证书检查 TLS 连接是否已通过认证：</p>
<ul>
<li>由其证书与检索到的 CA 证书匹配的 CA 签名。</li>
<li>在允许的 CN 列表中有一个 CN，除非列表为空，在这种情况下允许所有 CN。</li>
<li>从适当的头部中提取用户名和组</li>
</ul>
</li>
</ol>
<p>如果以上均通过，则该请求是来自合法认证代理（在本例中为 Kubernetes apiserver）
的有效代理请求。</p>
<p>请注意，扩展 apiserver 实现负责提供上述内容。
默认情况下，许多扩展 apiserver 实现利用 <code>k8s.io/apiserver/</code> 软件包来做到这一点。
也有一些实现可能支持使用命令行选项来覆盖这些配置。</p>
<p>为了具有检索 configmap 的权限，扩展 apiserver 需要适当的角色。
在 <code>kube-system</code> 名字空间中有一个默认角色
<code>extension-apiserver-authentication-reader</code> 可用于设置。</p>
<h3 id=扩展-apiserver-对请求鉴权>扩展 Apiserver 对请求鉴权</h3>
<p>扩展 apiserver 现在可以验证从标头检索的<code>user/group</code>是否有权执行给定请求。
通过向 Kubernetes apiserver 发送标准
<a href=/zh/docs/reference/access-authn-authz/authorization/>SubjectAccessReview</a> 请求来实现。</p>
<p>为了使扩展 apiserver 本身被鉴权可以向 Kubernetes apiserver 提交 SubjectAccessReview 请求，
它需要正确的权限。
Kubernetes 包含一个具有相应权限的名为 <code>system:auth-delegator</code> 的默认 <code>ClusterRole</code>，
可以将其授予扩展 apiserver 的服务帐户。</p>
<h3 id=扩展-apiserver-执行>扩展 Apiserver 执行</h3>
<p>如果 <code>SubjectAccessReview</code> 通过，则扩展 apiserver 执行请求。</p>
<h2 id=启用-kubernetes-apiserver-标志>启用 Kubernetes Apiserver 标志</h2>
<p>通过以下 kube-apiserver 标志启用聚合层。
你的服务提供商可能已经为你完成了这些工作：</p>
<pre><code>    --requestheader-client-ca-file=&lt;path to aggregator CA cert&gt;
    --requestheader-allowed-names=front-proxy-client
    --requestheader-extra-headers-prefix=X-Remote-Extra-
    --requestheader-group-headers=X-Remote-Group
    --requestheader-username-headers=X-Remote-User
    --proxy-client-cert-file=&lt;path to aggregator proxy cert&gt;
    --proxy-client-key-file=&lt;path to aggregator proxy key&gt;
</code></pre>
<h3 id=ca-reusage-and-conflicts>CA-重用和冲突 </h3>
<p>Kubernetes apiserver 有两个客户端 CA 选项：</p>
<ul>
<li><code>--client-ca-file</code></li>
<li><code>--requestheader-client-ca-file</code></li>
</ul>
<p>这些功能中的每个功能都是独立的；如果使用不正确，可能彼此冲突。</p>
<ul>
<li>
<p><code>--client-ca-file</code>：当请求到达 Kubernetes apiserver 时，如果启用了此选项，
则 Kubernetes apiserver 会检查请求的证书。
如果它是由 <code>--client-ca-file</code> 引用的文件中的 CA 证书之一签名的，
并且用户是公用名<code>CN=</code>的值，而组是组织<code>O=</code> 的取值，则该请求被视为合法请求。
请参阅<a href=/zh/docs/reference/access-authn-authz/authentication/#x509-client-certs>关于 TLS 身份验证的文档</a>。</p>
</li>
<li>
<p><code>--requestheader-client-ca-file</code>：当请求到达 Kubernetes apiserver 时，
如果启用此选项，则 Kubernetes apiserver 会检查请求的证书。
如果它是由文件引用中的 --requestheader-client-ca-file 所签署的 CA 证书之一签名的，
则该请求将被视为潜在的合法请求。
然后，Kubernetes apiserver 检查通用名称 <code>CN=</code> 是否是
<code>--requestheader-allowed-names</code> 提供的列表中的名称之一。
如果名称允许，则请求被批准；如果不是，则请求被拒绝。</p>
</li>
</ul>
<p>如果同时提供了 <code>--client-ca-file</code> 和 <code>--requestheader-client-ca-file</code>，
则首先检查 <code>--requestheader-client-ca-file</code> CA，然后再检查<code>--client-ca-file</code>。
通常，这些选项中的每一个都使用不同的 CA（根 CA 或中间 CA）。
常规客户端请求与 <code>--client-ca-file</code> 相匹配，而聚合请求要与
<code>--requestheader-client-ca-file</code> 相匹配。
但是，如果两者都使用同一个 CA，则通常会通过 <code>--client-ca-file</code>
传递的客户端请求将失败，因为 CA 将与 <code>--requestheader-client-ca-file</code>
中的 CA 匹配，但是通用名称 <code>CN=</code> 将不匹配 <code>--requestheader-allowed-names</code>
中可接受的通用名称之一。
这可能导致你的 kubelet 和其他控制平面组件以及最终用户无法向 Kubernetes
apiserver 认证。</p>
<p>因此，请对用于控制平面组件和最终用户鉴权的 <code>--client-ca-file</code> 选项和
用于聚合 apiserver 鉴权的 <code>--requestheader-client-ca-file</code> 选项使用
不同的 CA 证书。</p>
<div class="alert alert-danger warning callout" role=alert>
<strong>Warning:</strong> 除非你了解风险和保护 CA 用法的机制，否则 <em>不要</em> 重用在不同上下文中使用的 CA。
</div>
<p>如果你未在运行 API 服务器的主机上运行 kube-proxy，则必须确保使用以下
<code>kube-apiserver</code> 标志启用系统：</p>
<pre><code>--enable-aggregator-routing=true
</code></pre>
<h3 id=注册-apiservice-对象>注册 APIService 对象</h3>
<p>你可以动态配置将哪些客户端请求代理到扩展 apiserver。以下是注册示例：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiregistration.k8s.io/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>APIService<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>&lt;注释对象名称&gt;<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>group</span>:<span style=color:#bbb> </span>&lt;扩展 Apiserver 的 API 组名&gt;<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>version</span>:<span style=color:#bbb> </span>&lt;扩展 Apiserver 的 API 版本&gt;<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>groupPriorityMinimum</span>:<span style=color:#bbb> </span>&lt;APIService 对应组的优先级, 参考 API 文档&gt;<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>versionPriority</span>:<span style=color:#bbb> </span>&lt;版本在组中的优先排序, 参考 API 文档&gt;<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>service</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>&lt;拓展 Apiserver 服务的名字空间&gt;<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>&lt;拓展 Apiserver 服务的名称&gt;<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>caBundle</span>:<span style=color:#bbb> </span>&lt;PEM 编码的 CA 证书，用于对 Webhook 服务器的证书签名&gt;<span style=color:#bbb>
</span></code></pre></div>
<p>APIService 对象的名称必须是合法的
<a href=/zh/docs/concepts/overview/working-with-objects/names#path-segment-names>路径片段名称</a>。</p>
<h4 id=调用扩展-apiserver>调用扩展 apiserver</h4>
<p>一旦 Kubernetes apiserver 确定应将请求发送到扩展 apiserver，
它需要知道如何调用它。</p>
<p><code>service</code> 部分是对扩展 apiserver 的服务的引用。
服务的名字空间和名字是必需的。端口是可选的，默认为 443。
路径配置是可选的，默认为 <code>/</code>。</p>
<p>下面是为可在端口 <code>1234</code> 上调用的扩展 apiserver 的配置示例
服务位于子路径 <code>/my-path</code> 下，并针对 ServerName
<code>my-service-name.my-service-namespace.svc</code>
使用自定义的 CA 包来验证 TLS 连接
使用自定义 CA 捆绑包的<code>my-service-name.my-service-namespace.svc</code>。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiregistration.k8s.io/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>APIService<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>...<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>service</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>my-service-namespace<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-service-name<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>1234</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>caBundle</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;Ci0tLS0tQk...&lt;base64-encoded PEM bundle&gt;...tLS0K&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>...</span><span style=color:#bbb>
</span></code></pre></div><h2 id=what-s-next>What's next</h2>
<ul>
<li>使用聚合层<a href=/zh/docs/tasks/extend-kubernetes/setup-extension-api-server/>安装扩展 API 服务器</a>。</li>
<li>有关高级概述，请参阅<a href=/zh/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/>使用聚合层扩展 Kubernetes API</a>。</li>
<li>了解如何<a href=/zh/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/>使用自定义资源扩展 Kubernetes API</a>。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-c4798e42eaccc051e396542befb3c57b>3 - 安装一个扩展的 API server</h1>
<p>安装扩展的 API 服务器来使用聚合层以让 Kubernetes API 服务器使用
其它 API 进行扩展，
这些 API 不是核心 Kubernetes API 的一部分。</p>
<h2 id=before-you-begin>Before you begin</h2>
<p><p>你必须拥有一个 Kubernetes 的集群，同时你的 Kubernetes 集群必须带有 kubectl 命令行工具。
建议在至少有两个节点的集群上运行本教程，且这些节点不作为控制平面主机。
如果你还没有集群，你可以通过 <a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>Minikube</a>
构建一个你自己的集群，或者你可以使用下面任意一个 Kubernetes 工具构建：</p>
<ul>
<li><a href=https://www.katacoda.com/courses/kubernetes/playground>Katacoda</a></li>
<li><a href=http://labs.play-with-k8s.com/>玩转 Kubernetes</a></li>
</ul>
To check the version, enter <code>kubectl version</code>.
</p>
<ul>
<li>你必须<a href=/zh/docs/tasks/extend-kubernetes/configure-aggregation-layer/>配置聚合层</a>
并且启用 API 服务器的相关参数。</li>
</ul>
<h2 id=安装一个扩展的-api-服务器来使用聚合层>安装一个扩展的 API 服务器来使用聚合层</h2>
<p>以下步骤描述如何 <em>在一个高层次</em> 设置一个扩展的 apiserver。无论你使用的是 YAML 配置还是使用 API，这些步骤都适用。
目前我们正在尝试区分出两者的区别。有关使用 YAML 配置的具体示例，你可以在 Kubernetes 库中查看
<a href=https://github.com/kubernetes/sample-apiserver/blob/master/README.md>sample-apiserver</a>。</p>
<p>或者，你可以使用现有的第三方解决方案，例如
<a href=https://github.com/Kubernetes-incubator/apiserver-builder/blob/master/README.md>apiserver-builder</a>，
它将生成框架并自动执行以下所有步骤。</p>
<ol>
<li>确保启用了 APIService API（检查 <code>--runtime-config</code>）。默认应该是启用的，除非被特意关闭了。</li>
<li>你可能需要制定一个 RBAC 规则，以允许你添加 APIService 对象，或让你的集群管理员创建一个。
（由于 API 扩展会影响整个集群，因此不建议在实时集群中对 API 扩展进行测试/开发/调试）</li>
<li>创建 Kubernetes 命名空间，扩展的 api-service 将运行在该命名空间中。</li>
<li>创建（或获取）用来签署服务器证书的 CA 证书，扩展 api-server 中将使用该证书做 HTTPS 连接。</li>
<li>为 api-server 创建一个服务端的证书（或秘钥）以使用 HTTPS。这个证书应该由上述的 CA 签署。
同时应该还要有一个 Kube DNS 名称的 CN，这是从 Kubernetes 服务派生而来的，
格式为 <code>&lt;service name>.&lt;service name namespace>.svc</code>。</li>
<li>使用命名空间中的证书（或秘钥）创建一个 Kubernetes secret。</li>
<li>为扩展 api-server 创建一个 Kubernetes Deployment，并确保以卷的方式挂载了 Secret。
它应该包含对扩展 api-server 镜像的引用。Deployment 也应该在同一个命名空间中。</li>
</ol>
<ol start=8>
<li>确保你的扩展 apiserver 从该卷中加载了那些证书，并在 HTTPS 握手过程中使用它们。</li>
<li>在你的命名空间中创建一个 Kubernetes 服务账号。</li>
<li>为资源允许的操作创建 Kubernetes 集群角色。</li>
<li>用你命名空间中的服务账号创建一个 Kubernetes 集群角色绑定，绑定到你创建的角色上。</li>
<li>用你命名空间中的服务账号创建一个 Kubernetes 集群角色绑定，绑定到 <code>system:auth-delegator</code>
集群角色，以将 auth 决策委派给 Kubernetes 核心 API 服务器。</li>
<li>以你命名空间中的服务账号创建一个 Kubernetes 集群角色绑定，绑定到
<code>extension-apiserver-authentication-reader</code> 角色。
这将让你的扩展 api-server 能够访问 <code>extension-apiserver-authentication</code> configmap。</li>
</ol>
<ol start=14>
<li>创建一个 Kubernetes apiservice。
上述的 CA 证书应该使用 base64 编码，剥离新行并用作 apiservice 中的 spec.caBundle。
该资源不应放到任何名字空间。如果使用了
<a href=https://github.com/kubernetes/kube-aggregator/>kube-aggregator API</a>，那么只需要传入
PEM 编码的 CA 绑定，因为 base 64 编码已经完成了。</li>
<li>使用 kubectl 来获得你的资源。
它应该返回 "找不到资源"。此消息表示一切正常，但你目前还没有创建该资源类型的对象。</li>
</ol>
<h2 id=what-s-next>What's next</h2>
<ul>
<li>如果你还未配置，请<a href=/zh/docs/tasks/extend-kubernetes/configure-aggregation-layer/>配置聚合层</a>
并启用 apiserver 的相关参数。</li>
<li>高级概述，请参阅<a href=/zh/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation>使用聚合层扩展 Kubernetes API</a>。</li>
<li>了解如何<a href=/zh/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/>使用 Custom Resource Definition 扩展 Kubernetes API</a>。</li>
</ul>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-c00a2767fac9dbfafce583cf489cc423>4 - 配置多个调度器</h1>
<p>Kubernetes 自带了一个默认调度器，其详细描述请查阅
<a href=/zh/docs/reference/command-line-tools-reference/kube-scheduler/>这里</a>。
如果默认调度器不适合你的需求，你可以实现自己的调度器。
而且，你甚至可以和默认调度器一起同时运行多个调度器，并告诉 Kubernetes 为每个
Pod 使用哪个调度器。
让我们通过一个例子讲述如何在 Kubernetes 中运行多个调度器。</p>
<p>关于实现调度器的具体细节描述超出了本文范围。
请参考 kube-scheduler 的实现，规范示例代码位于
<a href=https://github.com/kubernetes/kubernetes/tree/master/pkg/scheduler>pkg/scheduler</a>。</p>
<h2 id=before-you-begin>Before you begin</h2>
<p><p>你必须拥有一个 Kubernetes 的集群，同时你的 Kubernetes 集群必须带有 kubectl 命令行工具。
建议在至少有两个节点的集群上运行本教程，且这些节点不作为控制平面主机。
如果你还没有集群，你可以通过 <a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>Minikube</a>
构建一个你自己的集群，或者你可以使用下面任意一个 Kubernetes 工具构建：</p>
<ul>
<li><a href=https://www.katacoda.com/courses/kubernetes/playground>Katacoda</a></li>
<li><a href=http://labs.play-with-k8s.com/>玩转 Kubernetes</a></li>
</ul>
To check the version, enter <code>kubectl version</code>.
</p>
<h2 id=打包调度器>打包调度器</h2>
<p>将调度器可执行文件打包到容器镜像中。出于示例目的，可以使用默认调度器
（kube-scheduler）作为第二个调度器。
克隆 <a href=https://github.com/kubernetes/kubernetes>GitHub 上 Kubernetes 源代码</a>，
并编译构建源代码。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>git clone https://github.com/kubernetes/kubernetes.git
<span style=color:#a2f>cd</span> kubernetes
make
</code></pre></div>
<p>创建一个包含 kube-scheduler 二进制文件的容器镜像。用于构建镜像的 <code>Dockerfile</code> 内容如下：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=color:#a2f;font-weight:700>FROM</span><span style=color:#b44> busybox</span><span>
</span><span></span><span style=color:#a2f;font-weight:700>ADD</span> ./_output/local/bin/linux/amd64/kube-scheduler /usr/local/bin/kube-scheduler<span>
</span></code></pre></div>
<p>将文件保存为 <code>Dockerfile</code>，构建镜像并将其推送到镜像仓库。
此示例将镜像推送到 <a href=https://cloud.google.com/container-registry/>Google 容器镜像仓库（GCR）</a>。
有关详细信息，请阅读 GCR <a href=https://cloud.google.com/container-registry/docs/>文档</a>。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>docker build -t gcr.io/my-gcp-project/my-kube-scheduler:1.0 .
gcloud docker -- push gcr.io/my-gcp-project/my-kube-scheduler:1.0
</code></pre></div>
<h2 id=为调度器定义-kubernetes-deployment>为调度器定义 Kubernetes Deployment</h2>
<p>现在将调度器放在容器镜像中，为它创建一个 Pod 配置，并在 Kubernetes 集群中
运行它。但是与其在集群中直接创建一个 Pod，不如使用
<a href=/zh/docs/concepts/workloads/controllers/deployment/>Deployment</a>。
Deployment 管理一个 <a href=/zh/docs/concepts/workloads/controllers/replicaset/>ReplicaSet</a>，
ReplicaSet 再管理 Pod，从而使调度器能够免受一些故障的影响。
以下是 Deployment 配置，将其保存为 <code>my-scheduler.yaml</code>：</p>
<div class=highlight>
<div class=copy-code-icon style=text-align:right>
<a href=https://raw.githubusercontent.com/kubernetes/website/release-1.23/content/zh/examples/admin/sched/my-scheduler.yaml download=admin/sched/my-scheduler.yaml><code>admin/sched/my-scheduler.yaml</code>
</a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick="copyCode('admin-sched-my-scheduler-yaml')" title="Copy admin/sched/my-scheduler.yaml to clipboard">
</img>
</div>
<div class=includecode id=admin-sched-my-scheduler-yaml>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ServiceAccount<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-scheduler<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>kube-system<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>rbac.authorization.k8s.io/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterRoleBinding<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-scheduler-as-kube-scheduler<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>subjects</span>:<span style=color:#bbb>
</span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ServiceAccount<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-scheduler<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>kube-system<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>roleRef</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterRole<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>system:kube-scheduler<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>apiGroup</span>:<span style=color:#bbb> </span>rbac.authorization.k8s.io<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ConfigMap<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-scheduler-config<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>kube-system<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>data</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>my-scheduler-config.yaml</span>:<span style=color:#bbb> </span>|<span style=color:#b44;font-style:italic>
</span><span style=color:#b44;font-style:italic>    apiVersion: kubescheduler.config.k8s.io/v1beta2
</span><span style=color:#b44;font-style:italic>    kind: KubeSchedulerConfiguration
</span><span style=color:#b44;font-style:italic>    profiles:
</span><span style=color:#b44;font-style:italic>      - schedulerName: my-scheduler
</span><span style=color:#b44;font-style:italic>    leaderElection:
</span><span style=color:#b44;font-style:italic>      leaderElect: false</span><span style=color:#bbb>    
</span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>rbac.authorization.k8s.io/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterRoleBinding<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-scheduler-as-volume-scheduler<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>subjects</span>:<span style=color:#bbb>
</span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ServiceAccount<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-scheduler<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>kube-system<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>roleRef</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterRole<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>system:volume-scheduler<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>apiGroup</span>:<span style=color:#bbb> </span>rbac.authorization.k8s.io<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Deployment<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>component</span>:<span style=color:#bbb> </span>scheduler<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>tier</span>:<span style=color:#bbb> </span>control-plane<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-scheduler<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>kube-system<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>component</span>:<span style=color:#bbb> </span>scheduler<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>tier</span>:<span style=color:#bbb> </span>control-plane<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>replicas</span>:<span style=color:#bbb> </span><span style=color:#666>1</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>component</span>:<span style=color:#bbb> </span>scheduler<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>tier</span>:<span style=color:#bbb> </span>control-plane<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>version</span>:<span style=color:#bbb> </span>second<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>serviceAccountName</span>:<span style=color:#bbb> </span>my-scheduler<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span>- <span style=color:green;font-weight:700>command</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span>- /usr/local/bin/kube-scheduler<span style=color:#bbb>
</span><span style=color:#bbb>        </span>- --config=/etc/kubernetes/my-scheduler/my-scheduler-config.yaml<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>gcr.io/my-gcp-project/my-kube-scheduler:1.0<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>livenessProbe</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>httpGet</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/healthz<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>10259</span><span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>scheme</span>:<span style=color:#bbb> </span>HTTPS<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>initialDelaySeconds</span>:<span style=color:#bbb> </span><span style=color:#666>15</span><span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>kube-second-scheduler<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>readinessProbe</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>httpGet</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/healthz<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>10259</span><span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>scheme</span>:<span style=color:#bbb> </span>HTTPS<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>requests</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>cpu</span>:<span style=color:#bbb> </span><span style=color:#b44>&#39;0.1&#39;</span><span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>securityContext</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>privileged</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span><span style=color:#bbb>          </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>config-volume<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/etc/kubernetes/my-scheduler<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>hostNetwork</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>hostPID</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>config-volume<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>configMap</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>my-scheduler-config<span style=color:#bbb>
</span></code></pre></div>
</div>
</div>
<p>在以上的清单中，你使用 <a href=/zh/docs/reference/scheduling/config/>KubeSchedulerConfiguration</a>
来自定义调度器实现的行为。当使用 <code>--config</code> 选项进行初始化时，该配置被传递到 <code>kube-scheduler</code>。
<code>my-scheduler-config</code> ConfigMap 存储配置数据。
<code>my-scheduler</code> Deployment 的 Pod 将 <code>my-scheduler-config</code> ConfigMap 挂载为一个卷。</p>
<p>在前面提到的调度器配置中，你的调度器通过 <a href=/docs/reference/config-api/kube-scheduler-config.v1beta3/#kubescheduler-config-k8s-io-v1beta3-KubeSchedulerProfile>KubeSchedulerProfile</a> 进行实现。
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong> 要确定一个调度器是否可以调度特定的 Pod，PodTemplate 或 Pod 清单中的 <code>spec.schedulerName</code>
字段必须匹配 <code>KubeSchedulerProfile</code> 中的 <code>schedulerName</code> 字段。
所有运行在集群中的调度器必须拥有唯一的名称。
</div></p>
<p>还要注意，我们创建了一个专用服务账号 <code>my-scheduler</code> 并将集群角色 <code>system:kube-scheduler</code>
绑定到它，以便它可以获得与 <code>kube-scheduler</code> 相同的权限。</p>
<p>请参阅 <a href=/docs/reference/command-line-tools-reference/kube-scheduler/>kube-scheduler 文档</a>
获取其他命令行参数以及 <a href=/docs/reference/config-api/kube-scheduler-config.v1beta3/>Scheduler 配置参考</a>
获取自定义 <code>kube-scheduler</code> 配置的详细说明。</p>
<h2 id=在集群中运行第二个调度器>在集群中运行第二个调度器</h2>
<p>为了在 Kubernetes 集群中运行我们的第二个调度器，在 Kubernetes 集群中创建上面配置中指定的 Deployment：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl create -f my-scheduler.yaml
</code></pre></div>
<p>验证调度器 Pod 正在运行：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl get pods --namespace<span style=color:#666>=</span>kube-system
</code></pre></div><p>输出类似于：</p>
<pre><code>NAME                                           READY     STATUS    RESTARTS   AGE
....
my-scheduler-lnf4s-4744f                       1/1       Running   0          2m
...
</code></pre>
<p>此列表中，除了默认的 <code>kube-scheduler</code> Pod 之外，你应该还能看到处于 “Running” 状态的
<code>my-scheduler</code> Pod。</p>
<h3 id=启用领导者选举>启用领导者选举</h3>
<p>要在启用了 leader 选举的情况下运行多调度器，你必须执行以下操作：</p>
<p>更新你的 YAML 文件中的 <code>my-scheduler-config</code> ConfigMap 里的 KubeSchedulerConfiguration 相关字段如下：</p>
<ul>
<li><code>leaderElection.leaderElect</code> to <code>true</code></li>
<li><code>leaderElection.resourceNamespace</code> to <code>&lt;lock-object-namespace></code></li>
<li><code>leaderElection.resourceName</code> to <code>&lt;lock-object-name></code></li>
</ul>
<div class="alert alert-info note callout" role=alert>
<strong>Note:</strong>
<p>控制平面会为你创建锁对象，但是命名空间必须已经存在。
你可以使用 <code>kube-system</code> 命名空间。
</div>
<p>如果在集群上启用了 RBAC，则必须更新 <code>system：kube-scheduler</code> 集群角色。
将调度器名称添加到应用了 <code>endpoints</code> 和 <code>leases</code> 资源的规则的 resourceNames 中，如以下示例所示：</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl edit clusterrole system:kube-scheduler
</code></pre></div>
<div class=highlight>
<div class=copy-code-icon style=text-align:right>
<a href=https://raw.githubusercontent.com/kubernetes/website/release-1.23/content/zh/examples/admin/sched/clusterrole.yaml download=admin/sched/clusterrole.yaml><code>admin/sched/clusterrole.yaml</code>
</a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick="copyCode('admin-sched-clusterrole-yaml')" title="Copy admin/sched/clusterrole.yaml to clipboard">
</img>
</div>
<div class=includecode id=admin-sched-clusterrole-yaml>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>rbac.authorization.k8s.io/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterRole<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>annotations</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>rbac.authorization.kubernetes.io/autoupdate</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;true&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubernetes.io/bootstrapping</span>:<span style=color:#bbb> </span>rbac-defaults<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>system:kube-scheduler<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>rules</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>apiGroups</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span>- coordination.k8s.io<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span>- leases<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>verbs</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span>- create<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>apiGroups</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span>- coordination.k8s.io<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resourceNames</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span>- kube-scheduler<span style=color:#bbb>
</span><span style=color:#bbb>      </span>- my-scheduler<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span>- leases<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>verbs</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span>- get<span style=color:#bbb>
</span><span style=color:#bbb>      </span>- update<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>apiGroups</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span>- <span style=color:#b44>&#34;&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resourceNames</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span>- kube-scheduler<span style=color:#bbb>
</span><span style=color:#bbb>      </span>- my-scheduler<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>resources</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span>- endpoints<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>verbs</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span>- delete<span style=color:#bbb>
</span><span style=color:#bbb>      </span>- get<span style=color:#bbb>
</span><span style=color:#bbb>      </span>- patch<span style=color:#bbb>
</span><span style=color:#bbb>      </span>- update<span style=color:#bbb>
</span></code></pre></div>
</div>
</div>
<h2 id=为-pod-指定调度器>为 Pod 指定调度器</h2>
<p>现在第二个调度器正在运行，创建一些 Pod，并指定它们由默认调度器或部署的调度器进行调度。
为了使用特定的调度器调度给定的 Pod，在那个 Pod 的 spec 中指定调度器的名称。让我们看看三个例子。</p>
<ul>
<li>
<p>Pod spec 没有任何调度器名称</p>
<div class=highlight>
<div class=copy-code-icon style=text-align:right>
<a href=https://raw.githubusercontent.com/kubernetes/website/release-1.23/content/zh/examples/admin/sched/pod1.yaml download=admin/sched/pod1.yaml><code>admin/sched/pod1.yaml</code>
</a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick="copyCode('admin-sched-pod1-yaml')" title="Copy admin/sched/pod1.yaml to clipboard">
</img>
</div>
<div class=includecode id=admin-sched-pod1-yaml>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>no</span>-annotation<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>multischeduler-example<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>pod-with-no-annotation-container<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>k8s.gcr.io/pause:2.0</code></pre></div>
</div>
</div>
<p>如果未提供调度器名称，则会使用 default-scheduler 自动调度 pod。</p>
<p>将此文件另存为 <code>pod1.yaml</code>，并将其提交给 Kubernetes 集群。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl create -f pod1.yaml
</code></pre></div></li>
</ul>
<ul>
<li>
<p>Pod spec 设置为 <code>default-scheduler</code></p>
<div class=highlight>
<div class=copy-code-icon style=text-align:right>
<a href=https://raw.githubusercontent.com/kubernetes/website/release-1.23/content/zh/examples/admin/sched/pod2.yaml download=admin/sched/pod2.yaml><code>admin/sched/pod2.yaml</code>
</a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick="copyCode('admin-sched-pod2-yaml')" title="Copy admin/sched/pod2.yaml to clipboard">
</img>
</div>
<div class=includecode id=admin-sched-pod2-yaml>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>annotation-default-scheduler<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>multischeduler-example<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>schedulerName</span>:<span style=color:#bbb> </span>default-scheduler<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>pod-with-default-annotation-container<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>k8s.gcr.io/pause:2.0<span style=color:#bbb>
</span></code></pre></div>
</div>
</div>
<p>通过将调度器名称作为 <code>spec.schedulerName</code> 参数的值来指定调度器。
在这种情况下，我们提供默认调度器的名称，即 <code>default-scheduler</code>。</p>
<p>将此文件另存为 <code>pod2.yaml</code>，并将其提交给 Kubernetes 集群。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl create -f pod2.yaml
</code></pre></div></li>
</ul>
<ul>
<li>
<p>Pod spec 设置为 <code>my-scheduler</code></p>
<div class=highlight>
<div class=copy-code-icon style=text-align:right>
<a href=https://raw.githubusercontent.com/kubernetes/website/release-1.23/content/zh/examples/admin/sched/pod3.yaml download=admin/sched/pod3.yaml><code>admin/sched/pod3.yaml</code>
</a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick="copyCode('admin-sched-pod3-yaml')" title="Copy admin/sched/pod3.yaml to clipboard">
</img>
</div>
<div class=includecode id=admin-sched-pod3-yaml>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>annotation-second-scheduler<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>multischeduler-example<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>schedulerName</span>:<span style=color:#bbb> </span>my-scheduler<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>pod-with-second-annotation-container<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>k8s.gcr.io/pause:2.0<span style=color:#bbb>
</span></code></pre></div>
</div>
</div>
<p>在这种情况下，我们指定此 Pod 使用我们部署的 <code>my-scheduler</code> 来调度。
请注意，<code>spec.schedulerName</code> 参数的值应该与调度器提供的 <code>KubeSchedulerProfile</code> 中的 <code>schedulerName</code> 字段相匹配。</p>
<p>将此文件另存为 <code>pod3.yaml</code>，并将其提交给 Kubernetes 集群。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl create -f pod3.yaml
</code></pre></div></li>
</ul>
<p>确认所有三个 pod 都在运行。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl get pods
</code></pre></div>
<h3 id=验证是否使用所需的调度器调度了-pod>验证是否使用所需的调度器调度了 pod</h3>
<p>为了更容易地完成这些示例，我们没有验证 Pod 实际上是使用所需的调度程序调度的。
我们可以通过更改 Pod 的顺序和上面的部署配置提交来验证这一点。
如果我们在提交调度器部署配置之前将所有 Pod 配置提交给 Kubernetes 集群，
我们将看到注解了 <code>annotation-second-scheduler</code> 的 Pod 始终处于 “Pending” 状态，
而其他两个 Pod 被调度。
一旦我们提交调度器部署配置并且我们的新调度器开始运行，注解了
<code>annotation-second-scheduler</code> 的 pod 就能被调度。</p>
<p>或者，可以查看事件日志中的 “Scheduled” 条目，以验证是否由所需的调度器调度了 Pod。</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl get events
</code></pre></div>
<p>你也可以使用<a href=/zh/docs/reference/scheduling/config/#multiple-profiles>自定义调度器配置</a>
或自定义容器镜像，用于集群的主调度器，方法是在相关控制平面节点上修改其静态 pod 清单。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-1707517970dd390995f760308c2e2de6>5 - 使用 HTTP 代理访问 Kubernetes API</h1>
<p>本文说明如何使用 HTTP 代理访问 Kubernetes API。</p>
<h2 id=before-you-begin>Before you begin</h2>
<ul>
<li><p>你必须拥有一个 Kubernetes 的集群，同时你的 Kubernetes 集群必须带有 kubectl 命令行工具。
建议在至少有两个节点的集群上运行本教程，且这些节点不作为控制平面主机。
如果你还没有集群，你可以通过 <a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>Minikube</a>
构建一个你自己的集群，或者你可以使用下面任意一个 Kubernetes 工具构建：</p>
<ul>
<li><a href=https://www.katacoda.com/courses/kubernetes/playground>Katacoda</a></li>
<li><a href=http://labs.play-with-k8s.com/>玩转 Kubernetes</a></li>
</ul>
To check the version, enter <code>kubectl version</code>.
</li>
</ul>
<ul>
<li>如果您的集群中还没有任何应用，使用如下命令启动一个 Hello World 应用：</li>
</ul>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl create deployment node-hello --image<span style=color:#666>=</span>gcr.io/google-samples/node-hello:1.0 --port<span style=color:#666>=</span><span style=color:#666>8080</span>
</code></pre></div>
<h2 id=使用-kubectl-启动代理服务器>使用 kubectl 启动代理服务器</h2>
<p>使用如下命令启动 Kubernetes API 服务器的代理：</p>
<pre><code>kubectl proxy --port=8080
</code></pre>
<h2 id=探究-kubernetes-api>探究 Kubernetes API</h2>
<p>当代理服务器在运行时，你可以通过 <code>curl</code>、<code>wget</code> 或者浏览器访问 API。</p>
<p>获取 API 版本：</p>
<pre><code>curl http://localhost:8080/api/
</code></pre>
<p>输出应该类似这样：</p>
<pre><code>{
  &quot;kind&quot;: &quot;APIVersions&quot;,
  &quot;versions&quot;: [
    &quot;v1&quot;
  ],
  &quot;serverAddressByClientCIDRs&quot;: [
    {
      &quot;clientCIDR&quot;: &quot;0.0.0.0/0&quot;,
      &quot;serverAddress&quot;: &quot;10.0.2.15:8443&quot;
    }
  ]
}
</code></pre>
<p>获取 Pod 列表：</p>
<pre><code>curl http://localhost:8080/api/v1/namespaces/default/pods

{
  &quot;kind&quot;: &quot;PodList&quot;,
  &quot;apiVersion&quot;: &quot;v1&quot;,
  &quot;metadata&quot;: {
    &quot;resourceVersion&quot;: &quot;33074&quot;
  },
  &quot;items&quot;: [
    {
      &quot;metadata&quot;: {
        &quot;name&quot;: &quot;kubernetes-bootcamp-2321272333-ix8pt&quot;,
        &quot;generateName&quot;: &quot;kubernetes-bootcamp-2321272333-&quot;,
        &quot;namespace&quot;: &quot;default&quot;,
        &quot;uid&quot;: &quot;ba21457c-6b1d-11e6-85f7-1ef9f1dab92b&quot;,
        &quot;resourceVersion&quot;: &quot;33003&quot;,
        &quot;creationTimestamp&quot;: &quot;2016-08-25T23:43:30Z&quot;,
        &quot;labels&quot;: {
          &quot;pod-template-hash&quot;: &quot;2321272333&quot;,
          &quot;run&quot;: &quot;kubernetes-bootcamp&quot;
        },
        ...
}
</code></pre>
<h2 id=what-s-next>What's next</h2>
<p>想了解更多信息，请参阅 <a href=/docs/reference/generated/kubectl/kubectl-commands#proxy>kubectl 代理</a>。</p>
</div>
<div class=td-content style=page-break-before:always>
<h1 id=pg-61cf1f2f0fbe98e7635fce65f04a775f>6 - 设置 Konnectivity 服务</h1>
<p>Konnectivity 服务为控制平面提供集群通信的 TCP 级别代理。</p>
<h2 id=before-you-begin>Before you begin</h2>
<p>你需要有一个 Kubernetes 集群，并且 kubectl 命令可以与集群通信。
建议在至少有两个不充当控制平面主机的节点的集群上运行本教程。
如果你还没有集群，可以使用
<a href=https://minikube.sigs.k8s.io/docs/tutorials/multi_node/>minikube</a> 创建一个集群。</p>
<h2 id=配置-konnectivity-服务>配置 Konnectivity 服务</h2>
<p>接下来的步骤需要出口配置，比如：</p>
<div class=highlight>
<div class=copy-code-icon style=text-align:right>
<a href=https://raw.githubusercontent.com/kubernetes/website/release-1.23/content/zh/examples/admin/konnectivity/egress-selector-configuration.yaml download=admin/konnectivity/egress-selector-configuration.yaml><code>admin/konnectivity/egress-selector-configuration.yaml</code>
</a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick="copyCode('admin-konnectivity-egress-selector-configuration-yaml')" title="Copy admin/konnectivity/egress-selector-configuration.yaml to clipboard">
</img>
</div>
<div class=includecode id=admin-konnectivity-egress-selector-configuration-yaml>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apiserver.k8s.io/v1beta1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>EgressSelectorConfiguration<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>egressSelections</span>:<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#080;font-style:italic># Since we want to control the egress traffic to the cluster, we use the</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#080;font-style:italic># &#34;cluster&#34; as the name. Other supported values are &#34;etcd&#34;, and &#34;master&#34;.</span><span style=color:#bbb>
</span><span style=color:#bbb></span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>cluster<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>connection</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># This controls the protocol between the API Server and the Konnectivity</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># server. Supported values are &#34;GRPC&#34; and &#34;HTTPConnect&#34;. There is no</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># end user visible difference between the two modes. You need to set the</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:#080;font-style:italic># Konnectivity server to work in the same mode.</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>proxyProtocol</span>:<span style=color:#bbb> </span>GRPC<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>transport</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># This controls what transport the API Server uses to communicate with the</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># Konnectivity server. UDS is recommended if the Konnectivity server</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># locates on the same machine as the API Server. You need to configure the</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># Konnectivity server to listen on the same UDS socket.</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># The other supported transport is &#34;tcp&#34;. You will need to set up TLS </span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:#080;font-style:italic># config to secure the TCP transport.</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>uds</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>udsName</span>:<span style=color:#bbb> </span>/etc/kubernetes/konnectivity-server/konnectivity-server.socket<span style=color:#bbb>
</span></code></pre></div>
</div>
</div>
<p>你需要配置 API 服务器来使用 Konnectivity 服务，并将网络流量定向到集群节点：</p>
<p>确保<a href=/zh/docs/tasks/configure-pod-container/configure-service-account/#service-account-token-volume-projection>服务账号令牌卷投射</a>
特性被启用。该特性自 Kubernetes v1.20 起默认已被启用。</p>
<ol>
<li>创建一个出站流量配置文件，比如 <code>admin/konnectivity/egress-selector-configuration.yaml</code>。</li>
<li>将 API 服务器的 <code>--egress-selector-config-file</code> 参数设置为你的 API 服务器的
离站流量配置文件路径。</li>
<li>如果你在使用 UDS 连接，须将卷配置添加到 kube-apiserver：
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>konnectivity-uds<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/etc/kubernetes/konnectivity-server<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>readOnly</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>konnectivity-uds<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>hostPath</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/etc/kubernetes/konnectivity-server<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>DirectoryOrCreate<span style=color:#bbb>
</span></code></pre></div></li>
</ol>
<p>为 konnectivity-server 生成或者取得证书和 kubeconfig 文件。
例如，你可以使用 OpenSSL 命令行工具，基于存放在某控制面主机上
<code>/etc/kubernetes/pki/ca.crt</code> 文件中的集群 CA 证书来
发放一个 X.509 证书，</p>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>openssl req -subj <span style=color:#b44>&#34;/CN=system:konnectivity-server&#34;</span> -new -newkey rsa:2048 -nodes -out konnectivity.csr -keyout konnectivity.key -out konnectivity.csr
openssl x509 -req -in konnectivity.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out konnectivity.crt -days <span style=color:#666>375</span> -sha256
<span style=color:#b8860b>SERVER</span><span style=color:#666>=</span><span style=color:#a2f;font-weight:700>$(</span>kubectl config view -o <span style=color:#b8860b>jsonpath</span><span style=color:#666>=</span><span style=color:#b44>&#39;{.clusters..server}&#39;</span><span style=color:#a2f;font-weight:700>)</span>
kubectl --kubeconfig /etc/kubernetes/konnectivity-server.conf config set-credentials system:konnectivity-server --client-certificate konnectivity.crt --client-key konnectivity.key --embed-certs<span style=color:#666>=</span><span style=color:#a2f>true</span>
kubectl --kubeconfig /etc/kubernetes/konnectivity-server.conf config set-cluster kubernetes --server <span style=color:#b44>&#34;</span><span style=color:#b8860b>$SERVER</span><span style=color:#b44>&#34;</span> --certificate-authority /etc/kubernetes/pki/ca.crt --embed-certs<span style=color:#666>=</span><span style=color:#a2f>true</span>
kubectl --kubeconfig /etc/kubernetes/konnectivity-server.conf config set-context system:konnectivity-server@kubernetes --cluster kubernetes --user system:konnectivity-server
kubectl --kubeconfig /etc/kubernetes/konnectivity-server.conf config use-context system:konnectivity-server@kubernetes
rm -f konnectivity.crt konnectivity.key konnectivity.csr
</code></pre></div>
<p>接下来，你需要部署 Konnectivity 服务器和代理。
<a href=https://github.com/kubernetes-sigs/apiserver-network-proxy>kubernetes-sigs/apiserver-network-proxy</a>
是一个参考实现。</p>
<p>在控制面节点上部署 Konnectivity 服务。
下面提供的 <code>konnectivity-server.yaml</code> 配置清单假定在你的集群中
Kubernetes 组件都是部署为<a class=glossary-tooltip title="静态Pod（Static Pod）是指由特定节点上的 kubelet 守护进程直接管理的 Pod。" data-toggle=tooltip data-placement=top href=/zh/docs/tasks/configure-pod-container/static-pod/ target=_blank aria-label="静态 Pod">静态 Pod</a> 的。
如果不是，你可以将 Konnectivity 服务部署为 DaemonSet。</p>
<div class=highlight>
<div class=copy-code-icon style=text-align:right>
<a href=https://raw.githubusercontent.com/kubernetes/website/release-1.23/content/zh/examples/admin/konnectivity/konnectivity-server.yaml download=admin/konnectivity/konnectivity-server.yaml><code>admin/konnectivity/konnectivity-server.yaml</code>
</a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick="copyCode('admin-konnectivity-konnectivity-server-yaml')" title="Copy admin/konnectivity/konnectivity-server.yaml to clipboard">
</img>
</div>
<div class=includecode id=admin-konnectivity-konnectivity-server-yaml>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>Pod<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>konnectivity-server<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>kube-system<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>priorityClassName</span>:<span style=color:#bbb> </span>system-cluster-critical<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>hostNetwork</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>konnectivity-server-container<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>us.gcr.io/k8s-artifacts-prod/kas-network-proxy/proxy-server:v0.0.16<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;/proxy-server&#34;</span>]<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb> </span>[<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:#b44>&#34;--logtostderr=true&#34;</span>,<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:#080;font-style:italic># This needs to be consistent with the value set in egressSelectorConfiguration.</span><span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:#b44>&#34;--uds-name=/etc/kubernetes/konnectivity-server/konnectivity-server.socket&#34;</span>,<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:#080;font-style:italic># The following two lines assume the Konnectivity server is</span><span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:#080;font-style:italic># deployed on the same machine as the apiserver, and the certs and</span><span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:#080;font-style:italic># key of the API Server are at the specified location.</span><span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:#b44>&#34;--cluster-cert=/etc/kubernetes/pki/apiserver.crt&#34;</span>,<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:#b44>&#34;--cluster-key=/etc/kubernetes/pki/apiserver.key&#34;</span>,<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:#080;font-style:italic># This needs to be consistent with the value set in egressSelectorConfiguration.</span><span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:#b44>&#34;--mode=grpc&#34;</span>,<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:#b44>&#34;--server-port=0&#34;</span>,<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:#b44>&#34;--agent-port=8132&#34;</span>,<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:#b44>&#34;--admin-port=8133&#34;</span>,<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:#b44>&#34;--health-port=8134&#34;</span>,<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:#b44>&#34;--agent-namespace=kube-system&#34;</span>,<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:#b44>&#34;--agent-service-account=konnectivity-agent&#34;</span>,<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:#b44>&#34;--kubeconfig=/etc/kubernetes/konnectivity-server.conf&#34;</span>,<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:#b44>&#34;--authentication-audience=system:konnectivity-server&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>            </span>]<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>livenessProbe</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>httpGet</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>scheme</span>:<span style=color:#bbb> </span>HTTP<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>host</span>:<span style=color:#bbb> </span><span style=color:#666>127.0.0.1</span><span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>8134</span><span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/healthz<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>initialDelaySeconds</span>:<span style=color:#bbb> </span><span style=color:#666>30</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>timeoutSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>60</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>ports</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>agentport<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>8132</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>hostPort</span>:<span style=color:#bbb> </span><span style=color:#666>8132</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>adminport<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>8133</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>hostPort</span>:<span style=color:#bbb> </span><span style=color:#666>8133</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>healthport<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containerPort</span>:<span style=color:#bbb> </span><span style=color:#666>8134</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>hostPort</span>:<span style=color:#bbb> </span><span style=color:#666>8134</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>k8s-certs<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/etc/kubernetes/pki<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>readOnly</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>kubeconfig<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/etc/kubernetes/konnectivity-server.conf<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>readOnly</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>true</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>konnectivity-uds<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/etc/kubernetes/konnectivity-server<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>readOnly</span>:<span style=color:#bbb> </span><span style=color:#a2f;font-weight:700>false</span><span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>k8s-certs<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>hostPath</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/etc/kubernetes/pki<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>kubeconfig<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>hostPath</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/etc/kubernetes/konnectivity-server.conf<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>FileOrCreate<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>konnectivity-uds<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>hostPath</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/etc/kubernetes/konnectivity-server<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>type</span>:<span style=color:#bbb> </span>DirectoryOrCreate<span style=color:#bbb>
</span></code></pre></div>
</div>
</div>
<p>在你的集群中部署 Konnectivity 代理：</p>
<div class=highlight>
<div class=copy-code-icon style=text-align:right>
<a href=https://raw.githubusercontent.com/kubernetes/website/release-1.23/content/zh/examples/admin/konnectivity/konnectivity-agent.yaml download=admin/konnectivity/konnectivity-agent.yaml><code>admin/konnectivity/konnectivity-agent.yaml</code>
</a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick="copyCode('admin-konnectivity-konnectivity-agent-yaml')" title="Copy admin/konnectivity/konnectivity-agent.yaml to clipboard">
</img>
</div>
<div class=includecode id=admin-konnectivity-konnectivity-agent-yaml>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>apps/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#080;font-style:italic># Alternatively, you can deploy the agents as Deployments. It is not necessary</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#080;font-style:italic># to have an agent on each node.</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>DaemonSet<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>addonmanager.kubernetes.io/mode</span>:<span style=color:#bbb> </span>Reconcile<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>k8s-app</span>:<span style=color:#bbb> </span>konnectivity-agent<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>kube-system<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>konnectivity-agent<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>selector</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>matchLabels</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>k8s-app</span>:<span style=color:#bbb> </span>konnectivity-agent<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>template</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span><span style=color:green;font-weight:700>k8s-app</span>:<span style=color:#bbb> </span>konnectivity-agent<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>spec</span>:<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>priorityClassName</span>:<span style=color:#bbb> </span>system-cluster-critical<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>tolerations</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>key</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;CriticalAddonsOnly&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>operator</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;Exists&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>containers</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>image</span>:<span style=color:#bbb> </span>us.gcr.io/k8s-artifacts-prod/kas-network-proxy/proxy-agent:v0.0.16<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>konnectivity-agent<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>command</span>:<span style=color:#bbb> </span>[<span style=color:#b44>&#34;/proxy-agent&#34;</span>]<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>args</span>:<span style=color:#bbb> </span>[<span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:#b44>&#34;--logtostderr=true&#34;</span>,<span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:#b44>&#34;--ca-cert=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt&#34;</span>,<span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:#080;font-style:italic># Since the konnectivity server runs with hostNetwork=true,</span><span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:#080;font-style:italic># this is the IP address of the master machine.</span><span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:#b44>&#34;--proxy-server-host=35.225.206.7&#34;</span>,<span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:#b44>&#34;--proxy-server-port=8132&#34;</span>,<span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:#b44>&#34;--admin-server-port=8133&#34;</span>,<span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:#b44>&#34;--health-server-port=8134&#34;</span>,<span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:#b44>&#34;--service-account-token-path=/var/run/secrets/tokens/konnectivity-agent-token&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>                  </span>]<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>volumeMounts</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span>- <span style=color:green;font-weight:700>mountPath</span>:<span style=color:#bbb> </span>/var/run/secrets/tokens<span style=color:#bbb>
</span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>konnectivity-agent-token<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>livenessProbe</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>httpGet</span>:<span style=color:#bbb>
</span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>port</span>:<span style=color:#bbb> </span><span style=color:#666>8134</span><span style=color:#bbb>
</span><span style=color:#bbb>              </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>/healthz<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>initialDelaySeconds</span>:<span style=color:#bbb> </span><span style=color:#666>15</span><span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>timeoutSeconds</span>:<span style=color:#bbb> </span><span style=color:#666>15</span><span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>serviceAccountName</span>:<span style=color:#bbb> </span>konnectivity-agent<span style=color:#bbb>
</span><span style=color:#bbb>      </span><span style=color:green;font-weight:700>volumes</span>:<span style=color:#bbb>
</span><span style=color:#bbb>        </span>- <span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>konnectivity-agent-token<span style=color:#bbb>
</span><span style=color:#bbb>          </span><span style=color:green;font-weight:700>projected</span>:<span style=color:#bbb>
</span><span style=color:#bbb>            </span><span style=color:green;font-weight:700>sources</span>:<span style=color:#bbb>
</span><span style=color:#bbb>              </span>- <span style=color:green;font-weight:700>serviceAccountToken</span>:<span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>path</span>:<span style=color:#bbb> </span>konnectivity-agent-token<span style=color:#bbb>
</span><span style=color:#bbb>                  </span><span style=color:green;font-weight:700>audience</span>:<span style=color:#bbb> </span>system:konnectivity-server<span style=color:#bbb>
</span></code></pre></div>
</div>
</div>
<p>最后，如果你的集群启用了 RBAC，请创建相关的 RBAC 规则：</p>
<div class=highlight>
<div class=copy-code-icon style=text-align:right>
<a href=https://raw.githubusercontent.com/kubernetes/website/release-1.23/content/zh/examples/admin/konnectivity/konnectivity-rbac.yaml download=admin/konnectivity/konnectivity-rbac.yaml><code>admin/konnectivity/konnectivity-rbac.yaml</code>
</a>
<img src=/images/copycode.svg style=max-height:24px;cursor:pointer onclick="copyCode('admin-konnectivity-konnectivity-rbac-yaml')" title="Copy admin/konnectivity/konnectivity-rbac.yaml to clipboard">
</img>
</div>
<div class=includecode id=admin-konnectivity-konnectivity-rbac-yaml>
<div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>rbac.authorization.k8s.io/v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterRoleBinding<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>system:konnectivity-server<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubernetes.io/cluster-service</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;true&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>addonmanager.kubernetes.io/mode</span>:<span style=color:#bbb> </span>Reconcile<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>roleRef</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>apiGroup</span>:<span style=color:#bbb> </span>rbac.authorization.k8s.io<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ClusterRole<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>system:auth-delegator<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>subjects</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span>- <span style=color:green;font-weight:700>apiGroup</span>:<span style=color:#bbb> </span>rbac.authorization.k8s.io<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>User<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>system:konnectivity-server<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:#00f;font-weight:700>---</span><span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>apiVersion</span>:<span style=color:#bbb> </span>v1<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>kind</span>:<span style=color:#bbb> </span>ServiceAccount<span style=color:#bbb>
</span><span style=color:#bbb></span><span style=color:green;font-weight:700>metadata</span>:<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>name</span>:<span style=color:#bbb> </span>konnectivity-agent<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>namespace</span>:<span style=color:#bbb> </span>kube-system<span style=color:#bbb>
</span><span style=color:#bbb>  </span><span style=color:green;font-weight:700>labels</span>:<span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>kubernetes.io/cluster-service</span>:<span style=color:#bbb> </span><span style=color:#b44>&#34;true&#34;</span><span style=color:#bbb>
</span><span style=color:#bbb>    </span><span style=color:green;font-weight:700>addonmanager.kubernetes.io/mode</span>:<span style=color:#bbb> </span>Reconcile<span style=color:#bbb>
</span></code></pre></div>
</div>
</div>
</div>
</main>
</div>
</div>
<footer class=d-print-none>
<div class=footer__links>
<nav>
<a class=text-white href=/zh/docs/home/>主页</a>
<a class=text-white href=/zh/blog/>博客</a>
<a class=text-white href=/zh/training/>培训</a>
<a class=text-white href=/zh/partners/>合作伙伴</a>
<a class=text-white href=/zh/community/>社区</a>
<a class=text-white href=/zh/case-studies/>案例分析</a>
</nav>
</div>
<div class=container-fluid>
<div class=row>
<div class="col-6 col-sm-2 text-xs-center order-sm-2">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="User mailing list" aria-label="User mailing list">
<a class=text-white target=_blank href=https://discuss.kubernetes.io>
<i class="fa fa-envelope"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter>
<a class=text-white target=_blank href=https://twitter.com/kubernetesio>
<i class="fab fa-twitter"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Calendar aria-label=Calendar>
<a class=text-white target=_blank href="https://calendar.google.com/calendar/embed?src=calendar%40kubernetes.io">
<i class="fas fa-calendar-alt"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Youtube aria-label=Youtube>
<a class=text-white target=_blank href=https://youtube.com/kubernetescommunity>
<i class="fab fa-youtube"></i>
</a>
</li>
</ul>
</div>
<div class="col-6 col-sm-2 text-right text-xs-center order-sm-3">
<ul class="list-inline mb-0">
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub>
<a class=text-white target=_blank href=https://github.com/kubernetes/kubernetes>
<i class="fab fa-github"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack>
<a class=text-white target=_blank href=https://slack.k8s.io>
<i class="fab fa-slack"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Contribute aria-label=Contribute>
<a class=text-white target=_blank href=https://git.k8s.io/community/contributors/guide>
<i class="fas fa-edit"></i>
</a>
</li>
<li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow">
<a class=text-white target=_blank href=https://stackoverflow.com/questions/tagged/kubernetes>
<i class="fab fa-stack-overflow"></i>
</a>
</li>
</ul>
</div>
<div class="col-12 col-sm-8 text-center order-sm-2">
<small class=text-white>&copy; 2023 The Kubernetes Authors | Documentation Distributed under <a href=https://git.k8s.io/website/LICENSE class=light-text>CC BY 4.0</a></small>
<br>
<small class=text-white>Copyright &copy; 2023 The Linux Foundation &reg;. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href=https://www.linuxfoundation.org/trademark-usage class=light-text>Trademark Usage page</a></small>
<br>
<small class=text-white>ICP license: 京ICP备17074266号-3</small>
</div>
</div>
</div>
</footer>
</div>
<script src=/js/popper-1.14.3.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script>
<script src=/js/bootstrap-4.3.1.min.js integrity=sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM crossorigin=anonymous></script>
<script src=/js/main.min.40616251a9b6e4b689e7769be0340661efa4d7ebb73f957404e963e135b4ed52.js integrity="sha256-QGFiUam25LaJ53ab4DQGYe+k1+u3P5V0BOlj4TW07VI=" crossorigin=anonymous></script>
</body>
</html>